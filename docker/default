server {
    listen 80 default_server;
    listen [::]:80 default_server;

    
    location @proxy_to_app {
        proxy_pass http://dockerhost:8000;
        
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Host $server_name;
        proxy_set_header  X-Real-IP $remote_addr;
        proxy_set_header  X-Scheme $scheme;
        proxy_set_header  Host $http_host;
        
        proxy_redirect    off;
    }

    # the /auth location will send a subrequest to Django each time someone wants
    # to subscribe to a nginx-push-stream channel (see /ws/ location definition below)
    location = /auth {
        internal;

        proxy_pass http://dockerhost:8000;
        
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Cookie $http_cookie;
    }

    location /channels-stats {
        push_stream_channels_statistics;
        push_stream_channels_path               $arg_id;
    }

    location /pub {
        push_stream_publisher admin;
        push_stream_channels_path               $arg_id;
    }

    location ~ /sub/(.*) {
        push_stream_subscriber;
        push_stream_channels_path                   $1;
    }

    location ~ /ws/(.*) {
        # mpasternak 17.02.2019 na ten moment NIE używaj tego /auth do
        # momentu podpięcia django-reciprocity. Potem włączyć. 
        # auth_request                                /auth;

        push_stream_subscriber websocket;
        push_stream_channels_path                   $1;
        push_stream_message_template                "{\"id\":~id~,\"channel\":\"~channel~\",\"text\":~text~, \"time\":\"~time~\", \"eventid\":\"~event-id~\"}";

    }
    location ~ /ev/(.*) {
        push_stream_subscriber                      eventsource;
        push_stream_channels_path                   $1;
        push_stream_message_template                "{\"id\":~id~,\"channel\":\"~channel~\",\"text\":~text~}";
    }

    root /var/www/html;

    # Add index.php to the list if you are using PHP
    index index.html index.htm index.nginx-debian.html;

    server_name _;

    location / {
        try_files $uri @proxy_to_app;
    }

}
