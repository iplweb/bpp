#!/bin/bash
set -euo pipefail

# Prepares .env file with port offsets based on worktree index
# Usage: ./bin/prepare-worktree.sh [--force]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PROJECT_DIR/.env"

# Parse arguments
FORCE=false
if [[ "${1:-}" == "--force" ]]; then
    FORCE=true
fi

# Check if .env already exists
if [[ -f "$ENV_FILE" && "$FORCE" == "false" ]]; then
    echo "Plik .env juz istnieje. Uzyj --force aby nadpisac."
    exit 0
fi

# Get worktree count from git (main worktree = index 0)
WORKTREE_COUNT=$(git worktree list 2>/dev/null | wc -l | tr -d ' ')
WORKTREE_INDEX=$((WORKTREE_COUNT - 1))

echo "Wykryto worktree index: $WORKTREE_INDEX"

# Base ports (from .env.docker defaults)
BASE_DB_PORT=5432
BASE_APP_PORT=8000
BASE_HTTP_PORT=1080
BASE_HTTPS_PORT=10443
BASE_REDIS_PORT=6379
BASE_RABBITMQ_PORT=5672
BASE_RABBITMQ_MGMT_PORT=15672

# Calculate offset ports
DJANGO_BPP_DB_PORT=$((BASE_DB_PORT + WORKTREE_INDEX))
DJANGO_BPP_PORT_APP=$((BASE_APP_PORT + WORKTREE_INDEX))
DJANGO_BPP_PORT_HTTP=$((BASE_HTTP_PORT + WORKTREE_INDEX))
DJANGO_BPP_PORT_HTTPS=$((BASE_HTTPS_PORT + WORKTREE_INDEX))
DJANGO_BPP_REDIS_PORT=$((BASE_REDIS_PORT + WORKTREE_INDEX))
DJANGO_BPP_RABBITMQ_PORT=$((BASE_RABBITMQ_PORT + WORKTREE_INDEX))
DJANGO_BPP_PORT_RABBITMQ_MGMT=$((BASE_RABBITMQ_MGMT_PORT + WORKTREE_INDEX))

# Function to check if port is in use
check_port() {
    local port=$1
    local name=$2
    if nc -z localhost "$port" 2>/dev/null; then
        echo "  UWAGA: Port $port ($name) jest juz zajety!"
    fi
}

# Check port availability
echo "Sprawdzam dostepnosc portow..."
check_port "$DJANGO_BPP_DB_PORT" "PostgreSQL"
check_port "$DJANGO_BPP_PORT_APP" "Django App"
check_port "$DJANGO_BPP_PORT_HTTP" "HTTP"
check_port "$DJANGO_BPP_PORT_HTTPS" "HTTPS"
check_port "$DJANGO_BPP_REDIS_PORT" "Redis"
check_port "$DJANGO_BPP_RABBITMQ_PORT" "RabbitMQ"
check_port "$DJANGO_BPP_PORT_RABBITMQ_MGMT" "RabbitMQ MGMT"

# Write to .env
cat > "$ENV_FILE" << EOF
# Generated by bin/prepare-worktree.sh
# Worktree index: $WORKTREE_INDEX

# Docker exposed ports (with worktree offset +$WORKTREE_INDEX)
DJANGO_BPP_DB_PORT=$DJANGO_BPP_DB_PORT
DJANGO_BPP_PORT_APP=$DJANGO_BPP_PORT_APP
DJANGO_BPP_PORT_HTTP=$DJANGO_BPP_PORT_HTTP
DJANGO_BPP_PORT_HTTPS=$DJANGO_BPP_PORT_HTTPS
DJANGO_BPP_REDIS_PORT=$DJANGO_BPP_REDIS_PORT
DJANGO_BPP_RABBITMQ_PORT=$DJANGO_BPP_RABBITMQ_PORT
DJANGO_BPP_PORT_RABBITMQ_MGMT=$DJANGO_BPP_PORT_RABBITMQ_MGMT

# PostgreSQL client configuration (for psql, pg_dump, etc.)
PGHOST=localhost
PGPORT=$DJANGO_BPP_DB_PORT
PGDATABASE=bpp
PGUSER=postgres
EOF

echo ""
echo "Zapisano konfiguracje do $ENV_FILE"
echo "Uruchom 'direnv allow' aby zaladowac zmienne srodowiskowe."
