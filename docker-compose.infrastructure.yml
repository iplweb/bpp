# BPP Docker Deployment - Infrastructure Component
# Contains Redis and RabbitMQ message broker services

services:
  redis:
    image: redis:latest
    restart: always
    command: redis-server --loglevel warning --port ${DJANGO_BPP_REDIS_PORT:-6379}
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${DJANGO_BPP_REDIS_PORT:-6379}", "ping"]
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 3
    ports:
      - ${DJANGO_BPP_REDIS_PORT:-6379}:${DJANGO_BPP_REDIS_PORT:-6379}
    volumes:
      - redis_data:/data

  rabbitmq:
    image: rabbitmq:management-alpine
    restart: always
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    ports:
      - ${DJANGO_BPP_RABBITMQ_PORT:-5672}:${DJANGO_BPP_RABBITMQ_PORT:-5672}
      - ${DJANGO_BPP_PORT_RABBITMQ_MGMT:-15672}:15672 # Management UI port
    environment:
      RABBITMQ_NODE_PORT: ${DJANGO_BPP_RABBITMQ_PORT:-5672}
      RABBITMQ_DEFAULT_USER: ${DJANGO_BPP_RABBITMQ_USER:-bpp}
      RABBITMQ_DEFAULT_PASS: ${DJANGO_BPP_RABBITMQ_PASS:-bpp}
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: >-
        -rabbit log_levels [{connection,error},{channel,error},{mirroring,error},{federation,error},{upgrade,error}]
        log [{console,[{level,error}]}]
        -rabbitmq_management path_prefix "/rabbitmq"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 5
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

volumes:
  redis_data:
  rabbitmq_data:
