name: Testy BPP

on:
  push:
    branches:
      - dev
      - master
  pull_request:
    branches:
      - dev

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.12,]

    services:
      postgres:
        image: iplweb/bpp_dbserver:latest
        env:
          POSTGRES_DB: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_USER: postgres
        ports:
          - 5433:5432
        # Set health checks to wait until postgres has started
#        options: >-
#          --health-cmd pg_"isready --username=postgres"
#          --health-interval 10s
#          --health-timeout 5s
#          --health-retries 5

    steps:
    - run: |
        uname -a
        sudo apt install software-properties-common
        sudo add-apt-repository -d -y -n ppa:mozillateam/ppa
        sudo add-apt-repository -d -y -n ppa:deadsnakes/ppa
        echo '
        Package: *
        Pin: origin packages.mozilla.org
        Pin-Priority: 1000

        Package: firefox*
        Pin: release o=Ubuntu
        Pin-Priority: -1' | sudo tee /etc/apt/preferences.d/mozilla
        curl -fsSL https://deb.nodesource.com/setup_current.x | bash -
        sudo apt install -y python3.11 python3.11-dev python3-dev libpq-dev firefox firefox-geckodriver nodejs
        sudo npm install -g yarn grunt-cli

    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        python -m pip install pip poetry
        poetry install --with=dev

    - name: Run Tests
      env:
        DJANGO_BPP_DB_HOST: 127.0.0.1
        DJANGO_BPP_DB_PORT: 5433
        DJANGO_BPP_DB_USER: postgres
      run: |
        make assets
        poetry run src/manage.py collectstatic --yes
        poetry run pytest --splinter-headless -k test_wyrzuc
