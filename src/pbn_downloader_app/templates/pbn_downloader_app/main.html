{% extends "base.html" %}
{% load static %}
{% csrf_token %}

{% block title %}PBN Downloader - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li class="current">PBN Downloader</li>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="large-12 columns">
            <h1>PBN Downloader <span class="label secondary">BETA</span></h1>
            <p class="lead">Narzędzie do pobierania danych z Polskiej Bibliografii Naukowej (PBN)</p>
        </div>
    </div>

    <div class="row equal-height-panels">
        <div class="large-12 xlarge-6 columns">
            <div class="panel callout secondary download-panel">
                <div class="panel-header">
                    <h4><i class="fi-page-multiple"></i> Pobieranie publikacji i oświadczeń</h4>
                    <p>Pobieranie publikacji instytucji oraz oświadczeń autorów z PBN.</p>
                </div>

                <div class="panel-icon">
                    <span style="color: #0066cc; font-size: 2em;">📄</span>
                    <span style="color: #0066cc; font-size: 1.2em; display: block;">Publications</span>
                </div>

                <div class="panel-action">
                    <button id="download-btn" class="button success expanded">
                        <i class="fi-cloud-download"></i> Pobierz publikacje z PBN
                    </button>
                </div>

                <!-- Simplified status display -->
                <div id="task-status" class="status-section" style="display: none;">
                    <hr />
                    <h5 class="status-title">Status pobierania</h5>

                    <div id="task-running" class="status-content" style="display: none;">
                        <div class="status-message">
                            <i class="fi-refresh"></i> <strong>Pobieranie w toku...</strong>
                            <small id="current-step" class="step-info">Inicjalizacja...</small>
                        </div>
                        <div class="progress">
                            <div id="progress-meter" class="meter success" style="width: 0%;"></div>
                        </div>
                        <div class="progress-info">
                            <span id="progress-percentage">0%</span>
                            <span id="progress-details"></span>
                        </div>
                    </div>

                    <div id="task-completed" class="status-badge success" style="display: none;">
                        <i class="fi-check"></i> <strong>Pobrane pomyślnie</strong>
                        <small>Ostatnia aktualizacja: <span id="last-update"></span></small>
                        <small>Użytkownik: <span id="task-user"></span></small>
                    </div>

                    <div id="task-failed" class="status-badge alert" style="display: none;">
                        <i class="fi-alert"></i> <strong>Błąd pobierania</strong>
                        <small><span id="error-message"></span></small>
                        <button id="retry-btn" class="button warning tiny">
                            <i class="fi-refresh"></i> Ponów
                        </button>
                    </div>

                    <div id="task-no-data" class="status-badge secondary" style="display: none;">
                        <i class="fi-info"></i> <strong>Brak danych</strong>
                        <small>Nie wykonano jeszcze pobierania</small>
                    </div>
                </div>

                <div class="panel-footer">
                    <small class="text-muted"><strong>Info:</strong> Proces może potrwać kilka minut</small>
                </div>
            </div>
        </div>

        <div class="large-12 xlarge-6 columns">
            <div class="panel callout warning download-panel">
                <div class="panel-header">
                    <h4><i class="fi-torsos-all"></i> Pobieranie osób z instytucji</h4>
                    <p>Pobieranie danych osób powiązanych z instytucją z PBN.</p>
                </div>

                <div class="panel-icon">
                    <span style="color: #e07600; font-size: 2em;">👥</span>
                    <span style="color: #e07600; font-size: 1.2em; display: block;">People</span>
                </div>

                <div class="panel-action">
                    <button id="people-download-btn" class="button warning expanded">
                        <i class="fi-torsos-all"></i> Pobierz osoby z PBN
                    </button>
                </div>

                <!-- Simplified status display -->
                <div id="people-task-status" class="status-section" style="display: none;">
                    <hr />
                    <h5 class="status-title">Status pobierania</h5>

                    <div id="people-task-running" class="status-content" style="display: none;">
                        <div class="status-message">
                            <i class="fi-refresh"></i> <strong>Pobieranie w toku...</strong>
                            <small id="people-current-step" class="step-info">Inicjalizacja...</small>
                        </div>
                        <div class="progress">
                            <div id="people-progress-meter" class="meter warning" style="width: 0%;"></div>
                        </div>
                        <div class="progress-info">
                            <span id="people-progress-percentage">0%</span>
                            <span id="people-progress-details"></span>
                        </div>
                    </div>

                    <div id="people-task-completed" class="status-badge success" style="display: none;">
                        <i class="fi-check"></i> <strong>Pobrane pomyślnie</strong>
                        <small>Ostatnia aktualizacja: <span id="people-last-update"></span></small>
                        <small>Użytkownik: <span id="people-task-user"></span></small>
                    </div>

                    <div id="people-task-failed" class="status-badge alert" style="display: none;">
                        <i class="fi-alert"></i> <strong>Błąd pobierania</strong>
                        <small><span id="people-error-message"></span></small>
                        <button id="people-retry-btn" class="button alert tiny">
                            <i class="fi-refresh"></i> Ponów
                        </button>
                    </div>

                    <div id="people-task-no-data" class="status-badge secondary" style="display: none;">
                        <i class="fi-info"></i> <strong>Brak danych</strong>
                        <small>Nie wykonano jeszcze pobierania</small>
                    </div>
                </div>

                <div class="panel-footer">
                    <small class="text-muted"><strong>Info:</strong> Proces może potrwać kilka minut</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="panel callout info">
                <h3><i class="fi-info"></i> Informacje o pobieraniu</h3>
                <div class="row">
                    <div class="medium-6 columns">
                        <h4>📄 Pobieranie publikacji</h4>
                        <p>Składa się z dwóch głównych etapów:</p>
                        <ul>
                            <li><strong>Faza 1:</strong> Pobieranie publikacji instytucji z PBN</li>
                            <li><strong>Faza 2:</strong> Pobieranie oświadczeń i publikacji</li>
                        </ul>
                    </div>
                    <div class="medium-6 columns">
                        <h4>👥 Pobieranie osób</h4>
                        <p>Pobieranie danych osób powiązanych z instytucją:</p>
                        <ul>
                            <li>Pobieranie listy osób z instytucji</li>
                            <li>Aktualizacja danych naukowców w systemie</li>
                        </ul>
                    </div>
                </div>
                <p><strong>Uwaga:</strong> Do rozpoczęcia pobierania wymagana jest ważna autoryzacja w systemie PBN. Upewnij się, że jesteś zalogowany w PBN i posiadasz odpowiednie uprawnienia.</p>
            </div>
        </div>
    </div>

    {% if latest_task or latest_people_task %}
    <div class="row">
        <div class="large-12 columns">
            <div class="panel callout">
                <h3><i class="fi-clock"></i> Historia ostatnich zadań</h3>
                <div class="row">
                    {% if latest_task %}
                    <div class="medium-6 columns">
                        <h4>📄 Ostatnie pobieranie publikacji</h4>
                        <div class="stat-box">
                            <strong>Status:</strong>
                            <span class="label
                                {% if latest_task.status == 'completed' %}success
                                {% elif latest_task.status == 'failed' %}alert
                                {% elif latest_task.status == 'running' %}warning
                                {% endif %}">
                                {{ latest_task.get_status_display }}
                            </span><br/>
                            <strong>Użytkownik:</strong> {{ latest_task.user.username }}<br/>
                            <strong>Rozpoczęte:</strong> {{ latest_task.started_at|date:"d.m.Y H:i:s" }}<br/>
                            <strong>Zakończone:</strong>
                            {% if latest_task.completed_at %}
                                {{ latest_task.completed_at|date:"d.m.Y H:i:s" }}
                            {% else %}
                                <em>W toku</em>
                            {% endif %}
                            {% if latest_task.current_step %}
                                <br/><strong>Aktualny krok:</strong> {{ latest_task.current_step }}
                            {% endif %}
                            {% if latest_task.error_message %}
                                <br/><strong>Błąd:</strong>
                                <div class="callout alert small" style="margin-top: 0.5rem;">
                                    {{ latest_task.error_message|truncatewords:15 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if latest_people_task %}
                    <div class="medium-6 columns">
                        <h4>👥 Ostatnie pobieranie osób</h4>
                        <div class="stat-box">
                            <strong>Status:</strong>
                            <span class="label
                                {% if latest_people_task.status == 'completed' %}success
                                {% elif latest_people_task.status == 'failed' %}alert
                                {% elif latest_people_task.status == 'running' %}warning
                                {% endif %}">
                                {{ latest_people_task.get_status_display }}
                            </span><br/>
                            <strong>Użytkownik:</strong> {{ latest_people_task.user.username }}<br/>
                            <strong>Rozpoczęte:</strong> {{ latest_people_task.started_at|date:"d.m.Y H:i:s" }}<br/>
                            <strong>Zakończone:</strong>
                            {% if latest_people_task.completed_at %}
                                {{ latest_people_task.completed_at|date:"d.m.Y H:i:s" }}
                            {% else %}
                                <em>W toku</em>
                            {% endif %}
                            {% if latest_people_task.current_step %}
                                <br/><strong>Aktualny krok:</strong> {{ latest_people_task.current_step }}
                            {% endif %}
                            {% if latest_people_task.error_message %}
                                <br/><strong>Błąd:</strong>
                                <div class="callout alert small" style="margin-top: 0.5rem;">
                                    {{ latest_people_task.error_message|truncatewords:15 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Equal height panels with flexbox */
        .equal-height-panels {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .equal-height-panels > .columns {
            display: flex;
            margin-bottom: 1rem;
            flex: 1 1 100%;
        }

        @media screen and (min-width: 1440px) {
            .equal-height-panels > .xlarge-6 {
                flex: 1 1 calc(50% - 0.5rem);
            }
        }

        .download-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 450px;
            width: 100%;
        }

        .panel-header {
            flex-shrink: 0;
        }

        .panel-icon {
            text-align: center;
            padding: 1rem 0;
            flex-shrink: 0;
        }

        .panel-action {
            flex-shrink: 0;
        }

        .status-section {
            flex: 1;
            margin-top: 1rem;
        }

        .panel-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #e6e6e6;
            flex-shrink: 0;
        }

        /* Simplified status styles */
        .status-title {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #666;
        }

        .status-content {
            padding: 0.5rem 0;
        }

        .status-message {
            margin-bottom: 0.5rem;
        }

        .status-message small {
            display: block;
            margin-top: 0.25rem;
            color: #666;
        }

        .status-badge {
            padding: 0.75rem;
            border-radius: 3px;
            margin-top: 0.5rem;
        }

        .status-badge.success {
            background: #e6f4ea;
            border: 1px solid #34a853;
            color: #137333;
        }

        .status-badge.alert {
            background: #fce8e6;
            border: 1px solid #ea4335;
            color: #a50e0e;
        }

        .status-badge.secondary {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            color: #5f6368;
        }

        .status-badge small {
            display: block;
            margin-top: 0.25rem;
        }

        .status-badge button {
            margin-top: 0.5rem;
        }

        /* Progress bar styles */
        .progress {
            background-color: #e6e6e6;
            border-radius: 3px;
            height: 20px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
            margin: 0.5rem 0;
        }

        .progress .meter {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 3px;
            display: block;
        }

        .progress .meter.success {
            background-color: #28a745;
        }

        .progress .meter.warning {
            background-color: #e07600;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
        }

        .stat-box {
            padding: 0.5rem;
            background: #f8f8f8;
            border-radius: 3px;
            margin-bottom: 1rem;
        }

        .text-muted {
            color: #6c757d;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .equal-height-panels {
                display: block;
            }
            .download-panel {
                min-height: auto;
            }
        }
    </style>

    <script>
        $(document).ready(function() {
            // Check task status on page load and then periodically
            checkTaskStatus();
            checkPeopleTaskStatus();
            var statusInterval = setInterval(function() {
                checkTaskStatus();
                checkPeopleTaskStatus();
            }, 5000); // Check every 5 seconds

            // Publication download button click handler
            $('#download-btn').click(function() {
                var btn = $(this);
                if (btn.hasClass('disabled')) return false;

                btn.addClass('disabled').html('<i class="fi-refresh"></i> Rozpoczynam pobieranie...');

                $.ajax({
                    url: '{% url "pbn_downloader_app:start_download" %}',
                    type: 'POST',
                    headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
                    success: function(data) {
                        if (data.success) {
                            checkTaskStatus();
                        } else {
                            alert('Błąd: ' + data.error);
                            btn.removeClass('disabled').html('<i class="fi-cloud-download"></i> Pobierz publikacje z PBN');
                        }
                    },
                    error: function() {
                        alert('Wystąpił błąd podczas komunikacji z serwerem');
                        btn.removeClass('disabled').html('<i class="fi-cloud-download"></i> Pobierz publikacje z PBN');
                    }
                });
            });

            // People download button click handler
            $('#people-download-btn').click(function() {
                var btn = $(this);
                if (btn.hasClass('disabled')) return false;

                btn.addClass('disabled').html('<i class="fi-refresh"></i> Rozpoczynam pobieranie...');

                $.ajax({
                    url: '{% url "pbn_downloader_app:start_people_download" %}',
                    type: 'POST',
                    headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
                    success: function(data) {
                        if (data.success) {
                            checkPeopleTaskStatus();
                        } else {
                            alert('Błąd: ' + data.error);
                            btn.removeClass('disabled').html('<i class="fi-torsos-all"></i> Pobierz osoby z PBN');
                        }
                    },
                    error: function() {
                        alert('Wystąpił błąd podczas komunikacji z serwerem');
                        btn.removeClass('disabled').html('<i class="fi-torsos-all"></i> Pobierz osoby z PBN');
                    }
                });
            });

            // Retry button handlers
            $(document).on('click', '#retry-btn', function() {
                var btn = $(this);
                btn.addClass('disabled').html('<i class="fi-refresh"></i> Ponawiam...');

                $.ajax({
                    url: '{% url "pbn_downloader_app:retry_task" %}',
                    type: 'POST',
                    headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
                    success: function(data) {
                        if (data.success) {
                            checkTaskStatus();
                        } else {
                            alert('Błąd: ' + data.error);
                            btn.removeClass('disabled').html('<i class="fi-refresh"></i> Spróbuj ponownie');
                        }
                    },
                    error: function() {
                        alert('Wystąpił błąd podczas komunikacji z serwerem');
                        btn.removeClass('disabled').html('<i class="fi-refresh"></i> Spróbuj ponownie');
                    }
                });
            });

            $(document).on('click', '#people-retry-btn', function() {
                var btn = $(this);
                btn.addClass('disabled').html('<i class="fi-refresh"></i> Ponawiam...');

                $.ajax({
                    url: '{% url "pbn_downloader_app:retry_people_task" %}',
                    type: 'POST',
                    headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
                    success: function(data) {
                        if (data.success) {
                            checkPeopleTaskStatus();
                        } else {
                            alert('Błąd: ' + data.error);
                            btn.removeClass('disabled').html('<i class="fi-refresh"></i> Spróbuj ponownie');
                        }
                    },
                    error: function() {
                        alert('Wystąpił błąd podczas komunikacji z serwerem');
                        btn.removeClass('disabled').html('<i class="fi-refresh"></i> Spróbuj ponownie');
                    }
                });
            });

            // Publications task status functions
            function checkTaskStatus() {
                $.ajax({
                    url: '{% url "pbn_downloader_app:task_status" %}',
                    type: 'GET',
                    success: function(data) { updateTaskStatus(data); },
                    error: function() { console.log('Error checking task status'); }
                });
            }

            function updateTaskStatus(data) {
                var downloadBtn = $('#download-btn');
                var taskStatus = $('#task-status');
                var taskRunning = $('#task-running');
                var taskCompleted = $('#task-completed');
                var taskFailed = $('#task-failed');
                var taskNoData = $('#task-no-data');

                taskRunning.hide();
                taskCompleted.hide();
                taskFailed.hide();
                taskNoData.hide();

                if (data.is_running) {
                    downloadBtn.addClass('disabled').html('<i class="fi-refresh"></i> Pobieranie w toku...');
                    taskStatus.show();
                    taskRunning.show();

                    if (data.latest_task) {
                        var task = data.latest_task;
                        if (task.current_step) $('#current-step').text(task.current_step);
                        if (task.progress_percentage !== undefined && task.progress_percentage !== null) {
                            var percentage = Math.max(0, Math.min(100, parseInt(task.progress_percentage)));
                            $('#progress-percentage').text(percentage + '%');
                            $('#progress-meter').css('width', percentage + '%');
                        }

                        var details = [];
                        if (task.publications_processed > 0 || task.total_publications) {
                            details.push('Publikacje: ' + (task.publications_processed || 0) +
                                        (task.total_publications ? '/' + task.total_publications : ''));
                        }
                        if (task.statements_processed > 0 || task.total_statements) {
                            details.push('Oświadczenia: ' + (task.statements_processed || 0) +
                                        (task.total_statements ? '/' + task.total_statements : ''));
                        }
                        $('#progress-details').text(details.join(', '));
                    }
                } else if (data.latest_task) {
                    var task = data.latest_task;
                    if (task.status === 'completed') {
                        downloadBtn.removeClass('disabled').html('<i class="fi-cloud-download"></i> Pobierz publikacje z PBN');
                        taskStatus.show();
                        taskCompleted.show();
                        $('#last-update').text(formatDate(task.completed_at));
                        $('#task-user').text(task.user);
                    } else if (task.status === 'failed') {
                        downloadBtn.removeClass('disabled').html('<i class="fi-cloud-download"></i> Pobierz publikacje z PBN');
                        taskStatus.show();
                        taskFailed.show();
                        $('#error-message').text(task.error_message || 'Nieznany błąd');
                        $('#error-time').text(formatDate(task.completed_at));
                    }
                } else {
                    downloadBtn.removeClass('disabled').html('<i class="fi-cloud-download"></i> Pobierz publikacje z PBN');
                    taskStatus.show();
                    taskNoData.show();
                }
            }

            // People task status functions
            function checkPeopleTaskStatus() {
                $.ajax({
                    url: '{% url "pbn_downloader_app:people_task_status" %}',
                    type: 'GET',
                    success: function(data) { updatePeopleTaskStatus(data); },
                    error: function() { console.log('Error checking people task status'); }
                });
            }

            function updatePeopleTaskStatus(data) {
                var peopleDownloadBtn = $('#people-download-btn');
                var peopleTaskStatus = $('#people-task-status');
                var peopleTaskRunning = $('#people-task-running');
                var peopleTaskCompleted = $('#people-task-completed');
                var peopleTaskFailed = $('#people-task-failed');
                var peopleTaskNoData = $('#people-task-no-data');

                peopleTaskRunning.hide();
                peopleTaskCompleted.hide();
                peopleTaskFailed.hide();
                peopleTaskNoData.hide();

                if (data.is_running) {
                    peopleDownloadBtn.addClass('disabled').html('<i class="fi-refresh"></i> Pobieranie w toku...');
                    peopleTaskStatus.show();
                    peopleTaskRunning.show();

                    if (data.latest_task) {
                        var task = data.latest_task;
                        if (task.current_step) $('#people-current-step').text(task.current_step);
                        if (task.progress_percentage !== undefined && task.progress_percentage !== null) {
                            var percentage = Math.max(0, Math.min(100, parseInt(task.progress_percentage)));
                            $('#people-progress-percentage').text(percentage + '%');
                            $('#people-progress-meter').css('width', percentage + '%');
                        }

                        var details = [];
                        if (task.people_processed > 0 || task.total_people) {
                            details.push('Osoby: ' + (task.people_processed || 0) +
                                        (task.total_people ? '/' + task.total_people : ''));
                        }
                        $('#people-progress-details').text(details.join(', '));
                    }
                } else if (data.latest_task) {
                    var task = data.latest_task;
                    if (task.status === 'completed') {
                        peopleDownloadBtn.removeClass('disabled').html('<i class="fi-torsos-all"></i> Pobierz osoby z PBN');
                        peopleTaskStatus.show();
                        peopleTaskCompleted.show();
                        $('#people-last-update').text(formatDate(task.completed_at));
                        $('#people-task-user').text(task.user);
                    } else if (task.status === 'failed') {
                        peopleDownloadBtn.removeClass('disabled').html('<i class="fi-torsos-all"></i> Pobierz osoby z PBN');
                        peopleTaskStatus.show();
                        peopleTaskFailed.show();
                        $('#people-error-message').text(task.error_message || 'Nieznany błąd');
                        $('#people-error-time').text(formatDate(task.completed_at));
                    }
                } else {
                    peopleDownloadBtn.removeClass('disabled').html('<i class="fi-torsos-all"></i> Pobierz osoby z PBN');
                    peopleTaskStatus.show();
                    peopleTaskNoData.show();
                }
            }

            function formatDate(isoString) {
                if (!isoString) return '';
                var date = new Date(isoString);
                return date.toLocaleString('pl-PL');
            }
        });
    </script>
{% endblock %}
