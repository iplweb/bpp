{% extends "base.html" %}
{% load static %}
{% load pbn_import_tags %}

{% block extratitle %}Szczegóły importu #{{ session.id }}{% endblock %}

{% block extrahead %}
<link rel="stylesheet"
      href="{% static 'pbn_import/css/pbn_import.css' %}">

<script>
document.addEventListener('click', function(e) {
    var btn = e.target.closest('[data-action="toggle-details"]');
    if (btn) {
        e.preventDefault();
        var details = btn.parentElement.querySelector('.pbn-import__log-message-expanded');
        if (details.style.display === 'none') {
            details.style.display = 'block';
            btn.textContent = 'Ukryj szczegóły';
        } else {
            details.style.display = 'none';
            btn.textContent = 'Pokaż szczegóły';
        }
    }
});
</script>
{% endblock %}

{% block content %}
<div class="pbn-import__session-detail">
    <!-- Back button -->
    <div class="pbn-import__back-button">
        <a href="{% url 'pbn_import:dashboard' %}" class="button secondary">
            <span class="fi-arrow-left"></span> Powrót do listy
        </a>
    </div>

    <!-- Session Header -->
    <div class="pbn-import__session-header">
        <h1>Import #{{ session.id }}</h1>
        <div class="pbn-import__session-meta">
            <div class="pbn-import__meta-item">
                <div class="pbn-import__meta-label">Status</div>
                <div class="pbn-import__meta-value">
                    <span class="pbn-import__status-badge pbn-import__status-badge--{{ session.status }}">
                        {{ session.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="pbn-import__meta-item">
                <div class="pbn-import__meta-label">Rozpoczęto</div>
                <div class="pbn-import__meta-value">{{ session.started_at|date:"d.m.Y H:i:s" }}</div>
            </div>
            <div class="pbn-import__meta-item">
                <div class="pbn-import__meta-label">Zakończono</div>
                <div class="pbn-import__meta-value">
                    {% if session.completed_at %}
                        {{ session.completed_at|date:"d.m.Y H:i:s" }}
                    {% else %}
                        W trakcie
                    {% endif %}
                </div>
            </div>
            <div class="pbn-import__meta-item">
                <div class="pbn-import__meta-label">Czas trwania</div>
                <div class="pbn-import__meta-value">
                    {% if duration %}
                        {{ duration.total_seconds|floatformat:0 }}s
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="pbn-import__meta-item">
                <div class="pbn-import__meta-label">Użytkownik</div>
                <div class="pbn-import__meta-value">{{ session.user.get_full_name|default:session.user.username }}</div>
            </div>
            <div class="pbn-import__meta-item">
                <div class="pbn-import__meta-label">Postęp</div>
                <div class="pbn-import__meta-value">{{ session.completed_steps }}/{{ session.total_steps }}</div>
            </div>
        </div>
    </div>

    <!-- Progress Bar Section -->
    {% if session.status == 'running' %}
    <div class="pbn-import__progress-section"
         id="session-progress-{{ session.id }}"
         hx-get="{% url 'pbn_import:progress' session.id %}"
         hx-trigger="load, every 5s"
         hx-swap="innerHTML">
        {% include "pbn_import/components/progress_compact.html" with session=session hide_details_button=True %}
    </div>
    {% elif session.total_steps > 0 %}
    <!-- Static progress bar for completed/failed sessions -->
    <div class="pbn-import__progress-section">
        <div class="import-progress-compact">
            <div class="progress-main">
                <div class="pbn-import__progress-info">
                    <span class="progress-step">{{ session.current_step|default:"Import zakończony" }}</span>
                    <span class="pbn-import__progress-percent">{{ session.overall_progress }}%</span>
                </div>
                <div class="pbn-import__progress-bar">
                    <div class="pbn-import__progress-fill pbn-import__progress-fill--{{ session.status }}" style="width: {{ session.overall_progress }}%;"></div>
                </div>
                <div class="pbn-import__progress-meta">
                    <span>Kroki: {{ session.completed_steps }}/{{ session.total_steps }}</span>
                    <span class="pbn-import__status-label pbn-import__status-label--{{ session.status }}">{{ session.get_status_display }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error Section (if failed) -->
    {% if session.status == 'failed' and session.error_message %}
    <div class="pbn-import__detail-section">
        <h2 class="pbn-import__section-title">
            <span class="fi-alert"></span>
            Błąd importu
        </h2>
        <div class="pbn-import__error-box">
            <div class="pbn-import__error-message">{{ session.error_message }}</div>
            {% if session.error_traceback %}
            <details>
                <summary class="pbn-import__error-summary">
                    Pokaż szczegóły techniczne
                </summary>
                <div class="pbn-import__error-traceback">{{ session.error_traceback }}</div>
            </details>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Tabs for different sections -->
    <ul class="tabs" data-tabs id="session-tabs">
        <li class="tabs-title is-active"><a href="#logs-panel" aria-selected="true">Logi</a></li>
        <li class="tabs-title"><a href="#errors-panel">Błędy i ostrzeżenia</a></li>
        <li class="tabs-title"><a href="#config-panel">Konfiguracja</a></li>
        {% if statistics %}
        <li class="tabs-title"><a href="#stats-panel">Statystyki</a></li>
        {% endif %}
    </ul>

    <div class="tabs-content" data-tabs-content="session-tabs">
        <!-- All Logs Panel -->
        <div class="tabs-panel is-active" id="logs-panel">
            <div class="pbn-import__detail-section">
                <h2 class="pbn-import__section-title">
                    <span class="fi-list"></span>
                    Wszystkie logi ({{ logs|length }})
                </h2>
                <div class="pbn-import__log-container">
                    {% for log in logs %}
                    <div class="pbn-import__log-entry">
                        <span class="pbn-import__log-timestamp">{{ log.timestamp|date:"d.m.Y H:i:s" }}</span>
                        <span class="pbn-import__log-level pbn-import__log-level--{{ log.level }}">{{ log.level }}</span>
                        <span class="pbn-import__log-step">{{ log.step }}</span>
                        <span class="pbn-import__log-message">
                            {% if log|is_error_log and log.details %}
                                {{ log.message|truncate_message:150 }}
                                <button type="button"
                                        class="pbn-import__error-details-toggle"
                                        data-action="toggle-details">Pokaż szczegóły</button>
                                <div class="pbn-import__log-message-expanded">
                                    <strong>Pełna wiadomość:</strong>
                                    <pre class="pbn-import__log-pre">{{ log.message }}</pre>
                                    {% if log.details %}
                                        <strong>Szczegóły techniczne:</strong>
                                        {% if log.details.traceback %}
                                            <pre class="pbn-import__json-display">{{ log.details.traceback }}</pre>
                                        {% else %}
                                            {{ log.details|format_json }}
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% else %}
                                {{ log.message }}
                            {% endif %}
                        </span>
                    </div>
                    {% empty %}
                    <p class="text-muted">Brak logów</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Errors Panel -->
        <div class="tabs-panel" id="errors-panel">
            <div class="pbn-import__detail-section">
                <h2 class="pbn-import__section-title">
                    <span class="fi-alert"></span>
                    Błędy i ostrzeżenia ({{ error_logs|length }})
                </h2>
                {% if error_logs %}
                <div class="pbn-import__log-container">
                    {% for log in error_logs %}
                    <div class="pbn-import__log-entry">
                        <span class="pbn-import__log-timestamp">{{ log.timestamp|date:"d.m.Y H:i:s" }}</span>
                        <span class="pbn-import__log-level pbn-import__log-level--{{ log.level }}">{{ log.level }}</span>
                        <span class="pbn-import__log-step">{{ log.step }}</span>
                        <span class="pbn-import__log-message">
                            {{ log.message|truncate_message:150 }}
                            {% if log.details %}
                            <details class="pbn-import__log-details">
                                <summary class="pbn-import__log-details-summary">
                                    <span class="fi-magnifying-glass"></span> Pokaż szczegóły
                                </summary>
                                <div class="pbn-import__log-details-content">
                                    <strong>Pełna wiadomość:</strong>
                                    <pre class="pbn-import__log-pre--styled">{{ log.message }}</pre>
                                    <strong>Szczegóły techniczne:</strong>
                                    {% if log.details.traceback %}
                                        <pre class="pbn-import__json-display">{{ log.details.traceback }}</pre>
                                    {% else %}
                                        {{ log.details|format_json }}
                                    {% endif %}
                                </div>
                            </details>
                            {% elif log.message|length > 150 %}
                            <details class="pbn-import__log-details">
                                <summary class="pbn-import__log-details-summary">
                                    <span class="fi-magnifying-glass"></span> Pokaż pełną wiadomość
                                </summary>
                                <pre class="pbn-import__log-pre--styled-spaced">{{ log.message }}</pre>
                            </details>
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">
                    {% if session.status == 'completed' %}
                        Brak błędów i ostrzeżeń - import przebiegł pomyślnie!
                    {% elif session.status == 'running' %}
                        Brak błędów i ostrzeżeń - import na ten moment przebiega pomyślnie.
                    {% elif session.status == 'pending' %}
                        Import jeszcze się nie rozpoczął.
                    {% elif session.status == 'cancelled' %}
                        Import został anulowany bez błędów.
                    {% else %}
                        Brak błędów i ostrzeżeń.
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Configuration Panel -->
        <div class="tabs-panel" id="config-panel">
            <div class="pbn-import__detail-section">
                <h2 class="pbn-import__section-title">
                    <span class="fi-widget"></span>
                    Konfiguracja importu
                </h2>
                <table class="pbn-import__config-table">
                    {% for key, value in config.items %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>
                            {% if value == True %}
                                <span class="pbn-import__config-value pbn-import__config-value--true">Tak</span>
                            {% elif value == False %}
                                <span class="pbn-import__config-value pbn-import__config-value--false">Nie</span>
                            {% else %}
                                <span class="pbn-import__config-value">{{ value }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-muted">Brak konfiguracji</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <!-- Statistics Panel -->
        {% if statistics %}
        <div class="tabs-panel" id="stats-panel">
            <div class="pbn-import__detail-section">
                <h2 class="pbn-import__section-title">
                    <span class="fi-graph-bar"></span>
                    Statystyki importu
                </h2>
                <div class="pbn-import__stats-grid">
                    <div class="pbn-import__stat-card">
                        <div class="pbn-import__stat-value">{{ statistics.authors_imported|default:"0" }}</div>
                        <div class="pbn-import__stat-label">Autorów</div>
                    </div>
                    <div class="pbn-import__stat-card">
                        <div class="pbn-import__stat-value">{{ statistics.publications_imported|default:"0" }}</div>
                        <div class="pbn-import__stat-label">Publikacji</div>
                    </div>
                    <div class="pbn-import__stat-card">
                        <div class="pbn-import__stat-value">{{ statistics.journals_imported|default:"0" }}</div>
                        <div class="pbn-import__stat-label">Czasopism</div>
                    </div>
                    <div class="pbn-import__stat-card">
                        <div class="pbn-import__stat-value">{{ statistics.publishers_imported|default:"0" }}</div>
                        <div class="pbn-import__stat-label">Wydawców</div>
                    </div>
                    <div class="pbn-import__stat-card">
                        <div class="pbn-import__stat-value">{{ statistics.conferences_imported|default:"0" }}</div>
                        <div class="pbn-import__stat-label">Konferencji</div>
                    </div>
                    <div class="pbn-import__stat-card">
                        <div class="pbn-import__stat-value">{{ statistics.statements_imported|default:"0" }}</div>
                        <div class="pbn-import__stat-label">Oświadczeń</div>
                    </div>
                </div>

                {% if statistics.authors_failed or statistics.publications_failed %}
                <div class="pbn-import__import-errors">
                    <h4 class="pbn-import__import-errors-title">Błędy importu:</h4>
                    {% if statistics.authors_failed %}
                    <p>Nieudane importy autorów: {{ statistics.authors_failed }}</p>
                    {% endif %}
                    {% if statistics.publications_failed %}
                    <p>Nieudane importy publikacji: {{ statistics.publications_failed }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script>
$(document).ready(function() {
    // Initialize Foundation tabs
    $(document).foundation();
});
</script>
{% endblock %}
