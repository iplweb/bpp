{% extends "base.html" %}
{% load static %}
{% load pbn_import_tags %}

{% block extratitle %}Import z PBN{% endblock %}

{% block extrahead %}
<link rel="stylesheet"
      href="{% static 'pbn_import/css/pbn_import.css' %}">
{% endblock %}

{% block content %}
<div class="pbn-import__dashboard">
    {% if not pbn_configured %}
    <div class="callout alert">
        <h5><span class="fi-alert"></span> PBN nie jest skonfigurowane</h5>
        <p>Przed rozpoczęciem importu należy skonfigurować integrację z PBN w ustawieniach uczelni.</p>
    </div>
    {% endif %}

    <!-- Active Import Section -->
    {% if active_session %}
    <div class="pbn-import__active-card">
        <h3 class="pbn-import__active-title"><span class="fi-play"></span> Aktywny Import #{{ active_session.id }}</h3>
        <div id="active-import-progress"
             hx-get="{% url 'pbn_import:progress' active_session.id %}"
             hx-trigger="load, every 5s"
             hx-swap="innerHTML">
            {% include "pbn_import/components/progress_compact.html" with session=active_session %}
        </div>
    </div>
    {% endif %}

    <!-- Import Presets -->
    {% if not active_session and pbn_configured %}
    <h2><span class="fi-list"></span> Wybierz typ importu</h2>
    <div class="pbn-import__preset-cards" id="preset-cards">
        <!-- Loaded via JavaScript -->
    </div>
    {% endif %}

    <!-- Session History -->
    <div class="pbn-import__session-history">
        <h2><span class="fi-clock"></span> Historia importów</h2>
        <div id="sessions-list">
            {% for session in recent_sessions %}
            <div class="pbn-import__session-item-wrapper">
                <a href="{% url 'pbn_import:session_detail' session.id %}" class="pbn-import__session-item">
                    <div>
                        <strong>Import #{{ session.id }}</strong>
                        <span class="text-muted">{{ session.started_at|date:"d.m.Y H:i" }}</span>
                        {% if session.error_message %}
                        <div class="pbn-import__error-preview">
                            <span class="fi-alert"></span>
                            <span class="error-preview">{{ session.error_message|truncatewords:10 }}</span>
                            {% if session.error_message|length > 100 %}
                            <button type="button" class="pbn-import__error-toggle" data-action="toggle-error">
                                Pokaż więcej
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="pbn-import__session-meta-wrapper">
                        <span class="pbn-import__session-status pbn-import__session-status--{{ session.status }}">
                            {{ session.get_status_display }}
                        </span>
                        <span class="fi-arrow-right pbn-import__session-arrow"></span>
                    </div>
                </a>
                {% if session.error_message and session.error_message|length > 100 %}
                <div class="pbn-import__error-details">
                    <strong class="pbn-import__error-label">Pełny komunikat błędu:</strong>
                    {% if session.error_message|is_json %}
                        {{ session.error_message|format_json }}
                    {% else %}
                        <pre class="pbn-import__error-message-pre">{{ session.error_message }}</pre>
                    {% endif %}
                    {% if session.error_traceback and user.is_superuser %}
                    <details class="pbn-import__details-wrapper">
                        <summary class="pbn-import__details-summary">
                            <span class="fi-shield"></span>
                            Pokaż szczegóły (superuser)
                        </summary>
                        <pre class="pbn-import__error-traceback-pre">{{ session.error_traceback }}</pre>
                    </details>
                    {% elif session.error_traceback %}
                    <div class="pbn-import__error-restricted-notice">
                        Szczegóły dostępne tylko dla superużytkowników
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-muted text-center">Brak historii importów</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Import Configuration Modal -->
<div class="reveal" id="import-config-modal" data-reveal>
    <h2><span class="fi-widget"></span> Konfiguracja importu</h2>

    <form method="post" action="{% url 'pbn_import:start' %}" id="import-config-form">
        {% csrf_token %}

        <div class="pbn-import__modal-content">
            <h4>Dane do importu</h4>

            <label>
                <input type="checkbox" name="initial" checked>
                <span class="fi-flag"></span> Konfiguracja początkowa
            </label>

            <label>
                <input type="checkbox" name="zrodla" checked>
                <span class="fi-book"></span> Źródła (czasopisma)
            </label>

            <label>
                <input type="checkbox" name="wydawcy" checked>
                <span class="fi-page-multiple"></span> Wydawcy
            </label>

            <label>
                <input type="checkbox" name="konferencje" checked>
                <span class="fi-calendar"></span> Konferencje
            </label>

            <label>
                <input type="checkbox" name="autorzy" checked>
                <span class="fi-torsos-all"></span> Autorzy
            </label>

            <label>
                <input type="checkbox" name="publikacje" checked>
                <span class="fi-page-copy"></span> Publikacje
            </label>

            <label>
                <input type="checkbox" name="integracja" checked>
                <span class="fi-link"></span> Integracja danych
            </label>

            <label>
                <input type="checkbox" name="oswiadczenia" checked>
                <span class="fi-clipboard-pencil"></span> Oświadczenia
            </label>

            <label>
                <input type="checkbox" name="oplaty" checked>
                <span class="fi-dollar"></span> Opłaty
            </label>

            <!-- Hidden field - never show delete existing option -->
            <input type="hidden" name="delete_existing" value="">

            {% if uzywaj_wydzialow %}
            <label class="pbn-import__modal-field--spaced">
                Domyślny wydział:
                <input type="text" name="wydzial_domyslny" value="Wydział Domyślny">
            </label>
            {% else %}
            <!-- Hidden field with default value when wydziały are not used -->
            <input type="hidden" name="wydzial_domyslny" value="Wydział Domyślny">
            {% endif %}

            <div class="callout primary pbn-import__modal-field--spaced">
                <h5><span class="fi-info"></span> Wskazówka</h5>
                <p>Import może potrwać od kilku minut do kilku godzin w zależności od ilości danych.</p>
                <p>Możesz bezpiecznie zamknąć tę stronę - import będzie kontynuowany w tle.</p>
            </div>
        </div>

        <div class="button-group align-right">
            <button type="button" class="button secondary" data-close>
                <span class="fi-x"></span> Anuluj
            </button>
            <button type="submit" class="button primary">
                <span class="fi-check"></span> Rozpocznij import
            </button>
        </div>
    </form>

    <button class="close-button" data-close aria-label="Zamknij" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<!-- Removed rocket per user request -->

<script>
// Store selected preset globally
let selectedPreset = null;

// Load presets
document.addEventListener('DOMContentLoaded', function() {
    // Re-initialize Foundation after dynamic content
    setTimeout(() => {
        $(document).foundation();
    }, 100);

    fetch('{% url "pbn_import:presets" %}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('preset-cards');
            if (!container) return;

            // Clear existing content
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            data.presets.forEach(preset => {
                const card = document.createElement('div');
                card.className = 'pbn-import__preset-card';
                card.dataset.presetId = preset.id;

                const iconDiv = document.createElement('div');
                iconDiv.className = 'pbn-import__preset-icon';
                const iconSpan = document.createElement('span');
                iconSpan.className = preset.icon;
                iconDiv.appendChild(iconSpan);

                const titleDiv = document.createElement('div');
                titleDiv.className = 'pbn-import__preset-title';
                titleDiv.textContent = preset.name;

                const descDiv = document.createElement('div');
                descDiv.className = 'pbn-import__preset-description';
                descDiv.textContent = preset.description;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'pbn-import__preset-actions';
                const btn = document.createElement('button');
                btn.className = 'button small primary select-preset-btn';
                btn.textContent = 'Wybierz';
                btn.dataset.preset = JSON.stringify(preset);
                actionsDiv.appendChild(btn);

                card.appendChild(iconDiv);
                card.appendChild(titleDiv);
                card.appendChild(descDiv);
                card.appendChild(actionsDiv);

                container.appendChild(card);
            });

            // Add click handlers to buttons
            container.querySelectorAll('.select-preset-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();

                    // Parse preset data
                    const preset = JSON.parse(this.dataset.preset);
                    selectedPreset = preset;

                    // Remove previous selection
                    container.querySelectorAll('.pbn-import__preset-card').forEach(c =>
                        c.classList.remove('pbn-import__preset-card--selected')
                    );

                    // Add selection to parent card
                    this.closest('.pbn-import__preset-card').classList.add('pbn-import__preset-card--selected');

                    // Apply preset configuration
                    if (preset && preset.config) {
                        applyPresetConfig(preset.config);
                    }

                    // Auto-open modal immediately
                    setTimeout(() => {
                        $('#import-config-modal').foundation('open');
                    }, 300);
                });
            });

            // Also allow clicking the card itself
            container.querySelectorAll('.pbn-import__preset-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // If not clicking the button, trigger button click
                    if (!e.target.closest('.select-preset-btn')) {
                        const btn = this.querySelector('.select-preset-btn');
                        if (btn) btn.click();
                    }
                });
            });
        })
        .catch(error => {
            console.error('Error loading presets:', error);
            const container = document.getElementById('preset-cards');
            if (container) {
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                const errorDiv = document.createElement('div');
                errorDiv.className = 'callout alert';
                errorDiv.textContent = 'Błąd ładowania presetów';
                container.appendChild(errorDiv);
            }
        });
});

function applyPresetConfig(config) {
    const form = document.getElementById('import-config-form');
    if (!form) {
        console.error('Form not found');
        return;
    }

    // First, set all checkboxes to checked (default state)
    form.querySelectorAll('input[type="checkbox"][name]').forEach(cb => {
        cb.checked = true; // Default all to checked
    });

    // Now apply the preset configuration
    Object.keys(config).forEach(key => {
        if (key.startsWith('disable_')) {
            // Extract the field name from disable_xxx
            const fieldName = key.replace('disable_', '');
            const input = form.querySelector(`[name="${fieldName}"]`);
            if (input && input.type === 'checkbox') {
                // If disable_xxx is true, uncheck the checkbox
                input.checked = !config[key];
            }
        } else if (key === 'delete_existing') {
            const input = form.querySelector('[name="delete_existing"]');
            if (input) input.checked = config[key];
        } else if (key === 'wydzial_domyslny') {
            const input = form.querySelector('[name="wydzial_domyslny"]');
            if (input) input.value = config[key];
        }
    });

    console.log('Preset applied:', config);
}

// Removed animations per user request

function toggleError(button) {
    var wrapper = button.closest('.pbn-import__session-item-wrapper');
    var errorDetails = wrapper.querySelector('.pbn-import__error-details');

    if (errorDetails.style.display === 'none' || errorDetails.style.display === '') {
        errorDetails.style.display = 'block';
        button.textContent = 'Ukryj';
    } else {
        errorDetails.style.display = 'none';
        button.textContent = 'Pokaż więcej';
    }

    return false;
}

// WebSocket connection for active import
{% if active_session %}
const ws = new WebSocket(
    'ws://' + window.location.host +
    '/ws/pbn-import/session/{{ active_session.id }}/'
);

ws.onmessage = function(e) {
    const data = JSON.parse(e.data);

    switch(data.type) {
        case 'progress_update':
            updateProgressDisplay(data);
            break;
        case 'log_entry':
            addLogEntry(data.log);
            break;
        case 'completion':
            // Simple notification, no confetti
            console.log('Import completed');
            break;
    }
};

ws.onclose = function(e) {
    console.log('WebSocket connection closed');
};

function updateProgressDisplay(data) {
    // Update progress bar and status
    document.title = 'Import ' + data.progress + '% - BPP';
}

function showMotivationalToast(message, icon) {
    // Show motivational message as toast notification
    const toast = document.createElement('div');
    toast.className = 'callout success';
    toast.textContent = icon + ' ' + message;
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.left = '20px';
    toast.style.zIndex = '10000';
    toast.style.animation = 'slideIn 0.5s';

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.5s';
        setTimeout(() => toast.remove(), 500);
    }, 5000);
}
{% endif %}
</script>
{% endblock %}
