{% extends "base.html" %}
{% load static %}
{% load pbn_import_tags %}

{% block extratitle %}Import z PBN{% endblock %}

{% block extrahead %}
<style>
    .import-dashboard {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }


    .preset-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .preset-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .preset-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        border-color: #667eea;
    }

    .preset-card.selected {
        border-color: #764ba2;
        background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
    }

    .preset-icon {
        font-size: 2rem;
        color: #667eea;
        margin-bottom: 10px;
    }

    .preset-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .preset-description {
        color: #666;
        font-size: 0.9rem;
    }

    .active-import-card {
        background: linear-gradient(135deg, #e0e7ff 0%, #f0f4ff 100%);
        border: 1px solid #c7d2fe;
        color: #4338ca;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        position: relative;
    }

    .session-history {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .session-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background 0.3s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }

    .session-item:hover {
        background: #f8f9fa;
        transform: translateX(5px);
    }

    a.session-item {
        display: flex;
        color: inherit;
        text-decoration: none;
    }

    .session-item-wrapper {
        border-bottom: 1px solid #eee;
    }

    .session-item-wrapper:last-child {
        border-bottom: none;
    }

    .error-details {
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
        }
        to {
            opacity: 1;
            max-height: 500px;
        }
    }

    .session-status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
    }

    .status-completed { background: #d4edda; color: #155724; }
    .status-running { background: #cce5ff; color: #004085; }
    .status-failed { background: #f8d7da; color: #721c24; }
    .status-cancelled { background: #e2e3e5; color: #383d41; }

    /* Removed floating elements */
</style>
{% endblock %}

{% block content %}
<div class="import-dashboard">
    {% if not pbn_configured %}
    <div class="callout alert">
        <h5><span class="fi-alert"></span> PBN nie jest skonfigurowane</h5>
        <p>Przed rozpoczęciem importu należy skonfigurować integrację z PBN w ustawieniach uczelni.</p>
    </div>
    {% endif %}

    <!-- Active Import Section -->
    {% if active_session %}
    <div class="active-import-card">
        <h3 style="margin: 0 0 15px 0;"><span class="fi-play"></span> Aktywny Import #{{ active_session.id }}</h3>
        <div id="active-import-progress"
             hx-get="{% url 'pbn_import:progress' active_session.id %}"
             hx-trigger="load, every 5s"
             hx-swap="innerHTML">
            {% include "pbn_import/components/progress_compact.html" with session=active_session %}
        </div>
    </div>
    {% endif %}

    <!-- Import Presets -->
    {% if not active_session and pbn_configured %}
    <h2><span class="fi-list"></span> Wybierz typ importu</h2>
    <div class="preset-cards" id="preset-cards">
        <!-- Loaded via JavaScript -->
    </div>
    {% endif %}

    <!-- Session History -->
    <div class="session-history">
        <h2><span class="fi-clock"></span> Historia importów</h2>
        <div id="sessions-list">
            {% for session in recent_sessions %}
            <div class="session-item-wrapper">
                <a href="{% url 'pbn_import:session_detail' session.id %}" class="session-item">
                    <div>
                        <strong>Import #{{ session.id }}</strong>
                        <span class="text-muted">{{ session.started_at|date:"d.m.Y H:i" }}</span>
                        {% if session.error_message %}
                        <div style="font-size: 0.85rem; color: #e53e3e; margin-top: 5px;">
                            <span class="fi-alert"></span>
                            <span class="error-preview">{{ session.error_message|truncatewords:10 }}</span>
                            {% if session.error_message|length > 100 %}
                            <button type="button" class="error-toggle" onclick="event.preventDefault(); event.stopPropagation(); toggleError(this);" style="color: #667eea; background: none; border: none; cursor: pointer; font-size: 0.8rem; text-decoration: underline;">
                                Pokaż więcej
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="session-status status-{{ session.status }}">
                            {{ session.get_status_display }}
                        </span>
                        <span class="fi-arrow-right" style="color: #718096;"></span>
                    </div>
                </a>
                {% if session.error_message and session.error_message|length > 100 %}
                <div class="error-details" style="display: none; padding: 15px; background: #fff5f5; border-top: 1px solid #feb2b2; font-size: 0.9rem;">
                    <strong style="color: #c53030;">Pełny komunikat błędu:</strong>
                    {% if session.error_message|is_json %}
                        {{ session.error_message|format_json }}
                    {% else %}
                        <pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 10px; color: #742a2a;">{{ session.error_message }}</pre>
                    {% endif %}
                    {% if session.error_traceback %}
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #667eea;">Pokaż szczegóły techniczne</summary>
                        <pre style="background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.8rem; max-height: 300px; overflow-y: auto;">{{ session.error_traceback }}</pre>
                    </details>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-muted text-center">Brak historii importów</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Import Configuration Modal -->
<div class="reveal" id="import-config-modal" data-reveal>
    <h2><span class="fi-widget"></span> Konfiguracja importu</h2>

    <form method="post" action="{% url 'pbn_import:start' %}" id="import-config-form">
        {% csrf_token %}

        <div style="max-width: 500px; margin: 0 auto;">
            <h4>Dane do importu</h4>

            <label>
                <input type="checkbox" name="initial" checked>
                <span class="fi-flag"></span> Konfiguracja początkowa
            </label>

            <label>
                <input type="checkbox" name="zrodla" checked>
                <span class="fi-book"></span> Źródła (czasopisma)
            </label>

            <label>
                <input type="checkbox" name="wydawcy" checked>
                <span class="fi-page-multiple"></span> Wydawcy
            </label>

            <label>
                <input type="checkbox" name="konferencje" checked>
                <span class="fi-calendar"></span> Konferencje
            </label>

            <label>
                <input type="checkbox" name="autorzy" checked>
                <span class="fi-torsos-all"></span> Autorzy
            </label>

            <label>
                <input type="checkbox" name="publikacje" checked>
                <span class="fi-page-copy"></span> Publikacje
            </label>

            <label>
                <input type="checkbox" name="oswiadczenia" checked>
                <span class="fi-clipboard-pencil"></span> Oświadczenia
            </label>

            <label>
                <input type="checkbox" name="oplaty" checked>
                <span class="fi-dollar"></span> Opłaty
            </label>

            <!-- Hidden field - never show delete existing option -->
            <input type="hidden" name="delete_existing" value="">

            {% if uzywaj_wydzialow %}
            <label style="margin-top: 20px;">
                Domyślny wydział:
                <input type="text" name="wydzial_domyslny" value="Wydział Domyślny">
            </label>
            {% else %}
            <!-- Hidden field with default value when wydziały are not used -->
            <input type="hidden" name="wydzial_domyslny" value="Wydział Domyślny">
            {% endif %}

            <div class="callout primary" style="margin-top: 20px;">
                <h5><span class="fi-info"></span> Wskazówka</h5>
                <p>Import może potrwać od kilku minut do kilku godzin w zależności od ilości danych.</p>
                <p>Możesz bezpiecznie zamknąć tę stronę - import będzie kontynuowany w tle.</p>
            </div>
        </div>

        <div class="button-group align-right">
            <button type="button" class="button secondary" data-close>
                <span class="fi-x"></span> Anuluj
            </button>
            <button type="submit" class="button primary">
                <span class="fi-check"></span> Rozpocznij import
            </button>
        </div>
    </form>

    <button class="close-button" data-close aria-label="Zamknij" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<!-- Removed rocket per user request -->

<script>
// Store selected preset globally
let selectedPreset = null;

// Load presets
document.addEventListener('DOMContentLoaded', function() {
    // Re-initialize Foundation after dynamic content
    setTimeout(() => {
        $(document).foundation();
    }, 100);

    fetch('{% url "pbn_import:presets" %}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('preset-cards');
            if (!container) return;

            container.innerHTML = data.presets.map(preset => `
                <div class="preset-card" data-preset-id="${preset.id}" style="cursor: pointer;">
                    <div class="preset-icon">
                        <span class="${preset.icon}"></span>
                    </div>
                    <div class="preset-title">${preset.name}</div>
                    <div class="preset-description">${preset.description}</div>
                    <div style="margin-top: 15px;">
                        <button class="button small primary select-preset-btn" data-preset='${JSON.stringify(preset)}'>
                            Wybierz
                        </button>
                    </div>
                </div>
            `).join('');

            // Add click handlers to buttons
            container.querySelectorAll('.select-preset-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();

                    // Parse preset data
                    const preset = JSON.parse(this.dataset.preset);
                    selectedPreset = preset;

                    // Remove previous selection
                    container.querySelectorAll('.preset-card').forEach(c =>
                        c.classList.remove('selected')
                    );

                    // Add selection to parent card
                    this.closest('.preset-card').classList.add('selected');

                    // Apply preset configuration
                    if (preset && preset.config) {
                        applyPresetConfig(preset.config);
                    }

                    // Auto-open modal immediately
                    setTimeout(() => {
                        $('#import-config-modal').foundation('open');
                    }, 300);
                });
            });

            // Also allow clicking the card itself
            container.querySelectorAll('.preset-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // If not clicking the button, trigger button click
                    if (!e.target.closest('.select-preset-btn')) {
                        const btn = this.querySelector('.select-preset-btn');
                        if (btn) btn.click();
                    }
                });
            });
        })
        .catch(error => {
            console.error('Error loading presets:', error);
            const container = document.getElementById('preset-cards');
            if (container) {
                container.innerHTML = '<div class="callout alert">Błąd ładowania presetów</div>';
            }
        });
});

function applyPresetConfig(config) {
    const form = document.getElementById('import-config-form');
    if (!form) {
        console.error('Form not found');
        return;
    }

    // First, set all checkboxes to checked (default state)
    form.querySelectorAll('input[type="checkbox"][name]').forEach(cb => {
        cb.checked = true; // Default all to checked
    });

    // Now apply the preset configuration
    Object.keys(config).forEach(key => {
        if (key.startsWith('disable_')) {
            // Extract the field name from disable_xxx
            const fieldName = key.replace('disable_', '');
            const input = form.querySelector(`[name="${fieldName}"]`);
            if (input && input.type === 'checkbox') {
                // If disable_xxx is true, uncheck the checkbox
                input.checked = !config[key];
            }
        } else if (key === 'delete_existing') {
            const input = form.querySelector('[name="delete_existing"]');
            if (input) input.checked = config[key];
        } else if (key === 'wydzial_domyslny') {
            const input = form.querySelector('[name="wydzial_domyslny"]');
            if (input) input.value = config[key];
        }
    });

    console.log('Preset applied:', config);
}

// Removed animations per user request

function toggleError(button) {
    var wrapper = button.closest('.session-item-wrapper');
    var errorDetails = wrapper.querySelector('.error-details');

    if (errorDetails.style.display === 'none' || errorDetails.style.display === '') {
        errorDetails.style.display = 'block';
        button.textContent = 'Ukryj';
    } else {
        errorDetails.style.display = 'none';
        button.textContent = 'Pokaż więcej';
    }

    return false;
}

// WebSocket connection for active import
{% if active_session %}
const ws = new WebSocket(
    'ws://' + window.location.host +
    '/ws/pbn-import/session/{{ active_session.id }}/'
);

ws.onmessage = function(e) {
    const data = JSON.parse(e.data);

    switch(data.type) {
        case 'progress_update':
            updateProgressDisplay(data);
            break;
        case 'log_entry':
            addLogEntry(data.log);
            break;
        case 'completion':
            // Simple notification, no confetti
            console.log('Import completed');
            break;
    }
};

ws.onclose = function(e) {
    console.log('WebSocket connection closed');
};

function updateProgressDisplay(data) {
    // Update progress bar and status
    document.title = `Import ${data.progress}% - BPP`;
}

function showMotivationalToast(message, icon) {
    // Show motivational message as toast notification
    const toast = document.createElement('div');
    toast.className = 'callout success';
    toast.innerHTML = `${icon} ${message}`;
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.left = '20px';
    toast.style.zIndex = '10000';
    toast.style.animation = 'slideIn 0.5s';

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.5s';
        setTimeout(() => toast.remove(), 500);
    }, 5000);
}
{% endif %}
</script>
{% endblock %}
