{% extends "base.html" %}
{% load static %}

{% block title %}Wysyłka oświadczeń do PBN - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li class="current">Wysyłka oświadczeń do PBN</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1><span class="fi-upload"></span> Wysyłka oświadczeń do PBN</h1>
        <p class="lead">Narzedzie do wysylania oswiadczen dyscyplin do Polskiej Bibliografii Naukowej (PBN)</p>
    </div>
</div>

<div class="row">
    <div class="large-12 columns">
        <div class="callout secondary">
            <h5><span class="fi-info"></span> Kryteria wyboru publikacji</h5>
            <ul>
                <li>publikacja musi byc wyslana do PBN (musi posiadac PBN UID)</li>
                <li>publikacja musi miec co najmniej jednego autora z przypisana dyscyplina,
                    dla ktorego zatrudniony=Tak i afiliuje=Tak</li>
                <li>rok publikacji musi miescic sie w podanym zakresie lat</li>
            </ul>
        </div>
    </div>
</div>

<div class="row">
    <div class="large-6 columns">
        <div class="panel callout">
            <h4><span class="fi-filter"></span> Parametry</h4>

            <form id="filter-form" method="get">
                <div class="row">
                    <div class="medium-6 columns">
                        <label for="rok_od">Rok od:</label>
                        <input type="number" id="rok_od" name="rok_od" value="{{ rok_od }}" min="2000" max="2100">
                    </div>
                    <div class="medium-6 columns">
                        <label for="rok_do">Rok do:</label>
                        <input type="number" id="rok_do" name="rok_do" value="{{ rok_do }}" min="2000" max="2100">
                    </div>
                </div>
                <div class="row">
                    <div class="medium-12 columns">
                        <label for="tytul">Tytul (zawiera):</label>
                        <input type="text" id="tytul" name="tytul" value="{{ tytul }}" placeholder="Wpisz fragment tytulu...">
                    </div>
                </div>
                <div class="row">
                    <div class="medium-12 columns">
                        <label>
                            <input type="checkbox" name="tylko_odpiete" value="true" {% if tylko_odpiete %}checked{% endif %}>
                            Tylko odpięte (oświadczenia bez przypiętych)
                        </label>
                    </div>
                </div>
                <button type="submit" class="button secondary small">
                    <span class="fi-refresh"></span> Odswiez
                </button>
            </form>

            <hr>

            <h5><span class="fi-list"></span> Publikacje do przetworzenia</h5>
            <table>
                <tr>
                    <td>Wydawnictwa ciagle:</td>
                    <td><strong>{{ ciagle_count }}</strong></td>
                </tr>
                <tr>
                    <td>Wydawnictwa zwarte:</td>
                    <td><strong>{{ zwarte_count }}</strong></td>
                </tr>
                <tr class="total">
                    <td><strong>Razem:</strong></td>
                    <td><strong>{{ total_count }}</strong></td>
                </tr>
            </table>

            {% if total_count > 0 %}
            <div class="button-group">
                <button id="start-fresh-btn" class="button success"
                        hx-post="{% url 'pbn_wysylka_oswiadczen:start' %}"
                        hx-vals='{"rok_od": "{{ rok_od }}", "rok_do": "{{ rok_do }}", "tytul": "{{ tytul }}", "tylko_odpiete": "{{ tylko_odpiete|yesno:"true,false" }}", "resume_mode": "false"}'
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        hx-swap="none"
                        hx-on:htmx:after-request="startStatusPolling()">
                    <span class="fi-play"></span> Wyślij wybrane rekordy
                </button>

                {% if can_resume %}
                <button id="resume-btn" class="button warning"
                        hx-post="{% url 'pbn_wysylka_oswiadczen:start' %}"
                        hx-vals='{"rok_od": "{{ rok_od }}", "rok_do": "{{ rok_do }}", "tytul": "{{ tytul }}", "tylko_odpiete": "{{ tylko_odpiete|yesno:"true,false" }}", "resume_mode": "true"}'
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        hx-swap="none"
                        hx-on:htmx:after-request="startStatusPolling()">
                    <span class="fi-fast-forward"></span> Kontynuuj
                </button>
                {% endif %}

                <a href="{% url 'pbn_wysylka_oswiadczen:export-excel' %}?rok_od={{ rok_od }}&rok_do={{ rok_do }}&tytul={{ tytul|urlencode }}&tylko_odpiete={{ tylko_odpiete|yesno:"true,false" }}" class="button secondary">
                    <span class="fi-page-export"></span> Eksportuj do Excel
                </a>
            </div>
            {% else %}
            <div class="callout secondary">
                <span class="fi-info"></span> Brak publikacji spelniajacych kryteria.
            </div>
            {% endif %}
        </div>
    </div>

    <div class="large-6 columns">
        <div id="task-status-panel">
            {% include "pbn_wysylka_oswiadczen/_task_status.html" %}
        </div>
    </div>
</div>

<div class="row">
    <div class="large-12 columns">
        <h4><span class="fi-page-multiple"></span> Podglad publikacji</h4>

        <div id="publication-list"
             hx-get="{% url 'pbn_wysylka_oswiadczen:publications' %}?rok_od={{ rok_od }}&rok_do={{ rok_do }}&tytul={{ tytul|urlencode }}&tylko_odpiete={{ tylko_odpiete|yesno:"true,false" }}"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="text-center">
                <span class="fi-refresh"></span> Ladowanie...
            </div>
        </div>
    </div>
</div>

<script>
var statusPollingInterval = null;

function refreshStatusPanel() {
    htmx.ajax('GET', '{% url "pbn_wysylka_oswiadczen:status-partial" %}', {target: '#task-status-panel', swap: 'innerHTML'});
}

function startStatusPolling() {
    // Refresh immediately
    refreshStatusPanel();

    // Clear any existing interval
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
    }

    // Start polling every 3 seconds
    statusPollingInterval = setInterval(function() {
        // Only poll if there's a running or pending task
        if (document.querySelector('.task-running')) {
            refreshStatusPanel();
        } else {
            // Task finished, stop polling
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }
    }, 3000);
}

// Also start polling on page load if there's an active task
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.task-running')) {
        startStatusPolling();
    }
});
</script>

{% endblock %}
