{% extends "base.html" %}
{% load pbn_komparator_tags static %}

{% block title %}
    Komparator źródeł BPP-PBN - Dyscypliny
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet"
          href="{% static 'pbn_komparator_zrodel/css/pbn_komparator_zrodel.css' %}">
{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="{% url 'pbn_komparator_zrodel:list' %}">Komparator źródeł BPP-PBN</a></li>
    <li class="current">Dyscypliny</li>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="medium-12 columns">
            <h1>Komparator źródeł BPP-PBN</h1>
            <p class="lead">
                Dyscypliny - porównanie dyscyplin źródeł w BPP z danymi PBN.
            </p>
        </div>
    </div>

    {# Nawigacja między widokami - przyciski 50%-50% #}
    <div class="row">
        <div class="medium-12 columns">
            <div class="button-group expanded pbn-komparator-zrodel__button-group">
                <a href="{% url 'pbn_komparator_zrodel:list' %}" class="button secondary">
                    <span class="fi-list"></span> Punkty
                </a>
                <a href="{% url 'pbn_komparator_zrodel:dyscypliny_list' %}" class="button">
                    <span class="fi-book"></span> Dyscypliny
                </a>
            </div>
        </div>
    </div>

    {% if brakujace_dyscypliny %}
    <div class="row">
        <div class="medium-12 columns">
            <div class="callout alert pbn-komparator-zrodel__alert-callout">
                <h4><span class="fi-alert"></span> Brakujące dyscypliny w BPP!</h4>
                <p>
                    W danych PBN znaleziono dyscypliny, które nie istnieją w bazie BPP.
                    Porównanie dyscyplin będzie niekompletne do czasu dodania tych dyscyplin do BPP.
                </p>
                <table class="pbn-komparator-zrodel__alert-table">
                    <thead>
                        <tr>
                            <th>Kod PBN</th>
                            <th>Kod BPP</th>
                            <th>Nazwa</th>
                            <th>Źródeł w PBN</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for kod_pbn, info in brakujace_dyscypliny.items %}
                        <tr>
                            <td>{{ kod_pbn }}</td>
                            <td>{{ info.kod_bpp }}</td>
                            <td>{{ info.nazwa }}</td>
                            <td>{{ info.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if not pbn_data_fresh %}
    <div class="row">
        <div class="medium-12 columns">
            <div class="callout alert">
                <h4><span class="fi-alert"></span> Dane PBN nieaktualne</h4>
                <p>{{ pbn_stale_message }}</p>
                {% if pbn_last_download %}
                <p><strong>Ostatnie pobranie danych źródeł PBN:</strong> {{ pbn_last_download|date:"Y-m-d H:i" }}</p>
                {% endif %}
                <a href="{% url 'pbn_downloader_app:main' %}" class="button">
                    <span class="fi-download"></span> Przejdź do pobierania danych PBN
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    {# Statystyki #}
    <div class="row">
        <div class="medium-12 columns">
            <div class="callout">
                <div class="row">
                    <div class="medium-4 columns">
                        <strong>Łącznie rekordów ({{ rok_od }}-{{ rok_do }}):</strong> {{ total_count }}
                    </div>
                    <div class="medium-4 columns">
                        <strong>Rozbieżności dyscyplin:</strong> {{ disciplines_count }}
                    </div>
                    <div class="medium-4 columns">
                        {% if meta.ostatnie_uruchomienie %}
                            <strong>Ostatnia aktualizacja:</strong><br>
                            {{ meta.ostatnie_uruchomienie|date:"Y-m-d H:i" }}
                        {% else %}
                            <strong>Jeszcze nie uruchomiono</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Filtry #}
    <div class="row">
        <div class="medium-12 columns">
            <form method="get" class="callout" id="filter-form">
                <div class="row">
                    <div class="medium-2 columns">
                        <label>Rok od:
                            <input type="number" name="rok_od" value="{{ rok_od }}" min="1900" max="2100"
                                   class="pbn-komparator-zrodel__year-input"
                                   data-submit-on-change>
                        </label>
                    </div>
                    <div class="medium-2 columns">
                        <label>Rok do:
                            <input type="number" name="rok_do" value="{{ rok_do }}" min="1900" max="2100"
                                   class="pbn-komparator-zrodel__year-input"
                                   data-submit-on-change>
                        </label>
                    </div>
                    <div class="medium-4 columns">
                        <label>Szukaj (nazwa/ISSN):
                            <input type="text" name="search" value="{{ search }}"
                                   placeholder="Szukaj w nazwie/ISSN...">
                        </label>
                    </div>
                    <div class="medium-4 columns">
                        <label class="pbn-komparator-zrodel__checkbox-label">
                            <input type="checkbox" name="tylko_rozbieznosci"
                                   {% if tylko_rozbieznosci %}checked{% endif %}
                                   data-submit-on-change>
                            Tylko rozbieżności
                        </label>
                        <label>
                            <input type="checkbox" name="bez_publikacji"
                                   {% if bez_publikacji %}checked{% endif %}
                                   data-submit-on-change>
                            Nie wyświetlaj źródeł bez publikacji
                        </label>
                        <label>
                            <input type="checkbox" name="bez_publikacji_2022_2025"
                                   {% if bez_publikacji_2022_2025 %}checked{% endif %}
                                   data-submit-on-change>
                            Nie wyświetlaj źródeł bez publikacji 2022-2025
                        </label>
                        <label>
                            <input type="checkbox" name="wyswietlaj_nazwy"
                                   {% if wyswietlaj_nazwy %}checked{% endif %}
                                   data-submit-on-change>
                            Wyświetlaj nazwy dyscyplin
                        </label>
                    </div>
                </div>
            </form>
            <div class="row">
                <div class="medium-12 columns pbn-komparator-zrodel__buttons-row">
                    <button type="submit" form="filter-form" class="button">
                        <span class="fi-filter"></span> Filtruj
                    </button>
                    <a href="{% url 'pbn_komparator_zrodel:dyscypliny_list' %}" class="button secondary">
                        <span class="fi-x"></span> Resetuj
                    </a>
                    <a href="{% url 'pbn_komparator_zrodel:przebuduj' %}" class="button alert">
                        <span class="fi-refresh"></span> Przebuduj rozbieżności
                    </a>
                    {% if page_obj.paginator.count > 0 %}
                    <a href="{% url 'pbn_komparator_zrodel:dyscypliny_eksport_xlsx' %}{% if filter_query_string %}?{{ filter_query_string }}{% endif %}"
                       class="button success">
                        <span class="fi-download"></span> Eksport XLSX
                    </a>
                    <form method="post"
                          action="{% url 'pbn_komparator_zrodel:aktualizuj_wszystkie_dyscypliny' %}{% if filter_query_string %}?{{ filter_query_string }}{% endif %}"
                          class="pbn-komparator-zrodel__inline-form">
                        {% csrf_token %}
                        <button type="submit" class="button warning"
                                data-confirm="Czy na pewno chcesz zaktualizować dyscypliny dla wszystkich {{ page_obj.paginator.count }} rekordów?">
                            <span class="fi-check"></span> Ustaw dyscypliny wg PBN
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="medium-12 columns">
            <p>
                Znaleziono: <strong>{{ page_obj.paginator.count }}</strong> rekordów
            </p>
        </div>
    </div>

    {% include "pagination/pagination_with_anchor.html" %}

    <table>
        <thead>
            <tr>
                <th>
                    {% if filter_query_string %}
                        <a href="?{{ filter_query_string }}&sort={% if current_sort == 'zrodlo__nazwa' %}-zrodlo__nazwa{% else %}zrodlo__nazwa{% endif %}">
                    {% else %}
                        <a href="?sort={% if current_sort == 'zrodlo__nazwa' %}-zrodlo__nazwa{% else %}zrodlo__nazwa{% endif %}">
                    {% endif %}
                        Źródło
                        {% if current_sort == 'zrodlo__nazwa' %}
                            <span class="fi-arrow-up"></span>
                        {% elif current_sort == '-zrodlo__nazwa' %}
                            <span class="fi-arrow-down"></span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    {% if filter_query_string %}
                        <a href="?{{ filter_query_string }}&sort={% if current_sort == 'rok' %}-rok{% else %}rok{% endif %}">
                    {% else %}
                        <a href="?sort={% if current_sort == 'rok' %}-rok{% else %}rok{% endif %}">
                    {% endif %}
                        Rok
                        {% if current_sort == 'rok' %}
                            <span class="fi-arrow-up"></span>
                        {% elif current_sort == '-rok' %}
                            <span class="fi-arrow-down"></span>
                        {% endif %}
                    </a>
                </th>
                <th>Ilość BPP</th>
                <th>Ilość PBN</th>
                <th>Dyscypliny BPP</th>
                <th>Dyscypliny PBN</th>
                <th>Operacje</th>
            </tr>
        </thead>
        <tbody>
            {% for elem in rozbieznosci %}
                <tr>
                    <td class="pbn-komparator-zrodel__source-cell">
                        <a href="{% url 'admin:bpp_zrodlo_change' elem.zrodlo.pk %}">
                            {{ elem.zrodlo.nazwa }}
                        </a>
                        {% if elem.zrodlo.issn %}
                            <br><small>ISSN: {{ elem.zrodlo.issn }}</small>
                        {% endif %}
                    </td>
                    <td>{{ elem.rok }}</td>
                    <td{% if elem.ma_rozbieznosc_dyscyplin %} class="pbn-komparator-zrodel__cell--bpp-warning"{% endif %}>
                        {{ elem.dyscypliny_bpp|dyscyplina_count }}
                    </td>
                    <td{% if elem.ma_rozbieznosc_dyscyplin %} class="pbn-komparator-zrodel__cell--pbn-success"{% endif %}>
                        {{ elem.dyscypliny_pbn|dyscyplina_count }}
                    </td>
                    <td{% if elem.ma_rozbieznosc_dyscyplin %} class="pbn-komparator-zrodel__cell--bpp-warning"{% endif %}>
                        {% dyscyplina_display elem.dyscypliny_bpp wyswietlaj_nazwy dyscypliny_cache %}
                    </td>
                    <td{% if elem.ma_rozbieznosc_dyscyplin %} class="pbn-komparator-zrodel__cell--pbn-success"{% endif %}>
                        {% dyscyplina_display elem.dyscypliny_pbn wyswietlaj_nazwy dyscypliny_cache %}
                    </td>
                    <td>
                        {% if elem.ma_rozbieznosc_dyscyplin %}
                        <form method="post" action="{% url 'pbn_komparator_zrodel:aktualizuj' elem.pk %}" class="pbn-komparator-zrodel__inline-form">
                            {% csrf_token %}
                            <input type="hidden" name="typ" value="dyscypliny">
                            <button type="submit" class="button tiny"
                                    data-confirm="Czy na pewno chcesz zaktualizować dyscypliny wg PBN?">
                                Ustaw wg PBN
                            </button>
                        </form>
                        {% else %}
                            <span class="label success">OK</span>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="text-center">
                        Brak rekordów dla wybranych kryteriów.
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {% include "pagination/pagination_with_anchor.html" %}

{% endblock %}
