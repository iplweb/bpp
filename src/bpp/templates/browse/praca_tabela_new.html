{% load prace user_in_group %}

<!-- Main publication container with modern card layout -->
<div class="praca-detail-new__container">

    <!-- Title Section - Most prominent -->
    <div class="praca-detail-new__title-section">
        <h2 class="praca-detail-new__title">
            {% if praca.tytul %}
                {{ praca.tytul_oryginalny|safe }} <span class="praca-detail-new__title-translated">({{ praca.tytul|safe }})</span>
            {% else %}
                {{ praca.tytul_oryginalny|znak_na_koncu:"."|safe }}
            {% endif %}
            {% if praca.charakter_formalny.charakter_ogolny != 'roz' %}
                <span class="praca-detail-new__edition-mark">{{ praca.oznaczenie_wydania|default:""|znak_na_koncu:"." }}</span>
            {% endif %}
        </h2>

        <!-- Authors Section -->
        <div class="praca-detail-new__authors-section">
            <div class="praca-detail-new__authors-list">
                {{ praca.tekst_przed_pierwszym_autorem|default:"" }}
                {% for autor in praca.autorzy_dla_opisu %}
                    {% ifchanged autor.typ_odpowiedzialnosci %}
                        <span class="praca-detail-new__author-badge">{{ autor.typ_odpowiedzialnosci.skrot|upper }}</span>
                    {% endifchanged %}
                    {% if links == "admin" %}
                        <a href="{% url "admin:bpp_autor_change" autor.autor.pk %}" class="praca-detail-new__author-link">
                    {% elif links == "normal" %}
                        <a href="{% url "bpp:browse_autor" autor.autor.slug %}" class="praca-detail-new__author-link">
                    {% endif %}
                    <span class="praca-detail-new__author-name {% if links %}praca-detail-new__author-name--linked{% else %}praca-detail-new__author-name--plain{% endif %}">
                        {{ autor.zapisany_jako|upper }}
                    </span>
                    {% if links == "admin" or links == "normal" %}</a>{% endif %}{% if not forloop.last %}, {% else %}{{ praca.tekst_po_ostatnim_autorze|default:"" }}.{% endif %}
                {% endfor %}
            </div>

            <!-- Show more authors button if there are many -->
            <div id="authors-toggle" class="praca-detail-new__authors-toggle">
                <button class="button tiny secondary" data-action="toggle-authors">Pokaż wszystkich autorów</button>
            </div>
        </div>
    </div>

    <!-- Main content in two columns -->
    <div class="praca-detail-new__columns">

        <!-- Left Column - Bibliographic Information -->
        <div class="praca-detail-new__left-column">

            <!-- Publication Details Card -->
            <div class="praca-detail-new__card">
                <h3 class="praca-detail-new__card-title">
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--blue"></div>
                    <span class="fi-clipboard"></span> Szczegoly publikacji
                </h3>

                {% if praca.zrodlo or praca.wydawnictwo_nadrzedne or praca.informacje or praca.szczegoly %}
                <div class="praca-detail-new__detail-row">
                    <strong class="praca-detail-new__detail-label">Zrodlo:</strong>
                    <div class="praca-detail-new__detail-content">
                        {% if praca.zrodlo %}
                            {% if links == "admin" %}
                                <a href="{% url "admin:bpp_zrodlo_change" praca.zrodlo.pk %}">{{ praca.zrodlo }}</a>
                            {% else %}
                                <a href="{% url "bpp:browse_zrodlo" praca.zrodlo.slug %}">{{ praca.zrodlo }}</a>
                            {% endif %}
                        {% endif %}
                        {% if praca.wydawnictwo_nadrzedne %}
                            <a href="{% url "bpp:browse_praca" "wydawnictwo_zwarte" praca.wydawnictwo_nadrzedne.pk %}">
                                {% if not praca.informacje and not praca.szczegoly %}
                                    {% if praca.wydawnictwo_nadrzedne.opis_bibliograficzny %}
                                        W: {{ praca.wydawnictwo_nadrzedne.opis_bibliograficzny|safe }}
                                    {% endif %}
                                {% endif %}
                            </a>
                        {% endif %}
                        {{ praca.informacje|default:""|znak_na_koncu:", "|safe }}
                        {{ praca.szczegoly|default:""|safe }}
                    </div>
                </div>
                {% endif %}

                {% if praca.wydawca or praca.wydawca_opis %}
                <div class="praca-detail-new__detail-row">
                    <strong class="praca-detail-new__detail-label">Wydawca:</strong>
                    <div class="praca-detail-new__detail-content">
                        {{ praca.wydawca|default:"" }} {{ praca.wydawca_opis|default:"" }}
                    </div>
                </div>
                {% endif %}

                <div class="praca-detail-new__detail-row">
                    <strong class="praca-detail-new__detail-label">Rok:</strong>
                    <span class="praca-detail-new__detail-inline">{{ praca.rok }}</span>
                </div>

                <div class="praca-detail-new__detail-row">
                    <strong class="praca-detail-new__detail-label">Jezyk:</strong>
                    <span class="praca-detail-new__detail-inline">{{ praca.jezyk }}</span>
                </div>

                <div class="praca-detail-new__detail-row">
                    <strong class="praca-detail-new__detail-label">Charakter formalny:</strong>
                    <span class="praca-detail-new__detail-inline">{{ praca.charakter_formalny }}</span>
                </div>

                {% if praca.typ_kbn %}
                <div class="praca-detail-new__detail-row">
                    <strong class="praca-detail-new__detail-label">Typ MNiSW/MEiN:</strong>
                    <span class="praca-detail-new__detail-inline">{{ praca.typ_kbn }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Abstracts Card -->
            {% if praca.streszczenia.exists %}
            <div class="praca-detail-new__card">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-page-edit"></span> Streszczenia
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--green"></div>
                </h3>
                {% for streszczenie in praca.streszczenia.all %}
                    <div class="praca-detail-new__abstract">
                        {% if praca.streszczenia.count > 1 %}
                            <strong class="praca-detail-new__abstract-label">
                                {{ streszczenie.jezyk_streszczenia.nazwa }}:
                            </strong>
                        {% endif %}
                        <p class="praca-detail-new__abstract-text">{{ streszczenie.streszczenie|safe }}</p>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- OpenAccess Card -->
            {% if praca.openaccess_tryb_dostepu or praca.openaccess_wersja_tekstu or praca.openaccess_licencja %}
            <div class="praca-detail-new__card praca-detail-new__card--openaccess">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-unlock"></span> Open Access
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--blue"></div>
                </h3>
                <div class="praca-detail-new__openaccess-grid">
                    {% if praca.openaccess_tryb_dostepu %}
                        <strong>Tryb dostepu:</strong> <span>{{ praca.openaccess_tryb_dostepu|lower }}</span>
                    {% endif %}
                    {% if praca.openaccess_wersja_tekstu %}
                        <strong>Wersja tekstu:</strong> <span>{{ praca.openaccess_wersja_tekstu|lower }}</span>
                    {% endif %}
                    {% if praca.openaccess_licencja %}
                        <strong>Licencja:</strong>
                        <span>
                            {% if praca.openaccess_licencja.webname %}
                                <a target="_blank" href="https://creativecommons.org/licenses/{{ praca.openaccess_licencja.webname }}/3.0/pl/#content">
                                    {{ praca.openaccess_licencja }}
                                </a>
                            {% else %}
                                {{ praca.openaccess_licencja }}
                            {% endif %}
                        </span>
                    {% endif %}
                    {% if praca.openaccess_czas_publikacji %}
                        <strong>Czas udostepnienia:</strong> <span>{{ praca.openaccess_czas_publikacji|lower }}</span>
                    {% endif %}
                    {% if praca.openaccess_ilosc_miesiecy %}
                        <strong>Ilosc miesiecy:</strong>
                        <span>{{ praca.openaccess_ilosc_miesiecy }} <small>(od publikacji do udostepnienia)</small></span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Identifiers and Metadata -->
        <div class="praca-detail-new__right-column">

            <!-- External Links Card - Priority for PBN -->
            {% if praca.pbn_uid_id or praca.doi or praca.pubmed_id or praca.pmc_id or praca.public_www or praca.www %}
            <div class="praca-detail-new__card">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-web"></span> Linki zewnetrzne
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--purple"></div>
                </h3>

                {% if praca.pbn_uid_id %}
                <div class="praca-detail-new__link-item praca-detail-new__link-item--pbn">
                    <div class="praca-detail-new__link-header">
                        <span class="praca-detail-new__link-icon fi-home"></span>
                        <strong>PBN UID</strong>
                    </div>
                    <button class="button expanded praca-detail-new__pbn-button" type="button"
                            data-open-url="{{ praca.link_do_pbn }}" data-target="_blank">
                        Otworz w PBN: {{ praca.pbn_uid_id }}
                    </button>
                    {% if not request.user.is_anonymous and praca.link_do_pi %}
                        <button class="button expanded secondary" type="button"
                                data-open-url="{{ praca.link_do_pi }}" data-target="_blank">
                            Profil instytucji
                        </button>
                    {% endif %}
                </div>
                {% endif %}

                {% if praca.doi %}
                <div class="praca-detail-new__link-item">
                    <span class="praca-detail-new__link-icon praca-detail-new__link-icon--small fi-bookmark"></span>
                    <strong>DOI:</strong>
                    <a target="_blank" href="http://doi.org/{{ praca.doi }}" class="praca-detail-new__link-text">
                        {{ praca.doi }}
                    </a>
                </div>
                {% endif %}

                {% if praca.pubmed_id %}
                <div class="praca-detail-new__link-item">
                    <span class="praca-detail-new__link-icon praca-detail-new__link-icon--small fi-torso"></span>
                    <strong>PubMed:</strong>
                    <a target="_blank" href="https://www.ncbi.nlm.nih.gov/pubmed/{{ praca.pubmed_id }}" class="praca-detail-new__link-text">
                        {{ praca.pubmed_id }}
                    </a>
                </div>
                {% endif %}

                {% if praca.pmc_id %}
                <div class="praca-detail-new__link-item">
                    <span class="praca-detail-new__link-icon praca-detail-new__link-icon--small fi-book"></span>
                    <strong>PMC:</strong>
                    <a href="https://www.ncbi.nlm.nih.gov/pmc/{{ praca.pmc_id }}" class="praca-detail-new__link-text">
                        {{ praca.pmc_id }}
                    </a>
                </div>
                {% endif %}

                {% if praca.public_www or praca.www %}
                <div class="praca-detail-new__link-item">
                    <span class="praca-detail-new__link-icon praca-detail-new__link-icon--small fi-web"></span>
                    <strong>WWW:</strong>
                    {% if praca.public_www %}
                        <a href="{{ praca.public_www }}" class="praca-detail-new__link-text">
                            {{ praca.public_www|truncatechars:60 }}
                        </a>
                    {% elif praca.www %}
                        <a href="{{ praca.www }}" class="praca-detail-new__link-text">
                            {{ praca.www|truncatechars:60 }}
                        </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Identifiers Card -->
            <div class="praca-detail-new__card">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-price-tag"></span> Identyfikatory
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--orange"></div>
                </h3>

                {% if praca.isbn %}
                <div class="praca-detail-new__id-item">
                    <span class="praca-detail-new__id-icon fi-book"></span>
                    <strong>ISBN:</strong> {{ praca.isbn }}
                </div>
                {% endif %}

                {% if praca.e_isbn %}
                <div class="praca-detail-new__id-item">
                    <span class="praca-detail-new__id-icon fi-laptop"></span>
                    <strong>e-ISBN:</strong> {{ praca.e_isbn }}
                </div>
                {% endif %}

                {% if praca.issn %}
                <div class="praca-detail-new__id-item">
                    <span class="praca-detail-new__id-icon fi-page"></span>
                    <strong>ISSN:</strong> {{ praca.issn }}
                </div>
                {% endif %}

                {% if praca.e_issn %}
                <div class="praca-detail-new__id-item">
                    <span class="praca-detail-new__id-icon fi-save"></span>
                    <strong>e-ISSN:</strong> {{ praca.e_issn }}
                </div>
                {% endif %}

                <div class="praca-detail-new__id-item">
                    <span class="praca-detail-new__id-icon fi-price-tag"></span>
                    <strong>BPP ID:</strong> {{ rekord.pk }}
                    <small class="praca-detail-new__id-subtext">
                        {{ rekord.describe_content_type }} #{{ praca.pk }}
                    </small>
                </div>

                {% if praca.pbn_id %}
                <div class="praca-detail-new__id-item">
                    <span class="praca-detail-new__id-icon fi-clipboard"></span>
                    <strong>PBN ID (hist.):</strong> {{ praca.pbn_id }}
                </div>
                {% endif %}
            </div>

            <!-- Metrics Card -->
            <div class="praca-detail-new__card">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-graph-bar"></span> Metryki
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--red"></div>
                </h3>

                <div class="praca-detail-new__metrics-grid">
                    <div class="praca-detail-new__metric-box">
                        <div class="praca-detail-new__metric-value praca-detail-new__metric-value--points">{{ praca.punkty_kbn|default:"0" }}</div>
                        <div class="praca-detail-new__metric-label">Punkty MNiSW/MEiN</div>
                    </div>

                    <div class="praca-detail-new__metric-box">
                        <div class="praca-detail-new__metric-value praca-detail-new__metric-value--impact">{{ praca.impact_factor|default:"0" }}</div>
                        <div class="praca-detail-new__metric-label">Impact Factor</div>
                    </div>

                    {% if praca.kwartyl_w_scopus %}
                    <div class="praca-detail-new__metric-box">
                        <div class="praca-detail-new__metric-value praca-detail-new__metric-value--scopus">Q{{ praca.kwartyl_w_scopus }}</div>
                        <div class="praca-detail-new__metric-label">SCOPUS</div>
                    </div>
                    {% endif %}

                    {% if praca.kwartyl_w_wos %}
                    <div class="praca-detail-new__metric-box">
                        <div class="praca-detail-new__metric-value praca-detail-new__metric-value--wos">Q{{ praca.kwartyl_w_wos }}</div>
                        <div class="praca-detail-new__metric-label">WoS</div>
                    </div>
                    {% endif %}

                    {% if praca.liczba_cytowan %}
                    <div class="praca-detail-new__metric-box">
                        <div class="praca-detail-new__metric-value praca-detail-new__metric-value--citations">{{ praca.liczba_cytowan }}</div>
                        <div class="praca-detail-new__metric-label">Cytowania</div>
                    </div>
                    {% endif %}

                    {% if uczelnia.pokazuj_punktacja_snip and praca.punktacja_snip %}
                    <div class="praca-detail-new__metric-box">
                        <div class="praca-detail-new__metric-value praca-detail-new__metric-value--snip">{{ praca.punktacja_snip }}</div>
                        <div class="praca-detail-new__metric-label">SNIP</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- BibTeX Card (Collapsible) -->
            <div class="praca-detail-new__card">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-page"></span> BibTeX
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--gray"></div>
                </h3>
                <button id="bibtex-toggle-btn" class="button expanded secondary" type="button">
                    Pokaz BibTeX
                </button>
                <button id="bibtex-copy-btn" class="button expanded success praca-detail-new__bibtex-copy-btn" type="button">
                    Skopiuj do schowka
                </button>
                <span id="bibtex-copy-feedback" class="praca-detail-new__bibtex-feedback">
                    Skopiowane!
                </span>
                <div id="bibtex-container" class="praca-detail-new__bibtex-container">
                    <textarea id="bibtex-content" readonly class="praca-detail-new__bibtex-textarea"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Points and Slots Tables -->
    {% if rekord.ma_punktacje_sloty %}
        {% if uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "always" or uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "logged-in" and not request.user.is_anonymous %}
        <div class="praca-detail-new__slots-section">
            <div class="praca-detail-new__card">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-torsos-all"></span> Punkty i sloty autorow
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--blue"></div>
                    {% if uczelnia.drukuj_oswiadczenia %}
                        {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                            <a target="_blank" href="{% url "oswiadczenia:wiele-oswiadczen" rekord.id.0 rekord.id.1 %}" class="praca-detail-new__print-link">
                                <span class="fi-print"></span>
                            </a>
                        {% endif %}
                    {% endif %}
                </h3>

                <div class="praca-detail-new__table-container">
                    <table class="praca-detail-new__table">
                        <thead class="praca-detail-new__table-head">
                            <tr>
                                <th class="praca-detail-new__table-th">Autor</th>
                                <th class="praca-detail-new__table-th">Dyscyplina</th>
                                <th class="praca-detail-new__table-th praca-detail-new__table-th--center">PkD / PkDAut</th>
                                <th class="praca-detail-new__table-th praca-detail-new__table-th--center">Slot</th>
                                {% if uczelnia.drukuj_oswiadczenia %}
                                    {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                                        <th class="praca-detail-new__table-th praca-detail-new__table-th--center">Oswiadczenia</th>
                                    {% endif %}
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for pa in rekord.punktacja_autora.select_related %}
                            <tr class="praca-detail-new__table-row">
                                <td class="praca-detail-new__table-cell">{{ pa.autor }}</td>
                                <td class="praca-detail-new__table-cell">{{ pa.dyscyplina.nazwa }}</td>
                                <td class="praca-detail-new__table-cell praca-detail-new__table-cell--center">
                                    <span class="praca-detail-new__badge praca-detail-new__badge--pkdaut">{{ pa.pkdaut }}</span>
                                </td>
                                <td class="praca-detail-new__table-cell praca-detail-new__table-cell--center">
                                    <span class="praca-detail-new__badge praca-detail-new__badge--slot">{{ pa.slot }}</span>
                                </td>
                                {% if uczelnia.drukuj_oswiadczenia %}
                                    {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                                        <td class="praca-detail-new__table-cell praca-detail-new__table-cell--center">
                                            <a target="_blank" title="Wydruk dyscypliny zgloszonej dla publikacji"
                                               href="{% url "oswiadczenia:jedno-oswiadczenie" rekord.id.0 rekord.id.1 pa.autor.id pa.dyscyplina.id %}">
                                                <span class="fi-print"></span>
                                            </a>
                                            {% if pa.czy_autor_ma_alternatywna_dyscypline and uczelnia.drukuj_alternatywne_oswiadczenia %}
                                                &nbsp;
                                                <a target="_blank" title="Wydruk alternatywnej dyscypliny autora"
                                                   href="{% url "oswiadczenia:jedno-oswiadczenie-druga-dyscyplina" rekord.id.0 rekord.id.1 pa.autor.id pa.dyscyplina.id %}">
                                                    <span class="fi-print praca-detail-new__print-icon-alt"></span>
                                                </a>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <h3 class="praca-detail-new__disc-slots-title">
                    <span class="fi-graph-trend"></span> Punkty i sloty dyscyplin
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--green"></div>
                </h3>

                <div class="praca-detail-new__table-container">
                    <table class="praca-detail-new__table">
                        <thead class="praca-detail-new__table-head">
                            <tr>
                                <th class="praca-detail-new__table-th">Dyscyplina</th>
                                <th class="praca-detail-new__table-th praca-detail-new__table-th--center">PkD / PkDAut</th>
                                <th class="praca-detail-new__table-th praca-detail-new__table-th--center">Slot</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pd in rekord.punktacja_dyscypliny.select_related %}
                            <tr class="praca-detail-new__table-row">
                                <td class="praca-detail-new__table-cell">{{ pd.dyscyplina.nazwa }}</td>
                                <td class="praca-detail-new__table-cell praca-detail-new__table-cell--center">
                                    <span class="praca-detail-new__badge praca-detail-new__badge--pkd">{{ pd.pkd }}</span>
                                </td>
                                <td class="praca-detail-new__table-cell praca-detail-new__table-cell--center">
                                    <span class="praca-detail-new__badge praca-detail-new__badge--disc-slot">{{ pd.slot }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    {% endif %}

    <!-- Additional Information (collapsed by default) -->
    <div class="praca-detail-new__additional-info">
        <div class="praca-detail-new__card praca-detail-new__card--additional">
            <h3 class="praca-detail-new__card-title praca-detail-new__card-title--clickable"
                data-action="toggle-additional-info"
                tabindex="0"
                role="button">
                <span class="fi-widget"></span> Informacje dodatkowe <span id="additional-toggle" class="praca-detail-new__additional-toggle">V</span>
            </h3>
            <div id="additional-content" class="praca-detail-new__additional-content">
                <table class="praca-detail-new__additional-table">
                    {% if praca.charakter_formalny.skrot == "PAT" %}
                    <tr>
                        <td colspan="2" class="praca-detail-new__additional-cell praca-detail-new__additional-cell--patent">
                            <strong>Patent:</strong><br/>
                            <div class="praca-detail-new__patent-details">
                                <b>Numer zgloszenia:</b> {{ praca.numer_zgloszenia|default:"brak" }}<br/>
                                <b>Wydzial:</b> {{ praca.wydzial|default:"brak" }}<br/>
                                <b>Rodzaj prawa:</b> {{ praca.rodzaj_prawa|default:"brak" }}<br/>
                                <b>Data zgloszenia:</b> {{ praca.data_zgloszenia|default:"brak" }}<br/>
                                <b>Data decyzji:</b> {{ praca.data_decyzji|default:"brak" }}<br/>
                                <b>Numer prawa wylacznego:</b> {{ praca.numer_prawa_wylacznego|default:"brak" }}<br/>
                                <b>Wdrozenie:</b> {% if praca.wdrozenie %}tak{% else %}nie{% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endif %}

                    {% if praca.liczba_znakow_wydawniczych %}
                    <tr>
                        <th class="praca-detail-new__additional-cell">Liczba arkuszy wydawniczych:</th>
                        <td class="praca-detail-new__additional-cell">{{ praca.wymiar_wydawniczy_w_arkuszach }}</td>
                    </tr>
                    {% endif %}

                    {% if uczelnia.pokazuj_status_korekty == "always" or uczelnia.pokazuj_status_korekty == "logged-in" and not request.user.is_anonymous %}
                    <tr>
                        <th class="praca-detail-new__additional-cell">Status:</th>
                        <td class="praca-detail-new__additional-cell">{{ praca.status_korekty }}</td>
                    </tr>
                    {% endif %}

                    {% if uczelnia.pokazuj_praca_recenzowana == "always" or uczelnia.pokazuj_praca_recenzowana == "logged-in" and not request.user.is_anonymous %}
                    <tr>
                        <th class="praca-detail-new__additional-cell">Praca recenzowana:</th>
                        <td class="praca-detail-new__additional-cell">{{ praca.recenzowana|yesno }}</td>
                    </tr>
                    {% endif %}

                    {% if praca.ma_procenty %}
                    <tr>
                        <th class="praca-detail-new__additional-cell praca-detail-new__additional-cell--vertical">Odpowiedzialnosc za powstanie pracy:</th>
                        <td class="praca-detail-new__additional-cell">
                            {% for autor in praca.autorzy_set.all %}
                                {% if autor.procent %}
                                    {{ autor.procent }}% {{ autor.zapisany_jako }}<br/>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}

                    {% if praca.zewnetrzna_baza_danych.exists %}
                    <tr>
                        <th class="praca-detail-new__additional-cell praca-detail-new__additional-cell--vertical">Zewnetrzna baza danych:</th>
                        <td class="praca-detail-new__additional-cell">
                            {% for db in praca.zewnetrzna_baza_danych.all %}
                                - {{ db.baza.nazwa }}<br/>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}

                    {% if praca.wydawnictwa_powiazane_set.exists %}
                    <tr>
                        <th class="praca-detail-new__additional-cell praca-detail-new__additional-cell--vertical">Rekordy powiazane:</th>
                        <td class="praca-detail-new__additional-cell">
                            {% for elem in praca.wydawnictwa_powiazane_posortowane.all %}
                                - <a href="{% url "bpp:browse_praca" "wydawnictwo_zwarte" elem.pk %}">
                                    {{ elem.opis_bibliograficzny_cache|safe }}
                                </a><br/>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}

                    <tr>
                        <th class="praca-detail-new__additional-cell">Rekord utworzony:</th>
                        <td class="praca-detail-new__additional-cell">{{ praca.utworzono }}</td>
                    </tr>

                    <tr>
                        <th class="praca-detail-new__additional-cell">Ostatnia aktualizacja:</th>
                        <td class="praca-detail-new__additional-cell">{{ praca.ostatnio_zmieniony }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- "Odpiete" dyscypliny -->
    {% if rekord.ma_odpiete_dyscypliny %}
        {% if uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "always" or uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "logged-in" and not request.user.is_anonymous %}
        <div class="praca-detail-new__detached-section">
            <div class="praca-detail-new__card praca-detail-new__card--detached">
                <h3 class="praca-detail-new__card-title">
                    <span class="fi-unlock"></span> "Odpiete" dyscypliny
                    <div class="praca-detail-new__gradient-line praca-detail-new__gradient-line--red"></div>
                </h3>
                <table class="praca-detail-new__table">
                    <thead class="praca-detail-new__table-head praca-detail-new__table-head--detached">
                        <tr>
                            <th class="praca-detail-new__table-th">Autor</th>
                            <th class="praca-detail-new__table-th">Dyscyplina</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pa in praca.odpiete_dyscypliny.select_related %}
                        <tr class="praca-detail-new__table-row praca-detail-new__table-row--detached">
                            <td class="praca-detail-new__table-cell">{{ pa.autor }}</td>
                            <td class="praca-detail-new__table-cell">{{ pa.dyscyplina_naukowa.nazwa }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- JavaScript for interactive elements -->
<script type="text/javascript">
(function($) {
    $(document).ready(function() {
        // BibTeX functionality
        var bibtexToggleBtn = $('#bibtex-toggle-btn');
        var bibtexContainer = $('#bibtex-container');
        var bibtexContent = $('#bibtex-content');
        var bibtexCopyBtn = $('#bibtex-copy-btn');
        var bibtexCopyFeedback = $('#bibtex-copy-feedback');
        var bibtexLoaded = false;

        bibtexToggleBtn.click(function() {
            if (bibtexContainer.is(':visible')) {
                bibtexContainer.hide();
                bibtexToggleBtn.text('Pokaż BibTeX');
                bibtexCopyBtn.hide();
            } else {
                if (!bibtexLoaded) {
                    loadBibTeX();
                } else {
                    bibtexContainer.show();
                    bibtexToggleBtn.text('Ukryj BibTeX');
                    bibtexCopyBtn.show();
                }
            }
        });

        bibtexCopyBtn.click(function() {
            copyToClipboard();
        });

        function loadBibTeX() {
            bibtexToggleBtn.prop('disabled', true).text('⏳ Ładowanie...');
            var modelName = '{{ rekord.content_type.model }}';
            var pk = '{{ praca.pk }}';
            var url = '/bpp/api/bibtex/' + modelName + '/' + pk + '/';

            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    bibtexContent.val(data.bibtex);
                    bibtexContainer.show();
                    bibtexToggleBtn.text('Ukryj BibTeX');
                    bibtexCopyBtn.show();
                    bibtexLoaded = true;
                },
                error: function(xhr, status, error) {
                    var errorMsg = 'Błąd podczas pobierania BibTeX';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += ': ' + xhr.responseJSON.error;
                    }
                    bibtexContent.val(errorMsg);
                    bibtexContainer.show();
                    bibtexToggleBtn.text('Ukryj BibTeX (błąd)');
                },
                complete: function() {
                    bibtexToggleBtn.prop('disabled', false);
                }
            });
        }

        function copyToClipboard() {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(bibtexContent.val()).then(function() {
                    showCopyFeedback();
                }, function(err) {
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        }

        function fallbackCopy() {
            bibtexContent.select();
            bibtexContent[0].setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showCopyFeedback();
            } catch (err) {
                alert('Nie można skopiować do schowka. Proszę zaznacz tekst i skopiuj ręcznie (Ctrl+C).');
            }
        }

        function showCopyFeedback() {
            bibtexCopyFeedback.show();
            setTimeout(function() {
                bibtexCopyFeedback.fadeOut();
            }, 2000);
        }

        // Check if there are many authors and implement show/hide
        var authorsList = $('.author-name');
        if (authorsList.length > 10) {
            // Implementation for show more authors would go here
        }
    });
})(jQuery || django.jQuery || $);

// Toggle additional information
function toggleAdditionalInfo() {
    var content = document.getElementById('additional-content');
    var toggle = document.getElementById('additional-toggle');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.innerHTML = '▲';
    } else {
        content.style.display = 'none';
        toggle.innerHTML = '▼';
    }
}
</script>
