{% load prace user_in_group %}

{% comment %} Include bibliography metadata in head section {% endcomment %}
{% if not request.is_ajax %}
    {% include "browse/bibliography_metadata.html" with praca=praca autorzy=autorzy %}
{% endif %}

<!-- Main publication container with modern card layout -->
<div class="praca-mono">

    <!-- Title Section - Most prominent -->
    <div class="praca-mono__title-section">
        <h2 class="praca-mono__title">
            {% if praca.tytul %}
                {{ praca.tytul_oryginalny|safe }}
                <span class="praca-mono__title-translation">({{ praca.tytul|safe }})</span>
            {% else %}
                {{ praca.tytul_oryginalny|znak_na_koncu:"."|safe }}
            {% endif %}
            {% if praca.charakter_formalny.charakter_ogolny != 'roz' %}
                <span class="praca-mono__edition-mark">{{ praca.oznaczenie_wydania|default:""|znak_na_koncu:"." }}</span>
            {% endif %}
            {% comment %} COinS metadata for automatic bibliography manager detection {% endcomment %}
            {% generate_coins praca autorzy %}
        </h2>

        <!-- Authors Section -->
        <div class="praca-mono__authors-section">
            <div class="praca-mono__authors-list">
                {{ praca.tekst_przed_pierwszym_autorem|default:"" }}
                {% for autor in praca.autorzy_dla_opisu %}
                    {% ifchanged autor.typ_odpowiedzialnosci %}
                        <span class="praca-mono__author-type-badge">{{ autor.typ_odpowiedzialnosci.skrot|upper }}</span>
                    {% endifchanged %}
                    {% if links == "admin" %}
                        <a href="{% url "admin:bpp_autor_change" autor.autor.pk %}">
                    {% elif links == "normal" %}
                        <a href="{% url "bpp:browse_autor" autor.autor.slug %}">
                    {% endif %}
                <span class="author-name{% if not links %} praca-mono__author-name{% endif %}">
                        {{ autor.zapisany_jako|upper }}
                    </span>
                {% if links == "admin" or links == "normal" %}</a>{% endif %}{% if not forloop.last %},
                    {% else %}{{ praca.tekst_po_ostatnim_autorze|default:"" }}.{% endif %}
                {% endfor %}
            </div>

            <!-- Show more authors button if there are many -->
            <div id="authors-toggle" class="praca-mono__authors-toggle">
                <button class="button tiny secondary"
                        data-toggle-authors="true"
                        aria-expanded="false"
                        aria-label="Pokaż wszystkich autorów publikacji">Pokaż wszystkich autorów</button>
            </div>
        </div>
    </div>

    <!-- Main content in two columns -->
    <div class="praca-mono__columns">

        <!-- Left Column - Bibliographic Information -->
        <div class="praca-mono__column--left">

            <!-- Edit Record Panel - Only for authorized users -->
            {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                <div class="info-card edit-panel hide-for-print">
                    <h3>
                        <span class="fi-pencil"></span> Edycja rekordu
                        <div class="shaded-hr-div-small"></div>
                    </h3>
                    <div class="edit-buttons">
                        <a target="_blank"
                           href="{% url "admin:"|add:rekord.content_type.app_label|add:"_"|add:rekord.content_type.model|add:"_change" rekord.object_id %}"
                           class="button btn-edit">
                            <span class="fi-page-edit"></span>
                            Otwórz do edycji
                        </a>

                        <a target="_blank"
                           href="{% url "admin:"|add:rekord.content_type.app_label|add:"_"|add:rekord.content_type.model|add:"_add" %}"
                           class="button btn-add">
                            <span class="fi-plus"></span>
                            Dodaj nowy rekord
                        </a>
                    </div>
                    <small class="edit-info">
                        <span class="fi-info"></span>
                        Linki otwierają się w nowej karcie
                    </small>
                </div>
            {% endif %}

            <!-- Bibliographic Description Card -->
            <div class="praca-mono__card">
                <h3 class="praca-mono__card-title">
                    <span class="fi-page-copy"></span> Opis bibliograficzny
                    <div class="shaded-hr-div-small"></div>
                </h3>
                <div id="bibliographic-description"
                     class="praca-mono__biblio-container"
                     data-copy-content="true"
                     role="button"
                     tabindex="0"
                     aria-label="Opis bibliograficzny - kliknij aby skopiować do schowka">
                    <div class="praca-mono__biblio-text">
                        {{ praca.opis_bibliograficzny_cache|safe }}
                    </div>
                    <div id="copy-biblio-feedback" class="praca-mono__biblio-feedback">
                        Skopiowane!
                    </div>
                </div>
                <small class="praca-mono__biblio-hint">Kliknij opis aby skopiować do
                    schowka</small>
            </div>

            <!-- Publication Details Card -->
            <div class="praca-mono__card">
                <h3 class="praca-mono__card-title">
                    <span class="fi-clipboard-notes"></span> Szczegóły publikacji
                    <div class="shaded-hr-div-small"></div>
                </h3>

                {% if praca.zrodlo or praca.wydawnictwo_nadrzedne or praca.informacje or praca.szczegoly %}
                    <div class="praca-mono__detail-row">
                        <strong class="praca-mono__detail-label">Źródło:</strong>
                        <div class="praca-mono__detail-value">
                            {% if praca.zrodlo %}
                                {% if links == "admin" %}
                                    <a href="{% url "admin:bpp_zrodlo_change" praca.zrodlo.pk %}">{{ praca.zrodlo }}</a>
                                {% else %}
                                    <a href="{% url "bpp:browse_zrodlo" praca.zrodlo.slug %}">{{ praca.zrodlo }}</a>
                                {% endif %}
                            {% endif %}
                            {% if praca.wydawnictwo_nadrzedne %}
                                {% if not praca.informacje and not praca.szczegoly %}
                                    {% if praca.wydawnictwo_nadrzedne.opis_bibliograficzny %}
                                        W: <a href="{% url "bpp:browse_praca_by_slug" praca.wydawnictwo_nadrzedne.slug %}">{{ praca.wydawnictwo_nadrzedne.opis_bibliograficzny|safe }}</a>
                                    {% endif %}
                                {% else %}
                                    <a href="{% url "bpp:browse_praca_by_slug" praca.wydawnictwo_nadrzedne.slug %}">Zobacz wydawnictwo nadrzędne</a>
                                {% endif %}
                            {% elif praca.wydawnictwo_nadrzedne_w_pbn %}
                                W: <a href="{{ praca.wydawnictwo_nadrzedne_w_pbn.link_do_pbn }}" target="_blank" title="Link do PBN">
                                    {{ praca.wydawnictwo_nadrzedne_w_pbn.title }}
                                    {% if praca.wydawnictwo_nadrzedne_w_pbn.autorzy %}
                                        /
                                        {% for typ, lista in praca.wydawnictwo_nadrzedne_w_pbn.autorzy.items %}
                                            {% for autor in lista %}
                                                {{ autor.lastName }} {{ autor.firstName|default:autor.givenNames|default:"" }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                            {% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    <span class="fi-link-external praca-mono__external-link-icon"></span>
                                </a>
                            {% endif %}
                            {{ praca.informacje|default:""|znak_na_koncu:", "|safe }}
                            {{ praca.szczegoly|default:""|safe }}
                        </div>
                    </div>
                {% endif %}

                {% if praca.wydawca or praca.wydawca_opis %}
                    <div class="praca-mono__detail-row">
                        <strong class="praca-mono__detail-label">Wydawca:</strong>
                        <div class="praca-mono__detail-value">
                            {{ praca.wydawca|default:"" }} {{ praca.wydawca_opis|default:"" }}
                        </div>
                    </div>
                {% endif %}

                <div class="praca-mono__detail-row">
                    <strong class="praca-mono__detail-label">Rok:</strong>
                    <span class="praca-mono__detail-inline">{{ praca.rok }}</span>
                </div>

                <div class="praca-mono__detail-row">
                    <strong class="praca-mono__detail-label">Język:</strong>
                    <span class="praca-mono__detail-inline">{{ praca.jezyk }}</span>
                </div>

                <div class="praca-mono__detail-row">
                    <strong class="praca-mono__detail-label">Charakter formalny:</strong>
                    <span class="praca-mono__detail-inline">{{ praca.charakter_formalny }}</span>
                </div>

                {% if praca.typ_kbn %}
                    <div class="praca-mono__detail-row">
                        <strong class="praca-mono__detail-label">Typ MNiSW/MEiN:</strong>
                        <span class="praca-mono__detail-inline">{{ praca.typ_kbn }}</span>
                    </div>
                {% endif %}
            </div>

            <!-- Abstracts Card -->
            {% if praca.streszczenia.exists %}
                <div class="praca-mono__card">
                    <h3 class="praca-mono__card-title">
                        <span class="fi-page-edit"></span> Streszczenia
                        <div class="shaded-hr-div-small"></div>
                    </h3>
                    {% for streszczenie in praca.streszczenia.all %}
                        <div class="praca-mono__abstract">
                            {% if praca.streszczenia.count > 1 %}
                                <strong class="praca-mono__abstract-label">
                                    {{ streszczenie.jezyk_streszczenia.nazwa }}:
                                </strong>
                            {% endif %}
                            <p class="praca-mono__abstract-text">{{ streszczenie.streszczenie|safe }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- OpenAccess Card -->
            {% if praca.openaccess_tryb_dostepu or praca.openaccess_wersja_tekstu or praca.openaccess_licencja %}
                <div class="praca-mono__card praca-mono__card--openaccess">
                    <h3 class="praca-mono__card-title">
                        <span class="fi-unlock"></span> Open Access
                        <div class="shaded-hr-div-small"></div>
                    </h3>
                    <div class="praca-mono__openaccess-grid">
                        {% if praca.openaccess_tryb_dostepu %}
                            <strong>Tryb dostępu:</strong> <span>{{ praca.openaccess_tryb_dostepu|lower }}</span>
                        {% endif %}
                        {% if praca.openaccess_wersja_tekstu %}
                            <strong>Wersja tekstu:</strong> <span>{{ praca.openaccess_wersja_tekstu|lower }}</span>
                        {% endif %}
                        {% if praca.openaccess_licencja %}
                            <strong>Licencja:</strong>
                            <span>
                            {% if praca.openaccess_licencja.webname %}
                                <a target="_blank"
                                   href="https://creativecommons.org/licenses/{{ praca.openaccess_licencja.webname }}/3.0/pl/#content">
                                    {{ praca.openaccess_licencja }}
                                </a>
                            {% else %}
                                {{ praca.openaccess_licencja }}
                            {% endif %}
                        </span>
                        {% endif %}
                        {% if praca.openaccess_czas_publikacji %}
                            <strong>Czas udostępnienia:</strong>
                            <span>{{ praca.openaccess_czas_publikacji|lower }}</span>
                        {% endif %}
                        {% if praca.openaccess_ilosc_miesiecy %}
                            <strong>Ilość miesięcy:</strong>
                            <span>{{ praca.openaccess_ilosc_miesiecy }} <small>(od publikacji do udostępnienia)</small></span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Right Column - Identifiers and Metadata -->
        <div class="praca-mono__column--right">

            <!-- External Links Card - Redesigned -->
            {% if praca.pbn_uid_id or praca.doi or praca.pubmed_id or praca.pmc_id or praca.public_www or praca.www %}
                <div class="external-links-card">
                    <h3>
                        <span class="fi-web"></span> Linki zewnętrzne
                        <div class="shaded-hr-div-small"></div>
                    </h3>

                    <div class="external-links-grid">
                        {% if praca.pbn_uid_id %}
                            <div class="external-link-item link-pbn">
                                <span class="fi-home link-icon"></span>
                                <div class="link-content">
                                    <div class="link-label">PBN</div>
                                    <div class="link-value">{{ praca.pbn_uid_id }}</div>
                                </div>
                                <div class="link-actions">
                                    <button class="button copy-button" type="button"
                                            data-copy-text="{{ praca.pbn_uid_id }}"
                                            title="Kopiuj identyfikator">
                                        <i class="fi-clipboard"></i>
                                    </button>
                                    <button class="button open-button" type="button"
                                            data-open-url="{{ praca.link_do_pbn }}" data-target="_blank"
                                            title="Otwórz w PBN">
                                        <i class="fi-arrow-right"></i> Otwórz
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                        {% if not request.user.is_anonymous and praca.link_do_pi %}
                            <div class="external-link-item link-pi">
                                <span class="fi-home link-icon" aria-hidden="true"></span>
                                <div class="link-content">
                                    <div class="link-label">Profil instytucji</div>
                                    <div class="link-value">{{ praca.link_do_pi|truncatechars:40 }}</div>
                                </div>
                                <div class="link-actions">
                                    <button class="button copy-button" type="button"
                                            data-copy-text="{{ praca.link_do_pi }}"
                                            title="Kopiuj adres">
                                        <i class="fi-clipboard"></i>
                                    </button>
                                    <button class="button open-button" type="button"
                                            data-open-url="{{ praca.link_do_pi }}" data-target="_blank"
                                            title="Otwórz w Profilu instytucji">
                                        <i class="fi-arrow-right"></i> Otwórz
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                        {% if praca.doi %}
                            <div class="external-link-item link-doi">
                                <span class="fi-bookmark link-icon" aria-hidden="true"></span>
                                <div class="link-content">
                                    <div class="link-label">DOI</div>
                                    <div class="link-value">{{ praca.doi }}</div>
                                </div>
                                <div class="link-actions">
                                    <button class="button copy-button" type="button"
                                            data-copy-text="{{ praca.doi }}"
                                            title="Kopiuj DOI">
                                        <i class="fi-clipboard"></i>
                                    </button>
                                    <button class="button open-button" type="button"
                                            data-open-url="http://doi.org/{{ praca.doi }}" data-target="_blank"
                                            title="Otwórz stronę DOI">
                                        <i class="fi-arrow-right"></i> Otwórz
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                        {% if praca.pubmed_id %}
                            <div class="external-link-item link-pubmed">
                                <span class="fi-first-aid link-icon" aria-hidden="true"></span>
                                <div class="link-content">
                                    <div class="link-label">PubMed</div>
                                    <div class="link-value">{{ praca.pubmed_id }}</div>
                                </div>
                                <div class="link-actions">
                                    <button class="button copy-button" type="button"
                                            data-copy-text="{{ praca.pubmed_id }}"
                                            title="Kopiuj ID">
                                        <i class="fi-clipboard"></i>
                                    </button>
                                    <button class="button open-button" type="button"
                                            data-open-url="https://www.ncbi.nlm.nih.gov/pubmed/{{ praca.pubmed_id }}" data-target="_blank"
                                            title="Otwórz w PubMed">
                                        <i class="fi-arrow-right"></i> Otwórz
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                        {% if praca.pmc_id %}
                            <div class="external-link-item link-pmc">
                                <span class="fi-book link-icon" aria-hidden="true"></span>
                                <div class="link-content">
                                    <div class="link-label">PMC</div>
                                    <div class="link-value">{{ praca.pmc_id }}</div>
                                </div>
                                <div class="link-actions">
                                    <button class="button copy-button" type="button"
                                            data-copy-text="{{ praca.pmc_id }}"
                                            title="Kopiuj ID">
                                        <i class="fi-clipboard"></i>
                                    </button>
                                    <button class="button open-button" type="button"
                                            data-open-url="https://www.ncbi.nlm.nih.gov/pmc/{{ praca.pmc_id }}" data-target="_blank"
                                            title="Otwórz w PMC">
                                        <i class="fi-arrow-right"></i> Otwórz
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                        {% if praca.public_www or praca.www %}
                            {% with url=praca.public_www|default:praca.www %}
                            <div class="external-link-item link-www">
                                <span class="fi-web link-icon" aria-hidden="true"></span>
                                <div class="link-content">
                                    <div class="link-label">Strona WWW</div>
                                    <div class="link-value">{{ url|truncatechars:40 }}</div>
                                </div>
                                <div class="link-actions">
                                    <button class="button copy-button" type="button"
                                            data-copy-text="{{ url }}"
                                            title="Kopiuj adres">
                                        <i class="fi-clipboard"></i>
                                    </button>
                                    <button class="button open-button" type="button"
                                            data-open-url="{{ url }}" data-target="_blank"
                                            title="Otwórz stronę">
                                        <i class="fi-arrow-right"></i> Otwórz
                                    </button>
                                </div>
                            </div>
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Identifiers Card -->
            <div class="praca-mono__card">
                <h3 class="praca-mono__card-title">
                    <span class="fi-credit-card"></span> Identyfikatory
                    <div class="shaded-hr-div-small"></div>
                </h3>

                {% if praca.isbn %}
                    <div class="praca-mono__id-item">
                        <span class="fi-book praca-mono__id-icon"></span>
                        <strong>ISBN:</strong> {{ praca.isbn }}
                    </div>
                {% endif %}

                {% if praca.e_isbn %}
                    <div class="praca-mono__id-item">
                        <span class="fi-laptop praca-mono__id-icon"></span>
                        <strong>e-ISBN:</strong> {{ praca.e_isbn }}
                    </div>
                {% endif %}

                {% if praca.issn %}
                    <div class="praca-mono__id-item">
                        <span class="fi-page-multiple praca-mono__id-icon"></span>
                        <strong>ISSN:</strong> {{ praca.issn }}
                    </div>
                {% endif %}

                {% if praca.e_issn %}
                    <div class="praca-mono__id-item">
                        <span class="fi-save praca-mono__id-icon"></span>
                        <strong>e-ISSN:</strong> {{ praca.e_issn }}
                    </div>
                {% endif %}

                <div class="praca-mono__id-item">
                    <span class="fi-tag praca-mono__id-icon"></span>
                    <strong>BPP ID:</strong> {{ rekord.pk }}
                    <small class="praca-mono__id-subtext">
                        {{ rekord.describe_content_type }} #{{ praca.pk }}
                    </small>
                </div>

                {% if praca.pbn_id %}
                    <div class="praca-mono__id-item">
                        <span class="fi-clipboard praca-mono__id-icon"></span>
                        <strong>PBN ID (hist.):</strong> {{ praca.pbn_id }}
                    </div>
                {% endif %}
            </div>

            <!-- Metrics Card -->
            <div class="praca-mono__card">
                <h3 class="praca-mono__card-title">
                    <span class="fi-graph-bar"></span> Metryki
                    <div class="shaded-hr-div-small"></div>
                </h3>

                <div class="praca-mono__metrics-grid">
                    <div class="praca-mono__metric-item">
                        <div class="praca-mono__metric-value praca-mono__metric-value--points">
                            {{ praca.punkty_kbn|default:"0" }}</div>
                        <div class="praca-mono__metric-label">Punkty MNiSW/MEiN</div>
                    </div>

                    <div class="praca-mono__metric-item">
                        <div class="praca-mono__metric-value praca-mono__metric-value--impact">
                            {{ praca.impact_factor|default:"0" }}</div>
                        <div class="praca-mono__metric-label">Impact Factor</div>
                    </div>

                    {% if praca.kwartyl_w_scopus %}
                        <div class="praca-mono__metric-item">
                            <div class="praca-mono__metric-value praca-mono__metric-value--scopus">
                                Q{{ praca.kwartyl_w_scopus }}</div>
                            <div class="praca-mono__metric-label">SCOPUS</div>
                        </div>
                    {% endif %}

                    {% if praca.kwartyl_w_wos %}
                        <div class="praca-mono__metric-item">
                            <div class="praca-mono__metric-value praca-mono__metric-value--wos">
                                Q{{ praca.kwartyl_w_wos }}</div>
                            <div class="praca-mono__metric-label">WoS</div>
                        </div>
                    {% endif %}

                    {% if praca.liczba_cytowan %}
                        <div class="praca-mono__metric-item">
                            <div class="praca-mono__metric-value praca-mono__metric-value--citations">{{ praca.liczba_cytowan }}</div>
                            <div class="praca-mono__metric-label">Cytowania</div>
                        </div>
                    {% endif %}

                    {% if uczelnia.pokazuj_punktacja_snip and praca.punktacja_snip %}
                        <div class="praca-mono__metric-item">
                            <div class="praca-mono__metric-value praca-mono__metric-value--snip">{{ praca.punktacja_snip }}</div>
                            <div class="praca-mono__metric-label">SNIP</div>
                        </div>
                    {% endif %}

                    {% if uczelnia.pokazuj_index_copernicus %}
                        <div class="praca-mono__metric-item">
                            <div class="praca-mono__metric-value praca-mono__metric-value--ic">{{ praca.index_copernicus|default:"0" }}</div>
                            <div class="praca-mono__metric-label">Index Copernicus</div>
                        </div>
                    {% endif %}

                    {% if uczelnia.pokazuj_punktacje_wewnetrzna %}
                        <div class="praca-mono__metric-item">
                            <div class="praca-mono__metric-value praca-mono__metric-value--internal">{{ praca.punktacja_wewnetrzna|default:"0" }}</div>
                            <div class="praca-mono__metric-label">Punktacja wewnętrzna</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Citation Export Card -->
            <div class="praca-mono__card">
                <h3 class="praca-mono__card-title">
                    <span class="fi-download"></span> Eksport cytowania
                    <div class="shaded-hr-div-small"></div>
                </h3>

                <!-- Reference Manager Support Info -->
                <div class="praca-mono__reference-info">
                    <p class="praca-mono__reference-text">
                        <span class="fi-info praca-mono__reference-icon"></span>
                        <strong>Wsparcie dla menedżerów bibliografii:</strong><br>
                        Ta strona wspiera automatyczny import do <strong>Zotero</strong>, <strong>Mendeley</strong> i <strong>EndNote</strong>.
                        Użytkownicy z zainstalowanym rozszerzeniem przeglądarki mogą zapisać tę publikację jednym kliknięciem -
                        ikona pojawi się automatycznie w pasku narzędzi przeglądarki.
                    </p>
                </div>

                <button id="bibtex-toggle-btn" class="button expanded secondary" type="button">
                    Pokaż BibTeX
                </button>
                <button id="bibtex-copy-btn"
                        class="button expanded success praca-mono__bibtex-copy-btn"
                        type="button">
                    Skopiuj do schowka
                </button>
                <span id="bibtex-copy-feedback" class="praca-mono__bibtex-feedback">
                    Skopiowane!
                </span>
                <div id="bibtex-container" class="praca-mono__bibtex-container">
                    <textarea id="bibtex-content" readonly
                              class="praca-mono__bibtex-textarea"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information Card - Show here if no abstracts, taking full width -->
    {% if not praca.streszczenia.exists %}
        <div class="praca-mono__additional-info">
            <div class="praca-mono__card">
                <h3 class="praca-mono__card-title">
                    <span class="fi-widget"></span> Informacje dodatkowe
                    <div class="shaded-hr-div-small"></div>
                </h3>
                <div class="praca-mono__additional-content">
                    <table class="praca-mono__table">
                        {% if praca.charakter_formalny.skrot == "PAT" %}
                            <tr>
                                <td colspan="2" class="praca-mono__patent-cell">
                                    <strong>Patent:</strong><br/>
                                    <div class="praca-mono__patent-details">
                                        <b>Numer zgłoszenia:</b> {{ praca.numer_zgloszenia|default:"brak" }}<br/>
                                        <b>Wydział:</b> {{ praca.wydzial|default:"brak" }}<br/>
                                        <b>Rodzaj prawa:</b> {{ praca.rodzaj_prawa|default:"brak" }}<br/>
                                        <b>Data zgłoszenia:</b> {{ praca.data_zgloszenia|default:"brak" }}<br/>
                                        <b>Data decyzji:</b> {{ praca.data_decyzji|default:"brak" }}<br/>
                                        <b>Numer prawa wyłącznego:</b> {{ praca.numer_prawa_wylacznego|default:"brak" }}<br/>
                                        <b>Wdrożenie:</b> {% if praca.wdrozenie %}tak{% else %}nie{% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endif %}

                        {% if praca.liczba_znakow_wydawniczych %}
                            <tr>
                                <th class="praca-mono__table-cell">Liczba arkuszy wydawniczych:</th>
                                <td class="praca-mono__table-cell">{{ praca.wymiar_wydawniczy_w_arkuszach }}</td>
                            </tr>
                        {% endif %}

                        {% if uczelnia.pokazuj_status_korekty == "always" or uczelnia.pokazuj_status_korekty == "logged-in" and not request.user.is_anonymous %}
                            <tr>
                                <th class="praca-mono__table-cell">Status:</th>
                                <td class="praca-mono__table-cell">{{ praca.status_korekty }}</td>
                            </tr>
                        {% endif %}

                        {% if uczelnia.pokazuj_praca_recenzowana == "always" or uczelnia.pokazuj_praca_recenzowana == "logged-in" and not request.user.is_anonymous %}
                            <tr>
                                <th class="praca-mono__table-cell">Praca recenzowana:</th>
                                <td class="praca-mono__table-cell">{{ praca.recenzowana|yesno }}</td>
                            </tr>
                        {% endif %}

                        {% if praca.ma_procenty %}
                            <tr>
                                <th class="praca-mono__table-cell--vertical-top">Odpowiedzialność za powstanie pracy:
                                </th>
                                <td class="praca-mono__table-cell">
                                    {% for autor in praca.autorzy_set.all %}
                                        {% if autor.procent %}
                                            {{ autor.procent }}% {{ autor.zapisany_jako }}<br/>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endif %}

                        {% if praca.zewnetrzna_baza_danych.exists %}
                            <tr>
                                <th class="praca-mono__table-cell--vertical-top">Zewnętrzna baza danych:</th>
                                <td class="praca-mono__table-cell">
                                    {% for db in praca.zewnetrzna_baza_danych.all %}
                                        {{ db.baza.nazwa }}<br/>
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endif %}

                        {% if praca.wydawnictwa_powiazane_set.exists %}
                            <tr>
                                <th class="praca-mono__table-cell--vertical-top">
                                    Rekordy powiązane ({{ praca.wydawnictwa_powiazane_posortowane.all.count }}):
                                </th>
                                <td class="praca-mono__table-cell">
                                    {% if praca.wydawnictwa_powiazane_posortowane.all.count > 2 %}
                                        <input type="text"
                                               class="related-records-search praca-mono__related-search"
                                               placeholder="Szukaj w rekordach powiązanych...">
                                        <div class="related-records-count praca-mono__related-count"></div>
                                    {% endif %}
                                    <ol class="related-records-list praca-mono__related-list"
                                        data-records='[{% for elem in praca.wydawnictwa_powiazane_posortowane.all %}{"url":"{% url "bpp:browse_praca" "wydawnictwo_zwarte" elem.pk %}","text":"{{ elem.opis_bibliograficzny_cache|safe|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'>
                                        {% for elem in praca.wydawnictwa_powiazane_posortowane.all %}
                                            <li class="praca-mono__related-item">
                                                <a href="{% url "bpp:browse_praca" "wydawnictwo_zwarte" elem.pk %}">
                                                    {{ elem.opis_bibliograficzny_cache|safe }}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ol>
                                </td>
                            </tr>
                        {% endif %}

                        <tr>
                            <th class="praca-mono__table-cell">Rekord utworzony:</th>
                            <td class="praca-mono__table-cell">{{ praca.utworzono }}</td>
                        </tr>

                        <tr>
                            <th class="praca-mono__table-cell">Ostatnia aktualizacja:</th>
                            <td class="praca-mono__table-cell">{{ praca.ostatnio_zmieniony }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Points and Slots Tables -->
    {% if rekord.ma_punktacje_sloty %}
        {% if uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "always" or uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "logged-in" and not request.user.is_anonymous %}
            <div class="praca-mono__slots-section">
                <div class="praca-mono__card">
                    <h3 class="praca-mono__card-title">
                        <span class="fi-torsos-all"></span> Punkty i sloty autorów

                        <div class="praca-mono__header-actions">
                            {% comment %} Check if there are multiple authors with disciplines set {% endcomment %}
                            {% with authors_with_disciplines=rekord.punktacja_autora.select_related|length %}
                            {% if authors_with_disciplines > 0 %}
                                {% if request.user.is_authenticated %}
                                    <a href="{% url "ewaluacja_optymalizuj_publikacje:optymalizuj" rekord.slug %}"
                                       class="print-button print-button-header praca-mono__optimize-button"
                                       title="Optymalizuj przypisanie dyscyplin">
                                        <span class="fi-wrench"></span> Optymalizuj
                                    </a>
                                {% endif %}
                            {% endif %}
                            {% endwith %}

                            {% if uczelnia.drukuj_oswiadczenia %}
                                {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                                    <a target="_blank"
                                       href="{% url "oswiadczenia:wiele-oswiadczen" rekord.id.0 rekord.id.1 %}"
                                       class="print-button print-button-header"
                                       title="Wydrukuj wszystkie oświadczenia">
                                        <span class="fi-print"></span>
                                    </a>
                                {% endif %}
                            {% endif %}
                        </div>

                        <div class="shaded-hr-div-small"></div>
                    </h3>

                    <div class="praca-mono__slots-overflow">
                        <table class="praca-mono__slots-table">
                            <thead class="praca-mono__slots-thead">
                            <tr>
                                <th class="praca-mono__slots-th">Autor</th>
                                <th class="praca-mono__slots-th">Dyscyplina</th>
                                <th class="praca-mono__slots-th praca-mono__slots-th--center">PkD / PkDAut</th>
                                <th class="praca-mono__slots-th praca-mono__slots-th--center">Slot</th>
                                {% if uczelnia.drukuj_oswiadczenia %}
                                    {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                                        <th class="praca-mono__slots-th praca-mono__slots-th--center">Oswiadczenia</th>
                                    {% endif %}
                                {% endif %}
                            </tr>
                            </thead>
                            <tbody>
                            {% for pa in rekord.punktacja_autora.select_related %}
                                <tr class="praca-mono__slots-tr">
                                    <td class="praca-mono__slots-td">{{ pa.autor }}</td>
                                    <td class="praca-mono__slots-td">{{ pa.dyscyplina.nazwa }}</td>
                                    <td class="praca-mono__slots-td praca-mono__slots-td--center">
                                        <span class="praca-mono__slot-badge praca-mono__slot-badge--pkdaut">{{ pa.pkdaut }}</span>
                                    </td>
                                    <td class="praca-mono__slots-td praca-mono__slots-td--center">
                                        <span class="praca-mono__slot-badge praca-mono__slot-badge--slot">{{ pa.slot }}</span>
                                    </td>
                                    {% if uczelnia.drukuj_oswiadczenia %}
                                        {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                                            <td class="praca-mono__slots-td praca-mono__slots-td--center">
                                                <a target="_blank"
                                                   title="Wydruk dyscypliny zgloszonej dla publikacji"
                                                   href="{% url "oswiadczenia:jedno-oswiadczenie" rekord.id.0 rekord.id.1 pa.autor.id pa.dyscyplina.id %}"
                                                   class="print-button print-button-small">
                                                    <span class="fi-print"></span>
                                                </a>
                                                {% if pa.czy_autor_ma_alternatywna_dyscypline and uczelnia.drukuj_alternatywne_oswiadczenia %}
                                                    &nbsp;
                                                    <a target="_blank"
                                                       title="Wydruk alternatywnej dyscypliny autora"
                                                       href="{% url "oswiadczenia:jedno-oswiadczenie-druga-dyscyplina" rekord.id.0 rekord.id.1 pa.autor.id pa.dyscyplina.id %}"
                                                       class="print-button print-button-small print-button-alt">
                                                        <span class="fi-print"></span>
                                                    </a>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <h3 class="praca-mono__slots-subtitle">
                        <span class="fi-graph-trend"></span> Punkty i sloty dyscyplin
                        <div class="shaded-hr-div-small"></div>
                    </h3>

                    <div class="praca-mono__slots-overflow">
                        <table class="praca-mono__slots-table">
                            <thead class="praca-mono__slots-thead">
                            <tr>
                                <th class="praca-mono__slots-th">Dyscyplina</th>
                                <th class="praca-mono__slots-th praca-mono__slots-th--center">PkD / PkDAut</th>
                                <th class="praca-mono__slots-th praca-mono__slots-th--center">Slot</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for pd in rekord.punktacja_dyscypliny.select_related %}
                                <tr class="praca-mono__slots-tr">
                                    <td class="praca-mono__slots-td">{{ pd.dyscyplina.nazwa }}</td>
                                    <td class="praca-mono__slots-td praca-mono__slots-td--center">
                                        <span class="praca-mono__slot-badge praca-mono__slot-badge--pkd">{{ pd.pkd }}</span>
                                    </td>
                                    <td class="praca-mono__slots-td praca-mono__slots-td--center">
                                        <span class="praca-mono__slot-badge praca-mono__slot-badge--discipline-slot">{{ pd.slot }}</span>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <!-- Additional Information Card - Show here if there are abstracts -->
    {% if praca.streszczenia.exists %}
        <div class="praca-mono__additional-info">
            <div class="praca-mono__card">
                <h3 class="praca-mono__card-title">
                    <span class="fi-widget"></span> Informacje dodatkowe
                    <div class="shaded-hr-div"></div>
                </h3>
                <div class="praca-mono__additional-content">
                    <table class="praca-mono__table">
                        {% if praca.charakter_formalny.skrot == "PAT" %}
                            <tr>
                                <td colspan="2" class="praca-mono__patent-cell">
                                    <strong>Patent:</strong><br/>
                                    <div class="praca-mono__patent-details">
                                        <b>Numer zgłoszenia:</b> {{ praca.numer_zgloszenia|default:"brak" }}<br/>
                                        <b>Wydział:</b> {{ praca.wydzial|default:"brak" }}<br/>
                                        <b>Rodzaj prawa:</b> {{ praca.rodzaj_prawa|default:"brak" }}<br/>
                                        <b>Data zgłoszenia:</b> {{ praca.data_zgloszenia|default:"brak" }}<br/>
                                        <b>Data decyzji:</b> {{ praca.data_decyzji|default:"brak" }}<br/>
                                        <b>Numer prawa wyłącznego:</b> {{ praca.numer_prawa_wylacznego|default:"brak" }}<br/>
                                        <b>Wdrożenie:</b> {% if praca.wdrozenie %}tak{% else %}nie{% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endif %}

                        {% if praca.liczba_znakow_wydawniczych %}
                            <tr>
                                <th class="praca-mono__table-cell">Liczba arkuszy wydawniczych:</th>
                                <td class="praca-mono__table-cell">{{ praca.wymiar_wydawniczy_w_arkuszach }}</td>
                            </tr>
                        {% endif %}

                        {% if uczelnia.pokazuj_status_korekty == "always" or uczelnia.pokazuj_status_korekty == "logged-in" and not request.user.is_anonymous %}
                            <tr>
                                <th class="praca-mono__table-cell">Status:</th>
                                <td class="praca-mono__table-cell">{{ praca.status_korekty }}</td>
                            </tr>
                        {% endif %}

                        {% if uczelnia.pokazuj_praca_recenzowana == "always" or uczelnia.pokazuj_praca_recenzowana == "logged-in" and not request.user.is_anonymous %}
                            <tr>
                                <th class="praca-mono__table-cell">Praca recenzowana:</th>
                                <td class="praca-mono__table-cell">{{ praca.recenzowana|yesno }}</td>
                            </tr>
                        {% endif %}

                        {% if praca.ma_procenty %}
                            <tr>
                                <th class="praca-mono__table-cell--vertical-top">Odpowiedzialność za powstanie pracy:
                                </th>
                                <td class="praca-mono__table-cell">
                                    {% for autor in praca.autorzy_set.all %}
                                        {% if autor.procent %}
                                            {{ autor.procent }}% {{ autor.zapisany_jako }}<br/>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endif %}

                        {% if praca.zewnetrzna_baza_danych.exists %}
                            <tr>
                                <th class="praca-mono__table-cell--vertical-top">Zewnętrzna baza danych:</th>
                                <td class="praca-mono__table-cell">
                                    {% for db in praca.zewnetrzna_baza_danych.all %}
                                        {{ db.baza.nazwa }}<br/>
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endif %}

                        {% if praca.wydawnictwa_powiazane_set.exists %}
                            <tr>
                                <th class="praca-mono__table-cell--vertical-top">
                                    Rekordy powiązane ({{ praca.wydawnictwa_powiazane_posortowane.all.count }}):
                                </th>
                                <td class="praca-mono__table-cell">
                                    {% if praca.wydawnictwa_powiazane_posortowane.all.count > 2 %}
                                        <input type="text"
                                               class="related-records-search praca-mono__related-search"
                                               placeholder="Szukaj w rekordach powiązanych...">
                                        <div class="related-records-count praca-mono__related-count"></div>
                                    {% endif %}
                                    <ol class="related-records-list praca-mono__related-list"
                                        data-records='[{% for elem in praca.wydawnictwa_powiazane_posortowane.all %}{"url":"{% url "bpp:browse_praca" "wydawnictwo_zwarte" elem.pk %}","text":"{{ elem.opis_bibliograficzny_cache|safe|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'>
                                        {% for elem in praca.wydawnictwa_powiazane_posortowane.all %}
                                            <li class="praca-mono__related-item">
                                                <a href="{% url "bpp:browse_praca" "wydawnictwo_zwarte" elem.pk %}">
                                                    {{ elem.opis_bibliograficzny_cache|safe }}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ol>
                                </td>
                            </tr>
                        {% endif %}

                        <tr>
                            <th class="praca-mono__table-cell">Rekord utworzony:</th>
                            <td class="praca-mono__table-cell">{{ praca.utworzono }}</td>
                        </tr>

                        <tr>
                            <th class="praca-mono__table-cell">Ostatnia aktualizacja:</th>
                            <td class="praca-mono__table-cell">{{ praca.ostatnio_zmieniony }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- "Odpięte" dyscypliny -->
    {% if rekord.ma_odpiete_dyscypliny %}
        {% if uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "always" or uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "logged-in" and not request.user.is_anonymous %}
            <div class="praca-mono__detached-section">
                <div class="praca-mono__card praca-mono__card--detached">
                    <h3 class="praca-mono__card-title">
                        <span class="fi-unlink"></span> "Odpięte" dyscypliny
                        <div class="shaded-hr-div-small"></div>
                    </h3>
                    <table class="praca-mono__slots-table">
                        <thead class="praca-mono__slots-thead praca-mono__slots-thead--detached">
                        <tr>
                            <th class="praca-mono__slots-th">Autor</th>
                            <th class="praca-mono__slots-th">Dyscyplina</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for pa in praca.odpiete_dyscypliny.select_related %}
                            <tr class="praca-mono__slots-tr praca-mono__slots-tr--detached">
                                <td class="praca-mono__slots-td">{{ pa.autor }}</td>
                                <td class="praca-mono__slots-td">{{ pa.dyscyplina_naukowa.nazwa }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>

<!-- JavaScript for interactive elements -->
<script type="text/javascript">
    (function ($) {
        $(document).ready(function () {
            // BibTeX functionality
            var bibtexToggleBtn = $('#bibtex-toggle-btn');
            var bibtexContainer = $('#bibtex-container');
            var bibtexContent = $('#bibtex-content');
            var bibtexCopyBtn = $('#bibtex-copy-btn');
            var bibtexCopyFeedback = $('#bibtex-copy-feedback');
            var bibtexLoaded = false;

            bibtexToggleBtn.click(function () {
                if (bibtexContainer.is(':visible')) {
                    bibtexContainer.hide();
                    bibtexToggleBtn.text('Pokaż BibTeX');
                    bibtexCopyBtn.hide();
                } else {
                    if (!bibtexLoaded) {
                        loadBibTeX();
                    } else {
                        bibtexContainer.show();
                        bibtexToggleBtn.text('Ukryj BibTeX');
                        bibtexCopyBtn.show();
                    }
                }
            });

            bibtexCopyBtn.click(function () {
                copyToClipboard();
            });

            function loadBibTeX() {
                bibtexToggleBtn.prop('disabled', true).text('⏳ Ładowanie...');
                var modelName = '{{ rekord.content_type.model }}';
                var pk = '{{ praca.pk }}';
                var url = '/bpp/api/bibtex/' + modelName + '/' + pk + '/';

                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        bibtexContent.val(data.bibtex);
                        bibtexContainer.show();
                        bibtexToggleBtn.text('Ukryj BibTeX');
                        bibtexCopyBtn.show();
                        bibtexLoaded = true;
                    },
                    error: function (xhr, status, error) {
                        var errorMsg = 'Błąd podczas pobierania BibTeX';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg += ': ' + xhr.responseJSON.error;
                        }
                        bibtexContent.val(errorMsg);
                        bibtexContainer.show();
                        bibtexToggleBtn.text('Ukryj BibTeX (błąd)');
                    },
                    complete: function () {
                        bibtexToggleBtn.prop('disabled', false);
                    }
                });
            }

            function copyToClipboard() {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(bibtexContent.val()).then(function () {
                        showCopyFeedback();
                    }, function (err) {
                        fallbackCopy();
                    });
                } else {
                    fallbackCopy();
                }
            }

            function fallbackCopy() {
                bibtexContent.select();
                bibtexContent[0].setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    showCopyFeedback();
                } catch (err) {
                    alert('Nie można skopiować do schowka. Proszę zaznacz tekst i skopiuj ręcznie (Ctrl+C).');
                }
            }

            function showCopyFeedback() {
                bibtexCopyFeedback.show();
                setTimeout(function () {
                    bibtexCopyFeedback.fadeOut();
                }, 2000);
            }

            // Check if there are many authors and implement show/hide
            var authorsList = $('.author-name');
            if (authorsList.length > 10) {
                // Implementation for show more authors would go here
            }

            // Related records search functionality
            $('.related-records-search').each(function() {
                var searchInput = $(this);
                var list = searchInput.siblings('.related-records-list');
                var countDisplay = searchInput.siblings('.related-records-count');

                // Parse records data from data attribute
                var allRecords = [];
                try {
                    allRecords = JSON.parse(list.attr('data-records') || '[]');
                } catch(e) {
                    console.error('Failed to parse records data:', e);
                    return;
                }

                var totalCount = allRecords.length;

                // Initial count display
                updateCount(totalCount, totalCount);

                searchInput.on('input', function() {
                    var searchTerm = $(this).val().toLowerCase().trim();

                    if (searchTerm === '') {
                        // Show all records
                        rebuildList(allRecords);
                        updateCount(totalCount, totalCount);
                    } else {
                        // Filter records
                        var filtered = allRecords.filter(function(record) {
                            return record.text.toLowerCase().indexOf(searchTerm) !== -1;
                        });

                        // Rebuild list with filtered records and highlighting
                        rebuildList(filtered, searchTerm);
                        updateCount(filtered.length, totalCount);
                    }
                });

                function rebuildList(records, searchTerm) {
                    // Clear list
                    list.empty();

                    // Add each record
                    records.forEach(function(record) {
                        var text = record.text;

                        // Add simple highlighting if search term provided
                        if (searchTerm) {
                            var escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            var regex = new RegExp('(' + escapedTerm + ')', 'gi');
                            text = text.replace(regex, '<mark style="background-color: #fff59d; padding: 2px;">$1</mark>');
                        }

                        var li = $('<li style="margin-bottom: 8px;"></li>');
                        var a = $('<a></a>').attr('href', record.url).html(text);
                        li.append(a);
                        list.append(li);
                    });
                }

                function updateCount(visible, total) {
                    if (visible === total) {
                        countDisplay.text('Wszystkie rekordy (' + total + ')');
                    } else {
                        countDisplay.text('Znaleziono ' + visible + ' z ' + total + ' rekordów');
                    }
                }
            });
        });
    })(jQuery || django.jQuery || $);

    // Event delegation for copy text (data-copy-text)
    document.addEventListener('click', function(e) {
        var target = e.target.closest('[data-copy-text]');
        if (!target) return;

        var text = target.dataset.copyText;
        copyTextToClipboard(text, target);
        e.preventDefault();
    });

    // Event delegation for copy content (data-copy-content)
    document.addEventListener('click', function(e) {
        var target = e.target.closest('[data-copy-content]');
        if (!target) return;

        var textContent = target.innerText || target.textContent;
        var feedbackDiv = document.getElementById('copy-biblio-feedback');
        copyTextToClipboard(textContent, null, feedbackDiv);
    });

    // Helper function for clipboard operations
    function copyTextToClipboard(text, button, feedbackDiv) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(function() {
                showCopyFeedback(button, feedbackDiv);
            }, function(err) {
                fallbackCopy(text, button, feedbackDiv);
            });
        } else {
            fallbackCopy(text, button, feedbackDiv);
        }
    }

    function fallbackCopy(text, button, feedbackDiv) {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            document.execCommand('copy');
            showCopyFeedback(button, feedbackDiv);
        } catch (err) {
            alert('Nie można skopiować do schowka.');
        }

        document.body.removeChild(textarea);
    }

    function showCopyFeedback(button, feedbackDiv) {
        if (button) {
            button.classList.add('copied');
            // Store original icon element
            var originalIcon = button.querySelector('i');
            var originalClass = originalIcon ? originalIcon.className : '';
            // Change to check icon
            if (originalIcon) {
                originalIcon.className = 'fi-check';
            }
            setTimeout(function() {
                button.classList.remove('copied');
                // Restore original icon
                if (originalIcon) {
                    originalIcon.className = originalClass;
                }
            }, 2000);
        }
        if (feedbackDiv) {
            feedbackDiv.style.display = 'block';
            setTimeout(function() {
                feedbackDiv.style.display = 'none';
            }, 2000);
        }
    }
</script>
