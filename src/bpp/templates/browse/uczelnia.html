{% extends "base.html" %}
{% load user_in_group deklinacja cache %}

{% block extratitle %}
    Uczelnia
{% endblock %}

{% block breadcrumbs-html %}
    <!-- Tips section in place of breadcrumbs for main page -->
        <div id="breadcrumbs-wrapper" class="grid-container-fluid hide-for-small-only breadcrumbs-tips-wrapper">
        <div class="grid-x">
            <div class="cell">
                <div id="rotating-tips">
                    <div class="tip-content">
                        <i class="fi-lightbulb"></i> <strong>Porady BPP:</strong> <span id="tip-text">Ładowanie porad...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const tips = [
            'Użyj <a href="/multiseek/">wyszukiwarki zaawansowanej</a> aby znaleźć publikacje według różnych kryteriów.',
            'W <a href="/admin/">panelu administracyjnym</a> możesz zarządzać rekordami publikacji i autorów.',
            'Skorzystaj z <a href="/bpp/ranking-autorow/">rankingu autorów</a> aby zobaczyć najaktywniejszych badaczy.',
            'Funkcja <strong>eksportu do PBN</strong> pozwala na synchronizację danych z Polską Bibliografią Naukową.',
            'W module <strong>raportów</strong> znajdziesz szczegółowe zestawienia publikacji według jednostek i wydziałów.',
            'Użyj filtrów <strong>według roku</strong> aby ograniczyć wyniki wyszukiwania do określonego okresu.',
            'System automatycznie <strong>przypisuje punktację</strong> publikacjom zgodnie z aktualnymi listami ministeralnymi.',
            'Funkcja <strong>duplikatów</strong> pomaga w identyfikacji i usuwaniu powtarzających się rekordów.',
            'W <strong>profilach autorów</strong> znajdziesz pełną listę ich publikacji i współprac.',
            'System obsługuje import danych z <strong>zewnętrznych baz</strong> jak CrossRef czy Web of Science.',
            'Użyj opcji <strong>"Zgłoś publikację"</strong> aby dodać nowe pozycje do bazy danych.',
            'Funkcja <strong>oświadczeń autorów</strong> pozwala na przypisanie publikacji do właściwych dyscyplin naukowych.',
            'W module <strong>statystyk</strong> znajdziesz wykresy pokazujące trendy publikacyjne uczelni.',
            'System automatycznie <strong>aktualizuje cytowania</strong> z baz Web of Science i Scopus.',
            'Skorzystaj z <strong>eksportu do BibTeX</strong> aby zaimportować publikacje do programów bibliograficznych.'
        ];

        const tipTextElement = document.getElementById('tip-text');
        const tipContentElement = document.querySelector('.tip-content');
        let usedTips = [];

        function getRandomTip() {
            // If all tips have been used, reset the array
            if (usedTips.length >= tips.length) {
                usedTips = [];
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * tips.length);
            } while (usedTips.includes(randomIndex));

            usedTips.push(randomIndex);
            return tips[randomIndex];
        }

        function showNextTip() {
            // Fade out current tip
            tipContentElement.style.opacity = '0';

            setTimeout(function() {
                // Change text while invisible
                tipTextElement.innerHTML = getRandomTip();
                tipContentElement.style.display = 'block';

                // Fade in new tip
                setTimeout(function() {
                    tipContentElement.style.opacity = '1';
                }, 50);
            }, 500); // Wait for fade out to complete
        }

        // Show first tip immediately
        tipTextElement.innerHTML = getRandomTip();
        tipContentElement.style.display = 'block';
        setTimeout(function() {
            tipContentElement.style.opacity = '1';
        }, 100);

        // Rotate tips every 15 seconds
        setInterval(showNextTip, 15000);
    });
    </script>
{% endblock %}

{% block content %}
    <div class="grid-x grid-padding-x align-middle align-center">
        {% if uczelnia.logo_www %}
            <div class="large-4 medium-2 cell">
                <img src="/media/{{ uczelnia.logo_www }}"
                     alt="Logo {{ uczelnia.nazwa_dopelniacz }}"
                />
            </div>
        {% endif %}
        <div class="large-6 medium-10 cell">
            <h2>
                Bibliografia Publikacji Pracowników<br/>
                {{ uczelnia.nazwa_dopelniacz }}
            </h2>
        </div>
        <div class="large-12 cell">
            <div class="shaded-hr-div"></div>
        </div>
        <div class="large-12 cell uczelnia-main-content">
            <a href="/zglos_publikacje/nowe_zgloszenie/" class=" main-page-button-primary">
                <i class="fi-page-add"></i> Masz nową publikację? Dodaj ją do bazy
            </a>
            {% if total_rekord_count > 25000 %}
                <form method="post" action="{% url 'bpp:browse_build_search' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="zakres_lat" value="[2022,{{ current_year }}]">
                    <input type="hidden" name="suggested-title" value="Cała baza to {{ total_rekord_count }} rekordów. Oglądasz wycinek - rekordy od 2022r"/>
                    <button type="submit" class="main-page-button-secondary" style="border: none; background: none; padding: 0;">
                        <span class="main-page-button-secondary" style="display: inline-block;">
                            <i class="fi-magnifying-glass"></i> Przeglądaj najnowsze prace
                        </span>
                    </button>
                </form>
            {% else %}
                <a href="{% url 'multiseek:index' %}" class="main-page-button-secondary">
                    <i class="fi-magnifying-glass"></i> Przeglądaj wszystkie prace
                </a>
            {% endif %}
        </div>
        <div class="large-12 cell">
            <div class="shaded-hr-div"></div>
        </div>
    </div>

    <div class="grid-x grid-margin-x">
        {% if article %}
            <div class="small-12 large-6 cell">
                <article class="single-article-container">
                    <div class="article-header">
                        <nav class="article-breadcrumb">
                            <a href=".." class="back-link">
                                <i class="fi-arrow-left"></i> Powrót do strony głównej
                            </a>
                        </nav>
                        <h1 class="article-main-title">{{ article.title }}</h1>
                        <div class="article-metadata">
                            <div class="metadata-item">
                                <i class="fi-calendar"></i>
                                <time datetime="{{ article.published_on|date:'Y-m-d' }}">
                                    {{ article.published_on|date:"j E Y, H:i" }}
                                </time>
                            </div>
                            {% if article.author %}
                                <div class="metadata-item">
                                    <i class="fi-torso"></i>
                                    <span>{{ article.author }}</span>
                                </div>
                            {% endif %}
                            {% if request.user.is_superuser or request.user|has_group:"web" %}
                                <div class="metadata-item admin-link">
                                    {% include "browse/go_to_admin_change.html" with group="web" url="admin:miniblog_article_change" pk=article.pk text="<i class='fi-pencil'></i> Edytuj artykuł" %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="article-body">
                        {{ article.article_body.content|safe }}
                    </div>
                </article>
            </div>
        {% else %}
            {% if request.user.is_superuser or request.user|has_group:"web" %}
                <div class="small-12 large-6 cell">
                    <h3 class="section-title">
                        <i class="fi-megaphone section-icon"></i>Aktualności
                    </h3>
                    <div class="news-articles">
                        {% for article in miniblog %}
                            <article class="news-article-card">
                                <div class="article-date-badge">
                                    <span class="day">{{ article.published_on|date:"d" }}</span>
                                    <span class="month">{{ article.published_on|date:"M" }}</span>
                                    <span class="year">{{ article.published_on|date:"Y" }}</span>
                                </div>
                                <div class="article-content">
                                    <h4 class="article-title">
                                        <a href="{% url "bpp:browse_artykul" uczelnia.slug article.slug %}">
                                            {{ article.title }}
                                        </a>
                                    </h4>
                                    <div class="article-meta">
                                        <i class="fi-calendar"></i> {{ article.published_on|date:"j E Y" }}
                                    </div>
                                    <div class="article-excerpt">
                                        {{ article.article_body.excerpt|safe }}
                                    </div>
                                    {% if article.article_body.has_more %}
                                        <div class="article-read-more">
                                            <a href="{% url "bpp:browse_artykul" uczelnia.slug article.slug %}" class="read-more-link">
                                                Czytaj więcej <i class="fi-arrow-right"></i>
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </article>
                        {% empty %}
                            <div class="news-empty-state">
                                <p><i class="fi-page"></i> Brak opublikowanych aktualności.</p>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="news-admin-links">
                        {% include "browse/go_to_admin_list.html" with group="web" url="admin:miniblog_article_changelist" text="<i class='fi-wrench'></i> zarządzaj aktualnościami" %}
                        {% include "browse/go_to_admin_list.html" with group="web" url="admin:miniblog_article_add" text="<i class='fi-page-add'></i> dodaj artykuł" %}
                    </div>
                </div>
            {% elif miniblog.exists %}
                <div class="small-12 large-6 cell">
                    <h3 class="section-title">
                        <i class="fi-megaphone section-icon"></i>Aktualności
                    </h3>
                    <div class="news-articles">
                        {% for article in miniblog %}
                            <article class="news-article-card">
                                <div class="article-date-badge">
                                    <span class="day">{{ article.published_on|date:"d" }}</span>
                                    <span class="month">{{ article.published_on|date:"M" }}</span>
                                    <span class="year">{{ article.published_on|date:"Y" }}</span>
                                </div>
                                <div class="article-content">
                                    <h4 class="article-title">
                                        <a href="{% url "bpp:browse_artykul" uczelnia.slug article.slug %}">
                                            {{ article.title }}
                                        </a>
                                    </h4>
                                    <div class="article-meta">
                                        <i class="fi-calendar"></i> {{ article.published_on|date:"j E Y" }}
                                    </div>
                                    <div class="article-excerpt">
                                        {{ article.article_body.excerpt|safe }}
                                    </div>
                                    {% if article.article_body.has_more %}
                                        <div class="article-read-more">
                                            <a href="{% url "bpp:browse_artykul" uczelnia.slug article.slug %}" class="read-more-link">
                                                Czytaj więcej <i class="fi-arrow-right"></i>
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endif %}
        {% if uczelnia.pokazuj_wydzialy_na_pierwszej_stronie %}
            {% if not miniblog.exists and not request.user.is_superuser and not request.user|has_group:"web" %}
                <div class="small-12 large-12 cell">
                    <h3 class="section-title">
                        <i class="fi-foundation section-icon"></i>Wybierz {% rzeczownik_wydział %}
                    </h3>
                    <div class="grid-x grid-margin-x">
                        {% for wydzial in uczelnia.wydzialy %}
                            <div class="small-12 medium-6 large-6 cell">
                                <div class="wydzial-card">
                                    <div class="arrow-icon">
                                        <i class="fi-arrow-right"></i>
                                    </div>
                                    <a href="{% url "bpp:browse_wydzial" wydzial.slug %}">
                                        {{ wydzial }}
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% include "browse/go_to_admin_list.html" with group="struktura" url="admin:bpp_wydzial_changelist" text="<i class='fi-wrench'></i> zarządzaj wydziałami" %}
                    {% include "browse/go_to_admin_change.html" with url="admin:bpp_uczelnia_change" pk=uczelnia.pk group="struktura" text="ustawienia dla uczelni" %}
                </div>
            {% else %}
                <div class="small-12 large-6 cell">
                    <h3 class="section-title">
                        <i class="fi-foundation section-icon"></i>Wybierz {% rzeczownik_wydział %}
                    </h3>
                    <div class="wydzial-list">
                        {% for wydzial in uczelnia.wydzialy %}
                            <div class="wydzial-card">
                                <div class="arrow-icon">
                                    <i class="fi-arrow-right"></i>
                                </div>
                                <a href="{% url "bpp:browse_wydzial" wydzial.slug %}">
                                    {{ wydzial }}
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                    {% include "browse/go_to_admin_list.html" with group="struktura" url="admin:bpp_wydzial_changelist" text="<i class='fi-wrench'></i> zarządzaj wydziałami" %}
                    {% include "browse/go_to_admin_change.html" with url="admin:bpp_uczelnia_change" pk=uczelnia.pk group="struktura" text="ustawienia dla uczelni" %}
                </div>
            {% endif %}
        {% endif %}
    {% if uczelnia.pokazuj_jednostki_na_pierwszej_stronie %}
        {% if not miniblog.exists and not request.user.is_superuser and not request.user|has_group:"web" %}
            <div class="small-12 large-12 cell">{% load deklinacja %}
                <h3 class="section-title">
                    <i class="fi-home section-icon"></i>Wybierz {% rzeczownik_jednostkę %}
                </h3>
                <div class="grid-x grid-margin-x">
                    {% for jednostka in uczelnia.jednostki %}
                        <div class="small-12 medium-6 large-6 cell">
                            <div class="jednostka-card-main">
                                <div class="arrow-icon">
                                    <i class="fi-arrow-right"></i>
                                </div>
                                <a href="{% url "bpp:browse_jednostka" jednostka.slug %}">
                                    {{ jednostka }}
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% include "browse/go_to_admin_list.html" with group="struktura" url="admin:bpp_jednostka_changelist" text="<i class='fi-wrench'></i> zarządzaj jednostkami" %}
                {% include "browse/go_to_admin_change.html" with url="admin:bpp_uczelnia_change" pk=uczelnia.pk group="struktura" text="ustawienia dla uczelni" %}
            </div>
        {% else %}
            <div class="small-12 large-6 cell">{% load deklinacja %}
                <h3 class="section-title">
                    <i class="fi-home section-icon"></i>Wybierz {% rzeczownik_jednostkę %}
                </h3>
                <div class="jednostka-list">
                    {% for jednostka in uczelnia.jednostki %}
                        <div class="jednostka-card-main">
                            <div class="arrow-icon">
                                <i class="fi-arrow-right"></i>
                            </div>
                            <a href="{% url "bpp:browse_jednostka" jednostka.slug %}">
                                {{ jednostka }}
                            </a>
                        </div>
                    {% endfor %}
                </div>
                {% include "browse/go_to_admin_list.html" with group="struktura" url="admin:bpp_jednostka_changelist" text="<i class='fi-wrench'></i> zarządzaj jednostkami" %}
                {% include "browse/go_to_admin_change.html" with url="admin:bpp_uczelnia_change" pk=uczelnia.pk group="struktura" text="ustawienia dla uczelni" %}
            </div>
        {% endif %}
    {% endif %}
    </div>

    {% if recently_updated or recent_abstracts %}
        <div class="grid-x grid-margin-x">
            {% if recently_updated %}
                {% cache 3600 recent_publications uczelnia.pk %}
                <div class="small-12 large-6 cell">
                    <h3 class="section-title" style="margin-top: 30px;">
                        <i class="fi-book section-icon"></i>Niedawno zaktualizowane rekordy
                    </h3>
                    <ul class="no-bullet">
                        {% for rekord in recently_updated %}
                            <li class="recent-publication-item">
                                <a href="{{ rekord.get_absolute_url }}">
                                    {{ rekord.opis_bibliograficzny_cache|safe }}
                                </a>
                                <div class="publication-meta">
                                    {{ rekord.ostatnio_zmieniony|date:"d.m.Y H:i" }}
                                    {% if rekord.rok %} &bull; {{ rekord.rok }}{% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                    <div class="text-center" style="margin-top: 15px;">
                        <a href="/multiseek/" class="button secondary expanded">Zobacz wszystkie publikacje</a>
                    </div>
                </div>
                {% endcache %}
            {% endif %}

            {% if recent_abstracts %}
                {% cache 3600 recent_abstracts uczelnia.pk %}
                <div class="small-12 large-6 cell">
                    <h3 class="section-title" style="margin-top: 30px;">
                        <i class="fi-page-multiple section-icon"></i>Najnowsze streszczenia
                    </h3>
                    <ul class="no-bullet">
                        {% for rekord in recent_abstracts %}
                            <li class="recent-abstract-item">
                                <a href="{{ rekord.rekord.get_absolute_url }}">
                                    {{ rekord.rekord.opis_bibliograficzny_cache|safe }}
                                </a>
                                <div class="abstract-content">
                                    {{ rekord.streszczenie|safe|truncatewords:130 }}
                                </div>
                                <div class="abstract-meta">
                                    {{ rekord.ostatnio_zmieniony|date:"d.m.Y H:i" }}
                                    {% if rekord.rok %} &bull; {{ rekord.rok }}{% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcache %}
            {% endif %}
        </div>
    {% endif %}

{% endblock %}
