{% extends "base.html" %}
{% load user_in_group deklinacja cache %}

{% block extratitle %}
    Uczelnia
{% endblock %}

{% block breadcrumbs-html %}
    <!-- Tips section in place of breadcrumbs for main page -->
        <div id="breadcrumbs-wrapper" class="grid-container-fluid hide-for-small-only" style="background-color: rgba(240, 240, 240, 0.85); border-bottom: 1px solid #d6d6d6; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 50px; z-index: 1; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);">
        <div class="grid-x">
            <div class="cell">
                <div id="rotating-tips" style="text-align: center; font-size: 14px; line-height: 1.4;">
                    <div class="tip-content" style="display: none; opacity: 0; transition: opacity 0.5s ease-in-out;">
                        <i class="fi-lightbulb"></i> <strong>Porady BPP:</strong> <span id="tip-text">Ładowanie porad...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const tips = [
            'Użyj <a href="/multiseek/">wyszukiwarki zaawansowanej</a> aby znaleźć publikacje według różnych kryteriów.',
            'W <a href="/admin/">panelu administracyjnym</a> możesz zarządzać rekordami publikacji i autorów.',
            'Skorzystaj z <a href="/bpp/ranking-autorow/">rankingu autorów</a> aby zobaczyć najaktywniejszych badaczy.',
            'Funkcja <strong>eksportu do PBN</strong> pozwala na synchronizację danych z Polską Bibliografią Naukową.',
            'W module <strong>raportów</strong> znajdziesz szczegółowe zestawienia publikacji według jednostek i wydziałów.',
            'Użyj filtrów <strong>według roku</strong> aby ograniczyć wyniki wyszukiwania do określonego okresu.',
            'System automatycznie <strong>przypisuje punktację</strong> publikacjom zgodnie z aktualnymi listami ministeralnymi.',
            'Funkcja <strong>duplikatów</strong> pomaga w identyfikacji i usuwaniu powtarzających się rekordów.',
            'W <strong>profilach autorów</strong> znajdziesz pełną listę ich publikacji i współprac.',
            'System obsługuje import danych z <strong>zewnętrznych baz</strong> jak CrossRef czy Web of Science.',
            'Użyj opcji <strong>"Zgłoś publikację"</strong> aby dodać nowe pozycje do bazy danych.',
            'Funkcja <strong>oświadczeń autorów</strong> pozwala na przypisanie publikacji do właściwych dyscyplin naukowych.',
            'W module <strong>statystyk</strong> znajdziesz wykresy pokazujące trendy publikacyjne uczelni.',
            'System automatycznie <strong>aktualizuje cytowania</strong> z baz Web of Science i Scopus.',
            'Skorzystaj z <strong>eksportu do BibTeX</strong> aby zaimportować publikacje do programów bibliograficznych.'
        ];

        const tipTextElement = document.getElementById('tip-text');
        const tipContentElement = document.querySelector('.tip-content');
        let usedTips = [];

        function getRandomTip() {
            // If all tips have been used, reset the array
            if (usedTips.length >= tips.length) {
                usedTips = [];
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * tips.length);
            } while (usedTips.includes(randomIndex));

            usedTips.push(randomIndex);
            return tips[randomIndex];
        }

        function showNextTip() {
            // Fade out current tip
            tipContentElement.style.opacity = '0';

            setTimeout(function() {
                // Change text while invisible
                tipTextElement.innerHTML = getRandomTip();
                tipContentElement.style.display = 'block';

                // Fade in new tip
                setTimeout(function() {
                    tipContentElement.style.opacity = '1';
                }, 50);
            }, 500); // Wait for fade out to complete
        }

        // Show first tip immediately
        tipTextElement.innerHTML = getRandomTip();
        tipContentElement.style.display = 'block';
        setTimeout(function() {
            tipContentElement.style.opacity = '1';
        }, 100);

        // Rotate tips every 15 seconds
        setInterval(showNextTip, 15000);
    });
    </script>
{% endblock %}

{% block content %}
    <div class="grid-x grid-padding-x align-middle align-center">
        {% if uczelnia.logo_www %}
            <div class="large-4 medium-2 cell">
                <img src="/media/{{ uczelnia.logo_www }}"
                     alt="Logo {{ uczelnia.nazwa_dopelniacz }}"
                />
            </div>
        {% endif %}
        <div class="large-6 medium-10 cell">
            <h2>
                Bibliografia Publikacji Pracowników<br/>
                {{ uczelnia.nazwa_dopelniacz }}
            </h2>
        </div>
        <div class="large-12 cell">
            <div class="shaded-hr-div"></div>
        </div>
        <div class="large-12 cell" style="text-align: center; margin: 20px 0;">
            <a href="/zglos_publikacje/nowe_zgloszenie/" class="button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; padding: 10px 18px; font-size: 14px; font-weight: 500; box-shadow: 0 3px 6px rgba(102, 126, 234, 0.2); transition: all 0.3s ease; margin-right: 8px; text-decoration: none; border: none;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 10px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 6px rgba(102, 126, 234, 0.2)';">
                <i class="fi-page-add" style="font-size: 16px; margin-right: 6px;"></i> Masz nową publikację? Dodaj ją do bazy
            </a>
            <a href="{% url 'multiseek:index' %}" class="button secondary" style="background: #f8f9fa; color: #495057; border-radius: 8px; padding: 10px 18px; font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.08); transition: all 0.3s ease; text-decoration: none; border: 1px solid #dee2e6;" onmouseover="this.style.background='#e9ecef'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.12)';" onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.08)';">
                <i class="fi-magnifying-glass" style="font-size: 16px; margin-right: 6px;"></i> Przeglądaj wszystkie prace
            </a>
        </div>
        <div class="large-12 cell">
            <div class="shaded-hr-div"></div>
        </div>
    </div>

    <div class="grid-x grid-margin-x">
        {% if article %}
            <div class="small-12 large-6 cell">
                <h2>{{ article.title }}</h2>
                {% include "browse/go_to_admin_change.html" with group="web" url="admin:miniblog_article_change" pk=article.pk text="otwórz do edycji" %}
                <p>opublikowano {{ article.published_on }}</p>
                <p>{{ article.article_body.content|safe }}</p>
                <a href="..">wstecz</a>
            </div>
        {% else %}
            {% if miniblog.exists or request.user.is_superuser or request.user|has_group:"web" %}
                <div class="small-12 large-6 cell">
                    <h3 style="color: #2c3e50; font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <i class="fi-megaphone" style="margin-right: 8px; color: #95a5a6;"></i>Aktualności
                    </h3>
                    {% for article in miniblog %}
                        <h3><strong>{{ article.title }}</strong></h3>
                        <p>
                            opublikowano {{ article.published_on }}</p>
                        <p>{{ article.article_body.excerpt|safe }}</p>
                        {% if article.article_body.has_more %}
                            <p>
                                <a href="{% url "bpp:browse_artykul" uczelnia.slug article.slug %}">
                                    więcej
                                </a>
                            </p>
                        {% endif %}
                    {% endfor %}
                    {% include "browse/go_to_admin_list.html" with group="web" url="admin:miniblog_article_changelist" text="<i class='fi-wrench'></i> zarządzaj aktualnościami" %}
                    {% include "browse/go_to_admin_list.html" with group="web" url="admin:miniblog_article_add" text="<i class='fi-page-add'></i> dodaj artykuł" %}
                </div>

            {% endif %}
        {% endif %}
        {% if uczelnia.pokazuj_wydzialy_na_pierwszej_stronie %}
            <div class="small-12 large-6 cell">
                <h3 style="color: #2c3e50; font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                    <i class="fi-foundation" style="margin-right: 8px; color: #95a5a6;"></i>Wybierz {% rzeczownik_wydział %}
                </h3>
                <div class="wydzial-list" style="margin-bottom: 20px;">
                    {% for wydzial in uczelnia.wydzialy %}
                        <div class="wydzial-card" style="background: white; border-radius: 6px; padding: 15px; margin-bottom: 12px; border: 2px solid #e9ecef; transition: all 0.2s ease; position: relative;"
                             onmouseover="this.style.borderColor='#667eea'; this.style.background='#fafbfc'; this.style.transform='translateX(4px)';"
                             onmouseout="this.style.borderColor='#e9ecef'; this.style.background='white'; this.style.transform='translateX(0)';">
                            <div style="position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: #bdc3c7;">
                                <i class="fi-arrow-right" style="font-size: 1.2rem;"></i>
                            </div>
                            <a href="{% url "bpp:browse_wydzial" wydzial.slug %}"
                               style="color: #2c3e50; text-decoration: none; font-weight: 500; font-size: 0.95rem; line-height: 1.4; display: block; padding-right: 30px;"
                               onmouseover="this.style.color='#667eea';"
                               onmouseout="this.style.color='#2c3e50';">
                                {{ wydzial }}
                            </a>
                        </div>
                    {% endfor %}
                </div>
                {% include "browse/go_to_admin_list.html" with group="struktura" url="admin:bpp_wydzial_changelist" text="<i class='fi-wrench'></i> zarządzaj wydziałami" %}
                {% include "browse/go_to_admin_change.html" with url="admin:bpp_uczelnia_change" pk=uczelnia.pk group="struktura" text="ustawienia dla uczelni" %}
            </div>
            </div>
        {% endif %}
    {% if uczelnia.pokazuj_jednostki_na_pierwszej_stronie %}
        <div class="small-12 large-6 cell">{% load deklinacja %}
            <h3 style="color: #2c3e50; font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                <i class="fi-home" style="margin-right: 8px; color: #95a5a6;"></i>Wybierz {% rzeczownik_jednostkę %}
            </h3>
            <div class="jednostka-list" style="margin-bottom: 20px;">
                {% for jednostka in uczelnia.jednostki %}
                    <div class="jednostka-card" style="background: white; border-radius: 6px; padding: 15px; margin-bottom: 12px; border: 2px solid #e9ecef; transition: all 0.2s ease; position: relative;"
                         onmouseover="this.style.borderColor='#667eea'; this.style.background='#fafbfc'; this.style.transform='translateX(4px)';"
                         onmouseout="this.style.borderColor='#e9ecef'; this.style.background='white'; this.style.transform='translateX(0)';">
                        <div style="position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: #bdc3c7;">
                            <i class="fi-arrow-right" style="font-size: 1.2rem;"></i>
                        </div>
                        <a href="{% url "bpp:browse_jednostka" jednostka.slug %}"
                           style="color: #2c3e50; text-decoration: none; font-weight: 500; font-size: 0.95rem; line-height: 1.4; display: block; padding-right: 30px;"
                           onmouseover="this.style.color='#667eea';"
                           onmouseout="this.style.color='#2c3e50';">
                            {{ jednostka }}
                        </a>
                    </div>
                {% endfor %}
            </div>
            {% include "browse/go_to_admin_list.html" with group="struktura" url="admin:bpp_jednostka_changelist" text="<i class='fi-wrench'></i> zarządzaj jednostkami" %}
            {% include "browse/go_to_admin_change.html" with url="admin:bpp_uczelnia_change" pk=uczelnia.pk group="struktura" text="ustawienia dla uczelni" %}
        </div>
        </div>
    {% endif %}

    {% if recently_updated or recent_abstracts %}
        <div class="grid-x grid-margin-x">
            {% if recently_updated %}
                {% cache 3600 recent_publications uczelnia.pk %}
                <div class="small-12 large-6 cell">
                    <h3 style="color: #2c3e50; font-size: 1.3rem; font-weight: 600; margin-top: 30px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <i class="fi-book" style="margin-right: 8px; color: #95a5a6;"></i>Niedawno zaktualizowane rekordy
                    </h3>
                    <ul class="no-bullet" style="line-height: 180%;">
                        {% for rekord in recently_updated %}
                            <li style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e6e6e6;">
                                <a href="{{ rekord.get_absolute_url }}" style="font-size: 14px; line-height: 1.4; display: block;">
                                    {{ rekord.opis_bibliograficzny_cache|safe }}
                                </a>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    {{ rekord.ostatnio_zmieniony|date:"d.m.Y H:i" }}
                                    {% if rekord.rok %} • {{ rekord.rok }}{% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="/multiseek/" class="button secondary expanded">Zobacz wszystkie publikacje</a>
                    </div>
                </div>
                {% endcache %}
            {% endif %}

            {% if recent_abstracts %}
                {% cache 3600 recent_abstracts uczelnia.pk %}
                <div class="small-12 large-6 cell">
                    <h3 style="color: #2c3e50; font-size: 1.3rem; font-weight: 600; margin-top: 30px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <i class="fi-page-multiple" style="margin-right: 8px; color: #95a5a6;"></i>Najnowsze streszczenia
                    </h3>
                    <ul class="no-bullet" style="line-height: 180%;">
                        {% for rekord in recent_abstracts %}
                            <li style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e6e6e6;">
                                <a href="{{ rekord.rekord.get_absolute_url }}" style="font-size: 14px; line-height: 1.4; display: block; font-weight: bold; margin-bottom: 8px;">
                                    {{ rekord.rekord.opis_bibliograficzny_cache|safe }}
                                </a>
                                <div style="font-size: 13px; line-height: 1.4; color: #333; margin-bottom: 5px;">
                                    {{ rekord.streszczenie|safe|truncatewords:130 }}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    {{ rekord.ostatnio_zmieniony|date:"d.m.Y H:i" }}
                                    {% if rekord.rok %} • {{ rekord.rok }}{% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endcache %}
            {% endif %}
        </div>
    {% endif %}

{% endblock %}
