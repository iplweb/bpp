{% load prace user_in_group %}
<table width="{{ width|default:"100%" }}"
       class="szczegolyRekordu {{ htmlclass|default:"naglowki_z_lewej" }}">
    <tr>
        <th width="20%">Tytu≈Ç:</th>
        <td>
            {% if praca.tytul %}
                <b>{{ praca.tytul_oryginalny|safe }} ({{ praca.tytul|safe }}).</b>
            {% else %}
                <b>{{ praca.tytul_oryginalny|znak_na_koncu:"."|safe }}</b>
            {% endif %}
            {% if praca.charakter_formalny.charakter_ogolny != 'roz' %}
                {{ praca.oznaczenie_wydania|default:""|znak_na_koncu:"." }}
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>
            Autorzy:
        </th>
        <td>
            {{ praca.tekst_przed_pierwszym_autorem|default:"" }}
            {% for autor in praca.autorzy_dla_opisu %}{% ifchanged autor.typ_odpowiedzialnosci %}
                [{{ autor.typ_odpowiedzialnosci.skrot|upper }}] {% endifchanged %}{% if links == "admin" %}
                <a href="{% url "admin:bpp_autor_change" autor.autor.pk %}">
                {% else %}{% if links == "normal" %}<a href="{% url "bpp:browse_autor" autor.autor.slug %}">{% else %}
                {% endif %}{% endif %}{% if links %}{{ autor.zapisany_jako }}{% else %}
                {{ autor.zapisany_jako|upper }}{% endif %}{% if links == "admin" or links == "normal" %}</a>{% endif %}
                {% if not forloop.last %}, {% else %}{{ praca.tekst_po_ostatnim_autorze|default:"" }}.
                {% endif %}{% endfor %}
        </td>
    </tr>
    {% if praca.zrodlo or praca.wydawnictwo_nadrzedne or praca.informacje or praca.szczegoly %}
        <tr>
            <th>
                Szczeg√≥≈Çy:
            </th>
            <td>
                {% if praca.zrodlo %}
                    {% if links == "admin" %}
                        <a href="{% url "admin:bpp_zrodlo_change" praca.zrodlo.pk %}">{{ praca.zrodlo }}</a>
                    {% else %}
                        <a href="{% url "bpp:browse_zrodlo" praca.zrodlo.slug %}">{{ praca.zrodlo }}</a>
                    {% endif %}
                {% endif %}
                {% if praca.wydawnictwo_nadrzedne %}
                    <a href="{% url "bpp:browse_praca" "wydawnictwo_zwarte" praca.wydawnictwo_nadrzedne.pk %}">
                {% endif %}
                {% if not praca.informacje and not praca.szczegoly %}
                    {% if praca.wydawnictwo_nadrzedne.opis_bibliograficzny %}
                        W: {{ praca.wydawnictwo_nadrzedne.opis_bibliograficzny|safe }}
                    {% endif %}
                {% endif %}
                {{ praca.informacje|default:""|znak_na_koncu:", "|safe }}
                {{ praca.szczegoly|default:""|safe }}
                {% if praca.wydawnictwo_nadrzedne %}
                    </a>
                {% endif %}
            </td>
        </tr>
    {% endif %}

    {% if praca.wydawca or praca.wydawca_opis %}
        <tr>
            <th>Wydawca:</th>
            <td>{{ praca.wydawca|default:"" }} {{ praca.wydawca_opis|default:"" }}</td>
        </tr>
    {% endif %}

    {% if praca.streszczenia.exists %}
        <tr>
            <th>Streszczenie:</th>
            <td>{% for streszczenie in praca.streszczenia.all %}
                <!-- <strong>{{streszczenie.jezyk_streszczenia.nazwa}}</strong> -->
                <p>{{ streszczenie.streszczenie|safe }}</p>
            {% endfor %}
            </td>
        </tr>
    {% endif %}

    {% if praca.isbn %}
        <tr>
            <th>ISBN:</th>
            <td>{{ praca.isbn }}</td>
        </tr>
    {% endif %}
    {% if praca.e_isbn %}
        <tr>
            <th>e-ISBN:</th>
            <td>{{ praca.e_isbn }}</td>
        </tr>
    {% endif %}

    {% if praca.issn %}
        <tr>
            <th>ISSN:</th>
            <td>{{ praca.issn }}</td>
        </tr>
    {% endif %}
    {% if praca.e_issn %}
        <tr>
            <th>e-ISSN:</th>
            <td>{{ praca.e_issn }}</td>
        </tr>
    {% endif %}

    {% if praca.charakter_formalny.skrot == "PAT" %}
        <tr>
            <th>Patent:</th>
            <td>
                <b>- numer zg≈Çoszenia:</b> {{ praca.numer_zgloszenia|default:"brak" }}. <br/>
                <b>- wydzia≈Ç:</b> {{ praca.wydzial|default:"brak" }}<br/>
                <b>- rodzaj prawa:</b> {{ praca.rodzaj_prawa|default:"brak" }}<br/>
                <b>- data zg≈Çoszenia:</b> {{ praca.data_zgloszenia|default:"brak" }}<br/>
                <b>- numer zg≈Çoszenia:</b> {{ praca.numer_zgloszenia|default:"brak" }}<br/>
                <b>- data decyzji:</b> {{ praca.data_decyzji|default:"brak" }}<br/>
                <b>- numer prawa wy≈ÇƒÖcznego:</b> {{ praca.numer_prawa_wylacznego|default:"brak" }}<br/>
                <b>- wdro≈ºenie:</b> {% if praca.wdrozenie %}tak{% else %}nie{% endif %}
            </td>
        </tr>
    {% endif %}
    {% if praca.public_www or praca.www %}
        <tr>
            <th>
                Strona WWW:
            </th>
            <td>
                {% if praca.public_www %}
                    <a href="{{ praca.public_www }}">
                        {{ praca.public_www|truncatechars:120 }}</a>
                {% elif praca.www %}
                    <a href="{{ praca.www }}">{{ praca.www|truncatechars:120 }}</a>
                {% else %}
                    Brak danych
                {% endif %}
            </td>
        </tr>
    {% endif %}
    {% if praca.doi %}
        <tr>
            <th>DOI</th>
            <td><a target="_blank" href="http://doi.org/{{ praca.doi }}">{{ praca.doi }}</a></td>
        </tr>
    {% endif %}

    {% if praca.pubmed_id %}
        <tr>
            <th>PubMed ID:</th>
            <td><a target="_blank"
                   href="https://www.ncbi.nlm.nih.gov/pubmed/{{ praca.pubmed_id }}">{{ praca.pubmed_id }}</a></td>
        </tr>
    {% endif %}

    {% if praca.pmc_id %}
        <tr>
            <th>PMC ID:</th>
            <td><a href="https://www.ncbi.nlm.nih.gov/pmc/{{ praca.pmc_id }}">{{ praca.pmc_id }}</a></td>
        </tr>
    {% endif %}

    <tr>
        <th>
            BPP ID:
        </th>
        <td>
            {{ rekord.pk }} <small>czyli {{ rekord.describe_content_type }} o ID = {{ praca.pk }}</small>
        </td>
    </tr>
    <tr>
        <th>
            BibTeX:
        </th>
        <td>
            <button id="bibtex-toggle-btn" class="button secondary" type="button">
                üìã Poka≈º BibTeX
            </button>
            <button id="bibtex-copy-btn" class="button success" type="button" style="margin-left: 10px; display: none;">
                üìÑ Skopiuj do schowka
            </button>
            <span id="bibtex-copy-feedback" style="margin-left: 10px;">
                ‚úì Skopiowane!
            </span>
            <div id="bibtex-container" style="display: none;">
                <textarea id="bibtex-content" readonly></textarea>
            </div>
        </td>
    </tr>
    {% if praca.pbn_uid_id %}
        <tr>
            <th>PBN UID:</th>
            <td>
                <button class="button secondary"
                        type="button"
                        onclick="window.open('{{ praca.link_do_pbn }}', '_blank')">
                    üîó {{ praca.pbn_uid_id }}
                </button>
                {% if not request.user.is_anonymous and praca.link_do_pi %}
                    <button class="button secondary"
                            type="button"
                            onclick="window.open('{{ praca.link_do_pi }}', '_blank')"
                            style="margin-left: 10px;">
                        üè¢ Profil instytucji
                    </button>
                {% endif %}
            </td>
        </tr>
    {% endif %}
    {% if praca.pbn_id %}
        <tr>
            <th>
                PBN ID (historyczne):
            </th>
            <td>
                {{ praca.pbn_id }}
            </td>
        </tr>
    {% endif %}

    <tr>
        <th>
            Rok:
        </th>
        <td>
            {{ praca.rok }}
        </td>
    </tr>
    <tr>
        <th>
            Charakter formalny:
        </th>
        <td>
            {{ praca.charakter_formalny }}
        </td>
    </tr>

    <tr>
        <th>
            Jƒôzyk:
        </th>
        <td>
            {{ praca.jezyk }}
        </td>
    </tr>
    {% if praca.typ_kbn %}
        <tr>
            <th>
                Typ MNiSW/MEiN:
            </th>
            <td>
                {{ praca.typ_kbn }}
            </td>
        </tr>
    {% endif %}
    {% if praca.openaccess_tryb_dostepu or praca.openaccess_wersja_tekstu or praca.openaccess_licencja or praca.openaccess_czas_publikacji or praca.openaccess_ilosc_miesiecy %}
        <tr>
            <th style="vertical-align: top;">OpenAccess:</th>
            <td>
                {% if praca.openaccess_tryb_dostepu %}
                    <b>- tryb dostƒôpu: </b>
                    {{ praca.openaccess_tryb_dostepu|lower }}
                    <br/>
                {% endif %}

                {% if praca.openaccess_wersja_tekstu %}

                    <b> - wersja tekstu: </b>
                    {{ praca.openaccess_wersja_tekstu|lower }}<br/>

                {% endif %}
                {% if praca.openaccess_licencja %}

                    <b> - licencja: </b>
                    {% if praca.openaccess_licencja.webname %}
                        <a target="_blank"
                           href="https://creativecommons.org/licenses/{{ praca.openaccess_licencja.webname }}/3.0/pl/#content">
                    {% endif %}
                {{ praca.openaccess_licencja }}
                {% if praca.openaccess_licencja.webname %}
                    </a>
                {% endif %}
                    <br/>

                {% endif %}
                {% if praca.openaccess_czas_publikacji %}

                    <b> - czas udostƒôpnienia: </b>
                    {{ praca.openaccess_czas_publikacji|lower }}<br/>

                {% endif %}
                {% if praca.openaccess_ilosc_miesiecy %}

                    <b> - ilo≈õƒá miesiƒôcy: </b>
                    {{ praca.openaccess_ilosc_miesiecy }}
                    <small>ilo≈õƒá miesiƒôcy kt√≥re up≈Çynƒô≈Çy od momentu opublikowania do momentu udostƒôpnienia
                    </small>
                    <br/>

                {% endif %}
            </td>
            </td>
        </tr>
    {% endif %}
    <tr>
        <th>
            Punkty MNiSW/MEiN:
        </th>
        <td>
            {{ praca.punkty_kbn }}
        </td>
    </tr>

    <tr>
        <th>
            Impact factor:
        </th>
        <td>
            {{ praca.impact_factor }}
        </td>
    </tr>
    {% if praca.kwartyl_w_scopus %}
        <tr>
            <th>
                Kwartyl w SCOPUS:
            </th>
            <td>
                Q{{ praca.kwartyl_w_scopus }}
            </td>
        </tr>
    {% endif %}
    {% if praca.kwartyl_w_wos %}
        <tr>
            <th>
                Kwartyl w WoS:
            </th>
            <td>
                Q{{ praca.kwartyl_w_wos }}
            </td>
        </tr>
    {% endif %}
    {% if praca.liczba_cytowan %}
        <tr>
            <th>Liczba cytowa≈Ñ:</th>
            <td>{{ praca.liczba_cytowan }}</td>
        </tr>
    {% endif %}
    {% if praca.liczba_znakow_wydawniczych %}
        <tr>
            <th>Liczba arkuszy wydawniczych:</th>
            <td>{{ praca.wymiar_wydawniczy_w_arkuszach }}</td>
        </tr>
    {% endif %}
    {% if uczelnia.pokazuj_punktacja_snip %}
        <tr>
            <th>Punktacja SNIP:</th>
            <td>{{ praca.punktacja_snip }}</td>
        </tr>
    {% endif %}
    {% if uczelnia.pokazuj_index_copernicus %}
        <tr>
            <th>
                Index Copernicus:
            </th>
            <td>
                {{ praca.index_copernicus }}
            </td>
        </tr>
    {% endif %}

    {% if uczelnia.pokazuj_punktacje_wewnetrzna %}
        <tr>
            <th>
                Punktacja wewnƒôtrzna:
            </th>
            <td>
                {{ praca.punktacja_wewnetrzna }}
            </td>
        </tr>
    {% endif %}
    {% if uczelnia.pokazuj_status_korekty == "always" or uczelnia.pokazuj_status_korekty == "logged-in" and not request.user.is_anonymous %}
        <tr>
            <th>
                Status:
            </th>
            <td>
                {{ praca.status_korekty }}
            </td>
        </tr>
    {% endif %}
    {% if praca.wydawnictwa_powiazane_set.exists %}
        <tr>
            <th>Rekordy powiƒÖzane</th>
            <td>
                <ol>
                    {% for elem in praca.wydawnictwa_powiazane_posortowane.all %}
                        <li>
                            <a href="{% url "bpp:browse_praca" "wydawnictwo_zwarte" elem.pk %}">{{ elem.opis_bibliograficzny_cache|safe }}</a>
                        </li>
                    {% endfor %}
                </ol>
            </td>
        </tr>
    {% endif %}
    {% if uczelnia.pokazuj_praca_recenzowana == "always" or uczelnia.pokazuj_praca_recenzowana == "logged-in" and not request.user.is_anonymous %}
        <tr>
            <th>
                Praca recenzowana:
            </th>
            <td>
                {{ praca.recenzowana|yesno }}
            </td>
        </tr>
    {% endif %}
    {% if praca.ma_procenty %}
        <tr>
            <th>Odpowiedzialno≈õƒá za powstanie pracy</th>
            <td>
                {% for autor in praca.autorzy_set.all %}
                    {% if autor.procent %}
                        {{ autor.procent }}% {{ autor.zapisany_jako }}<br/>
                    {% endif %}
                {% endfor %}

            </td>
        </tr>
    {% endif %}

    <tr>
        <th>
            Rekord utworzony:
        </th>
        <td>
            {{ praca.utworzono }}
        </td>
    </tr>

    <tr>
        <th>
            Rekord zaktualizowany:
        </th>
        <td>
            {{ praca.ostatnio_zmieniony }}
        </td>
    </tr>
    {% if praca.zewnetrzna_baza_danych.exists %}
        <tr>
            <th>Zewnƒôtrzna<br/>baza danych:</th>
            <td>
                <ul>{% for db in praca.zewnetrzna_baza_danych.all %}
                    <li>{{ db.baza.nazwa }}</li>
                {% endfor %}
                </ul>
            </td>
        </tr>
    {% endif %}
</table>

{% if rekord.ma_punktacje_sloty %}
    {% if uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "always" or uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "logged-in" and not request.user.is_anonymous %}
        <h4>Punkty i sloty autor√≥w
            {% if uczelnia.drukuj_oswiadczenia %}
                {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                    <a target="_blank" href="{% url "oswiadczenia:wiele-oswiadczen" rekord.id.0 rekord.id.1 %}">
                        <span class="fi-print"></span>
                    </a>
                {% endif %}
            {% endif %}

        </h4>
        <table>
            <tr>
                <th>Autor</th>
                <th>Dyscyplina</th>
                <th>PkD / PkDAut</th>
                <th>Slot</th>
                {% if uczelnia.drukuj_oswiadczenia %}
                    {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                        <th>O≈õwiadczenia</th>
                    {% endif %}
                {% endif %}
            </tr>

            {% for pa in rekord.punktacja_autora.select_related %}
                <tr>
                    <td>{{ pa.autor }}</td>
                    <td>{{ pa.dyscyplina.nazwa }}</td>
                    <td>{{ pa.pkdaut }}</td>
                    <td>{{ pa.slot }}</td>
                    {% if uczelnia.drukuj_oswiadczenia %}
                        {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                            <td>
                                <!-- wydruk oswiadczenia -->
                                <a target="_blank"
                                   title="Wydruk dyscypliny zg≈Çoszonej dla publikacji"
                                   href="{% url "oswiadczenia:jedno-oswiadczenie" rekord.id.0 rekord.id.1 pa.autor.id pa.dyscyplina.id %}">
                                    <span class="fi-print"></span>
                                </a>
                                <!-- wydruk drugiego oswiadczenia jezeli ma subdyscypline -->
                                {% if pa.czy_autor_ma_alternatywna_dyscypline and uczelnia.drukuj_alternatywne_oswiadczenia %}
                                    &nbsp;
                                    <a target="_blank"
                                       title="Wydruk alternatywnej dyscypliny autora (innej, ni≈º zg≈Çoszona dla publikacji)"
                                       href="{% url "oswiadczenia:jedno-oswiadczenie-druga-dyscyplina" rekord.id.0 rekord.id.1 pa.autor.id pa.dyscyplina.id %}">
                                        <span class="fi-print" style="color: palevioletred;"></span>
                                    </a>
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endif %}
                </tr>
            {% endfor %}
        </table>
        <h4>Punkty i sloty dyscyplin</h4>
        <table>
            <tr>
                <th>Dyscyplina</th>
                <th>PkD / PkDAut</th>
                <th>Slot</th>
            </tr>
            {% for pd in rekord.punktacja_dyscypliny.select_related %}
                <tr>
                    <td>{{ pd.dyscyplina.nazwa }}</td>
                    <td>{{ pd.pkd }}</td>
                    <td>{{ pd.slot }}</td>
                    {% load user_in_group %}
                </tr>
            {% endfor %}
        </table>

    {% endif %}
{% endif %}

<style type="text/css">
/* BibTeX specific styles */
#bibtex-container {
    margin-top: 10px;
}

#bibtex-content {
    width: 100%;
    min-height: 200px;
    font-family: 'Courier New', Consolas, Monaco, monospace;
    font-size: 12px;
    background-color: #f8f8f8;
    border: 1px solid #ccc;
    border-radius: 3px;
    padding: 10px;
    resize: vertical;
    line-height: 1.4;
}

#bibtex-toggle-btn,
#bibtex-copy-btn {
    margin: 0;
    vertical-align: top;
}

#bibtex-copy-btn {
    margin-left: 10px;
}

#bibtex-copy-feedback {
    margin-left: 10px;
    color: #28a745;
    font-weight: bold;
    display: none;
    vertical-align: top;
}

/* Responsive adjustments */
@media screen and (max-width: 640px) {
    #bibtex-content {
        font-size: 10px;
        min-height: 150px;
    }

    #bibtex-toggle-btn,
    #bibtex-copy-btn {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
    }
}

/* Better button styling for loading state */
#bibtex-toggle-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>

<script type="text/javascript">
(function($) {
    $(document).ready(function() {
        var bibtexToggleBtn = $('#bibtex-toggle-btn');
        var bibtexContainer = $('#bibtex-container');
        var bibtexContent = $('#bibtex-content');
        var bibtexCopyBtn = $('#bibtex-copy-btn');
        var bibtexCopyFeedback = $('#bibtex-copy-feedback');
        var bibtexLoaded = false;

        // Toggle BibTeX display
        bibtexToggleBtn.click(function() {
            if (bibtexContainer.is(':visible')) {
                bibtexContainer.hide();
                bibtexToggleBtn.text('üìã Poka≈º BibTeX');
            } else {
                if (!bibtexLoaded) {
                    // Load BibTeX via AJAX
                    loadBibTeX();
                } else {
                    bibtexContainer.show();
                    bibtexToggleBtn.text('üìã Ukryj BibTeX');
                }
            }
        });

        // Copy to clipboard functionality
        bibtexCopyBtn.click(function() {
            copyToClipboard();
        });

        function loadBibTeX() {
            bibtexToggleBtn.prop('disabled', true).text('‚è≥ ≈Åadowanie...');

            // Extract model and pk from the current page
            var modelName = '{{ rekord.content_type.model }}';
            var pk = '{{ praca.pk }}';

            var url = '/bpp/api/bibtex/' + modelName + '/' + pk + '/';

            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    bibtexContent.val(data.bibtex);
                    bibtexContainer.show();
                    bibtexToggleBtn.text('üìã Ukryj BibTeX');
                    bibtexCopyBtn.show();
                    bibtexLoaded = true;

                    // Auto-resize textarea to content
                    autoResizeTextarea();
                },
                error: function(xhr, status, error) {
                    var errorMsg = 'B≈ÇƒÖd podczas pobierania BibTeX';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += ': ' + xhr.responseJSON.error;
                    }
                    bibtexContent.val(errorMsg);
                    bibtexContainer.show();
                    bibtexToggleBtn.text('üìã Ukryj BibTeX (b≈ÇƒÖd)');
                },
                complete: function() {
                    bibtexToggleBtn.prop('disabled', false);
                }
            });
        }

        function autoResizeTextarea() {
            var lines = bibtexContent.val().split('\n').length;
            var minHeight = 200;
            var lineHeight = 16;
            var newHeight = Math.max(minHeight, (lines + 1) * lineHeight);
            bibtexContent.css('height', newHeight + 'px');
        }

        function copyToClipboard() {
            // Modern Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(bibtexContent.val()).then(function() {
                    showCopyFeedback();
                }, function(err) {
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        }

        function fallbackCopy() {
            // Fallback for older browsers
            bibtexContent.select();
            bibtexContent[0].setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                showCopyFeedback();
            } catch (err) {
                alert('Nie mo≈ºna skopiowaƒá do schowka. Proszƒô zaznacz tekst i skopiuj rƒôcznie (Ctrl+C).');
            }
        }

        function showCopyFeedback() {
            bibtexCopyFeedback.show();
            setTimeout(function() {
                bibtexCopyFeedback.fadeOut();
            }, 2000);
        }
    });
})(jQuery || django.jQuery || $);
</script>

{% if rekord.ma_odpiete_dyscypliny %}
    {% if uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "always" or uczelnia.pokazuj_tabele_slotow_na_stronie_rekordu == "logged-in" and not request.user.is_anonymous %}
        <h4>"Odpiƒôte" dyscypliny:</h4>
        <table>
            <tr>
                <th>Autor</th>
                <th>Dyscyplina</th>
            </tr>
            {% for pa in praca.odpiete_dyscypliny.select_related %}
                <tr>
                    <td>{{ pa.autor }}</td>
                    <td>{{ pa.dyscyplina_naukowa.nazwa }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
{% endif %}
