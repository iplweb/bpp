<style>
    .dropdown.menu > li > a:hover .bpp-logo {
        filter: grayscale(0%) drop-shadow(0 0 8px rgba(255, 150, 0, 0.8)) !important;
        transform: scale(1.1);
    }

    /* Hide the dropdown arrow for single-item menus */
    .dropdown.menu > li.no-dropdown-arrow > a::after {
        display: none !important;
    }

    /* Global search modal closing animations */
    .global-search-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .global-search-modal.show {
        display: block;
        opacity: 1;
    }

    .global-search-modal.closing {
        animation: fadeOutModal 0.4s ease-out forwards;
    }

    @keyframes fadeOutModal {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    .global-search-container {
        position: fixed;
        width: 85vw;
        max-width: 1200px;
        min-height: 300px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        padding: 30px;
        opacity: 0;
        transform: scale(0);
        pointer-events: none;
    }

    .global-search-modal.show .global-search-container {
        pointer-events: auto;
    }

    /* Animation from search button */
    .global-search-modal.show .global-search-container:not(.animating-out) {
        animation: expandFromButton 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .global-search-container.animating-out {
        animation: collapseToButton 0.4s cubic-bezier(0.64, 0, 0.66, 0.44) forwards !important;
        pointer-events: none !important;
    }

    @keyframes expandFromButton {
        from {
            transform: scale(0);
            opacity: 0;
        }
        60% {
            transform: scale(1.05);
            opacity: 1;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    @keyframes collapseToButton {
        from {
            transform: scale(1);
            opacity: 1;
        }
        40% {
            transform: scale(1.05);
            opacity: 1;
        }
        to {
            transform: scale(0);
            opacity: 0;
        }
    }

    .global-search-input {
        width: 100%;
        font-size: 1.2rem;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.3s;
        background-color: #f9f9f9;
    }

    .global-search-input:focus {
        border-color: #007bff;
        background-color: white;
    }

    .global-search-results {
        max-height: 60vh;
        overflow-y: auto;
        margin-top: 15px;
        padding-top: 5px;
        scroll-behavior: smooth;
    }

    .search-result-group {
        padding: 8px 0;
    }

    .search-result-group-title {
        font-weight: 600;
        color: #2c3e50;
        padding: 8px 15px;
        background: linear-gradient(90deg, #f8f9fa 0%, #ffffff 100%);
        margin: 10px 0 5px 0;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-left: 4px solid #007bff;
        display: flex;
        align-items: center;
    }

    .search-result-group-title i {
        font-size: 1.1rem;
        margin-right: 8px;
        color: #007bff;
        opacity: 0.8;
    }

    .search-result-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 6px;
        margin: 2px 10px;
        position: relative;
        font-size: 0.95rem;
        color: #333;
        border: 1px solid transparent;
    }

    .search-result-item:hover {
        background: linear-gradient(90deg, #f0f7ff 0%, #f8fbff 100%);
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        border-color: #e3f2fd;
    }

    .search-result-item.selected {
        background: linear-gradient(90deg, #e3f2fd 0%, #f0f7ff 100%);
        border-left: 3px solid #007bff;
        padding-left: 12px;
        box-shadow: 0 2px 12px rgba(0, 123, 255, 0.15);
    }

    .global-search-close {
        position: absolute;
        top: 15px;
        right: 25px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
    }

    .global-search-close:hover {
        color: #333;
    }

    .global-search-loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .global-search-no-results {
        text-align: center;
        padding: 20px;
        color: #999;
    }

    .search-hint {
        position: absolute;
        top: 15px;
        right: 60px;
        color: #999;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.9);
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
    }
</style>

<div class="title-bar" data-responsive-toggle="example-menu" data-hide-for="medium">
    <button class="menu-icon" type="button" data-toggle="example-menu"></button>
    <div class="title-bar-title hide-for-print">Menu</div>
</div>

<div class="top-bar stacked-for-medium hide-for-print sticky-header" id="example-menu">
    <div class="top-bar-left">
        <ul class="dropdown menu" data-dropdown-menu>
            <li>
                <a href="/">
                    <img src="{% load static %}{% static 'images/bpp-icon.png' %}" alt="BPP" class="bpp-logo" style="height: 24px; width: auto; vertical-align: middle; filter: grayscale(100%); transition: filter 0.3s ease, transform 0.3s ease; margin-right: 0.4rem;">
                    BPP
                </a>
            </li>
            <li>
                <a href="#"><i class="fi-magnifying-glass" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> szukaj</a>
                <ul class="menu vertical">
                    <li>
                        <a href="#" onclick="openGlobalSearch(event); return false;">
                            <i class="fi-magnifying-glass" style="font-size: 1.6rem; margin-right: 0.8rem;"></i>
                            szybko
                            <span style="float: right; border: 1px solid #ccc; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; color: #666; font-size: 0.85rem; font-weight: 500; margin-left: 20px; background: #f8f8f8;">/</span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url "multiseek:index" %}">
                            <i class="fi-page-search" style="font-size: 1.6rem; margin-right: 0.8rem;"></i>
                            precyzyjnie
                        </a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fi-list" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> przeglądaj</a>
                <ul class="menu vertical">{% load deklinacja %}
                    <li><a href="/"><i class="fi-foundation" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> {% rzeczownik_uczelnia %}</a></li>
                    <li><a href="{% url "bpp:browse_jednostki" %}"><i class="fi-results-demographics" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> {% rzeczownik_jednostki_m %}</a></li>
                    <li><a href="{% url "bpp:browse_autorzy" %}"><i class="fi-torsos-all" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> autorzy</a></li>
                    <li><a href="{% url "bpp:browse_zrodla" %}"><i class="fi-book" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> źródła</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fi-graph-trend" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> raporty</a>
                <ul class="menu vertical" id="top-bar-menu-raportow">
                    {% load czy_pokazywac %}
                    {% load user_in_group %}

                    {% if ENABLE_NEW_REPORTS %}
                        {% czy_pokazywac raport_uczelni %}
                            <li>
                                <a href="{% url "nowe_raporty:uczelnia_form" %}">
                                    <i class="fi-foundation" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport uczelni
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_wydzialow %}
                            <li>
                                <a href="{% url "nowe_raporty:wydzial_form" %}">
                                    <i class="fi-results-demographics" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport wydziałów
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_jednostek %}
                            <li>
                                <a href="{% url "nowe_raporty:jednostka_form" %}">
                                    <i class="fi-map" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport jednostek
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_autorow %}
                            <li>
                                <a href="{% url "nowe_raporty:autor_form" %}">
                                    <i class="fi-torsos-all" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport autorów
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                    {% endif %}
                    {% czy_pokazywac ranking_autorow %}
                        <hr/>
                        <li><a href="{% url "bpp:ranking_autorow_formularz" %}"><i class="fi-trophy" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> ranking
                            autorów</a></li>
                        <hr>
                    {% end_czy_pokazywac %}

                </ul>
            </li>

            <script type="text/javascript">
                var raportMenu = document.getElementById("top-bar-menu-raportow");

                // Remove leading HR elements
                while (raportMenu.firstElementChild && raportMenu.firstElementChild.tagName == "HR") {
                    raportMenu.firstElementChild.remove();
                }

                // Remove trailing HR elements
                while (raportMenu.lastElementChild && raportMenu.lastElementChild.tagName == "HR") {
                    raportMenu.lastElementChild.remove();
                }

                // Hide the entire raporty menu if it's empty
                if (raportMenu.children.length === 0) {
                    // Find and hide the parent <li> element that contains the "raporty" link and submenu
                    raportMenu.parentElement.style.display = 'none';
                }
            </script>

            <li>
                <a href="#"><i class="fi-graph-bar" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> ewaluacja</a>
                <ul class="menu vertical" id="top-bar-menu-ewaluacji">
                    {% load czy_pokazywac %}
                    {% load user_in_group %}

                    {% czy_pokazywac raport_slotow_autor %}
                        <li><a href="{% url "raport_slotow:index" %}"><i class="fi-torso" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport slotów - autor</a></li>
                    {% end_czy_pokazywac %}
                    {% czy_pokazywac raport_slotow_zerowy %}
                        <li><a href="{% url "raport_slotow:raport-slotow-zerowy-parametry" %}"><i class="fi-clipboard-notes" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport slotów -
                            zerowy</a>
                        </li>
                    {% end_czy_pokazywac %}

                    {% czy_pokazywac raport_slotow_uczelnia %}
                        <li><a href="{% url "raport_slotow:lista-raport-slotow-uczelnia" %}"><i class="fi-foundation" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport slotów -
                            uczelnia</a></li>
                        <li><a href="{% url "raport_slotow:index-ewaluacja" %}"><i class="fi-clipboard-pencil" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport slotów - ewaluacja</a>
                        <li><a href="{% url "raport_slotow:index-upowaznienia" %}"><i class="fi-shield" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport ewaluacja -
                            upoważnienia</a>
                        <li><a href="{% url "ewaluacja2021:lista-raportow3n" %}"><i class="fi-page-multiple" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport ewaluacja - 3N</a>
                        </li>
                        <li><a href="{% url "snapshot_odpiec:index" %}"><i class="fi-camera" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> snapshoty odpięć</a></li>
                    {% end_czy_pokazywac %}

                </ul>
            </li>

            <script type="text/javascript">
                // Hide ewaluacja menu if it's empty
                var ewaluacjaMenu = document.getElementById("top-bar-menu-ewaluacji");
                if (ewaluacjaMenu && ewaluacjaMenu.children.length === 0) {
                    // Hide the parent <li> element that contains the menu
                    ewaluacjaMenu.parentElement.style.display = 'none';
                }
            </script>

            {% if not request.user.is_anonymous %}

                {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                    {% if uczelnia.pbn_integracja %}
                        <li>
                            <a href="#"><i class="fi-link" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> PBN</a>
                            <ul class="menu vertical">
                                {% if request.user|has_group:"wprowadzanie danych" or request.user.is_superuser %}
                                    <li><a href="{% url "pbn_api:authorize" %}" onclick="this.href='{% url "pbn_api:authorize" %}?next=' + encodeURIComponent(window.location.pathname + window.location.search + window.location.hash)"><i class="fi-key" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> autoryzuj PBN API</a></li>
                                    <li><a href="{% url "pbn_import:dashboard" %}"><i class="fi-burst-new" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> 🚀 Import z PBN</a></li>
                                    <li><a href="{% url "pbn_downloader_app:main" %}"><i class="fi-download" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> pobieranie danych z PBN</a></li>
                                    <li><a href="{% url "pbn_api:export-queue-list" %}"><i class="fi-list" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> kolejka eksportu do PBN</a></li>
                                    <li><a href="{% url "komparator_pbn:main" %}"><i class="fi-arrows-compress" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> komparator PBN</a></li>
                                    <li><a href="{% url "komparator_pbn_udzialy:list" %}"><i class="fi-alert" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> komparator udziałów PBN</a></li>
                                    <li><a href="{% url "komparator_publikacji_pbn:comparison_list" %}"><i class="fi-page-search" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> komparator publikacji PBN</a></li>
                                    <li><a href="{% url "importer_autorow_pbn:main" %}"><i class="fi-torsos-female-male" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> importer autorów PBN</a></li>
                                    <li><a href="{% url "deduplikator_autorow:duplicate_authors" %}"><i class="fi-filter" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> deduplikator autorów PBN</a></li>
                                {% endif %}
                            </ul>
                        </li>
                    {% endif %}

                    <li class="has-submenu">
                        <a href="#" data-toggle><i class="fi-wrench" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> operacje</a>
                        <div class="menu-columns-wrapper" data-submenu>
                            {% if request.user|has_group:"wprowadzanie danych" or request.user.is_superuser %}
                                <ul class="menu vertical column-1">
                                    <li><a href="{% url "integrator2:main" %}"><i class="fi-upload" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> import danych</a></li>
                                    <li><a href="{% url "import_pracownikow:index" %}"><i class="fi-torsos" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> import pracowników</a></li>
                                    <li><a href="{% url "import_polon:index" %}"><i class="fi-database" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> import z POLON</a></li>
                                    <li><a href="{% url "import_polon:index-absencji" %}"><i class="fi-calendar" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> import absencji</a></li>
                                    <li><a href="{% url "import_list_ministerialnych:index" %}"><i class="fi-clipboard-notes" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> import list
                                        ministerialnych</a></li>
{#                                    <li><a href="{% url "ewaluacja2021:lista-importow" %}">import udziałów dla#}
{#                                        autorów</a>#}
{#                                    </li>#}
                                    <li><a href="{% url "import_list_if:index" %}"><i class="fi-graph-bar" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> import list IF</a></li>
                                    <li><a href="{% url "import_dyscyplin:index" %}"><i class="fi-folder" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> import dyscyplin</a></li>
                                    <hr/>
                                    <li><a href="{% url "bpp:xlsx-issn-chunks" %}"><i class="fi-download" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> eksport ISSNów</a></li>
                                </ul>
                                <ul class="menu vertical column-2">
                                    <li><a href="{% url "admin:rozbieznosci_dyscyplin_rozbieznosciview_changelist" %}">
                                        <i class="fi-alert" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> rozbieżności dyscyplin</a></li>
                                    <li><a href="{% url "rozbieznosci_if:index" %}"><i class="fi-alert" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> rozbieżności
                                        punktacji IF</a></li>
                                </ul>
                            {% endif %}
                        </div>
                    </li>
                {% endif %}

                {% if request.user.is_staff %}
                    <li><a target="_blank"
                           href="{% url "admin:index" %}"><i class="fi-pencil" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> redagowanie</a>
                    </li>
                {% endif %}

                <li id="wyloguj-menu-item">
                    <a href="#" onclick="document.getElementById('logout-form').submit(); return false;">
                        <i class="fi-power" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i> wyloguj
                    </a>
                    <ul class="menu vertical" id="wyloguj-submenu">
                        <li>
                            <a href="#" onclick="document.getElementById('logout-form').submit(); return false;">
                                <i class="fi-power" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> wyloguj
                            </a>
                        </li>
                        {% if not microsoft_login_enabled %}
                            <li><a id="password-change-link" href="{% url "password_change" %}"><i class="fi-key" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> zmiana hasła</a></li>
                        {% endif %}
                        {% if request.user.is_superuser %}
                            <li><a href="/admin/bpp/bppuser/" target="_blank"><i class="fi-torso-business" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> zaloguj jako inny użytkownik</a></li>
                        {% endif %}
                    </ul>
                </li>

                <script type="text/javascript">
                    // Check if wyloguj menu has only one item and simplify if so
                    document.addEventListener('DOMContentLoaded', function() {
                        var wylogujMenuItem = document.getElementById('wyloguj-menu-item');
                        var wylogujSubmenu = document.getElementById('wyloguj-submenu');

                        if (wylogujMenuItem && wylogujSubmenu) {
                            // Count the number of submenu items
                            var submenuItems = wylogujSubmenu.querySelectorAll('li');

                            if (submenuItems.length === 1) {
                                // Remove the submenu entirely
                                wylogujSubmenu.remove();

                                // Remove the dropdown behavior by removing data attributes
                                var mainLink = wylogujMenuItem.querySelector('a');
                                if (mainLink) {
                                    // The main link already has the logout onclick handler, so we just need to ensure
                                    // it doesn't act as a dropdown trigger
                                    wylogujMenuItem.classList.remove('has-submenu');

                                    // Remove the class that adds the dropdown arrow
                                    wylogujMenuItem.classList.remove('is-dropdown-submenu-parent');

                                    // Remove any Foundation dropdown attributes that might have been added
                                    delete wylogujMenuItem.dataset.dropdownMenu;

                                    // Add a specific class to hide the arrow for this item only
                                    wylogujMenuItem.classList.add('no-dropdown-arrow');
                                }
                            }
                        }
                    });
                </script>

                <!-- Hidden logout form -->
                <form id="logout-form" action="{% url "logout" %}" method="post" style="display: none;">
                    {% csrf_token %}
                </form>

            {% endif %}

            {% if request.user.is_anonymous %}
                {% if microsoft_login_enabled %}
                    <li>
                        <a href="#"><i class="fi-lock" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i>
                        zaloguj</a>
                        <ul class="menu vertical">
                            <li><a href="{% url "bpp:microsoft_auth_redirect" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-cloud" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> logowanie</a></li>
                            <li><a href="{% url "local_login_form" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-home" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> logowanie lokalne</a></li>
                            <li><a href="{% url "admin:login" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-pencil" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> redagowanie</a></li>
                        </ul>
                    </li>
                {% else %}
                    <li><a href="{% url "login_form" %}?next={{ request.get_full_path }}">
                        <i class="fi-lock" style="font-size: 1.6rem; margin-right: 0.4rem; vertical-align: middle;"></i>
                        zaloguj</a></li>
                {% endif %}

            {% endif %}


        </ul>
    </div>
</div>

<!-- Include Global Search Modal -->
{% include 'global_search_modal.html' %}
<div id="globalSearchModal" class="global-search-modal">
    <div class="global-search-container">
        <button class="global-search-close" onclick="closeGlobalSearch()">&times;</button>
        <div class="search-hint">
            <span class="fi-key"></span> Skrót klawiszowy: /
        </div>
        <input type="text"
               id="globalSearchInput"
               class="global-search-input"
               placeholder="Wpisz, aby wyszukać... (minimum 3 znaki)"
               autocomplete="off">
        <div id="globalSearchResults" class="global-search-results"></div>
    </div>
</div>

<script type="text/javascript">
    (function() {
        var searchTimer = null;
        var currentRequest = null;
        var selectedIndex = -1;
        var searchResults = [];

        // Open search modal with dynamic positioning
        window.openGlobalSearch = function(event, isKeyboard) {
            var modal = document.getElementById('globalSearchModal');
            var input = document.getElementById('globalSearchInput');
            var container = document.querySelector('.global-search-container');

            // Remove previous animation classes
            container.classList.remove('from-button');

            // Calculate position
            var x, y;
            var animateFromButton = false;

            if (event && event.clientX && !isKeyboard) {
                // Clicked on search button - animate from button position
                var searchButton = document.querySelector('.search-icon-button');
                if (searchButton) {
                    var rect = searchButton.getBoundingClientRect();
                    x = rect.left + rect.width / 2;
                    y = rect.top + rect.height;
                    animateFromButton = true;
                } else {
                    x = event.clientX;
                    y = event.clientY;
                }
            } else {
                // Keyboard shortcut or fallback - center on screen
                x = window.innerWidth / 2;
                y = window.innerHeight * 0.25;
            }

            // Get container dimensions
            var containerWidth = Math.min(window.innerWidth * 0.85, 1200); // 85vw with max 1200px
            var containerHeight = 700; // approximate height with larger container

            // Calculate position
            var left, top;

            if (animateFromButton) {
                // Position near the search button for expansion animation
                left = Math.min(window.innerWidth - containerWidth - 20, x - containerWidth + 100);
                top = y + 10;
                container.classList.add('from-button');
            } else {
                // Center on screen for keyboard trigger
                left = (window.innerWidth - containerWidth) / 2;
                top = (window.innerHeight - containerHeight) / 2;
            }

            // Ensure container stays within viewport
            var padding = 20;

            // Check boundaries
            if (left < padding) left = padding;
            if (left + containerWidth > window.innerWidth - padding) {
                left = window.innerWidth - containerWidth - padding;
            }
            if (top < padding) top = padding;
            if (top + containerHeight > window.innerHeight - padding) {
                top = window.innerHeight - containerHeight - padding;
            }

            // Apply position
            container.style.left = left + 'px';
            container.style.top = top + 'px';

            // Show modal with animation
            modal.classList.add('show');

            // Reset and focus input
            setTimeout(function() {
                input.value = '';
                input.focus();
            }, 100);

            document.getElementById('globalSearchResults').innerHTML = '';
            selectedIndex = -1;
            searchResults = [];
        };

        // Close search modal
        window.closeGlobalSearch = function() {
            var modal = document.getElementById('globalSearchModal');
            var container = document.querySelector('.global-search-container');

            // Add closing animation
            container.classList.add('animating-out');
            modal.classList.add('closing');

            // After animation completes, hide modal
            setTimeout(function() {
                modal.classList.remove('show', 'closing');
                container.classList.remove('animating-out');

                // Reset container styles for next opening
                container.style.transform = '';
                container.style.opacity = '';
            }, 400);

            // Cancel any pending request
            if (currentRequest) {
                currentRequest.abort();
                currentRequest = null;
            }
        };

        // Perform search
        function performSearch(query) {
            if (query.length < 3) {
                document.getElementById('globalSearchResults').innerHTML =
                    '<div class="global-search-no-results">Wpisz minimum 3 znaki</div>';
                return;
            }

            // Cancel previous request if exists
            if (currentRequest) {
                currentRequest.abort();
            }

            // Show loading
            document.getElementById('globalSearchResults').innerHTML =
                '<div class="global-search-loading">Wyszukiwanie...</div>';

            // Make AJAX request
            currentRequest = $.ajax({
                url: '/bpp/navigation-autocomplete/',
                data: { q: query },
                dataType: 'json',
                success: function(data) {
                    displayResults(data.results || []);
                    currentRequest = null;
                },
                error: function(xhr) {
                    if (xhr.statusText !== 'abort') {
                        document.getElementById('globalSearchResults').innerHTML =
                            '<div class="global-search-no-results">Błąd podczas wyszukiwania</div>';
                    }
                    currentRequest = null;
                }
            });
        }

        // Display search results
        function displayResults(results) {
            var resultsContainer = document.getElementById('globalSearchResults');
            searchResults = [];

            if (!results || results.length === 0) {
                resultsContainer.innerHTML =
                    '<div class="global-search-no-results">Brak wyników</div>';
                return;
            }

            var html = '';
            results.forEach(function(group) {
                if (group.children && group.children.length > 0) {
                    var groupText = (group.text || '').toLowerCase();
                    var icon = '';

                    // Map Polish category names to Foundation Icons
                    if (groupText.includes('jednostk')) {
                        icon = '<i class="fi-home"></i>';
                    } else if (groupText.includes('autor')) {
                        icon = '<i class="fi-torso"></i>';
                    } else if (groupText.includes('źródł') || groupText.includes('zrodl')) {
                        icon = '<i class="fi-book"></i>';
                    } else if (groupText.includes('rekord')) {
                        icon = '<i class="fi-page"></i>';
                    }

                    html += '<div class="search-result-group">';
                    html += '<div class="search-result-group-title">' + icon + (group.text || '') + '</div>';

                    group.children.forEach(function(item) {
                        var index = searchResults.length;
                        searchResults.push(item);
                        html += '<div class="search-result-item" data-index="' + index + '" data-id="' + item.id + '">';
                        html += item.text;
                        html += '</div>';
                    });

                    html += '</div>';
                }
            });

            resultsContainer.innerHTML = html;
            selectedIndex = -1;

            // Add click handlers to results
            $('.search-result-item').on('click', function() {
                var itemId = $(this).data('id');
                navigateToResult(itemId);
            });
        }

        // Navigate to selected result
        function navigateToResult(itemId) {
            if (itemId) {
                location.href = '/global-nav-redir/' + itemId + '/?source=user';
            }
        }

        // Update selected item visual state with auto-scroll
        function updateSelection() {
            $('.search-result-item').removeClass('selected');
            if (selectedIndex >= 0 && selectedIndex < searchResults.length) {
                var $selectedItem = $('.search-result-item[data-index="' + selectedIndex + '"]');
                $selectedItem.addClass('selected');

                // Auto-scroll to keep selected item visible
                var container = $('#globalSearchResults')[0];
                var item = $selectedItem[0];

                if (item && container) {
                    var itemTop = item.offsetTop - container.offsetTop;
                    var itemBottom = itemTop + item.offsetHeight;
                    var containerHeight = container.clientHeight;
                    var scrollTop = container.scrollTop;

                    if (itemTop < scrollTop) {
                        // Item is above visible area
                        container.scrollTop = itemTop - 10;
                    } else if (itemBottom > scrollTop + containerHeight) {
                        // Item is below visible area
                        container.scrollTop = itemBottom - containerHeight + 10;
                    }
                }
            }
        }

        // Input handler with debouncing
        $('#globalSearchInput').on('input', function() {
            var query = $(this).val();

            // Clear previous timer
            if (searchTimer) {
                clearTimeout(searchTimer);
            }

            // Set new timer
            searchTimer = setTimeout(function() {
                performSearch(query);
            }, 300);
        });

        // Keyboard navigation
        $('#globalSearchInput').on('keydown', function(e) {
            if (e.key === 'Escape') {
                closeGlobalSearch();
                return;
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (selectedIndex < searchResults.length - 1) {
                    selectedIndex++;
                    updateSelection();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedIndex > 0) {
                    selectedIndex--;
                    updateSelection();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && searchResults[selectedIndex]) {
                    navigateToResult(searchResults[selectedIndex].id);
                } else if (searchResults.length > 0) {
                    // Select first result if none selected
                    navigateToResult(searchResults[0].id);
                }
            }
        });

        // Close on click outside
        $('#globalSearchModal').on('click', function(e) {
            if (e.target === this) {
                closeGlobalSearch();
            }
        });

        // Close on ESC key anywhere
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape' && $('#globalSearchModal').hasClass('show')) {
                closeGlobalSearch();
            }
        });

        // Open search with "/" key shortcut
        $(document).on('keydown', function(e) {
            // Don't trigger if user is typing in an input/textarea
            if ($(e.target).is('input, textarea, select')) {
                return;
            }

            // Check for "/" key (forward slash)
            if (e.key === '/' && !$('#globalSearchModal').hasClass('show')) {
                e.preventDefault();
                openGlobalSearch(null, true); // Pass true to indicate keyboard trigger
            }
        });
    })();
</script>
