
<nav role="navigation" aria-label="Główna nawigacja" class="sticky-header">
<div class="title-bar" data-responsive-toggle="example-menu" data-hide-for="medium">
    <button class="menu-icon" type="button" data-toggle="example-menu"
            aria-label="Otwórz menu nawigacyjne"></button>
    <div class="title-bar-title hide-for-print">Menu</div>
</div>

<div class="top-bar stacked-for-medium hide-for-print" id="example-menu">
    <div class="top-bar-left">
        <ul class="dropdown menu" data-dropdown-menu>
            <li>
                <a href="/">
                    <img src="{% load static %}{% static 'images/bpp-icon.png' %}" alt="BPP" class="bpp-logo">
                    BPP
                </a>
            </li>
            <li>
                <a href="#" aria-haspopup="menu"><i class="fi-magnifying-glass" aria-hidden="true"></i> szukaj</a>
                <ul class="menu vertical" role="menu">
                    <li role="menuitem">
                        <a href="#" data-action="open-global-search">
                            <i class="fi-magnifying-glass" aria-hidden="true"></i>
                            szybko
                            <span class="keyboard-shortcut" aria-label="Skrót klawiszowy: ukośnik">/</span>
                        </a>
                    </li>
                    <li role="menuitem">
                        <a href="{% url "multiseek:index" %}">
                            <i class="fi-page-search" aria-hidden="true"></i>
                            precyzyjnie
                        </a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#" aria-haspopup="menu"><i class="fi-list" aria-hidden="true"></i> przeglądaj</a>
                <ul class="menu vertical" role="menu">{% load deklinacja %}
                    <li role="menuitem"><a href="/"><i class="fi-foundation" aria-hidden="true"></i> {% rzeczownik_uczelnia %}</a></li>
                    <li role="menuitem"><a href="{% url "bpp:browse_jednostki" %}"><i class="fi-results-demographics" aria-hidden="true"></i> {% rzeczownik_jednostki_m %}</a></li>
                    <li role="menuitem"><a href="{% url "bpp:browse_autorzy" %}"><i class="fi-torsos-all" aria-hidden="true"></i> autorzy</a></li>
                    <li role="menuitem"><a href="{% url "bpp:browse_zrodla" %}"><i class="fi-book" aria-hidden="true"></i> źródła</a></li>
                    <li role="menuitem"><a href="{% url "bpp:browse_lata" %}"><i class="fi-calendar" aria-hidden="true"></i> wg roku</a></li>
                </ul>
            </li>
            <li>
                <a href="#" aria-haspopup="menu"><i class="fi-graph-trend" aria-hidden="true"></i> raporty</a>
                <ul class="menu vertical" role="menu" id="top-bar-menu-raportow">
                    {% load czy_pokazywac %}
                    {% load user_in_group %}

                    {% if ENABLE_NEW_REPORTS %}
                        {% czy_pokazywac raport_uczelni %}
                            <li>
                                <a href="{% url "nowe_raporty:uczelnia_form" %}">
                                    <i class="fi-foundation"></i> raport uczelni
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_wydzialow %}
                            <li>
                                <a href="{% url "nowe_raporty:wydzial_form" %}">
                                    <i class="fi-results-demographics"></i> raport wydziałów
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_jednostek %}
                            <li>
                                <a href="{% url "nowe_raporty:jednostka_form" %}">
                                    <i class="fi-map"></i> raport jednostek
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_autorow %}
                            <li>
                                <a href="{% url "nowe_raporty:autor_form" %}">
                                    <i class="fi-torsos-all"></i> raport autorów
                                </a>
                            </li>
                        {% end_czy_pokazywac %}
                    {% endif %}
                    {% czy_pokazywac ranking_autorow %}
                        <hr/>
                        <li><a href="{% url "bpp:ranking_autorow_formularz" %}"><i class="fi-trophy"></i> ranking
                            autorów</a></li>
                        <hr>
                    {% end_czy_pokazywac %}

                </ul>
            </li>

            <script type="text/javascript">
                var raportMenu = document.getElementById("top-bar-menu-raportow");

                // Remove leading HR elements
                while (raportMenu.firstElementChild && raportMenu.firstElementChild.tagName == "HR") {
                    raportMenu.firstElementChild.remove();
                }

                // Remove trailing HR elements
                while (raportMenu.lastElementChild && raportMenu.lastElementChild.tagName == "HR") {
                    raportMenu.lastElementChild.remove();
                }

                // Hide the entire raporty menu if it's empty
                if (raportMenu.children.length === 0) {
                    // Find and hide the parent <li> element that contains the "raporty" link and submenu
                    raportMenu.parentElement.style.display = 'none';
                }
            </script>

            <li class="has-submenu">
                <a href="#" data-toggle aria-haspopup="menu"><i class="fi-graph-bar" aria-hidden="true"></i> ewaluacja</a>
                <div class="menu-columns-wrapper" data-submenu id="top-bar-menu-ewaluacji">
                    {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                        <ul class="menu vertical column-1">
                            <li><a href="{% url "ewaluacja_liczba_n:index" %}"><i class="fi-list-number"></i> liczba N</a></li>
                            <li><a href="{% url "ewaluacja_metryki:lista" %}"><i class="fi-graph-trend"></i> metryki ewaluacyjne</a></li>
                            <li><a href="{% url "ewaluacja_optymalizacja:index" %}"><i class="fi-target-two"></i> optymalizacja ewaluacji</a></li>
                            <li><a href="{% url "snapshot_odpiec:index" %}"><i class="fi-camera"></i> snapshoty odpięć</a></li>
                            <li><a href="{% url "oswiadczenia:wydruk-2022-25" %}"><i class="fi-print"></i> wydruk oświadczeń 2022-25</a></li>
                        </ul>
                    {% endif %}
                    {% load czy_pokazywac %}
                    {% load user_in_group %}
                    <ul class="menu vertical column-2">
                        {% czy_pokazywac raport_slotow_autor %}
                            <li><a href="{% url "raport_slotow:index" %}"><i class="fi-torso"></i> raport slotów - autor</a></li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_slotow_zerowy %}
                            <li><a href="{% url "raport_slotow:raport-slotow-zerowy-parametry" %}"><i class="fi-clipboard-notes"></i> raport slotów -
                                zerowy</a>
                            </li>
                        {% end_czy_pokazywac %}
                        {% czy_pokazywac raport_slotow_uczelnia %}
                            <li><a href="{% url "raport_slotow:lista-raport-slotow-uczelnia" %}"><i class="fi-foundation"></i> raport slotów -
                                uczelnia</a></li>
                            <li><a href="{% url "raport_slotow:index-ewaluacja" %}"><i class="fi-clipboard-pencil"></i> raport slotów - ewaluacja</a>
                            <li><a href="{% url "raport_slotow:index-upowaznienia" %}"><i class="fi-shield"></i> raport ewaluacja -
                                upoważnienia</a>
                            {# Disabled 3N report #}
                            {# <li><a href="{% url "ewaluacja2021:lista-raportow3n" %}"><i class="fi-page-multiple" style="font-size: 1.6rem; margin-right: 0.8rem;"></i> raport ewaluacja - 3N</a> #}
                            </li>
                        {% end_czy_pokazywac %}
                    </ul>
                </div>
            </li>

            <script type="text/javascript">
                // Hide ewaluacja menu if both columns are empty
                var ewaluacjaMenu = document.getElementById("top-bar-menu-ewaluacji");
                if (ewaluacjaMenu) {
                    var columns = ewaluacjaMenu.querySelectorAll('ul.menu.vertical');
                    var allEmpty = true;
                    columns.forEach(function(col) {
                        if (col.querySelectorAll('li').length > 0) {
                            allEmpty = false;
                        }
                    });
                    if (columns.length === 0 || allEmpty) {
                        ewaluacjaMenu.parentElement.style.display = 'none';
                    }
                }
            </script>

            {% if not request.user.is_anonymous %}

                {% if request.user.is_superuser or request.user|has_group:"wprowadzanie danych" %}
                    {% if uczelnia.pbn_integracja %}
                        <li class="has-submenu">
                            <a href="#" data-toggle aria-haspopup="menu"><i class="fi-link" aria-hidden="true"></i> PBN</a>
                            <div class="menu-columns-wrapper" data-submenu>
                                {% if request.user|has_group:"wprowadzanie danych" or request.user.is_superuser %}
                                    <ul class="menu vertical column-1">
                                        <li><a href="{% url "pbn_api:authorize" %}" data-action="set-pbn-authorize-next"><i class="fi-key"></i> autoryzuj PBN API</a></li>
                                        <li><a href="{% url "pbn_import:dashboard" %}"><i class="fi-burst-new"></i> Import z PBN</a></li>
                                        <li><a href="{% url "pbn_downloader_app:main" %}"><i class="fi-download"></i> pobieranie danych z PBN</a></li>
                                        <li><a href="{% url "pbn_wysylka_oswiadczen:main" %}"><i class="fi-upload"></i> wysylka oswiadczen do PBN</a></li>
                                        <li><a href="{% url "pbn_export_queue:export-queue-list" %}"><i class="fi-list"></i> kolejka eksportu do PBN</a></li>
                                        <li><a href="{% url "importer_autorow_pbn:main" %}"><i class="fi-torsos-female-male"></i> importer autorów PBN</a></li>
                                        <li><a href="{% url "deduplikator_autorow:duplicate_authors" %}"><i class="fi-filter"></i> deduplikator autorów PBN</a></li>
                                    </ul>
                                    <ul class="menu vertical column-2">
                                        <li><a href="{% url "komparator_pbn:main" %}"><i class="fi-arrows-compress"></i> komparator PBN</a></li>
                                        <li><a href="{% url "komparator_pbn_udzialy:list" %}"><i class="fi-alert"></i> komparator udziałów PBN</a></li>
                                        <li><a href="{% url "komparator_publikacji_pbn:comparison_list" %}"><i class="fi-page-search"></i> komparator publikacji PBN</a></li>
                                        <li><a href="{% url "pbn_komparator_zrodel:list" %}"><i class="fi-book"></i> komparator źródeł PBN</a></li>
                                        <li><a href="{% url "przemapuj_zrodla_pbn:lista_skasowanych_zrodel" %}"><i class="fi-x-circle"></i> źródła skasowane w PBN</a></li>
                                    </ul>
                                {% endif %}
                            </div>
                        </li>
                    {% endif %}

                    <li class="has-submenu">
                        <a href="#" data-toggle aria-haspopup="menu"><i class="fi-wrench" aria-hidden="true"></i> operacje</a>
                        <div class="menu-columns-wrapper" data-submenu>
                            {% if request.user|has_group:"wprowadzanie danych" or request.user.is_superuser %}
                                <ul class="menu vertical column-1">
                                    <li><a href="{% url "integrator2:main" %}"><i class="fi-upload"></i> import danych</a></li>
                                    <li><a href="{% url "import_pracownikow:index" %}"><i class="fi-torsos"></i> import pracowników</a></li>
                                    <li><a href="{% url "import_polon:index" %}"><i class="fi-database"></i> import z POLON</a></li>
                                    <li><a href="{% url "import_polon:index-absencji" %}"><i class="fi-calendar"></i> import absencji</a></li>
                                    <li><a href="{% url "import_list_ministerialnych:index" %}"><i class="fi-clipboard-notes"></i> import list
                                        ministerialnych</a></li>
{#                                    <li><a href="{% url "ewaluacja2021:lista-importow" %}">import udziałów dla#}
{#                                        autorów</a>#}
{#                                    </li>#}
                                    <li><a href="{% url "import_list_if:index" %}"><i class="fi-graph-bar"></i> import list IF</a></li>
                                    <li><a href="{% url "import_dyscyplin:index" %}"><i class="fi-folder"></i> import dyscyplin</a></li>
                                    <hr/>
                                    <li><a href="{% url "bpp:xlsx-issn-chunks" %}"><i class="fi-download"></i> eksport ISSNów</a></li>
                                </ul>
                                <ul class="menu vertical column-2">
                                    <li><a href="{% url "admin:rozbieznosci_dyscyplin_rozbieznosciview_changelist" %}?q-l=on&q=rok%3E%3D2022&pracuje_na_uczelni=tak">
                                        <i class="fi-results-demographics"></i> rozbieżności dyscyplin autorów</a></li>
                                    <li><a href="{% url "admin:rozbieznosci_dyscyplin_rozbieznoscizrodelview_changelist" %}?q-l=on&q=rok%3E%3D2022&pracuje_na_uczelni=tak">
                                        <i class="fi-page-search"></i> rozbieżności dyscyplin źródeł</a></li>
                                    <li><a href="{% url "rozbieznosci_if:index" %}"><i class="fi-graph-pie"></i> rozbieżności
                                        punktacji IF</a></li>
                                    <li><a href="{% url "rozbieznosci_pk:index" %}"><i class="fi-graph-pie"></i> rozbieżności
                                        punktacji MNiSW</a></li>
                                    <hr>
                                    <li><a href="{% url "deduplikator_zrodel:duplicate_sources" %}">
                                        <i class="fi-page-multiple"></i> deduplikator źródeł</a></li>
                                </ul>
                            {% endif %}
                        </div>
                    </li>
                {% endif %}

                {% if request.user.is_staff %}
                    <li>
                        <a href="#" aria-haspopup="menu"><i class="fi-pencil" aria-hidden="true"></i> redagowanie</a>
                        <ul class="menu vertical" role="menu">
                            <li>
                                <a target="_blank" href="{% url "admin:index" %}">
                                    <i class="fi-pencil"></i> redagowanie
                                </a>
                            </li>
                            <hr/>
                            <li>
                                <a target="_blank" href="{% url "admin:bpp_autor_changelist" %}">
                                    <i class="fi-torso"></i> Autor
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="{% url "admin:bpp_wydawnictwo_ciagle_changelist" %}">
                                    <i class="fi-book"></i> Wydawnictwo Ciągłe
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="{% url "admin:bpp_wydawnictwo_zwarte_changelist" %}">
                                    <i class="fi-book"></i> Wydawnictwo Zwarte
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="{% url "admin:bpp_zrodlo_changelist" %}">
                                    <i class="fi-page-multiple"></i> Źródło
                                </a>
                            </li>
                            <li>
                                <a target="_blank" href="{% url "admin:zglos_publikacje_zgloszenie_publikacji_changelist" %}">
                                    <i class="fi-upload"></i> Zgłoszenia publikacji
                                </a>
                            </li>
                            {% if request.user.is_superuser %}
                                <hr/>
                                <li>
                                    <a target="_blank" href="{% url "admin:bpp_bppuser_changelist" %}">
                                        <i class="fi-torsos-all"></i> Użytkownicy
                                    </a>
                                </li>
                                <li>
                                    <a target="_blank" href="{% url "admin:auth_group_changelist" %}">
                                        <i class="fi-results-demographics"></i> Grupy
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </li>
                {% endif %}

                <li id="wyloguj-menu-item">
                    <a href="#" data-action="submit-logout-form"
                       aria-haspopup="menu">
                        <i class="fi-power" aria-hidden="true"></i> wyloguj
                    </a>
                    <ul class="menu vertical" role="menu" id="wyloguj-submenu">
                        <li role="menuitem">
                            <a href="#" data-action="submit-logout-form">
                                <i class="fi-power" aria-hidden="true"></i> wyloguj
                            </a>
                        </li>
                        {% if not microsoft_login_enabled %}
                            <li><a id="password-change-link" href="{% url "password_change" %}"><i class="fi-key"></i> zmiana hasła</a></li>
                        {% endif %}
                        {% if request.user.is_superuser %}
                            <li><a href="/admin/bpp/bppuser/" target="_blank"><i class="fi-torso-business"></i> zaloguj jako inny użytkownik</a></li>
                        {% endif %}
                    </ul>
                </li>

                <script type="text/javascript">
                    // Check if wyloguj menu has only one item and simplify if so
                    document.addEventListener('DOMContentLoaded', function() {
                        var wylogujMenuItem = document.getElementById('wyloguj-menu-item');
                        var wylogujSubmenu = document.getElementById('wyloguj-submenu');

                        if (wylogujMenuItem && wylogujSubmenu) {
                            // Count the number of submenu items
                            var submenuItems = wylogujSubmenu.querySelectorAll('li');

                            if (submenuItems.length === 1) {
                                // Remove the submenu entirely
                                wylogujSubmenu.remove();

                                // Remove the dropdown behavior by removing data attributes
                                var mainLink = wylogujMenuItem.querySelector('a');
                                if (mainLink) {
                                    // The main link already has the logout onclick handler, so we just need to ensure
                                    // it doesn't act as a dropdown trigger
                                    wylogujMenuItem.classList.remove('has-submenu');

                                    // Remove the class that adds the dropdown arrow
                                    wylogujMenuItem.classList.remove('is-dropdown-submenu-parent');

                                    // Remove any Foundation dropdown attributes that might have been added
                                    delete wylogujMenuItem.dataset.dropdownMenu;

                                    // Add a specific class to hide the arrow for this item only
                                    wylogujMenuItem.classList.add('no-dropdown-arrow');
                                }
                            }
                        }
                    });
                </script>

                <script type="text/javascript">
                    // Auto-position two-column menus to prevent viewport overflow
                    document.addEventListener('DOMContentLoaded', function() {
                        var hasSubmenus = document.querySelectorAll('li.has-submenu');

                        hasSubmenus.forEach(function(li) {
                            var menu = li.querySelector('.menu-columns-wrapper');
                            if (!menu) return;

                            li.addEventListener('mouseenter', function() {
                                // Reset position first
                                li.classList.remove('opens-left');
                                menu.style.left = '';
                                menu.style.right = '';

                                // Temporarily make menu measurable (visible layout but hidden visually)
                                var originalVisibility = menu.style.visibility;
                                var originalDisplay = menu.style.display;
                                menu.style.visibility = 'hidden';
                                menu.style.display = 'flex';

                                var menuRect = menu.getBoundingClientRect();
                                var liRect = li.getBoundingClientRect();
                                var viewportWidth = window.innerWidth;

                                // Calculate overflow for both directions
                                // Case 1: Open to right (left: 0) - menu left edge at li left edge
                                var menuRightIfOpenRight = liRect.left + menuRect.width;
                                var overflowRight = Math.max(0, menuRightIfOpenRight - viewportWidth);

                                // Case 2: Open to left (right: 0) - menu right edge at li right edge
                                var menuLeftIfOpenLeft = liRect.right - menuRect.width;
                                var overflowLeft = Math.max(0, -menuLeftIfOpenLeft);

                                // Restore original styles (CSS hover will take over)
                                menu.style.visibility = originalVisibility;
                                menu.style.display = originalDisplay;

                                // Choose direction with less overflow
                                if (overflowLeft < overflowRight) {
                                    li.classList.add('opens-left');
                                    menu.style.left = 'auto';
                                    menu.style.right = '0';
                                } else {
                                    menu.style.left = '0';
                                    menu.style.right = '';
                                }
                            });
                        });
                    });
                </script>

                <script type="text/javascript">
                    // Menu closing with 500ms delay - JavaScript controls visibility completely
                    // CSS :hover is NOT used for show/hide - only JS inline styles
                    document.addEventListener('DOMContentLoaded', function() {
                        var menuItems = document.querySelectorAll('.dropdown.menu > li');
                        var CLOSING_TIME = 500; // ms

                        menuItems.forEach(function(li) {
                            var closeTimeout = null;
                            var submenu = li.querySelector('.menu.vertical, .menu-columns-wrapper');
                            if (!submenu) return;

                            function showSubmenu() {
                                submenu.style.visibility = 'visible';
                                submenu.style.opacity = '1';
                                submenu.style.maxHeight = '800px';
                                submenu.style.transform = 'translateY(0) scaleY(1)';
                            }

                            function hideSubmenu() {
                                submenu.style.visibility = 'hidden';
                                submenu.style.opacity = '0';
                                submenu.style.maxHeight = '0';
                                submenu.style.transform = 'translateY(-20px) scaleY(0.8)';
                            }

                            // Mouseenter: show immediately, cancel own timeout, close others
                            li.addEventListener('mouseenter', function() {
                                if (closeTimeout) {
                                    clearTimeout(closeTimeout);
                                    closeTimeout = null;
                                }

                                // JavaScript SHOWS menu, not CSS :hover
                                showSubmenu();

                                // Close OTHER menus immediately
                                menuItems.forEach(function(otherLi) {
                                    if (otherLi !== li) {
                                        if (otherLi._closeTimeout) {
                                            clearTimeout(otherLi._closeTimeout);
                                            otherLi._closeTimeout = null;
                                        }
                                        var otherSubmenu = otherLi.querySelector('.menu.vertical, .menu-columns-wrapper');
                                        if (otherSubmenu) {
                                            otherSubmenu.style.visibility = 'hidden';
                                            otherSubmenu.style.opacity = '0';
                                            otherSubmenu.style.maxHeight = '0';
                                            otherSubmenu.style.transform = 'translateY(-20px) scaleY(0.8)';
                                        }
                                    }
                                });
                            });

                            // Mouseleave: 500ms timeout before hiding
                            li.addEventListener('mouseleave', function(e) {
                                var goingToMenu = e.relatedTarget && e.relatedTarget.closest('.dropdown.menu > li');
                                if (goingToMenu) return;

                                closeTimeout = setTimeout(function() {
                                    hideSubmenu();
                                    closeTimeout = null;
                                }, CLOSING_TIME);
                                li._closeTimeout = closeTimeout;
                            });
                        });
                    });
                </script>

                <!-- Hidden logout form -->
                <form id="logout-form" action="{% url "logout" %}" method="post" class="hidden-logout-form">
                    {% csrf_token %}
                </form>

            {% endif %}

            {% if request.user.is_anonymous %}
                {% if microsoft_login_enabled %}
                    <li>
                        <a href="#" aria-haspopup="menu"><i class="fi-lock" aria-hidden="true"></i>
                        zaloguj</a>
                        <ul class="menu vertical" role="menu">
                            <li><a href="{% url "bpp:microsoft_auth_redirect" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-cloud"></i> logowanie instytucjonalne</a></li>
                            <li><a href="{% url "local_login_form" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-home"></i> logowanie BPP</a></li>
                            <li><a href="{% url "admin:login" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-pencil"></i> redagowanie</a></li>
                        </ul>
                    </li>
                {% else %}
                    <li>
                        <a href="#" aria-haspopup="menu"><i class="fi-lock" aria-hidden="true"></i>
                        zaloguj</a>
                        <ul class="menu vertical" role="menu">
                            <li><a href="{% url "login_form" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-home"></i> logowanie</a></li>
                            <li><a href="{% url "admin:login" %}?next={{ request.get_full_path|urlencode }}">
                                <i class="fi-pencil"></i> redagowanie</a></li>
                        </ul>
                    </li>
                {% endif %}

            {% endif %}


        </ul>
    </div>
</div>
</nav>

<!-- Include Global Search Modal -->
{% include 'global_search_modal.html' %}
