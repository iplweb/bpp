{% extends "admin/base.html" %}

{% load compress i18n admin_tools_menu_tags crispy_forms_tags %}

{% block title %}{{ title }} - Bibliografia Publikacji Pracownik√≥w{% endblock %}

{% block branding %}
    <h1 id="site-name">{% trans 'Django administration' %}</h1>
{% endblock %}

{% block extrahead %}
    {{ global_nav_form.media }}

    <!-- HTMX for AJAX functionality -->
    {% load static %}
    <script src="{% static 'htmx.org/dist/htmx.js' %}"></script>

    <!-- Anti-FOUC: Hide page until fully loaded -->
    <style>
        html {
            visibility: hidden !important;
            opacity: 0 !important;
        }
    </style>
    <script>
        // Show page after select2 and all scripts are loaded
        (function() {
            function showPage() {
                document.documentElement.style.setProperty('visibility', 'visible', 'important');
                document.documentElement.style.setProperty('opacity', '1', 'important');
            }

            // Wait for window.load (all resources including scripts loaded)
            window.addEventListener('load', function() {
                // Give select2 extra 100ms to initialize
                setTimeout(showPage, 100);
            });
        })();
    </script>
{% endblock %}

{% block nav-global %}
    {% if user.is_active and user.is_staff %}
        {% if not is_popup %}
            <div id="nav-global-container">
                <div id="menu-container">
                    {% if request.user.is_staff %}
                        {% admin_tools_render_menu %}
                    {% endif %}
                </div>
                <div id="search-container">
                    {% crispy global_nav_form %}
                    <script type="text/javascript">
                        (function($){
                            // Handle select2 change event
                            $(':input[name$=global_nav_value]').on('change', function () {
                                var $select = $(this);
                                var $container = $select.next('.select2-container');

                                // Close dropdown immediately
                                $select.select2('close');

                                // Disable select to prevent further interaction
                                $select.prop('disabled', true);

                                // Add loading state to container
                                $container.addClass('select2-loading');

                                // Change cursor to waiting
                                $('body').css('cursor', 'wait');

                                // Perform redirect
                                location.href = "/global-nav-redir/" + $(this).val() +
                                    "?source=admin";
                            });

                            // Function to focus on Select2 search field
                            function focusSelect2SearchField() {
                                // Try multiple strategies with increasing delays
                                var attempts = [0, 50, 150];
                                var attemptIndex = 0;

                                function tryFocus() {
                                    setTimeout(function() {
                                        // Try different selectors
                                        var $search1 = $('.select2-container--open .select2-search__field');
                                        var $search2 = $('.select2-search--dropdown .select2-search__field');
                                        var $search3 = $('input.select2-search__field:visible');

                                        // Try to find the search field
                                        var $search = $search1.length ? $search1 : ($search2.length ? $search2 : $search3);

                                        if ($search.length > 0) {
                                            // Force focus
                                            $search[0].focus();
                                            $search.trigger('focus');
                                            $search.select();
                                        } else {
                                            // If not found and more attempts available, try again
                                            if (attemptIndex < attempts.length - 1) {
                                                attemptIndex++;
                                                tryFocus();
                                            }
                                        }
                                    }, attempts[attemptIndex]);
                                }

                                tryFocus();
                            }

                            // Focus search field on any open (click or hotkey)
                            var $select = $('#id_global_nav_value');
                            $select.on('select2:open', function() {
                                focusSelect2SearchField();
                            });

                            // Add "/" hotkey to open global search
                            $(document).on('keydown', function(e) {
                                // Don't trigger if user is typing in an input/textarea
                                if ($(e.target).is('input, textarea, select')) {
                                    return;
                                }

                                // Check for "/" key
                                if (e.key === '/') {
                                    e.preventDefault();

                                    // Find the select2 container and open it
                                    if ($select.length > 0) {
                                        // Open the dropdown (focus will be handled by select2:open event)
                                        $select.select2('open');
                                    }
                                }
                            });
                        })(django.jQuery || $);
                    </script>
                </div>
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block footer %}
    {{ block.super }}

    {% if user.is_authenticated %}
        {% if not TESTING %}
        <!-- Freshworks Support Widget -->
        <script>
            window.fwSettings={
                'widget_id':205000000433
            };
            !function(){if("function"!=typeof window.FreshworksWidget){var n=function(){n.q.push(arguments)};n.q=[],window.FreshworksWidget=n}}()
        </script>
        <script type='text/javascript' src='https://euc-widget.freshworks.com/widgets/205000000433.js' async defer></script>

        <!-- Custom Support Button -->
        <button class="bpp-support-button hide-on-print" id="bppSupportButton">
            <span class="button-content">
                <span class="support-symbols">!?!</span>
                <span class="support-text">Support BPP</span>
            </span>
        </button>

        <script type="text/javascript">
            (function($){
                $(document).ready(function() {
                    // Hide the default Freshworks launcher
                    FreshworksWidget('hide', 'launcher');

                    setTimeout(function() {
                        if (typeof FreshworksWidget !== 'undefined') {

                            FreshworksWidget('prefill', 'ticketForm', {
                                custom_fields: {
                                    cf_adres_url: window.location.href
                                }
                            });


                            // Identify user for Freshworks
                            FreshworksWidget('identify', 'ticketForm', {
                                name: '{{ request.user.get_full_name|default:request.user.username|escapejs }}',
                                email: '{{ request.user.email|escapejs }}'
                            });
                        }
                    }, 1000);

                    // Track widget state
                    var widgetOpen = false;

                    // Handle custom support button click - toggle widget
                    $('#bppSupportButton').on('click', function(e) {
                        e.preventDefault();
                        if (typeof FreshworksWidget !== 'undefined') {
                            if (!widgetOpen) {
                                FreshworksWidget('open');
                                widgetOpen = true;
                            } else {
                                FreshworksWidget('close');
                                widgetOpen = false;
                            }
                        }
                    });
                });
            })(grp.jQuery);
        </script>
        {% endif %}
    {% endif %}

    {% compress css %}
        <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}bpp/css/admin-style.css"/>
        <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}bpp/css/admin-menu.css"/>
        <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}bpp/css/admin-themes.css"/>

        <!-- CSS Custom Property dla hover color (per theme) -->
        <style type="text/css">
            :root {
                {% if THEME_NAME_RAW == 'app-blue' %}
                --admin-hover-bg: #f0f7fa;
                {% elif THEME_NAME_RAW == 'app-green' %}
                --admin-hover-bg: #f0f8f2;
                {% elif THEME_NAME_RAW == 'app-orange' %}
                --admin-hover-bg: #fef5f0;
                {% else %}
                --admin-hover-bg: #f5f5f5;
                {% endif %}
            }
        </style>
    {% endcompress %}

    {% compress js %}
        <script type="text/javascript" src="{{ STATIC_URL }}bpp/js/admin-table-enhancements.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}bpp/js/admin-theme-switcher.js"></script>
    {% endcompress %}

    <script type="text/javascript">
        (function ($) {

            $(document).ready(function () {

                grp.jQuery('.charmap').keypad({
                    keypadOnly: false,
                    layout: [
                        'Œ±Œ≤Œ≥Œ¥ŒµŒ∂ ¬©¬Æ √†√°√¢√£√§√•√¶√ß√ü —ä—è—à–µ—Ä—Ç—ã—É',
                        'Œ∑Œ∏ŒπŒ∫ŒªŒº ‚Ñ¢‚Ñ† √®√©√™√´√¨√≠√≠√Æ  –∏–æ–ø—é—â—ç–∞—Å',
                        'ŒΩŒæŒøœÄœÅœÉ ‚Ç¨¬£ √Ø√±√≤√≥√¥√µ√∂√∏  –¥—Ñ–≥—á–π–∫–ª—å',
                        'œÑœÖœÜœáœàœâ ¬•¬¢ √π√∫√ª√º√Ω√ø√∞√æ  –∂–∑—Ö—Ü–≤–±–Ω–º',
                        grp.jQuery.keypad.SHIFT + grp.jQuery.keypad.CLOSE
                    ],
                    showAnim: 'fadeIn',
                    duration: 'fast',
                    showOn: 'button',
                    buttonText: 'üåê'
                });

                // Przyciski jquery.keypad
                $("button.keypad-trigger").each(
                    function (no, tag) {
                        var tag = $(tag);
                        var first = tag.siblings().first();
                        if (first.is("textarea"))
                            tag.css("margin-left", "12px")
                                .css("margin-top", "15px");

                        tag.css("color", "black")
                            .attr("tabindex", "-1");
                    });
            });

        })(grp.jQuery);
    </script>

    <script type="text/javascript">
        (function($){
            $(document).ready(function() {
                // Przechwytywanie klikniƒôƒá w menu admin - WSZYSTKIE linki w menu-container
                $('#menu-container a').on('click', function(e) {
                    var $link = $(this);
                    var menuLabel = $link.text().trim();
                    var menuUrl = $link.attr('href');

                    // Nie loguj klikniƒôƒá w # (placeholder links)
                    if (!menuUrl || menuUrl === '#' || menuUrl === 'javascript://') {
                        return;
                    }

                    // Wy≈õlij dane do backendu (asynchronicznie, nie blokuj nawigacji)
                    $.ajax({
                        url: '{% url "admin_dashboard:log_menu_click" %}',
                        type: 'POST',
                        data: {
                            menu_label: menuLabel,
                            menu_url: menuUrl,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        async: true,
                        // Ignoruj b≈Çƒôdy - nie chcemy przerywaƒá nawigacji
                        error: function() {
                            // Silent fail
                        }
                    });
                });
            });
        })(grp.jQuery);
    </script>
{% endblock %}
