{% extends "admin/base.html" %}

{% load compress i18n admin_tools_menu_tags crispy_forms_tags %}

{% block title %}{{ title }} - Bibliografia Publikacji Pracowników{% endblock %}

{% block branding %}
    <h1 id="site-name">{% trans 'Django administration' %}</h1>
{% endblock %}

{% block extrahead %}
    {{ global_nav_form.media }}

    <!-- Anti-FOUC: Hide page until fully loaded -->
    <style>
        html {
            visibility: hidden !important;
            opacity: 0 !important;
        }
    </style>
    <script>
        // Show page after select2 and all scripts are loaded
        (function() {
            function showPage() {
                document.documentElement.style.setProperty('visibility', 'visible', 'important');
                document.documentElement.style.setProperty('opacity', '1', 'important');
            }

            // Wait for window.load (all resources including scripts loaded)
            window.addEventListener('load', function() {
                // Give select2 extra 100ms to initialize
                setTimeout(showPage, 100);
            });
        })();
    </script>
{% endblock %}

{% block nav-global %}
    {% if user.is_active and user.is_staff %}
        {% if not is_popup %}
            <div style="float: right; ">
                {% crispy global_nav_form %}
                <script type="text/javascript">
                    (function($){
                        // Handle select2 change event
                        $(':input[name$=global_nav_value]').on('change', function () {
                            var $select = $(this);
                            var $container = $select.next('.select2-container');

                            // Close dropdown immediately
                            $select.select2('close');

                            // Disable select to prevent further interaction
                            $select.prop('disabled', true);

                            // Add loading state to container
                            $container.addClass('select2-loading');

                            // Change cursor to waiting
                            $('body').css('cursor', 'wait');

                            // Perform redirect
                            location.href = "/global-nav-redir/" + $(this).val() +
                                "?source=admin";
                        });

                        // Add "/" hotkey to open global search
                        $(document).on('keydown', function(e) {
                            // Don't trigger if user is typing in an input/textarea
                            if ($(e.target).is('input, textarea, select')) {
                                return;
                            }

                            // Check for "/" key
                            if (e.key === '/') {
                                e.preventDefault();

                                // Find the select2 container and open it
                                var $select = $('#id_global_nav_value');

                                if ($select.length > 0) {
                                    // Use select2:open event to ensure dropdown is fully rendered
                                    $select.one('select2:open', function() {
                                        // Try multiple strategies with increasing delays
                                        var attempts = [50, 150, 300];
                                        var attemptIndex = 0;

                                        function tryFocus() {
                                            setTimeout(function() {
                                                // Try different selectors
                                                var $search1 = $('.select2-container--open .select2-search__field');
                                                var $search2 = $('.select2-search--dropdown .select2-search__field');
                                                var $search3 = $('input.select2-search__field:visible');

                                                // Try to find the search field
                                                var $search = $search1.length ? $search1 : ($search2.length ? $search2 : $search3);

                                                if ($search.length > 0) {
                                                    // Force focus
                                                    $search[0].focus();
                                                    $search.trigger('focus');
                                                    $search.select();
                                                } else {
                                                    // If not found and more attempts available, try again
                                                    if (attemptIndex < attempts.length - 1) {
                                                        attemptIndex++;
                                                        tryFocus();
                                                    }
                                                }
                                            }, attempts[attemptIndex]);
                                        }

                                        tryFocus();
                                    });

                                    // Open the dropdown
                                    $select.select2('open');
                                }
                            }
                        });
                    })(django.jQuery || $);
                </script>
            </div>
            <div>
                {% if request.user.is_staff %}
                    {% admin_tools_render_menu %}
                {% endif %}
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block footer %}
    {{ block.super }}

    {% if user.is_authenticated %}
        {% if not TESTING %}
        <!-- Freshworks Support Widget -->
        <script>
            window.fwSettings={
                'widget_id':205000000433
            };
            !function(){if("function"!=typeof window.FreshworksWidget){var n=function(){n.q.push(arguments)};n.q=[],window.FreshworksWidget=n}}()
        </script>
        <script type='text/javascript' src='https://euc-widget.freshworks.com/widgets/205000000433.js' async defer></script>

        <!-- Custom Support Button -->
        <button class="bpp-support-button hide-on-print" id="bppSupportButton">
            <span class="button-content">
                <span class="support-symbols">!?!</span>
                <span class="support-text">Support BPP</span>
            </span>
        </button>

        <script type="text/javascript">
            (function($){
                $(document).ready(function() {
                    // Hide the default Freshworks launcher
                    FreshworksWidget('hide', 'launcher');

                    setTimeout(function() {
                        if (typeof FreshworksWidget !== 'undefined') {

                            FreshworksWidget('prefill', 'ticketForm', {
                                custom_fields: {
                                    cf_adres_url: window.location.href
                                }
                            });


                            // Identify user for Freshworks
                            FreshworksWidget('identify', 'ticketForm', {
                                name: '{{ request.user.get_full_name|default:request.user.username|escapejs }}',
                                email: '{{ request.user.email|escapejs }}'
                            });
                        }
                    }, 1000);

                    // Track widget state
                    var widgetOpen = false;

                    // Handle custom support button click - toggle widget
                    $('#bppSupportButton').on('click', function(e) {
                        e.preventDefault();
                        if (typeof FreshworksWidget !== 'undefined') {
                            if (!widgetOpen) {
                                FreshworksWidget('open');
                                widgetOpen = true;
                            } else {
                                FreshworksWidget('close');
                                widgetOpen = false;
                            }
                        }
                    });
                });
            })(grp.jQuery);
        </script>
        {% endif %}
    {% endif %}

    {% compress css %}
        <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}bpp/css/admin-style.css"/>
        <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}bpp/css/admin-menu.css"/>

        <style type="text/css">
            .keypad-key {
                color: black !important;
            }

            /* Admin table row hover effect with theme color */
            {% if THEME_NAME_RAW == 'app-blue' %}
                #result_list tbody tr:hover td,
                #result_list tbody tr:hover th {
                    background-color: #f0f7fa !important;
                    transition: background-color 0.15s ease;
                }
                .form-row.grp-row:hover {
                    background-color: #f5f5f5;
                    transition: background-color 0.15s ease;
                    border-radius: 3px;
                }
            {% elif THEME_NAME_RAW == 'app-green' %}
                #result_list tbody tr:hover td,
                #result_list tbody tr:hover th {
                    background-color: #f0f8f2 !important;
                    transition: background-color 0.15s ease;
                }
                .form-row.grp-row:hover {
                    background-color: #f5f5f5;
                    transition: background-color 0.15s ease;
                    border-radius: 3px;
                }
            {% elif THEME_NAME_RAW == 'app-orange' %}
                #result_list tbody tr:hover td,
                #result_list tbody tr:hover th {
                    background-color: #fef5f0 !important;
                    transition: background-color 0.15s ease;
                }
                .form-row.grp-row:hover {
                    background-color: #f5f5f5;
                    transition: background-color 0.15s ease;
                    border-radius: 3px;
                }
            {% else %}
                /* Fallback for unknown theme */
                #result_list tbody tr:hover td,
                #result_list tbody tr:hover th {
                    background-color: #f5f5f5 !important;
                    transition: background-color 0.15s ease;
                }
                .form-row.grp-row:hover {
                    background-color: #f5f5f5;
                    transition: background-color 0.15s ease;
                    border-radius: 3px;
                }
            {% endif %}

            /* Support Button Styles for Admin */
            .bpp-support-button {
                position: fixed;
                bottom: 70px;
                right: 25px;
                z-index: 9999;
                background-color: #417690;
                {#color: white;#}
                border: none;
                border-radius: 5px;
                padding: 0px 20px !important;
                {#font-size: 18px;#}
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transition: all 0.3s ease;
                min-width: 60px;
                text-align: center;
            }

            /* Move button 50px lower when there's no fixed footer */
            body:not(:has(footer.grp-module.grp-submit-row.grp-fixed-footer)) .bpp-support-button {
                bottom: 20px;
            }

            .bpp-support-button .button-content {
                position: relative;
                display: inline-block;
            }

            .bpp-support-button .support-symbols {
                display: inline-block;
                opacity: 1;
                transition: opacity 0.3s ease;
                letter-spacing: 1px;
            }

            .bpp-support-button .support-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                opacity: 0;
                transition: opacity 0.3s ease;
                white-space: nowrap;
                pointer-events: none;
            }

            .bpp-support-button:hover {
                background-color: #205067;
                color: white;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
                padding: 0px 0px !important;
                width: 150px;
                height: 40px;
            }

            .bpp-support-button:hover .support-symbols {
                opacity: 0;
            }

            .bpp-support-button:hover .support-text {
                opacity: 1;
                {#font-size: 16px;#}
            }

            .bpp-support-button:active {
                transform: translateY(0);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .bpp-support-button:focus {
                outline: 2px solid #79aec8;
                outline-offset: 2px;
            }

            @media screen and (max-width: 640px) {
                .bpp-support-button {
                    bottom: 20px;
                    right: 20px;
                    font-size: 16px;
                    padding: 0px 0px;
                }

                .bpp-support-button:hover {
                    padding: 0px 0px;
                }

                .bpp-support-button:hover .support-text {
                    font-size: 14px;
                }
            }

            @media print {
                .bpp-support-button {
                    display: none;
                }
            }
        </style>
    {% endcompress %}

    {% compress js %}
        <script type="text/javascript" src="{{ STATIC_URL }}bpp/js/admin-table-enhancements.js"></script>
    {% endcompress %}

    <script type="text/javascript">
        (function ($) {

            $(document).ready(function () {

                txt = $("#grp-admin-title").text();
                $("#grp-admin-title").html(
                    '<a href="/">' + txt + '</a>');

                grp.jQuery('.charmap').keypad({
                    keypadOnly: false,
                    layout: [
                        'αβγδεζ ©® àáâãäåæçß ъяшертыу',
                        'ηθικλμ ™℠ èéêëìííî  иопющэас',
                        'νξοπρσ €£ ïñòóôõöø  дфгчйкль',
                        'τυφχψω ¥¢ ùúûüýÿðþ  жзхцвбнм',
                        grp.jQuery.keypad.SHIFT + grp.jQuery.keypad.CLOSE
                    ],
                    showAnim: 'fadeIn',
                    duration: 'fast',
                    showOn: 'button'
                });

                // Przyciski jquery.keypad
                $("button.keypad-trigger").each(
                    function (no, tag) {
                        var tag = $(tag);
                        var first = tag.siblings().first();
                        if (first.is("textarea"))
                            tag.css("margin-left", "12px")
                                .css("margin-top", "15px");

                        tag.css("color", "black")
                            .attr("tabindex", "-1");
                    });
            });

        })(grp.jQuery);
    </script>
{% endblock %}
