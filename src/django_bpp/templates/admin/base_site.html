{% extends "admin/base.html" %}

{% load compress i18n admin_tools_menu_tags crispy_forms_tags %}

{% block title %}{{ title }} - Bibliografia Publikacji Pracowników{% endblock %}

{% block branding %}
    <h1 id="site-name">{% trans 'Django administration' %}</h1>
{% endblock %}

{% block extrahead %}
    {{ global_nav_form.media }}
{% endblock %}

{% block nav-global %}
    {% if user.is_active and user.is_staff %}
        {% if not is_popup %}
            <div style="float: right; ">
                {% crispy global_nav_form %}
                <script type="text/javascript">
                    (function($){
                        // Handle select2 change event
                        $(':input[name$=global_nav_value]').on('change', function () {
                            location.href = "/global-nav-redir/" + $(this).val() +
                                "?source=admin";
                        });

                        // Add "/" hotkey to open global search
                        $(document).on('keydown', function(e) {
                            // Don't trigger if user is typing in an input/textarea
                            if ($(e.target).is('input, textarea, select')) {
                                return;
                            }

                            // Check for "/" key
                            if (e.key === '/') {
                                e.preventDefault();

                                // Find the select2 container and open it
                                var $select = $('#id_global_nav_value');

                                if ($select.length > 0) {
                                    // Use select2:open event to ensure dropdown is fully rendered
                                    $select.one('select2:open', function() {
                                        // Try multiple strategies with increasing delays
                                        var attempts = [50, 150, 300];
                                        var attemptIndex = 0;

                                        function tryFocus() {
                                            setTimeout(function() {
                                                // Try different selectors
                                                var $search1 = $('.select2-container--open .select2-search__field');
                                                var $search2 = $('.select2-search--dropdown .select2-search__field');
                                                var $search3 = $('input.select2-search__field:visible');

                                                // Try to find the search field
                                                var $search = $search1.length ? $search1 : ($search2.length ? $search2 : $search3);

                                                if ($search.length > 0) {
                                                    // Force focus
                                                    $search[0].focus();
                                                    $search.trigger('focus');
                                                    $search.select();
                                                } else {
                                                    // If not found and more attempts available, try again
                                                    if (attemptIndex < attempts.length - 1) {
                                                        attemptIndex++;
                                                        tryFocus();
                                                    }
                                                }
                                            }, attempts[attemptIndex]);
                                        }

                                        tryFocus();
                                    });

                                    // Open the dropdown
                                    $select.select2('open');
                                }
                            }
                        });
                    })(django.jQuery || $);
                </script>
            </div>
            <div style="display: none;" id="show-after-load">
                {% if request.user.is_staff %}
                    {% admin_tools_render_menu %}
                {% endif %}
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block footer %}
    {{ block.super }}
    {% compress css %}
        <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}bpp/css/admin-style.css"/>
        <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}bpp/css/admin-menu.css"/>

        <style type="text/css">
            .keypad-key {
                color: black !important;
            }
        </style>
    {% endcompress %}
    <script type="text/javascript">
        (function ($) {

            $(document).ready(function () {

                $("#show-after-load").css("display", "block");
                txt = $("#grp-admin-title").text();
                $("#grp-admin-title").html(
                    '<a href="/">' + txt + '</a>');

                grp.jQuery('.charmap').keypad({
                    keypadOnly: false,
                    layout: [
                        'αβγδεζ ©® àáâãäåæçß ъяшертыу',
                        'ηθικλμ ™℠ èéêëìííî  иопющэас',
                        'νξοπρσ €£ ïñòóôõöø  дфгчйкль',
                        'τυφχψω ¥¢ ùúûüýÿðþ  жзхцвбнм',
                        grp.jQuery.keypad.SHIFT + grp.jQuery.keypad.CLOSE
                    ],
                    showAnim: 'fadeIn',
                    duration: 'fast',
                    showOn: 'button'
                });

                // Przyciski jquery.keypad
                $("button.keypad-trigger").each(
                    function (no, tag) {
                        var tag = $(tag);
                        var first = tag.siblings().first();
                        if (first.is("textarea"))
                            tag.css("margin-left", "12px")
                                .css("margin-top", "15px");

                        tag.css("color", "black")
                            .attr("tabindex", "-1");
                    });
            });

        })(grp.jQuery);
    </script>
{% endblock %}
