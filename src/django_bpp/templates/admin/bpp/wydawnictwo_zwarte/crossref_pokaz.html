{% extends "admin/base_site.html" %}
{% load compress %}
<!-- LOADING -->
{% load static i18n admin_modify admin_urls grp_tags %}


<!-- STYLESHEETS -->
{% block stylesheets %}
    {{ block.super }}
{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" type="text/css"
          href="{% static "foundation-datepicker/foundation/fonts/foundation-icons.css" %}">
{% endblock %}

<!-- BREADCRUMBS -->
{% block breadcrumbs %}
    <ul>
        <li><a href="{% url 'admin:index' %}"></a></li>
        <li><a href="/admin/bpp/">BPP</a></li>
        <li><a href="{% url 'admin:bpp_wydawnictwo_zwarte_changelist' %}">Wydawnictwa zwarte</a></li>
        <li>Pobierz z CrossRef API</li>
    </ul>
{% endblock %}

<!-- CONTENT -->
{% block content %}
<div class="crossref-content">
    <div style="border: 2px solid red; border-style: groove; padding: 5px; width: auto;">
        <p><strong>Prace w toku!</strong></p>
        <p>Ogldasz cz serwisu udostpnion jako podgld technologiczny nadchodzcych zmian.
            Funkcja nie zostaa jeszcze ukoczona. </p>

    </div>

    <!-- Enhanced Styles -->
    {% if rekord_po_stronie_bpp %}
        <div class="danger-card">
            <h1><span class="fi-alert"></span> Rekord prawdopodobnie ju偶 istnieje w BPP!</h1>
            <p>Wyglda na to, 偶e po stronie BPP mo偶e ju偶 istnie taki rekord.</p>

            <div class="bibliographic-desc">
                <a href="{{ rekord_po_stronie_bpp.get_absolute_url }}" class="record-link">{{ rekord_po_stronie_bpp.opis_bibliograficzny_cache|safe }}</a>
            </div>

            <p>Poni偶ej mo偶esz obejrze dane, kt贸re otrzymane zostay z CrossRef API oraz ich ewentualne
                por贸wnanie z tym, co znajduje si po stronie BPP.</p>

            <p>Mo偶esz te偶 mimo to spr贸bowa <a href="../add/?identyfikator_doi={{ identyfikator_doi }}" class="link-button warning">Dodaj nowy rekord (ryzyko duplikatu)</a></p>
        </div>
    {% else %}
        <div class="success-card">
            <h1><span class="fi-check"></span> Brak odpowiednika po stronie BPP</h1>
            <p>Wyglda na to (bazujc na polach DOI, alternative-id oraz title), 偶e w bazie BPP nie ma takiego
                rekordu. Mo偶esz klikn poni偶szy link, aby przej do formularza tworzenia nowego rekordu.
                <strong>Uwaga</strong> - po zatwierdzeniu formularza zostanie utworzony nowy rekord w bazie.</p>

            <p><a href="../add/?identyfikator_doi={{ identyfikator_doi }}" class="link-button primary">Dodaj nowy rekord</a></p>
        </div>
    {% endif %}
    <style>
        /* Base Styles - scoped to crossref content only */
        .crossref-content {
            background: transparent;
            position: relative;
        }

        /* Card Containers */
        .crossref-content .result-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .crossref-content .warning-card {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .crossref-content .success-card {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .crossref-content .danger-card {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .crossref-content .info-card {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        /* Headers - scoped to crossref content */
        .crossref-content h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e8ed;
        }

        .crossref-content h2 {
            color: #34495e;
            font-size: 20px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .crossref-content h3 {
            color: #34495e;
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
            font-size: 14px !important;
        }

        .data-table th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
            font-size: 14px !important;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Column widths for matchowanie table */
        .matchowanie-table td:nth-child(1) { /* Atrybut */
            width: 15%;
            min-width: 120px;
        }

        .matchowanie-table td:nth-child(2) { /* Warto z CrossRef */
            width: 35%;
            min-width: 250px;
        }

        .matchowanie-table td:nth-child(3) { /* Status icon */
            width: 5%;
            min-width: 50px;
            text-align: center;
        }

        .matchowanie-table td:nth-child(4) { /* Wynik por贸wnania */
            width: 25%;
            min-width: 150px;
        }

        .matchowanie-table td:nth-child(5) { /* Odsyacze */
            width: 20%;
            min-width: 150px;
        }

        /* Column widths for kopiowanie table */
        .kopiowanie-table td:nth-child(1) { /* Atrybut */
            width: 20%;
            min-width: 120px;
        }

        .kopiowanie-table td:nth-child(2) { /* Warto */
            width: 40%;
            min-width: 200px;
        }

        .kopiowanie-table.with-bpp td:nth-child(3) { /* Warto po stronie BPP */
            width: 40%;
            min-width: 200px;
        }

        .kopiowanie-table.with-bpp td:nth-child(4) { /* Sugerowane dziaania */
            width: 20%;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
        }

        .status-ok {
            background: #d4edda;
            color: #28a745;
        }

        .status-user {
            background: #f8d7da;
            color: #dc3545;
        }

        .status-loose {
            background: #fff3cd;
            color: #ffc107;
        }

        .status-none {
            background: #e2e3e5;
            color: #6c757d;
        }

        .status-error {
            background: #f8d7da;
            color: #dc3545;
        }

        /* Pre and Code */
        pre {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
            white-space: pre-wrap !important;
            word-break: break-word;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px !important;
            line-height: 1.6;
            max-width: 600px;
            margin: 0;
            color: #212529;
        }

        code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px !important;
        }

        /* Buttons and Links */
        .action-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 4px 0;
            transition: background 0.2s;
        }

        .action-button:hover {
            background: #0056b3;
        }

        .action-button.success {
            background: #28a745;
        }

        .action-button.success:hover {
            background: #218838;
        }

        .action-button.warning {
            background: #ffc107;
            color: #212529;
        }

        .action-button.warning:hover {
            background: #e0a800;
        }

        .link-button {
            display: inline-block;
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 4px 0;
            font-size: 14px;
            transition: background 0.2s;
        }

        .link-button:hover {
            background: #5a6268;
            color: white;
            text-decoration: none;
        }

        .link-button.primary {
            background: #007bff;
        }

        .link-button.primary:hover {
            background: #0056b3;
        }

        /* New Source Box */
        .new-source-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .new-source-box strong {
            color: #ffd700;
        }

        /* Explanation Box */
        .crossref-content .explanation-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Details Summary */
        details {
            margin: 20px 0;
        }

        details summary {
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-weight: 600;
            color: #495057;
        }

        details summary:hover {
            background: #e9ecef;
        }

        details[open] summary {
            border-radius: 4px 4px 0 0;
            background: #e9ecef;
        }

        /* Attribute Column */
        .attribute-name {
            font-weight: 600;
            color: #495057;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px !important;
        }

        /* General text improvements - scoped to CrossRef pages only */
        .crossref-content p,
        .crossref-content li {
            font-size: 14px !important;
            line-height: 1.6;
        }

        .crossref-content .explanation-box p,
        .crossref-content .explanation-box li {
            font-size: 14px !important;
        }

        .crossref-content .result-card p {
            font-size: 14px !important;
        }

        /* Icon Adjustments */
        .fi-check, .fi-results, .fi-die-five, .fi-prohibited, .fi-skull {
            font-size: 20px;
        }

        /* Record Link */
        .record-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .record-link:hover {
            text-decoration: underline;
        }

        /* Bibliographic Description */
        .bibliographic-desc {
            background: #f8f9fa;
            padding: 15px;
            border-left: 3px solid #007bff;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
    <script type="text/javascript">
        // Use DOMContentLoaded instead of load to avoid conflicts
        document.addEventListener("DOMContentLoaded", () => {
            function sendData(form) {
                const XHR = new XMLHttpRequest();
                const FD = new FormData(form);

                XHR.addEventListener("load", (event) => {
                    const btn = form.querySelector("input[type=submit]");
                    if (btn) btn.value = "Wykonano!";
                });

                XHR.addEventListener("error", (event) => {
                    const btn = form.querySelector("input[type=submit]");
                    if (btn) btn.value = "Wystpi bd...";
                    alert('Wystpi bd podczas wysyania zapytania.');
                });

                XHR.open("POST", form.action);
                XHR.send(FD);
            }

            // More specific selector to avoid catching nav search form
            const forms = document.querySelectorAll(".crossref-content form.ajax-form");

            forms.forEach(function (item, idx) {
                item.addEventListener('submit', function (event) {
                    event.preventDefault();
                    sendData(item);
                });
            });
        });
    </script>

    <div class="result-card">
        <h1>Matchowanie danych</h1>
        <div class="explanation-box">
            <p><strong>Wyjanienie procesu matchowania:</strong></p>
            <p>Poni偶ej znajduj si elementy danych z CrossRef API kt贸re po stronie BPP s indeksowane bd藕
            s identyfikatorami. Dla istniejcych rekord贸w po stronie BPP powinien pojawi
            si match (lu藕ny bd藕 dopasowany) oraz odsyacz do tego matchu.</p>
            <ul>
                <li>W przypadku niejednoznacznego matchowania - pojawi si lista mo偶liwych dopasowa</li>
                <li>Gdy nie mo偶na dopasowa 偶adnego rekordu - upewnij si, 偶e po stronie BPP na pewno nie ma takiego wpisu</li>
                <li>Problemy z matchowaniem mog wynika z r贸偶nych form tekstowego zapisu (np. nazwisk, mylnik贸w, polskich znak贸w)</li>
            </ul>
        </div>

        <table class="data-table matchowanie-table">
        <tr>
            <th>Atrybut</th>
            <th>Warto z CrossRef</th>
            <th></th>
            <th>Wynik por贸wnania</th>
            <th>Odsyacze</th>
        </tr>
        {% for elem in dane_porownania %}
            <tr>
                <td><span class="attribute-name">{{ elem.atrybut }}</span></td>
                <td>
                    <pre>{{ elem.wartosc_z_crossref_print }}</pre>
                </td>
                <td>
                    {% if elem.rezultat.status == 'ok' %}
                        <span class="status-badge status-ok"><span class="fi-check"></span></span>
                    {% elif elem.rezultat.status == 'user' %}
                        <span class="status-badge status-user"><span class="fi-results"></span></span>
                    {% elif elem.rezultat.status == 'luzne' %}
                        <span class="status-badge status-loose"><span class="fi-die-five"></span></span>
                    {% elif elem.rezultat.status == 'brak' %}
                        <span class="status-badge status-none"><span class="fi-prohibited"></span></span>
                    {% elif elem.rezultat.status == 'blad' %}
                        <span class="status-badge status-error"><span class="fi-skull"></span></span>
                    {% else %}
                        Brak templatki dla statusu {{ elem.rezultat.status }} -- nale偶y poprawi
                        w kodzie oprogramowania BPP. Powiadom administratora serwisu.
                    {% endif %}
                </td>
                <td>{{ elem.rezultat.opis }}</td>
                <td>
                    {% for rekord in elem.rezultat.rekordy %}
                        <a target="_blank" href="{{ rekord.get_absolute_url }}" class="record-link">
                            {{ rekord }}{% if rekord.aktualna_jednostka %} -
                                {{ rekord.aktualna_jednostka }}{% endif %}</a>
                        <br/>
                    {% endfor %}

                    {% if elem.atrybut == "container-title" %}
                        {% if dane_nowego_zrodla %}
                            <form action="{% url "admin:bpp_zrodlo_add" %}" method="GET" target="_blank">
                                <input type="hidden" name="nazwa" value="{{ dane_nowego_zrodla.nazwa }}"/>
                                <input type="hidden" name="skrot" value="{{ dane_nowego_zrodla.skrot }}"/>
                                <input type="hidden" name="issn" value="{{ dane_nowego_zrodla.issn }}"/>
                                <input type="submit" value="Utw贸rz nowe 藕r贸do" class="action-button success"/>
                            </form>
                        {% endif %}
                    {% endif %}

                    {% if elem.orig_atrybut == "author" %}
                        {# umo偶liwiaj dodanie autora #}
                        {% if elem.rezultat.status != 'ok' %}
                            <form action="{% url "admin:bpp_autor_add" %}" method="GET" target="_blank">
                                <input type="hidden" name="nazwisko" value="{{ elem.wartosc_z_crossref.family }}"/>
                                <input type="hidden" name="imiona" value="{{ elem.wartosc_z_crossref.given }}"/>
                                <input type="hidden" name="orcid" value="{{ elem.wartosc_z_crossref.ORCID }}"/>
                                <input type="submit" value="Utw贸rz nowego autora" class="action-button"/>
                            </form>
                        {% endif %}

                        {# Je偶eli autor jest jeden i nie ma ORCIDu po stronie BPP, a po stronie CrossRef jest #}
                        {# to wywietl przycisk umo偶liwiajcy jego dodanie:  #}
                        {% if elem.wartosc_z_crossref.ORCID %}
                            {% if elem.rezultat.rekordy|length == 1 %}
                                {% if not elem.rezultat.rekordy.0.orcid %}
                                    <form class="ajax-form"
                                          method="post" action="{% url "bpp:api_ustaw_orcid" %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="autor" value="{{ elem.rezultat.rekordy.0.pk }}"/>
                                        <input type="hidden" name="orcid" value="{{ elem.wartosc_z_crossref.ORCID }}"/>
                                        <input type="submit" id="id_ustaw_orcid_button_{{ elem.atrybut }}"
                                               value="Skopiuj ORCID do rekordu autora" class="action-button warning"/>
                                    </form>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    </table>
    </div>

    <div class="result-card">
    <h1>Kopiowanie danych</h1>
    <p>Poni偶sze pola s znane i mog zosta skopiowane do docelowego rekordu z niewielkimi przer贸bkami.</p>
    <table class="data-table kopiowanie-table {% if rekord_po_stronie_bpp %}with-bpp{% endif %}">
        <tr>
            <th>Atrybut</th>
            <th>Warto</th>

            {% if rekord_po_stronie_bpp %}
                <th>Warto po stronie BPP</th>
                <th>Sugerowane dziaania</th>
            {% endif %}
        </tr>
        {% for key, value in do_skopiowania %}
            <tr>
                <td><span class="attribute-name">{{ key }}</span></td>
                <td>
                    <pre>{{ value.print }}</pre>
                </td>
                {% if rekord_po_stronie_bpp %}
                    <td>
                        {% if key == "abstract" %}
                            {% if rekord_po_stronie_bpp.original.streszczenia.exists %}
                                Istniej streszczenia dla tego rekordu.
                                <br/>
                                {% for streszczenie in rekord_po_stronie_bpp.original.streszczenia.all %}
                                    Jzyk: {{ streszczenie.jezyk_streszczenia }}<br/>
                                    {{ streszczenie.streszczenie }}
                                {% endfor %}
                            {% else %}
                                Brak streszcze.
                            {% endif %}
                        {% endif %}

                        {% if key == "page" %}
                            {% if rekord_po_stronie_bpp.original.strony != value.original %}
                                warto r贸偶na, po stronie BPP: {{ rekord_po_stronie_bpp.original.strony }}
                            {% else %}
                                wartoci zgodne
                            {% endif %}
                        {% endif %}

                        {% if key == "issue" %}
                            {% if rekord_po_stronie_bpp.original.nr_zeszytu != value.original %}
                                warto r贸偶na, po stronie BPP: {{ rekord_po_stronie_bpp.original.nr_zeszytu }}
                            {% else %}
                                wartoci zgodne
                            {% endif %}
                        {% endif %}

                        {% if key == "volume" %}
                            {% if rekord_po_stronie_bpp.original.tom != value.original %}
                                warto r贸偶na, po stronie BPP: {{ rekord_po_stronie_bpp.original.tom }}
                            {% else %}
                                wartoci zgodne
                            {% endif %}
                        {% endif %}

                        {% if key == "subject" %}
                            {% if rekord_po_stronie_bpp.slowa_kluczowe.exists %}
                                Okrelone sowa kluczowe:<br/>
                                {% for slowo_kluczowe in rekord_po_stronie_bpp.slowa_kluczowe.all %}
                                    {{ slowo_kluczowe.tag }}<br/>
                                {% endfor %}
                            {% else %}
                                brak s贸w kluczowych
                            {% endif %}
                        {% endif %}

                    </td>
                    <td>
                        {% if key == "abstract" %}
                            {% if not rekord_po_stronie_bpp.original.streszczenia.exists %}

                                <form class="ajax-form"
                                      method="post" action="{% url "bpp:api_ustaw_streszczenie" %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="rekord"
                                           value="{{ rekord_po_stronie_bpp.form_post_pk }}"/>
                                    <input type="hidden" name="streszczenie" value="{{ value.original|escape }}"/>
                                    <input type="submit" id="id_ustaw_streszczenie_button"
                                           value="Skopiuj warto do rekordu" class="action-button"/>
                                </form>
                            {% else %}
                                System BPP na ten moment potrafi doda streszczenie, gdy nie ma po stronie BPP
                                偶adnych streszcze. Ten rekord ma streszczenia po stronie BPP. Je偶eli potrzebujesz
                                je doda, zr贸b to rcznie.
                            {% endif %}
                        {% endif %}

                        {% if key == "page" %}
                            {% if rekord_po_stronie_bpp.original.strony != value.original %}
                                <form class="ajax-form"
                                      method="post" action="{% url "bpp:api_ustaw_strony" %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="rekord"
                                           value="{{ rekord_po_stronie_bpp.form_post_pk }}"/>
                                    <input type="hidden" name="strony" value="{{ value.original }}"/>
                                    <input type="submit" id="id_ustaw_strony_button"
                                           value="Skopiuj warto do rekordu" class="action-button"/>
                                </form>
                            {% endif %}
                        {% endif %}

                        {% if key == "volume" %}
                            {% if rekord_po_stronie_bpp.original.tom != value.original %}
                                <form class="ajax-form"
                                      method="post" action="{% url "bpp:api_ustaw_tom" %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="rekord"
                                           value="{{ rekord_po_stronie_bpp.form_post_pk }}"/>
                                    <input type="hidden" name="tom" value="{{ value.original }}"/>
                                    <input type="submit" id="id_ustaw_tom_button"
                                           value="Skopiuj warto do rekordu" class="action-button"/>
                                </form>
                            {% endif %}
                        {% endif %}

                        {% if key == "issue" %}

                            {% if rekord_po_stronie_bpp.original.nr_zeszytu != value.original %}
                                <form class="ajax-form"
                                      method="post" action="{% url "bpp:api_ustaw_nr_zeszytu" %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="rekord"
                                           value="{{ rekord_po_stronie_bpp.form_post_pk }}"/>
                                    <input type="hidden" name="nr_zeszytu" value="{{ value.original }}"/>
                                    <input type="submit" id="id_ustaw_nr_zeszytu_button"
                                           value="Skopiuj warto do rekordu" class="action-button"/>
                                </form>
                            {% endif %}
                        {% endif %}
                        {% if key == "subject" %}
                            {% if not rekord_po_stronie_bpp.original.slowa_kluczowe.exists %}
                                Dodaj sowa kluczowe rcznie - na ten moment po stronie BPP brak kodu umo偶liwiajcego
                                automatyczne dodawanie s贸w kluczowych.
                            {% endif %}
                        {% endif %}
                    </td>
                {% endif %}
            </tr>
        {% endfor %}
    </table>
    </div>

    <div class="result-card">
    <h2>Ignorowane dane</h2>
    <div class="explanation-box">
        <p>Poni偶sze pola zostay oznaczone w kodzie BPP jako ignorowane. Oznacza to, 偶e wiemy,
        偶e pojawiaj si w danych z CrossRef API, ale nie wiemy, co sob reprezentuj,
        nie mamy wskaz贸wek, w jaki spos贸b je wykorzysta lub te偶 wiemy, czym s i po co s,
        ale nie zrobimy z nimi po stronie BPP nic u偶ytecznego:</p>
    </div>
    <table class="data-table">
        {% for key, value in ignorowane %}
            <tr>
                <td><span class="attribute-name">{{ key }}</span></td>
                <td>
                    <pre>{{ value.print }}</pre>
                </td>
            </tr>
        {% endfor %}
    </table>
    </div>

    {% if obce %}
        <div class="result-card">
        <h2>Dane obce</h2>
        <div class="explanation-box">
            <p>Poni偶sze pola nie figuruj w kodzie BPP i nie ma na ten moment w kodzie 偶adnych wskaz贸wek,
            do jakiej grupy je zakwalifikowa.</p>
        </div>
        <table class="data-table">
            {% for key, value in obce %}
                <tr>
                    <td><span class="attribute-name">{{ key }}</span></td>
                    <td>
                        <pre>{{ value.print }}</pre>
                    </td>
                </tr>
            {% endfor %}
        </table>
        </div>
    {% endif %}
</div><!-- end crossref-content -->

{% endblock %}
