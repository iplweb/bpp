{% extends "bare.html" %}
{% load static static cache just_single_quotes bpp_version crispy_forms_tags %}

{% block extrahead %}
    {{ block.super }}

    <!-- jQuery Circle Progress for circular progress bars -->
    <script src="{% static 'jquery-circle-progress/dist/circle-progress.min.js' %}"></script>

    {% load session_security_tags %}
    {% load l10n %}

    {% if request.user.is_authenticated %}
        {% include 'session_security/dialog.html' %}
        <script type="text/javascript">
            var sessionSecurity = new yourlabs.SessionSecurity({
                pingUrl: '{% url 'session_security_ping' %}',
                warnAfter: {{ request|warn_after|unlocalize }},
                expireAfter: {{ request|expire_after|unlocalize }},
                confirmFormDiscard: false
            });

            var messageAlertSound = null;
        </script>
    {% endif %}

{% endblock %}

{% block body %}
    <script type="text/javascript">
        // Global search hotkey handler
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', function(e) {
                // Check if "/" key is pressed and not in an input field
                if (e.key === '/' && !$(e.target).is('input, textarea, select')) {
                    e.preventDefault(); // Prevent default search behavior
                    if (typeof openGlobalSearch === 'function') {
                        openGlobalSearch(null, true); // Pass true to indicate keyboard trigger
                    }
                }
            });
        });
    </script>
    <script type="text/javascript">
        function adjustBreadcrumbsPosition() {
            var topBar = document.getElementById('example-menu');
            var breadcrumbs = document.getElementById('breadcrumbs-wrapper');

            if (topBar && breadcrumbs) {
                var topBarHeight = topBar.getBoundingClientRect().height;
                breadcrumbs.style.top = topBarHeight + 'px';
            }
        }

        // Adjust on page load
        document.addEventListener('DOMContentLoaded', adjustBreadcrumbsPosition);

        // Adjust on window resize
        window.addEventListener('resize', adjustBreadcrumbsPosition);

        // Adjust after Foundation initializes (in case it changes heights)
        $(document).ready(function () {
            setTimeout(adjustBreadcrumbsPosition, 10);
        });
    </script>
    {% load notifications %}
    <div id="messageTemplate">
    {% verbatim messageTemplate %}
    <div data-closable
         data-url="{{ closeURL }}"
         class="ajax-on-close callout primary {{ cssClass }}{{^cssClass}}info{{/cssClass}}">
    {{#clickURL}}
        <a href="{{ clickURL }}">
        {{/clickURL}}
        {{{ text }}}
        {{#clickURL}}</a>{{/clickURL}}
            <button
                type="button"
                class="close-button"
                aria-label="Zamknij powiadomienie"
                data-close>
             <span aria-hidden="true">&times;</span>
             </button>

        </div>
        {% endverbatim messageTemplate %}
        </div>
        {# fix pycharm highlighting #}

    {% if request.user.is_authenticated %}
        {{ extraChannels|json_script:"extra-channels" }}

        {% if not TESTING %}
        <!-- Freshworks Support Widget -->
        <script>
            window.fwSettings={
                'widget_id':205000000433
            };
            !function(){if("function"!=typeof window.FreshworksWidget){var n=function(){n.q.push(arguments)};n.q=[],window.FreshworksWidget=n}}()
        </script>
        <script type='text/javascript' src='https://euc-widget.freshworks.com/widgets/205000000433.js' async defer></script>

        <!-- Identify user for Freshworks -->
        <script type="text/javascript">
            $(document).ready(function() {
                FreshworksWidget('hide', 'launcher');

                // Wait a bit for the widget to initialize
                setTimeout(function() {
                    if (typeof FreshworksWidget !== 'undefined') {
                        FreshworksWidget('identify', 'ticketForm', {
                            name: '{{ request.user.get_full_name|default:request.user.username|escapejs }}',
                            email: '{{ request.user.email|escapejs }}'
                        });

                    }
                }, 1000);
            });
        </script>

        <!-- Custom Support Button -->
        <button class="bpp-support-button hide-on-print" id="bppSupportButton">
            <span class="button-content">
                <span class="support-symbols">!?!</span>
                <span class="support-text">Support BPP</span>
            </span>
        </button>

        <script type="text/javascript">
            $(document).ready(function() {
                // Track widget state
                var widgetOpen = false;

                // Handle custom support button click - toggle widget
                $('#bppSupportButton').on('click', function(e) {
                    e.preventDefault();
                    if (typeof FreshworksWidget !== 'undefined') {
                        if (!widgetOpen) {

                            FreshworksWidget('prefill', 'ticketForm', {
                                custom_fields: {
                                    cf_adres_url: window.location.href
                                }
                            });

                            // Optional: make it read-only so users can’t change it
                            FreshworksWidget('disable', 'ticketForm', ['custom_fields.cf_page_url']);

                            FreshworksWidget('open');
                            widgetOpen = true;
                        } else {
                            FreshworksWidget('close');
                            widgetOpen = false;
                        }
                    }
                });
            });
        </script>
        {% endif %}

        <script type="text/javascript">
            $(document).ready(function () {
                bppNotifications.init(document.getElementById('extra-channels').textContent);

                $(document).on('closed.zf', function (event) {
                    if ($(event.target).hasClass("ajax-on-close")) {
                        var url = $(event.target).data("url");
                        if (url) {
                            $.get(url);
                        }
                    }
                });

                {% if messages %}
                    {% for message in messages %}
                        bppNotifications.addMessage({
                            cssClass: '{{ message.level|message_level_to_css_class }}',
                            clickURL: '{{ message.url }}',
                            {% if message.pk %}
                                closeURL: '{% url "messages_extends:message_mark_read" message.pk %}',
                            {% endif %}
                            pk: '{{ message.pk }}',
                            text: '{{ message.message|just_single_quotes|safe }}',
                            sound: false
                        });
                    {% endfor %}
                {% endif %}

            });

        </script>
    {% else %}
        {#        Użytkownik NIE jest autoryzowany -- wyrzuć mu za pomoca JScript (zeby wygladalo identycznie) #}
        {#        listę statycznych komunikatów -- flash messages (tych co to pomiędzy requestami)... #}

        <script type="text/javascript">
            $(document).ready(function () {
                bppNotifications.init();

                {% if messages %}
                    {% for message in messages %}
                        bppNotifications.addMessage({
                            cssClass: '{{ message.level|message_level_to_css_class }}',
                            clickURL: '{{ message.url }}',
                            {% if message.pk %}
                                closeURL: '{% url "messages_extends:message_mark_read" message.pk %}',
                            {% endif %}
                            pk: '{{ message.pk }}',
                            text: '{{ message.message|just_single_quotes|safe }}',
                            sound: false
                        });
                    {% endfor %}
                {% endif %}
            });
        </script>

    {% endif %}

    {% include "top_bar.html" %}
    {% block before-breadcrumbs %}{% endblock %}
    {% block breadcrumbs-html %}
        <div id="breadcrumbs-wrapper" class="grid-container-fluid hide-for-small-only">
            <div class="grid-x align-middle">
                <div class="cell auto">
                    <ul class="breadcrumbs">
                        {% block breadcrumbs %}
                            <li><a href="/">{{ uczelnia.skrot }}</a></li>
                        {% endblock %}
                    </ul>
                </div>
            </div>
        </div>
    {% endblock %}

    {% comment %}Countdown banner - handles both active and maintenance countdowns{% endcomment %}
    {% include "django_countdown/countdown_banner.html" %}

    <div class="grid-container-fluid" data-sticky-container>
        <div class="grid-container">
            <div class="grid-x">
                <div class="cell"><p/>
                    <div id="messagesPlaceholder"></div>
                    {% if DJANGO_BPP_ENABLE_TEST_CONFIGURATION %}
                        <div class="test-server-banner hide-on-print">
                            <span class="fi-alert"></span>
                            <span>SERWER TESTOWY - ZMIANY MOGĄ BYĆ NADPISANE BEZ OSTRZEŻENIA</span>
                            <span class="fi-alert"></span>
                        </div>
                    {% endif %}
                    <div id="content">

                        {% include "test_server_detection.html" %}

                        {% if password_change_required %}
                            <div class="grid-x align-center">
                                <div class="large-6 medium-8 small-12 cell">

                                    <div class='callout primary'>Twoje hasło uległo przeterminowaniu.
                                        Proszę, zmień je używając poniższego formularza.
                                    </div>
                                    <form action="." method="post">{% csrf_token %}
                                        {% crispy form %}{% if next %}
                                            <input type="hidden" name="next" value="{{ next }}"/>{% endif %}
                                    </form>
                                </div>
                            </div>
                        {% else %}<p/>
                            {% block content %}
                            {% endblock %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% load cookielaw_tags %}
            {% if cookielaw.notset %}{% rejectable_cookielaw_banner %}{% endif %}
        </div>
    </div>

    <!-- Full-width footer -->
    <div class="grid-container-fluid footer-container">
        <div class="grid-container">
            <div class="grid-x">
                {% include "base_footer.html" %}
            </div>
        </div>
    </div>

    {% if cookielaw.accepted %}
        {% cache 3600 google %}
            {% if GOOGLE_ANALYTICS_PROPERTY_ID %}
                {% include "google_analytics.html" %}
            {% endif %}
        {% endcache %}
    {% endif %}

    {% if not TESTING %}
        <!-- Widget dostępności UserWay (WCAG) -->
        <script>
            (function(d){
              var s = d.createElement("script");

              // Dynamiczne pobieranie koloru głównego (primary-color) ze stylów strony
              // Tworzymy tymczasowy element aby pobrać kolor przycisku Foundation
              var tempBtn = d.createElement('a');
              tempBtn.className = 'button';
              tempBtn.style.display = 'none';
              d.body.appendChild(tempBtn);
              var primaryColor = window.getComputedStyle(tempBtn).backgroundColor;
              d.body.removeChild(tempBtn);

              // Konwertujemy rgb() na hex jeśli potrzeba
              if (primaryColor && primaryColor.startsWith('rgb')) {
                var rgb = primaryColor.match(/\d+/g);
                if (rgb) {
                  primaryColor = '#' +
                    ('0' + parseInt(rgb[0]).toString(16)).slice(-2) +
                    ('0' + parseInt(rgb[1]).toString(16)).slice(-2) +
                    ('0' + parseInt(rgb[2]).toString(16)).slice(-2);
                }
              }

              /* uncomment the following line to override default position*/
              /* s.setAttribute("data-position", 3);*/
              /* uncomment the following line to override default size (values: small, large)*/
              /* s.setAttribute("data-size", "small");*/
              /* uncomment the following line to override default language (e.g., fr, de, es, he, nl, etc.)*/
              /* s.setAttribute("data-language", "language");*/

              // Ustawienie koloru widgetu zgodnie z kolorem głównym strony
              if (primaryColor) {
                s.setAttribute("data-color", primaryColor);
              }

              /* uncomment the following line to override type set via widget (1=person, 2=chair, 3=eye, 4=text)*/
              /* s.setAttribute("data-type", "1");*/
              /* s.setAttribute("data-statement_text:", "Our Accessibility Statement");*/
              /* s.setAttribute("data-statement_url", "http://www.example.com/accessibility")";*/
              /* uncomment the following line to override support on mobile devices*/
              /* s.setAttribute("data-mobile", true);*/
              /* uncomment the following line to set custom trigger action for accessibility menu*/
              /* s.setAttribute("data-trigger", "triggerId")*/
              /* uncomment the following line to override widget's z-index property*/
              /* s.setAttribute("data-z-index", 10001);*/
              /* uncomment the following line to enable Live site translations (e.g., fr, de, es, he, nl, etc.)*/
              /* s.setAttribute("data-site-language", "null");*/
              s.setAttribute("data-widget_layout", "full")
              s.setAttribute("data-account", "u5BrWIqGkK");
              s.setAttribute("src", "https://cdn.userway.org/widget.js");
              (d.body || d.head).appendChild(s);
            })(document)
        </script>
        <noscript>Please ensure Javascript is enabled for purposes of <a href="https://userway.org">website accessibility</a></noscript>
    {% endif %}

{% endblock %}
