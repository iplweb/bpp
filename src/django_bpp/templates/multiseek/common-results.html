{% load i18n %}
{% load pagination_tags %}

{% load compress %}
{% load prace %}

{% include "multiseek/print-logo.html" %}
{% include "multiseek/title.html" %}
<div class="multiseek-report-container">
    {%  if paginator_count > 25000 %}
        <div style="padding-left: 4em; padding-right: 4em;">
        <p>Wynik obecnego zapytania do bazy da≈Çby w rezultacie {{ paginator_count }} rekord√≥w. Jest to do≈õƒá du≈ºa ilo≈õƒá
            i szczerze m√≥wiƒÖc pobieranie ich wszystkich przez tƒÖ stronƒô WWW bƒôdzie dla Ciebie do≈õƒá karko≈Çomne. StƒÖd te≈º
            wy≈õwietlenie ich wszystkich nie wydaje siƒô byƒá na ten moment najlepszym pomys≈Çem.
            </p>
            <p>
            Prosimy, postaraj siƒô ograniczyƒá zapytanie do bazy danych w taki spos√≥b, aby dawa≈Ço w rezultacie maksymalnie
                do 25 tysiƒôcy rekord√≥w - w√≥wczas zostanƒÖ one wy≈õwietlone w wybranym przez Ciebie formacie w tym miejscu.</p>
        <p>Je≈ºeli potrzebujesz pobraƒá wszystkie rekordy z systemu BPP, skorzystaj z dostƒôpu przez API. Obs≈Çugiwane
            API to <a target="_blank" class="external-arrow-box" href="/api/v1/">JSON-REST</a> oraz <a target="_blank" class="external-arrow-box" href="/bpp/oai/?verb=ListSets">protok√≥≈Ç OAI-PMH</a>.
        </div>
    {% else %}

{% if request.user.is_anonymous %}
    {#    anonim #}
    {% if request.GET.all == "1" %}
        {% autopaginate object_list paging uczelnia.wyszukiwanie_rekordy_na_strone_anonim %}
    {% else %}
        {% autopaginate object_list paging %}
    {% endif %}
{% else %}
    {#    zalogowany #}
    {% if request.GET.all == "1" %}
        {% autopaginate object_list paging uczelnia.wyszukiwanie_rekordy_na_strone_zalogowany %}
    {% else %}
        {% autopaginate object_list paging %}
    {% endif %}

{% endif %}

{% if request.user.is_anonymous %}
    {% include "multiseek/paginator.html" with max_rows=uczelnia.wyszukiwanie_rekordy_na_strone_anonim is_live=is_live %}
{% else %}
    {% include "multiseek/paginator.html" with max_rows=uczelnia.wyszukiwanie_rekordy_na_strone_zalogowany is_live=is_live %}
{% endif %}

<div style="padding: 10px;">

    {% if description %}
        <div class="multiseek-query-params {% if not uczelnia.wydruk_parametry_zapytania %}hide-for-print{% endif %}">
            <strong>Parametry zapytania:</strong> {{ description|default:"brak"|safe }}
        </div>
    {% endif %}

    {% if removed_ids %}
        <script type="text/javascript">
        function togglePokaz(){
            $('#rekordy-usuniete').toggle();
        }

        $(document).ready(function(){
            $("#rekordy-usuniete").hide();
        });
        </script>
        {% if not print_removed %}
            <div class="multiseek-removed-panel hide-for-print" id="panel-removed-by-hand">
                <div>
                    Z zapytania usuniƒôto rƒôcznie <span class="removed-count">{{ removed_ids|length }}</span> rekord(√≥w).
                </div>
                <div class="removed-actions">
                    <a id="pokaz-jakie" onclick="togglePokaz()">üìã Poka≈º, jakie</a>
                    <a onclick="return confirm('Czy na pewno dodaƒá wszystkie rƒôcznie usuniƒôte prace do wynik√≥w wyszukiwania ponownie?');" href="../reenable-removed-ids/">‚Ü©Ô∏è Przywr√≥ƒá wszystkie</a>
                    <a href=".">üîÑ Od≈õwie≈º stronƒô</a>
                    <a href="?print-removed=1&all=1">üëÅÔ∏è Poka≈º tylko usuniƒôte</a>
                    <a href="?print=1&print-removed=1&all=1">üñ®Ô∏è Wydrukuj tylko usuniƒôte</a>
                </div>

                <div id="rekordy-usuniete" class="removed-list">
                    <p>
                    <ul>
                        {% for elem in removed_ids %}
                            <li id="multiseek-row-{{ elem.0 }}_{{ elem.1 }}" class="multiseek-row">
                                <span class="multiseek-element" style="text-decoration: line-through">
                                {% opis_bibliograficzny_cache elem %}
                                    </span>
                                <a onclick="multiseek.removeFromResults('{{ elem.0 }}_{{ elem.1 }}')"
                                style="font-size: 8pt;">
                                    &nbsp;‚úÖ
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                    </p>
                </div>

            </div>
        {% else %}
           <div class="multiseek-removed-panel hide-for-print" id="panel-removed-by-hand">
               <strong>Wy≈õwietlam listƒô rekord√≥w usuniƒôtych rƒôcznie z zapytania.</strong>
               <div class="removed-actions">
                   <a href=".">‚Ü©Ô∏è Poka≈º wszystkie rekordy</a>
               </div>
            </div>
        {% endif %}
    {% endif %}

    {% if report_type == "bibtex" %}
        <div class="multiseek-bibtex-container">
            {% if object_list %}
                <div class="bibtex-actions bibtex-actions-top">
                    <button onclick="copyBibTeXToClipboard()" type="button">
                        üìã Skopiuj wszystko do schowka
                    </button>
                    <span id="bibtex-copy-feedback" class="copy-feedback" style="display: none;">
                        ‚úì Skopiowane!
                    </span>
                </div>
            {% endif %}
            <pre>{% for element in object_list %}{{ element.original.to_bibtex }}{% if not forloop.last %}

{% endif %}{% endfor %}</pre>
        </div>
    {% elif report_type == "list" or report_type == "numer_list" or report_type == None %}
        <div class="multiseek-list-report">
            <ol style="counter-reset: list-counter {{ page_obj.start_index|add:-1 }}">
                {% for element in object_list %}

                <li class="multiseek-row" id="multiseek-row-{{ element.js_safe_pk }}">
                    <span class="multiseek-element">
                        <a href="{% url "bpp:browse_praca" element.id.0 element.id.1 %}"
                           target="_top">
                            {{ element.opis_bibliograficzny_cache|safe }}

                        </a>

                        {% if report_type == "numer_list" %}
                            <span style="color: red;">
                    {{ element.uwagi }}
                    </span>
                        {% endif %}

                    </span>
                {% if not print_removed %}
                    <span class="multiseek-remove-from-results">
                        <a onclick="multiseek.removeFromResults('{{ element.js_safe_pk }}'); return false" style="font-size: 8pt;">
                            ‚ùå
                        </a>
                    </span>
                {% endif %}
                </li>
                {% empty %}
                    <li style="text-align: center; color: #6c757d; padding: 20px;">{% trans "No elements" %}</li>
                {% endfor %}
            </ol>
        </div>
    {% else %}
        <div class="multiseek-table-report">
            <table>
            <tr>
                <th>Lp.</th>
                <th>Tytu≈Ç, autorzy, ≈∫r√≥d≈Ço</th>
                <th>IF</th>

                {% if report_type == "table_cytowania" or report_type == "pkt_wewn_cytowania" or report_type == "pkt_wewn_bez_cytowania" %}
                    <th>Liczba cytowa≈Ñ</th>
                {% endif %}

                <th>PK</th>

                {% if report_type == "pkt_wewn" or report_type == "pkt_wewn_cytowania" %}
                    <th>pkt. wewn.</th>
                {% endif %}

                {% if report_type != "pkt_wewn" and report_type != "pkt_wewn_bez" and report_type != "pkt_wewn_cytowania" and report_type != "pkt_wewn_bez_cytowania" %}
                    <th>Charakter</th>
                {% endif %}

                <th>Typ MNiSW/MEiN</th>
            </tr>
            {% for element in object_list %}
                <tr>
                    <td valign="top">
                        {{ page_obj.start_index|add:forloop.counter|add:-1 }}.
                    </td>
                    <td class="multiseek-row"
                          id="multiseek-row-{{ element.js_safe_pk }}">
                    <span class="multiseek-element">
                    <a href="{% url "bpp:browse_praca" element.id.0 element.id.1 %}"
                       target="_top">
                        {{ element.opis_bibliograficzny_cache|safe }}

                    </a>
                    </span>
                        {% if not print_removed %}
                    <span class="multiseek-remove-from-results">
                        <a onclick="multiseek.removeFromResults('{{ element.js_safe_pk }}'); return false" style="font-size: 8pt;">
                            ‚ùå
                        </a>
                    </span>
                        {% endif %}
                    </td>
                    <td>{{ element.impact_factor }}</td>
                    {% if report_type == "table_cytowania" or report_type == "pkt_wewn_cytowania" or report_type == "pkt_wewn_bez_cytowania" %}
                        <td>{{ element.liczba_cytowan }}</td>
                    {% endif %}

                    <td>{{ element.punkty_kbn }}</td>

                    {% if report_type == "pkt_wewn" or report_type == "pkt_wewn_cytowania" %}
                        <td>{{ element.punktacja_wewnetrzna }}</td>
                    {% endif %}

                {% if report_type != "pkt_wewn" and report_type != "pkt_wewn_bez" and report_type != "pkt_wewn_cytowania" and report_type != "pkt_wewn_bez_cytowania" %}
                    <td>{{ element.charakter_formalny }}</td>
                {% endif %}
                    <td>{{ element.typ_kbn }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="10" style="text-align: center;">{% trans "No elements" %}
                    </td>
                </tr>
            {% endfor %}

            {% if page_obj.number == page_obj.paginator.num_pages %}
                <tfoot>
                <tr>
                    <td colspan="2">
                        Suma:
                    </td>
                    <td>
                        {{ sumy.impact_factor__sum|default_if_none:"0.00" }}
                    </td>
                    {% if report_type == "table_cytowania" or report_type == "pkt_wewn_cytowania" or report_type == "pkt_wewn_bez_cytowania" %}
                        <td>
                            {{ sumy.liczba_cytowan__sum|default_if_none:"0.00" }}
                        </td>
                    {% endif %}
                    <td>
                        {{ sumy.punkty_kbn__sum|default_if_none:"0.00" }}
                    </td>
                    {% if report_type == "pkt_wewn" or report_type == "pkt_wewn_cytowania" %}
                        <td>
                            {{ sumy.punktacja_wewnetrzna__sum|default_if_none:"0.00" }}
                        </td>
                    {% endif %}
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
                </tfoot>
            {% endif %}

            </table>
        </div>
    {% endif %}

</div>

{% if not is_live and paginator.num_pages > 1 %}
    {% if request.user.is_anonymous %}
        {% include "multiseek/paginator.html" with max_rows=uczelnia.wyszukiwanie_rekordy_na_strone_anonim is_live=is_live magellan="no" suffix="_object_list" %}
    {% else %}
        {% include "multiseek/paginator.html" with max_rows=uczelnia.wyszukiwanie_rekordy_na_strone_zalogowany is_live=is_live magellan="no" %}
    {% endif %}
{% endif %}

    {% endif %}
</div>

<div id="end-of-content">&nbsp;</div>

<script type="text/javascript">
    if (queryDict.print == "1")
        window.print();

    // BibTeX copy to clipboard functionality
    function copyBibTeXToClipboard() {
        var preElement = document.querySelector('pre');
        var bibtexContent = preElement.textContent || preElement.innerText;
        var copyFeedback = document.getElementById('bibtex-copy-feedback');

        // Modern Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(bibtexContent).then(function() {
                showBibTeXCopyFeedback(copyFeedback);
            }, function(err) {
                fallbackBibTeXCopy(bibtexContent, copyFeedback);
            });
        } else {
            fallbackBibTeXCopy(bibtexContent, copyFeedback);
        }
    }

    function fallbackBibTeXCopy(content, feedbackElement) {
        // Create temporary textarea for fallback copy
        var tempTextarea = document.createElement('textarea');
        tempTextarea.value = content;
        tempTextarea.style.position = 'fixed';
        tempTextarea.style.left = '-999999px';
        tempTextarea.style.top = '-999999px';
        document.body.appendChild(tempTextarea);

        tempTextarea.focus();
        tempTextarea.select();

        try {
            document.execCommand('copy');
            showBibTeXCopyFeedback(feedbackElement);
        } catch (err) {
            alert('Nie mo≈ºna skopiowaƒá do schowka. Proszƒô zaznacz tekst i skopiuj rƒôcznie (Ctrl+C).');
        } finally {
            document.body.removeChild(tempTextarea);
        }
    }

    function showBibTeXCopyFeedback(feedbackElement) {
        feedbackElement.style.display = 'inline';
        setTimeout(function() {
            feedbackElement.style.display = 'none';
        }, 2000);
    }
</script>
