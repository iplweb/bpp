{% extends "base.html" %}{% load render_table from django_tables2 %}{% load static %}

{% block extratitle %}
    Import Polon - szczegóły {{ object.plik.name }}
{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="{% url "import_list_ministerialnych:index" %}">import list ministerialnych</a></li>
    <li class="current">import {{ object.plik.name }}</li>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script type="text/javascript">
        // Event delegation for toggle filter buttons
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-action="toggle-filter"]');
            if (btn) {
                e.preventDefault();
                var filterName = btn.dataset.filterName;
                var form = document.getElementById('filter-form');
                var input = form.querySelector('input[name="' + filterName + '"]');

                // Toggle the value
                input.value = input.value === '1' ? '0' : '1';

                // Submit the form
                form.submit();
            }
        });

        // Debounce function for search input
        var searchTimeout;
        function handleSearchInput() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                document.getElementById('filter-form').submit();
            }, 500);
        }
    </script>
{% endblock %}


{% block content %}
    <h1>Import danych {{ object.plik.name }}</h1>
    {% if object.zapisz_zmiany_do_bazy %}
        <div class="panel callout success">
            <h2>Zmiany wprowadzono do bazy danych</h2>
        </div>
    {% else %}
        <div class="panel callout warning">
            <h2>Zmiany nie zostały wprowadzone do bazy danych.</h2> Import został uruchomiony bez opcji zapisywania
            danych do bazy, więc to co widzisz poniżej, to informacja, która byłaby wprowadzona do bazy, gdyby
            zaznaczono opcję zapisywania zmian do bazy.
        </div>
    {% endif %}
    {% include "long_running/operation_details.html" %}

    <a id="filtry"></a>
    {% if object.finished_successfully %}
        {# Statistics section #}
        <div class="panel">
            <h3><span class="fi-graph-bar"></span> Statystyki importu</h3>
            <div class="row">
                <div class="medium-3 columns">
                    <strong>Wszystkich wierszy:</strong> {{ total_count }}
                </div>
                <div class="medium-3 columns">
                    <strong>Duplikatów:</strong> {{ duplicate_count }}
                    {% if duplicate_count > 0 %}
                        <span class="label warning">{{ duplicate_count }}</span>
                    {% endif %}
                </div>
                <div class="medium-3 columns">
                    <strong>Identyczna punktacja:</strong> {{ identical_punkty_count }}
                </div>
                <div class="medium-3 columns">
                    <strong>Identyczne dyscypliny:</strong> {{ identical_dyscypliny_count }}
                </div>
            </div>
        </div>

        {# Filter controls #}
        <div class="panel">
            <h3><span class="fi-filter"></span> Filtry</h3>
            <div class="row">
                <div class="medium-12 columns">
                    <form method="get" id="filter-form" action="#filtry">
                        <div class="row">
                            <div class="medium-5 columns">
                                <input type="text" name="search_query" value="{{ search_query }}"
                                       placeholder="Szukaj po nazwie, ISSN, E-ISSN, rezultacie lub nr wiersza (np. 5,12,20)..."
                                       oninput="handleSearchInput()">
                            </div>
                            <div class="medium-7 columns">
                                <div class="button-group">
                                    <button type="button" class="button small {% if exclude_identical_punkty %}success{% else %}secondary{% endif %}"
                                            data-action="toggle-filter" data-filter-name="exclude_identical_punkty">
                                        {% if exclude_identical_punkty %}
                                            <span class="fi-check"></span>
                                        {% endif %}
                                        Ukryj identyczną punktację
                                    </button>
                                    <button type="button" class="button small {% if exclude_identical_dyscypliny %}success{% else %}secondary{% endif %}"
                                            data-action="toggle-filter" data-filter-name="exclude_identical_dyscypliny">
                                        {% if exclude_identical_dyscypliny %}
                                            <span class="fi-check"></span>
                                        {% endif %}
                                        Ukryj identyczne dyscypliny
                                    </button>
                                    <button type="button" class="button small {% if only_duplicates %}warning{% else %}secondary{% endif %}"
                                            data-action="toggle-filter" data-filter-name="only_duplicates">
                                        {% if only_duplicates %}
                                            <span class="fi-check"></span>
                                        {% endif %}
                                        Pokaż tylko duplikaty
                                    </button>
                                    {% if exclude_identical_punkty or exclude_identical_dyscypliny or only_duplicates or search_query %}
                                        <a href="?#filtry" class="button small alert">
                                            <span class="fi-x"></span> Wyczyść filtry
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="exclude_identical_punkty" value="{{ exclude_identical_punkty|yesno:'1,0' }}">
                        <input type="hidden" name="exclude_identical_dyscypliny" value="{{ exclude_identical_dyscypliny|yesno:'1,0' }}">
                        <input type="hidden" name="only_duplicates" value="{{ only_duplicates|yesno:'1,0' }}">
                    </form>
                </div>
            </div>
        </div>

        {# Duplicate summary section #}
        {% with duplicates=object.wierszimportulistyministerialnej_set.filter|dictsortreversed:"is_duplicate"|first %}
        {% if duplicates.is_duplicate %}
            <div class="panel callout warning">
                <h3><span class="fi-alert"></span> Wykryto duplikaty w pliku Excel</h3>
                <p>Znaleziono powtarzające się czasopisma w pliku importu. Szczegóły znajdują się w tabeli poniżej.</p>
            </div>
        {% endif %}
        {% endwith %}

        {% include "pagination.html" %}
        <table>
            <thead>
            <tr>
                <th>Wiersz w XLSX</th>
                <th>Zrodlo XLS</th>
                <th>Zrodlo BPP</th>
                <th>Rezultat</th>
            </tr>

            </thead>
            <tbody>
            {% for row in object_list %}
                <tr {% if row.is_duplicate %}class="duplicate-row" style="background-color: #fff3cd;"{% endif %}>
                    <td>
                        <a href="{% url "import_list_ministerialnych:importrow-detail" object.pk row.pk %}">{{ row.nr_wiersza }}</a>
                        {% if row.is_duplicate %}
                            <br/><small style="color: #856404;">
                                <span class="fi-link"></span> Duplikat wiersza {{ row.duplicate_of_row }}
                            </small>
                        {% endif %}
                    </td>
                    <td>
                        {{ row.dane_z_xls.Tytul_1 }}
                        {% if row.dane_z_xls.issn %}(ISSN: {{ row.dane_z_xls.issn }}){% endif %}
                        {% if row.is_duplicate and row.duplicate_reason %}
                            <br/><small style="color: #856404;">Duplikat po: {{ row.duplicate_reason }}</small>
                        {% endif %}
                    </td>
                    <td>{% if row.zrodlo_id %}
                        {{ row.zrodlo.nazwa }} ({{ row.zrodlo.issn }})
                    {% else %}-
                    {% endif %}</td>
                    <td>
                        {% if row.is_duplicate %}
                            <span class="fi-alert" style="color: #856404;"></span>
                        {% endif %}
                        {{ row.rezultat }}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

    {% endif %}


{% endblock %}
