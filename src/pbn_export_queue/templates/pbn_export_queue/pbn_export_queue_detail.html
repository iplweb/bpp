{% extends "base.html" %}
{% load humanize static pbn_extras %}

{% block extratitle %}
    Szczegoly eksportu do PBN #{{ export_queue_item.pk }}
{% endblock %}

{% block extrahead %}
<link rel="stylesheet"
      href="{% static 'pbn_export_queue/css/pbn_export_queue.css' %}">

<script>
    // Simple JSON syntax highlighting
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.json-highlight').forEach(function(element) {
            var json = element.textContent;
            try {
                // Re-parse and format to ensure it's valid JSON
                var parsed = JSON.parse(json);
                var formatted = JSON.stringify(parsed, null, 2);

                // Apply syntax highlighting with better visibility
                var highlighted = formatted
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                        var cls = 'number';
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = 'key';
                                // Remove the trailing colon for the key
                                match = match.slice(0, -1);
                                return '<span class="json-highlight__key">' + match + '</span>:';
                            } else {
                                cls = 'string';
                                return '<span class="json-highlight__string">' + match + '</span>';
                            }
                        } else if (/true|false/.test(match)) {
                            cls = 'boolean';
                            return '<span class="json-highlight__boolean">' + match + '</span>';
                        } else if (/null/.test(match)) {
                            cls = 'null';
                            return '<span class="json-highlight__null">' + match + '</span>';
                        }
                        return '<span class="json-highlight__number">' + match + '</span>';
                    });

                element.textContent = '';
                element.insertAdjacentHTML('beforeend', highlighted);
            } catch (e) {
                // If parsing fails, leave as is
                console.error('Failed to parse JSON for highlighting:', e);
            }
        });
    });
</script>
{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="{% url 'pbn_export_queue:export-queue-list' %}">Kolejka eksportu do PBN</a></li>
    <li class="current">Szczegoly #{{ export_queue_item.pk }}</li>
{% endblock %}

{% block content %}
    <div class="pbn-export-detail">
        <div class="row">
            <div class="large-6 columns">
                <h2>Szczegoly eksportu do PBN #{{ export_queue_item.pk }}</h2>
            </div>
            <div class="large-6 columns pbn-export-queue__header">
                <div class="button-group">
                    <a href="{% url 'pbn_export_queue:export-queue-list' %}" class="button secondary">
                        <span class="fi-arrow-left"></span> Powrot do listy
                    </a>

                    {% if export_queue_item.rekord_do_wysylki %}
                        {% if export_queue_item.wykluczone %}
                            <div class="button secondary disabled pbn-export-queue__button--disabled"
                                 title="Nie mozna wyslac - publikacja wykluczona z eksportu">
                                <span class="fi-minus-circle"></span> Wykluczone z eksportu
                            </div>
                        {% else %}
                            <form method="post"
                                  action="{% url 'pbn_export_queue:export-queue-resend' export_queue_item.pk %}"
                                  class="pbn-export-queue__form--inline">
                                {% csrf_token %}
                                <button type="submit" class="button success"
                                        data-confirm="Czy na pewno chcesz wyslac ten rekord do PBN?">
                                    <span class="fi-upload"></span> Wyslij do PBN
                                </button>
                            </form>
                        {% endif %}
                    {% else %}
                        <div class="button alert disabled">
                            <span class="fi-alert"></span> Rekord zrodlowy zostal usuniety
                        </div>
                    {% endif %}

                    <form method="post"
                          action="{% url 'pbn_export_queue:export-queue-delete' export_queue_item.pk %}"
                          class="pbn-export-queue__form--inline">
                        {% csrf_token %}
                        <button type="submit" class="button alert"
                                data-confirm="Czy na pewno chcesz usunac ten element z kolejki?">
                            <span class="fi-trash"></span> Usun z kolejki
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {% if request.user.is_staff or perms.pbn_api %}
            <div class="row">
                <div class="large-12 columns">
                <div class="callout">
                    <h4>Informacje podstawowe</h4>
                    <table>
                        <tbody>
                            <tr>
                                <th width="200">ID:</th>
                                <td>{{ export_queue_item.pk }}</td>
                            </tr>
                            <tr>
                                <th>Rekord do wysylki:</th>
                                <td>
                                    {% if export_queue_item.rekord_do_wysylki %}
                                        {% with rekord=export_queue_item.rekord_do_wysylki %}
                                            {% if rekord.slug %}
                                                <a href="{% url 'bpp:browse_praca_by_slug' rekord.slug %}"
                                                   target="_blank"
                                                   class="pbn-export-queue__link--plain">
                                            {% endif %}
                                            {% if rekord.opis_bibliograficzny_cache %}
                                                {{ rekord.opis_bibliograficzny_cache|safe }}
                                            {% elif rekord.tytul_oryginalny %}
                                                {{ rekord.tytul_oryginalny }}
                                            {% else %}
                                                {{ rekord }}
                                            {% endif %}
                                            {% if rekord.slug %}
                                                </a>
                                            {% endif %}
                                        {% endwith %}
                                        <br>
                                        <small>Typ: {{ export_queue_item.content_type }}</small>
                                        <br>
                                        <div class="button-group small pbn-export-queue__button-group--small">
                                            {% if export_queue_item.rekord_do_wysylki.slug %}
                                                <a href="{% url 'bpp:browse_praca_by_slug' export_queue_item.rekord_do_wysylki.slug %}"
                                                   target="_blank"
                                                   class="button tiny secondary">
                                                    <span class="fi-eye"></span> Zobacz w BPP
                                                </a>
                                            {% endif %}
                                            {% if record_admin_url and request.user.is_staff %}
                                                <a href="{{ record_admin_url }}"
                                                   target="_blank"
                                                   class="button tiny warning">
                                                    <span class="fi-pencil"></span> Edytuj w admin
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <em class="alert label">Rekord zostal usuniety</em>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Rok:</th>
                                <td>
                                    {% if export_queue_item.rekord_do_wysylki and export_queue_item.rekord_do_wysylki.rok %}
                                        {{ export_queue_item.rekord_do_wysylki.rok }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Wyslal:</th>
                                <td>{{ export_queue_item.zamowil }}</td>
                            </tr>
                            <tr>
                                <th>Data wyslania:</th>
                                <td>{{ export_queue_item.zamowiono }} ({{ export_queue_item.zamowiono|naturaltime }})</td>
                            </tr>
                            <tr>
                                <th>Wysylke podjeto:</th>
                                <td>
                                    {% if export_queue_item.wysylke_podjeto %}
                                        {{ export_queue_item.wysylke_podjeto }} ({{ export_queue_item.wysylke_podjeto|naturaltime }})
                                    {% else %}
                                        <em>Nie podjeto</em>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Wysylke zakonczono:</th>
                                <td>
                                    {% if export_queue_item.wysylke_zakonczono %}
                                        {{ export_queue_item.wysylke_zakonczono }} ({{ export_queue_item.wysylke_zakonczono|naturaltime }})
                                    {% else %}
                                        <em>Nie zakonczono</em>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Ilosc prob:</th>
                                <td>{{ export_queue_item.ilosc_prob }}</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    {% if export_queue_item.zakonczono_pomyslnie == True %}
                                        <span class="label success">Zakonczono pomyslnie</span>
                                    {% elif export_queue_item.wykluczone %}
                                        <span class="label secondary pbn-export-queue__label--excluded">Wykluczone z eksportu</span>
                                        <div class="pbn-export-queue__status-excluded">
                                            <strong>Ta publikacja zostala wykluczona z eksportu do PBN.</strong>
                                            <p class="pbn-export-queue__status-excluded-text">
                                                Eksport nie jest mozliwy z powodow konfiguracyjnych systemu.
                                                Aby zmienic ten stan, nalezy zmodyfikowac ustawienia charakterow formalnych
                                                lub konfiguracji eksportu w panelu administracyjnym.
                                            </p>
                                        </div>
                                    {% elif export_queue_item.zakonczono_pomyslnie == False %}
                                        <span class="label alert">Zakonczono z bledem</span>

                                        {% if pbn_error_info.is_pbn_api_error %}
                                            <div class="pbn-export-queue__error-section">
                                                <strong class="pbn-export-queue__error-title">
                                                    {% if pbn_error_info.error_code %}
                                                        Blad po stronie PBN -- kod {{ pbn_error_info.error_code }}
                                                    {% else %}
                                                        Blad merytoryczny: {{ pbn_error_info.exception_type }}
                                                    {% endif %}
                                                </strong>
                                                {% if pbn_error_info.error_message %}
                                                    <div class="pbn-export-queue__error-message">
                                                        {{ pbn_error_info.error_message }}
                                                        {% if pbn_error_info.error_description %}
                                                            - {{ pbn_error_info.error_description }}
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                                {% if pbn_error_info.error_details_json %}
                                                    <div class="pbn-export-queue__error-details">
                                                        <strong>Szczegoly bledu:</strong>
                                                        <pre class="pbn-export-queue__json-pre"><code class="json-highlight">{{ pbn_error_info.error_details_json }}</code></pre>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                    {% elif export_queue_item.retry_after_user_authorised %}
                                        <span class="label warning">Oczekuje na autoryzacje uzytkownika</span>
                                    {% else %}
                                        <span class="label secondary">W kolejce / w trakcie</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                {% if sent_data %}
                    <div class="callout {% if export_queue_item.zakonczono_pomyslnie == True %}success{% elif export_queue_item.zakonczono_pomyslnie == False %}alert{% else %}secondary{% endif %}">
                        <h4>Linki do wyslanego rekordu</h4>
                        <div class="button-group">
                            {% if pbn_publication_url %}
                                <a href="{{ pbn_publication_url }}" target="_blank" class="button primary">
                                    <span class="fi-link"></span> Zobacz w PBN
                                </a>
                            {% endif %}

                            <a href="{% url 'admin:pbn_api_sentdata_change' sent_data.pk %}" target="_blank" class="button secondary">
                                <span class="fi-page-filled"></span> Otworz w admin
                            </a>
                        </div>
                    </div>

                    <div class="callout secondary">
                        <h4>Wyslane dane JSON</h4>

                        <details class="pbn-export-queue__details">
                            <summary class="pbn-export-queue__details-summary">
                                <span class="fi-page-filled"></span> Pokaz/ukryj wyslane dane JSON
                            </summary>
                            <div class="pbn-export-queue__details-content">
                                <pre class="pbn-export-queue__json-data-pre"><code class="json-highlight">{{ json_data|default:"Brak danych" }}</code></pre>
                            </div>
                        </details>

                        <h5>Skopiuj do schowka lub pobierz plik:</h5>

                        {# Hidden fields containing pre-fetched data for Safari clipboard compatibility #}
                        <textarea id="json-data-field"
                                  class="pbn-export-queue__hidden-field"
                                  readonly>{{ json_data|default:"" }}</textarea>
                        <textarea id="helpdesk-email-field"
                                  class="pbn-export-queue__hidden-field"
                                  readonly>{{ helpdesk_email|default:"" }}</textarea>
                        <textarea id="ai-prompt-field"
                                  class="pbn-export-queue__hidden-field"
                                  readonly>{{ ai_prompt|default:"" }}</textarea>

                        <div class="button-group">
                            <button type="button" class="button secondary copy-to-clipboard-btn"
                                    data-source-id="json-data-field">
                                <span class="fi-page-copy"></span> JSON wyslanych danych
                            </button>
                            <button type="button" class="button secondary download-file-btn"
                                    data-source-id="json-data-field"
                                    data-filename="pbn_export_{{ export_queue_item.pk }}.json">
                                <span class="fi-download"></span> Pobierz plik JSON
                            </button>

                            {% if export_queue_item.zakonczono_pomyslnie == False %}
                                <button type="button" class="button warning copy-to-clipboard-btn"
                                        data-source-id="helpdesk-email-field">
                                    <span class="fi-mail"></span> Zgloszenie do helpdesku PBN
                                </button>
                                <button type="button" class="button info copy-to-clipboard-btn"
                                        data-source-id="ai-prompt-field">
                                    <span class="fi-lightbulb"></span> Prompt dla AI
                                </button>
                            {% endif %}
                        </div>

                        {% if export_queue_item.zakonczono_pomyslnie == False %}
                            <p class="pbn-export-queue__hint">
                                <strong>Wskazowka:</strong> Kliknij przycisk "E-mail do helpdesku", aby skopiowac gotowa tresc wiadomosci
                                z opisem problemu. Mozesz tez skopiowac prompt dla AI (np. Claude, ChatGPT),
                                ktory pomoze zidentyfikowac problem zgodnie z dokumentacja API PBN.
                            </p>
                        {% endif %}
                    </div>

                    <script>
                        (function() {
                            // Simplified copy to clipboard - reads directly from hidden fields (Safari compatible)
                            document.querySelectorAll('.copy-to-clipboard-btn').forEach(function(btn) {
                                btn.addEventListener('click', function() {
                                    var sourceId = this.getAttribute('data-source-id');
                                    var sourceField = document.getElementById(sourceId);
                                    var button = this;
                                    var originalText = button.textContent;
                                    var originalClasses = button.className;

                                    if (!sourceField || !sourceField.value) {
                                        alert('Brak danych do skopiowania.');
                                        return;
                                    }

                                    // Select and copy - synchronous operation within user gesture (Safari compatible)
                                    sourceField.select();
                                    sourceField.setSelectionRange(0, 99999); // For mobile devices

                                    try {
                                        document.execCommand('copy');

                                        // Show success
                                        button.textContent = 'Skopiowano do schowka!';
                                        button.classList.add('success');
                                        button.classList.remove('secondary', 'warning', 'info');

                                        setTimeout(function() {
                                            button.textContent = originalText;
                                            button.className = originalClasses;
                                        }, 2000);
                                    } catch (err) {
                                        console.error('Copy failed: ', err);
                                        alert('Nie udalo sie skopiowac do schowka. Sprobuj uzyc innej przegladarki.');
                                    }

                                    // Deselect
                                    if (window.getSelection) {
                                        window.getSelection().removeAllRanges();
                                    }
                                });
                            });

                            // Download file button handler - reads directly from hidden field
                            document.querySelectorAll('.download-file-btn').forEach(function(btn) {
                                btn.addEventListener('click', function() {
                                    var sourceId = this.getAttribute('data-source-id');
                                    var sourceField = document.getElementById(sourceId);
                                    var filename = this.getAttribute('data-filename');
                                    var button = this;
                                    var originalText = button.textContent;
                                    var originalClasses = button.className;

                                    if (!sourceField || !sourceField.value) {
                                        alert('Brak danych do pobrania.');
                                        return;
                                    }

                                    // Create a Blob from the text
                                    var blob = new Blob([sourceField.value], { type: 'application/json' });
                                    var downloadUrl = window.URL.createObjectURL(blob);

                                    // Create a temporary anchor element and trigger download
                                    var tempLink = document.createElement('a');
                                    tempLink.href = downloadUrl;
                                    tempLink.setAttribute('download', filename);
                                    document.body.appendChild(tempLink);
                                    tempLink.click();
                                    document.body.removeChild(tempLink);

                                    // Clean up the object URL
                                    window.URL.revokeObjectURL(downloadUrl);

                                    // Show success
                                    button.textContent = 'Pobrano!';
                                    button.classList.add('success');
                                    button.classList.remove('secondary');

                                    setTimeout(function() {
                                        button.textContent = originalText;
                                        button.className = originalClasses;
                                    }, 2000);
                                });
                            });
                        })();
                    </script>
                {% endif %}

                {% if export_queue_item.komunikat %}
                    <div class="callout">
                        <h4>Historia komunikatow</h4>

                        {% with messages=export_queue_item.komunikat|parse_historia_komunikatow %}
                        {% if messages %}
                            <!-- Formatted view with toggle -->
                            <div class="pbn-export-queue__toggle-view">
                                <button type="button" class="button tiny secondary" data-action="toggle-komunikat-view">
                                    <span class="fi-arrows-expand"></span> Przelacz widok (sformatowany/surowy)
                                </button>
                            </div>

                            <!-- Formatted messages view -->
                            <div id="formatted-messages" class="pbn-export-queue__messages-container">
                                {% for msg in messages %}
                                <div class="pbn-export-queue__message-block pbn-export-queue__message-block--{{ msg.type }}">
                                    <div class="pbn-export-queue__message-header">
                                        <span class="{{ msg.type|message_icon }} pbn-export-queue__message-icon pbn-export-queue__message-icon--{{ msg.type }}"></span>
                                        <strong class="pbn-export-queue__message-datetime">{{ msg.datetime|format_datetime_pl }}</strong>
                                        {% if msg.type == 'error' %}
                                            <span class="label alert pbn-export-queue__message-label">Blad</span>
                                        {% elif msg.type == 'success' %}
                                            <span class="label success pbn-export-queue__message-label">Sukces</span>
                                        {% elif msg.type == 'warning' %}
                                            <span class="label warning pbn-export-queue__message-label">Ostrzezenie</span>
                                        {% elif msg.type == 'resend' %}
                                            <span class="label info pbn-export-queue__message-label">Ponowna wysylka</span>
                                        {% endif %}
                                    </div>
                                    <div class="pbn-export-queue__message-content">
                                        {% if msg.is_traceback %}
                                            <details>
                                                <summary class="pbn-export-queue__traceback-summary">
                                                    Wystapil blad (kliknij aby zobaczyc szczegoly)
                                                </summary>
                                                <pre class="pbn-export-queue__traceback-pre">{{ msg.content|safe }}</pre>
                                            </details>
                                        {% else %}
                                            <div class="pbn-export-queue__message-text">{{ msg.content|safe }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Raw text view (hidden by default) -->
                            <div id="raw-messages" class="pbn-export-queue__raw-messages">
                                <pre class="pbn-export-queue__raw-pre">{{ export_queue_item.komunikat|safe }}</pre>
                            </div>

                            <script>
                                function toggleKomunikatView() {
                                    var formatted = document.getElementById('formatted-messages');
                                    var raw = document.getElementById('raw-messages');

                                    if (formatted.style.display === 'none') {
                                        formatted.style.display = 'block';
                                        raw.style.display = 'none';
                                    } else {
                                        formatted.style.display = 'none';
                                        raw.style.display = 'block';
                                    }
                                }
                                document.addEventListener('click', function(e) {
                                    if (e.target.closest('[data-action="toggle-komunikat-view"]')) {
                                        e.preventDefault();
                                        toggleKomunikatView();
                                    }
                                });
                            </script>
                        {% else %}
                            <!-- Fallback to raw view if parsing fails -->
                            <div class="pbn-export-queue__raw-messages" style="display: block;">
                                <pre class="pbn-export-queue__raw-pre">{{ export_queue_item.komunikat|safe }}</pre>
                            </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                {% endif %}

            </div>
        </div>
        {% else %}
            <p class="alert-box alert">Brak uprawnien do przegladania szczegolow eksportu.</p>
        {% endif %}
    </div>

{% endblock %}
