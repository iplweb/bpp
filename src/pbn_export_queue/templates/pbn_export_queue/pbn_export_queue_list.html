{% extends "base.html" %}
{% load humanize static %}

{% block extratitle %}
    Kolejka eksportu do PBN
{% endblock %}

{% block extrahead %}
<style>
    /* Remove underlines from clickable table rows in export queue only */
    #export-queue-table tr[onclick] td a,
    #export-queue-table tr[onclick] td a:hover,
    #export-queue-table tr[onclick] td a:focus,
    #export-queue-table tr[onclick] td a:visited {
        text-decoration: none !important;
    }


    /* Filter buttons de-emphasis */
    .filter-section {
        margin: 20px 0;
    }

    .filter-section h4 {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
    }

    .filter-section .button-group .button.secondary {
        background-color: transparent;
        border: 1px solid #cacaca;
        color: #333;
    }

    .filter-section .button-group .button.secondary:hover {
        background-color: #f0f0f0;
    }

    /* Refresh toggle styling */
    .refresh-control {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin-bottom: 15px;
        gap: 10px;
    }

    .progress-bar-container {
        width: 100px;
        height: 6px;
        background-color: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
        display: none;
    }

    .progress-bar-container.active {
        display: block;
    }

    .progress-bar {
        height: 100%;
        background-color: #1779ba;
        width: 0%;
        border-radius: 3px;
        animation: countdown 5s linear infinite;
    }

    @keyframes countdown {
        from {
            width: 0%;
        }
        to {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li class="current">Kolejka eksportu do PBN</li>
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
        <h2 style="margin: 0;">Kolejka eksportu do PBN</h2>

        {% if request.user.is_staff or perms.pbn_api %}
            {% if error_count > 0 or waiting_count > 0 %}
            <div style="text-align: right;">
                {% if error_count > 0 %}
                <form method="post" action="{% url 'pbn_export_queue:export-queue-resend-all-errors' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="button alert" onclick="return confirm('Czy na pewno chcesz wysłać ponownie wszystkie {{ error_count }} rekordów z błędami?');">
                        <span class="fi-refresh"></span> Wyślij ponownie błędy ({{ error_count }})
                    </button>
                </form>
                {% endif %}
                {% if waiting_count > 0 %}
                <form method="post" action="{% url 'pbn_export_queue:export-queue-resend-all-waiting' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="button warning" onclick="return confirm('Czy na pewno chcesz wysłać ponownie wszystkie {{ waiting_count }} rekordów oczekujących na autoryzację?');">
                        <span class="fi-clock"></span> Wyślij oczekujące ({{ waiting_count }})
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
        {% endif %}
    </div>

    {% if request.user.is_staff or perms.pbn_api %}

        <div class="filter-section" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex-grow: 1;">
                <h4>Filtry</h4>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <div class="button-group">
                        <a href="?{% if search_query %}q={{ search_query|urlencode }}&{% endif %}" class="button {% if current_filter == 'all' %}primary{% else %}secondary{% endif %}">
                            <span class="fi-list"></span> Wszystkie ({{ total_count }})
                        </a>
                        <a href="?zakonczono_pomyslnie=true{% if search_query %}&q={{ search_query|urlencode }}{% endif %}" class="button {% if current_filter == 'true' %}success{% else %}secondary{% endif %}">
                            <span class="fi-check"></span> Zakończone pomyślnie ({{ success_count }})
                        </a>
                        <a href="?zakonczono_pomyslnie=false{% if search_query %}&q={{ search_query|urlencode }}{% endif %}" class="button {% if current_filter == 'false' %}alert{% else %}secondary{% endif %}">
                            <span class="fi-x"></span> Zakończone z błędem ({{ error_count }})
                        </a>
                        <a href="?zakonczono_pomyslnie=none{% if search_query %}&q={{ search_query|urlencode }}{% endif %}" class="button {% if current_filter == 'none' %}warning{% else %}secondary{% endif %}">
                            <span class="fi-clock"></span> W trakcie/oczekujące ({{ pending_count }})
                        </a>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <form method="get" action="" style="margin: 0; display: flex; align-items: center;">
                            {% if request.GET.zakonczono_pomyslnie %}
                                <input type="hidden" name="zakonczono_pomyslnie" value="{{ request.GET.zakonczono_pomyslnie }}">
                            {% endif %}
                            <input type="search"
                                   name="q"
                                   placeholder="Szukaj w tytule..."
                                   value="{{ search_query }}"
                                   style="margin: 0; height: 37px; min-width: 200px;"
                                   autocomplete="off">
                            <button type="submit" class="button secondary" style="margin: 0; margin-left: 5px;">
                                <span class="fi-magnifying-glass"></span>
                            </button>
                            {% if search_query %}
                            <a href="?{% if request.GET.zakonczono_pomyslnie %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}{% endif %}"
                               class="button secondary"
                               style="margin: 0; margin-left: 5px;"
                               title="Wyczyść wyszukiwanie">
                                <span class="fi-x"></span>
                            </a>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>

            <div class="refresh-control">
                <div class="progress-bar-container" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <label style="font-weight: normal;">
                    <input type="checkbox" id="auto-refresh-toggle" style="margin-right: 5px;">
                    <span class="fi-refresh"></span> Odświeżaj co 5 sekund
                </label>
            </div>
        </div>

        <div id="export-queue-table"
             hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if request.GET.zakonczono_pomyslnie %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}sort={{ current_sort|default:'-ostatnia_aktualizacja' }}"
             hx-swap="innerHTML">
            {% include 'pbn_export_queue/pbn_export_queue_table.html' %}
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var refreshToggle = document.getElementById('auto-refresh-toggle');
                var tableDiv = document.getElementById('export-queue-table');
                var progressContainer = document.getElementById('progress-container');
                var progressBar = document.getElementById('progress-bar');
                var refreshInterval = null;
                var errorExpanded = false;

                // Load saved preference from localStorage
                var savedPreference = localStorage.getItem('pbn_export_queue_auto_refresh');
                if (savedPreference === 'true') {
                    refreshToggle.checked = true;
                    startAutoRefresh();
                }

                refreshToggle.addEventListener('change', function() {
                    localStorage.setItem('pbn_export_queue_auto_refresh', refreshToggle.checked);
                    if (refreshToggle.checked) {
                        startAutoRefresh();
                    } else {
                        stopAutoRefresh();
                    }
                });

                // Listen for error expansion events from the table
                document.addEventListener('errorToggled', function(event) {
                    errorExpanded = event.detail.expanded;

                    if (errorExpanded && refreshToggle.checked) {
                        // Temporarily stop refresh when error is expanded
                        stopAutoRefresh(true);
                    } else if (!errorExpanded && refreshToggle.checked) {
                        // Resume refresh when error is collapsed
                        startAutoRefresh();
                    }
                });

                function startAutoRefresh() {
                    // Don't start if error is expanded
                    if (errorExpanded) {
                        return;
                    }

                    // Show progress bar
                    progressContainer.classList.add('active');

                    // Reset animation
                    progressBar.style.animation = 'none';
                    void progressBar.offsetHeight; // Trigger reflow
                    progressBar.style.animation = 'countdown 5s linear infinite';

                    // Initial refresh
                    refreshTable();
                    refreshCounts();

                    // Set up interval for continuous polling
                    refreshInterval = setInterval(function() {
                        if (!errorExpanded) {
                            refreshTable();
                            refreshCounts();
                            // Reset animation
                            progressBar.style.animation = 'none';
                            void progressBar.offsetHeight; // Trigger reflow
                            progressBar.style.animation = 'countdown 5s linear infinite';
                        }
                    }, 5000);
                }

                function stopAutoRefresh(temporary) {
                    // Hide progress bar (unless this is temporary due to error expansion)
                    if (!temporary) {
                        progressContainer.classList.remove('active');
                    }

                    // Clear the interval
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }

                    // Stop animation
                    progressBar.style.animation = 'none';
                }

                function refreshTable() {
                    // Get current URL with all parameters
                    var url = tableDiv.getAttribute('hx-get');
                    htmx.ajax('GET', url, {target: '#export-queue-table', swap: 'innerHTML'});
                }

                function refreshCounts() {
                    // Fetch updated counts from the server
                    fetch('{% url "pbn_export_queue:export-queue-counts" %}')
                        .then(response => response.json())
                        .then(data => {
                            // Update all count displays
                            updateButtonCount('all', data.total_count);
                            updateButtonCount('true', data.success_count);
                            updateButtonCount('false', data.error_count);
                            updateButtonCount('none', data.pending_count);

                            // Update resend buttons counts
                            updateResendButtonCount('error', data.error_count);
                            updateResendButtonCount('waiting', data.waiting_count);
                        })
                        .catch(error => {
                            console.error('Error fetching counts:', error);
                        });
                }

                function updateButtonCount(filter, count) {
                    var button = document.querySelector('.button-group a[href' +
                        (filter === 'all' ? '="?"' : '="?zakonczono_pomyslnie=' + filter + '"') + ']');
                    if (button) {
                        // Find the count in parentheses and update it
                        button.innerHTML = button.innerHTML.replace(/\(\d+\)/, '(' + count + ')');
                    }
                }

                function updateResendButtonCount(type, count) {
                    if (type === 'error') {
                        var button = document.querySelector('button[type="submit"][onclick*="błędami"]');
                        if (button) {
                            button.innerHTML = button.innerHTML.replace(/\(\d+\)/, '(' + count + ')');
                            // Show/hide button based on count
                            button.parentElement.style.display = count > 0 ? 'inline' : 'none';
                        }
                    } else if (type === 'waiting') {
                        var button = document.querySelector('button[type="submit"][onclick*="oczekujących"]');
                        if (button) {
                            button.innerHTML = button.innerHTML.replace(/\(\d+\)/, '(' + count + ')');
                            // Show/hide button based on count
                            button.parentElement.style.display = count > 0 ? 'inline' : 'none';
                        }
                    }
                }
            });
        </script>
    {% else %}
        <p class="alert-box alert">Brak uprawnień do przeglądania kolejki eksportu.</p>
    {% endif %}

{% endblock %}
