{% extends "base.html" %}
{% load humanize static %}

{% block extratitle %}
    Kolejka eksportu do PBN
{% endblock %}

{% block extrahead %}
<link rel="stylesheet"
      href="{% static 'pbn_export_queue/css/pbn_export_queue.css' %}">
{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li class="current">Kolejka eksportu do PBN</li>
{% endblock %}

{% block content %}
    <div class="pbn-export-queue__page-header">
        <h2 class="pbn-export-queue__page-title">Kolejka eksportu do PBN</h2>

        {% if request.user.is_staff or perms.pbn_api %}
            {% if error_techniczny_count > 0 or waiting_count > 0 or never_sent_count > 0 %}
            <div class="pbn-export-queue__page-actions">
                {% if never_sent_count > 0 %}
                <form method="post"
                      action="{% url 'pbn_export_queue:export-queue-wake-up' %}"
                      class="pbn-export-queue__form--inline">
                    {% csrf_token %}
                    <button type="submit" class="button info"
                            data-confirm="Czy na pewno chcesz obudzic wysylke dla {{ never_sent_count }} rekordow ktore nigdy nie byly wysylane?">
                        <span class="fi-play"></span> Obudz wysylke ({{ never_sent_count }})
                    </button>
                </form>
                {% endif %}
                {% if error_techniczny_count > 0 %}
                <form method="post"
                      action="{% url 'pbn_export_queue:export-queue-resend-all-errors' %}"
                      class="pbn-export-queue__form--inline">
                    {% csrf_token %}
                    <button type="submit" class="button alert"
                            data-confirm="Czy na pewno chcesz wyslac ponownie wszystkie {{ error_techniczny_count }} rekordow z bledami technicznymi?">
                        <span class="fi-refresh"></span> Wyslij ponownie bledy techniczne ({{ error_techniczny_count }})
                    </button>
                </form>
                {% endif %}
                {% if waiting_count > 0 %}
                <form method="post"
                      action="{% url 'pbn_export_queue:export-queue-resend-all-waiting' %}"
                      class="pbn-export-queue__form--inline">
                    {% csrf_token %}
                    <button type="submit" class="button warning"
                            data-confirm="Czy na pewno chcesz wyslac ponownie wszystkie {{ waiting_count }} rekordow oczekujacych na autoryzacje?">
                        <span class="fi-clock"></span> Wyslij oczekujace ({{ waiting_count }})
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
        {% endif %}
    </div>

    {% if request.user.is_staff or perms.pbn_api %}

        <fieldset class="filter-section pbn-export-queue__filter-fieldset">
            <legend class="pbn-export-queue__filter-legend">Filtry</legend>

            <div class="pbn-export-queue__filter-content">
                <div class="pbn-export-queue__filter-main">
                    <!-- Wiersz 1: Przyciski filtrow statusu -->
                    <div class="button-group pbn-export-queue__filter-buttons">
                        <a href="?{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}{% endif %}"
                           class="button {% if current_filter == 'all' and not current_error_type %}primary{% else %}secondary{% endif %}">
                            <span class="fi-list"></span> Wszystkie ({{ total_count }})
                        </a>
                        <a href="?zakonczono_pomyslnie=true{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if rok_od %}&rok_od={{ rok_od }}{% endif %}{% if rok_do %}&rok_do={{ rok_do }}{% endif %}"
                           class="button {% if current_filter == 'true' %}success{% else %}secondary{% endif %}">
                            <span class="fi-check"></span> Zakonczone pomyslnie ({{ success_count }})
                        </a>
                        <a href="?zakonczono_pomyslnie=false{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if rok_od %}&rok_od={{ rok_od }}{% endif %}{% if rok_do %}&rok_do={{ rok_do }}{% endif %}"
                           class="button {% if current_filter == 'false' and not current_error_type %}alert{% else %}secondary{% endif %}">
                            <span class="fi-x"></span> Wszystkie bledy ({{ error_count }})
                        </a>
                        <a href="?rodzaj_bledu=MERYT{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if rok_od %}&rok_od={{ rok_od }}{% endif %}{% if rok_do %}&rok_do={{ rok_do }}{% endif %}"
                           class="button {% if current_error_type == 'MERYT' %}alert{% else %}secondary{% endif %}">
                            <span class="fi-x"></span> Bledy merytoryczne ({{ error_merytoryczny_count }})
                        </a>
                        <a href="?rodzaj_bledu=TECH{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if rok_od %}&rok_od={{ rok_od }}{% endif %}{% if rok_do %}&rok_do={{ rok_do }}{% endif %}"
                           class="button {% if current_error_type == 'TECH' %}alert{% else %}secondary{% endif %}">
                            <span class="fi-x"></span> Bledy techniczne ({{ error_techniczny_count }})
                        </a>
                        <a href="?zakonczono_pomyslnie=none{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if rok_od %}&rok_od={{ rok_od }}{% endif %}{% if rok_do %}&rok_do={{ rok_do }}{% endif %}"
                           class="button {% if current_filter == 'none' %}warning{% else %}secondary{% endif %}">
                            <span class="fi-clock"></span> W trakcie/oczekujace ({{ pending_count }})
                        </a>
                        <a href="?wykluczone=true{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if rok_od %}&rok_od={{ rok_od }}{% endif %}{% if rok_do %}&rok_do={{ rok_do }}{% endif %}"
                           class="button secondary {% if current_wykluczone == 'true' %}pbn-export-queue__filter-excluded--active{% endif %}">
                            <span class="fi-minus-circle"></span> Wykluczone ({{ wykluczone_count }})
                        </a>
                    </div>

                    <!-- Wiersz 2: Rok od, Rok do, Szukaj w tytule, przyciski -->
                    <form method="get" action="">
                        {% if request.GET.zakonczono_pomyslnie %}
                            <input type="hidden" name="zakonczono_pomyslnie" value="{{ request.GET.zakonczono_pomyslnie }}">
                        {% endif %}
                        {% if request.GET.rodzaj_bledu %}
                            <input type="hidden" name="rodzaj_bledu" value="{{ request.GET.rodzaj_bledu }}">
                        {% endif %}
                        <div class="pbn-export-queue__filter-row">
                            <input type="number"
                                   name="rok_od"
                                   placeholder="Rok od"
                                   value="{{ rok_od }}"
                                   class="pbn-export-queue__filter-input pbn-export-queue__filter-input--year"
                                   min="1900" max="2100">
                            <input type="number"
                                   name="rok_do"
                                   placeholder="Rok do"
                                   value="{{ rok_do }}"
                                   class="pbn-export-queue__filter-input pbn-export-queue__filter-input--year"
                                   min="1900" max="2100">
                            <input type="search"
                                   name="q"
                                   placeholder="Szukaj w tytule..."
                                   value="{{ search_query }}"
                                   class="pbn-export-queue__filter-input pbn-export-queue__filter-input--search"
                                   autocomplete="off">
                            <button type="submit" class="button pbn-export-queue__filter-button">
                                <span class="fi-magnifying-glass"></span> Filtruj
                            </button>
                            <a href="?" class="button secondary pbn-export-queue__filter-button">
                                <span class="fi-x"></span> Resetuj
                            </a>
                        </div>
                    </form>
                </div>

                <div class="refresh-control pbn-export-queue__refresh-control">
                    <div class="progress-bar-container" id="progress-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <label>
                        <input type="checkbox" id="auto-refresh-toggle">
                        <span class="fi-refresh"></span> Odswiezaj co 5 sekund
                    </label>
                </div>
            </div>
        </fieldset>

        <div class="pbn-export-queue__send-section">
            <form method="post"
                  action="{% url 'pbn_export_queue:export-queue-resend-filtered' %}"
                  class="pbn-export-queue__form--inline">
                {% csrf_token %}
                {% if request.GET.zakonczono_pomyslnie %}
                    <input type="hidden" name="zakonczono_pomyslnie" value="{{ request.GET.zakonczono_pomyslnie }}">
                {% endif %}
                {% if request.GET.rodzaj_bledu %}
                    <input type="hidden" name="rodzaj_bledu" value="{{ request.GET.rodzaj_bledu }}">
                {% endif %}
                <input type="hidden" name="rok_od" value="{{ rok_od }}">
                {% if rok_do %}
                    <input type="hidden" name="rok_do" value="{{ rok_do }}">
                {% endif %}
                {% if search_query %}
                    <input type="hidden" name="q" value="{{ search_query }}">
                {% endif %}
                <button type="submit" class="button primary"
                        data-confirm="Czy na pewno chcesz wyslac widoczne rekordy (max 100)?">
                    <span class="fi-upload"></span> Wyslij widoczne rekordy
                </button>
            </form>
        </div>

        <div id="export-queue-table"
             hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if request.GET.zakonczono_pomyslnie %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if request.GET.rodzaj_bledu %}rodzaj_bledu={{ request.GET.rodzaj_bledu }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={{ current_sort|default:'-ostatnia_aktualizacja' }}"
             hx-swap="innerHTML">
            {% include 'pbn_export_queue/pbn_export_queue_table.html' %}
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var refreshToggle = document.getElementById('auto-refresh-toggle');
                var tableDiv = document.getElementById('export-queue-table');
                var progressContainer = document.getElementById('progress-container');
                var progressBar = document.getElementById('progress-bar');
                var refreshInterval = null;

                // Load saved preference from localStorage
                var savedPreference = localStorage.getItem('pbn_export_queue_auto_refresh');
                if (savedPreference === 'true') {
                    refreshToggle.checked = true;
                    startAutoRefresh();
                }

                refreshToggle.addEventListener('change', function() {
                    localStorage.setItem('pbn_export_queue_auto_refresh', refreshToggle.checked);
                    if (refreshToggle.checked) {
                        startAutoRefresh();
                    } else {
                        stopAutoRefresh();
                    }
                });

                function startAutoRefresh() {
                    // Show progress bar
                    progressContainer.classList.add('active');

                    // Reset animation
                    progressBar.style.animation = 'none';
                    void progressBar.offsetHeight; // Trigger reflow
                    progressBar.style.animation = 'countdown 5s linear infinite';

                    // Initial refresh
                    refreshTable();
                    refreshCounts();

                    // Set up interval for continuous polling
                    refreshInterval = setInterval(function() {
                        refreshTable();
                        refreshCounts();
                        // Reset animation
                        progressBar.style.animation = 'none';
                        void progressBar.offsetHeight; // Trigger reflow
                        progressBar.style.animation = 'countdown 5s linear infinite';
                    }, 5000);
                }

                function stopAutoRefresh() {
                    // Hide progress bar
                    progressContainer.classList.remove('active');

                    // Clear the interval
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }

                    // Stop animation
                    progressBar.style.animation = 'none';
                }

                function refreshTable() {
                    // Get current URL with all parameters
                    var url = tableDiv.getAttribute('hx-get');
                    htmx.ajax('GET', url, {target: '#export-queue-table', swap: 'innerHTML'});
                }

                function refreshCounts() {
                    // Fetch updated counts from the server
                    fetch('{% url "pbn_export_queue:export-queue-counts" %}')
                        .then(response => response.json())
                        .then(data => {
                            // Update all count displays
                            updateButtonCount('all', data.total_count);
                            updateButtonCount('true', data.success_count);
                            updateButtonCount('false', data.error_count);
                            updateButtonCount('none', data.pending_count);
                            updateButtonCount('MERYT', data.error_merytoryczny_count);
                            updateButtonCount('TECH', data.error_techniczny_count);

                            // Update resend buttons counts
                            updateResendButtonCount('error_tech', data.error_techniczny_count);
                            updateResendButtonCount('waiting', data.waiting_count);
                        })
                        .catch(error => {
                            console.error('Error fetching counts:', error);
                        });
                }

                function updateButtonCount(filter, count) {
                    var selector;
                    if (filter === 'all') {
                        selector = '.button-group a[href="?"]';
                    } else if (filter === 'MERYT' || filter === 'TECH') {
                        selector = '.button-group a[href^="?rodzaj_bledu=' + filter + '"]';
                    } else {
                        selector = '.button-group a[href^="?zakonczono_pomyslnie=' + filter + '"]';
                    }
                    var button = document.querySelector(selector);
                    if (button) {
                        // Find the count in parentheses and update it
                        button.textContent = button.textContent.replace(/\(\d+\)/, '(' + count + ')');
                    }
                }

                function updateResendButtonCount(type, count) {
                    if (type === 'error_tech') {
                        var button = document.querySelector('button[type="submit"][onclick*="technicznymi"]');
                        if (button) {
                            button.textContent = button.textContent.replace(/\(\d+\)/, '(' + count + ')');
                            // Show/hide button based on count
                            button.parentElement.style.display = count > 0 ? 'inline' : 'none';
                        }
                    } else if (type === 'waiting') {
                        var button = document.querySelector('button[type="submit"][onclick*="oczekujacych"]');
                        if (button) {
                            button.textContent = button.textContent.replace(/\(\d+\)/, '(' + count + ')');
                            // Show/hide button based on count
                            button.parentElement.style.display = count > 0 ? 'inline' : 'none';
                        }
                    }
                }
            });
        </script>
    {% else %}
        <p class="alert-box alert">Brak uprawnien do przegladania kolejki eksportu.</p>
    {% endif %}

{% endblock %}
