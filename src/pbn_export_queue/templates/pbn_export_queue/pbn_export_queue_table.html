{% load humanize pbn_queue_extras url_helpers %}
<table>
    <thead>
        <tr>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'pk' %}-pk{% else %}pk{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'pk' %}-pk{% else %}pk{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    ID {% if current_sort == 'pk' %}▲{% elif current_sort == '-pk' %}▼{% endif %}
                </a>
            </th>
            <th>Rekord</th>
            <th>Rok</th>
            <th>Wyslal</th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zamowiono' %}-zamowiono{% else %}zamowiono{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zamowiono' %}-zamowiono{% else %}zamowiono{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Wyslano {% if current_sort == 'zamowiono' %}▲{% elif current_sort == '-zamowiono' %}▼{% endif %}
                </a>
            </th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ostatnia_aktualizacja' %}-ostatnia_aktualizacja{% else %}ostatnia_aktualizacja{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ostatnia_aktualizacja' %}-ostatnia_aktualizacja{% else %}ostatnia_aktualizacja{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Ostatnia aktualizacja {% if current_sort == 'ostatnia_aktualizacja' %}▲{% elif current_sort == '-ostatnia_aktualizacja' %}▼{% endif %}
                </a>
            </th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ilosc_prob' %}-ilosc_prob{% else %}ilosc_prob{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ilosc_prob' %}-ilosc_prob{% else %}ilosc_prob{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Ilosc prob {% if current_sort == 'ilosc_prob' %}▲{% elif current_sort == '-ilosc_prob' %}▼{% endif %}
                </a>
            </th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zakonczono_pomyslnie' %}-zakonczono_pomyslnie{% else %}zakonczono_pomyslnie{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zakonczono_pomyslnie' %}-zakonczono_pomyslnie{% else %}zakonczono_pomyslnie{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Status {% if current_sort == 'zakonczono_pomyslnie' %}▲{% elif current_sort == '-zakonczono_pomyslnie' %}▼{% endif %}
                </a>
            </th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody>
        {% for item in export_queue_items %}
            <tr class="pbn-export-queue__table-row--clickable"
                data-navigate-url="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                tabindex="0"
                role="button">
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">{{ item.pk }}</a></td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">
                        {% if item.rekord_do_wysylki %}
                            {% with rekord=item.rekord_do_wysylki %}
                                {% if rekord.opis_bibliograficzny_cache %}
                                    {{ rekord.opis_bibliograficzny_cache|safe|truncatechars:50 }}
                                {% elif rekord.tytul_oryginalny %}
                                    {{ rekord.tytul_oryginalny|truncatechars:50 }}
                                {% else %}
                                    {{ rekord|truncatechars:50 }}
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <em>Rekord usuniety</em>
                        {% endif %}
                    </a>
                </td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">
                        {% if item.rekord_do_wysylki and item.rekord_do_wysylki.rok %}
                            {{ item.rekord_do_wysylki.rok }}
                        {% else %}
                            -
                        {% endif %}
                    </a>
                </td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">{{ item.zamowil }}</a></td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">{{ item.zamowiono|naturaltime }}</a></td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">{{ item.ostatnia_aktualizacja|naturaltime }}</a></td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">{{ item.ilosc_prob }}</a></td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="pbn-export-queue__table-link">
                        {% if item.zakonczono_pomyslnie == True %}
                            <span class="fi-check"></span>
                        {% elif item.wykluczone %}
                            <span class="fi-minus-circle pbn-export-queue__icon--excluded"
                                  title="Wykluczone z eksportu"></span>
                        {% elif item.zakonczono_pomyslnie == False %}
                            {% if item.rodzaj_bledu == 'MERYT' %}
                                <span class="fi-alert"></span>
                            {% else %}
                                <span class="fi-x"></span>
                            {% endif %}
                        {% elif item.retry_after_user_authorised %}
                            <span class="fi-lock"></span>
                        {% else %}
                            <span class="fi-clock"></span>
                        {% endif %}
                    </a>
                </td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="button tiny"
                       data-stop-propagation="true">
                        <span class="fi-magnifying-glass"></span> Szczegoly
                    </a>
                </td>
            </tr>
            {% if item.zakonczono_pomyslnie == False and item.komunikat %}
            <tr id="error-{{ item.pk }}">
                <td></td>
                <td colspan="8" class="pbn-export-queue__error-row-cell">
                    <div class="pbn-export-queue__error-display">{{ item.komunikat|format_pbn_error }}</div>
                </td>
            </tr>
            {% endif %}
        {% empty %}
            <tr>
                <td colspan="9" class="text-center">Brak elementow w kolejce eksportu do PBN.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

{% include "pagination/pagination_with_anchor.html" %}
