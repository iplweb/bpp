{% load humanize pbn_queue_extras url_helpers %}
<table>
    <thead>
        <tr>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'pk' %}-pk{% else %}pk{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'pk' %}-pk{% else %}pk{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    ID {% if current_sort == 'pk' %}‚ñ≤{% elif current_sort == '-pk' %}‚ñº{% endif %}
                </a>
            </th>
            <th>Rekord</th>
            <th>Rok</th>
            <th>Wys≈Ça≈Ç</th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zamowiono' %}-zamowiono{% else %}zamowiono{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zamowiono' %}-zamowiono{% else %}zamowiono{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Wys≈Çano {% if current_sort == 'zamowiono' %}‚ñ≤{% elif current_sort == '-zamowiono' %}‚ñº{% endif %}
                </a>
            </th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ostatnia_aktualizacja' %}-ostatnia_aktualizacja{% else %}ostatnia_aktualizacja{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ostatnia_aktualizacja' %}-ostatnia_aktualizacja{% else %}ostatnia_aktualizacja{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Ostatnia aktualizacja {% if current_sort == 'ostatnia_aktualizacja' %}‚ñ≤{% elif current_sort == '-ostatnia_aktualizacja' %}‚ñº{% endif %}
                </a>
            </th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ilosc_prob' %}-ilosc_prob{% else %}ilosc_prob{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'ilosc_prob' %}-ilosc_prob{% else %}ilosc_prob{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Ilo≈õƒá pr√≥b {% if current_sort == 'ilosc_prob' %}‚ñ≤{% elif current_sort == '-ilosc_prob' %}‚ñº{% endif %}
                </a>
            </th>
            <th>
                <a href="?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zakonczono_pomyslnie' %}-zakonczono_pomyslnie{% else %}zakonczono_pomyslnie{% endif %}"
                   hx-get="{% url 'pbn_export_queue:export-queue-table' %}?{% if current_filter != 'all' %}zakonczono_pomyslnie={{ request.GET.zakonczono_pomyslnie }}&{% endif %}{% if search_query %}q={{ search_query|urlencode }}&{% endif %}{% if rok_od %}rok_od={{ rok_od }}&{% endif %}{% if rok_do %}rok_do={{ rok_do }}&{% endif %}sort={% if current_sort == 'zakonczono_pomyslnie' %}-zakonczono_pomyslnie{% else %}zakonczono_pomyslnie{% endif %}"
                   hx-target="#export-queue-table"
                   hx-swap="innerHTML"
                   hx-push-url="false">
                    Status {% if current_sort == 'zakonczono_pomyslnie' %}‚ñ≤{% elif current_sort == '-zakonczono_pomyslnie' %}‚ñº{% endif %}
                </a>
            </th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody>
        {% for item in export_queue_items %}
            <tr style="cursor: pointer;" onclick="if (!event.defaultPrevented) { window.location='{% url 'pbn_export_queue:export-queue-detail' item.pk %}'; }">
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">{{ item.pk }}</a></td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">
                        {% if item.rekord_do_wysylki %}
                            {% with rekord=item.rekord_do_wysylki %}
                                {% if rekord.opis_bibliograficzny_cache %}
                                    {{ rekord.opis_bibliograficzny_cache|safe|truncatechars:50 }}
                                {% elif rekord.tytul_oryginalny %}
                                    {{ rekord.tytul_oryginalny|truncatechars:50 }}
                                {% else %}
                                    {{ rekord|truncatechars:50 }}
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <em>Rekord usuniƒôty</em>
                        {% endif %}
                    </a>
                </td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">
                        {% if item.rekord_do_wysylki and item.rekord_do_wysylki.rok %}
                            {{ item.rekord_do_wysylki.rok }}
                        {% else %}
                            -
                        {% endif %}
                    </a>
                </td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">{{ item.zamowil }}</a></td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">{{ item.zamowiono|naturaltime }}</a></td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">{{ item.ostatnia_aktualizacja|naturaltime }}</a></td>
                <td><a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">{{ item.ilosc_prob }}</a></td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}" style="color: inherit;">
                        {% if item.zakonczono_pomyslnie == True %}
                            ‚úÖ
                        {% elif item.zakonczono_pomyslnie == False %}
                            {% if item.rodzaj_bledu == 'MERYT' %}
                                ‚ö†Ô∏è
                            {% else %}
                                ‚ùå
                            {% endif %}
                        {% elif item.retry_after_user_authorised %}
                            üîê
                        {% else %}
                            ‚è≥
                        {% endif %}
                    </a>
                </td>
                <td>
                    <a href="{% url 'pbn_export_queue:export-queue-detail' item.pk %}"
                       class="button tiny"
                       onclick="event.stopPropagation();">
                        <span class="fi-magnifying-glass"></span> Szczeg√≥≈Çy
                    </a>
                </td>
            </tr>
            {% if item.zakonczono_pomyslnie == False and item.komunikat %}
            <tr id="error-{{ item.pk }}">
                <td></td>
                <td colspan="8" style="padding: 10px;">
                    <div style="font-family: monospace; font-size: 0.9em; line-height: 1.4; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">{{ item.komunikat|format_pbn_error }}</div>
                </td>
            </tr>
            {% endif %}
        {% empty %}
            <tr>
                <td colspan="9" class="text-center">Brak element√≥w w kolejce eksportu do PBN.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

{% include "pagination/pagination_with_anchor.html" %}
