{% extends "base.html" %}
{% load static %}

{% block title %}Deduplikator Autor√≥w PBN{% endblock %}

{% block breadcrumbs %}
    <li><a href="/">Strona g≈Ç√≥wna</a></li>
    <li><a href="{% url "deduplikator_autorow:duplicate_authors" %}">Deduplikator autor√≥w PBN</a></li>
{% endblock %}

{% block content %}
    <div id="left-menu-container">
        <!-- Left Sidebar Menu -->
        <div class="left-menu-sidebar">
            <div class="left-menu-menu">
                <ul class="accordion" data-accordion data-allow-all-closed="true" data-multi-expand="true" style="border: none; padding: 0; margin: 0;">
                    {% if total_authors_with_duplicates %}
                    <!-- Liczba autor√≥w z duplikatami -->
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title" href="#" aria-expanded="true" style="pointer-events: none; cursor: default;">
                            üë• {{ total_authors_with_duplicates }} autor{% if total_authors_with_duplicates != 1 %}√≥w{% endif %} z duplikatami
                        </a>
                        <div class="accordion-content" data-tab-content style="display: none;"></div>
                    </li>
                    {% endif %}

                    <!-- PBN Download Info -->
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#" style="pointer-events: none; cursor: default;">
                            üì• Dane PBN
                        </a>
                        <div class="accordion-content" data-tab-content style="display: block; padding: 10px 15px;">
                            {% if latest_pbn_download %}
                                <p style="margin-bottom: 5px; font-size: 0.85rem;">
                                    <strong>Ostatnie pobieranie:</strong><br>
                                    {{ latest_pbn_download.started_at|date:"d.m.Y H:i" }}
                                </p>
                                <p style="margin-bottom: 5px; font-size: 0.85rem;">
                                    <strong>Status:</strong>
                                    {% if latest_pbn_download.status == 'completed' %}
                                        <span style="color: green;">‚úì Zako≈Ñczone</span>
                                    {% elif latest_pbn_download.status == 'running' %}
                                        <span style="color: orange;">‚è≥ W trakcie</span>
                                    {% else %}
                                        <span style="color: red;">‚úó B≈ÇƒÖd</span>
                                    {% endif %}
                                </p>
                                {% if latest_pbn_download.completed_at %}
                                    <p style="margin-bottom: 10px; font-size: 0.85rem;">
                                        <strong>Zako≈Ñczone:</strong><br>
                                        {{ latest_pbn_download.completed_at|date:"d.m.Y H:i" }}
                                    </p>
                                {% endif %}
                            {% else %}
                                <p style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                    Brak informacji o pobraniu danych z PBN
                                </p>
                            {% endif %}
                            <a href="{% url 'pbn_downloader_app:main' %}"
                               class="button primary expanded small"
                               target="_blank">
                                üîÑ Pobierz dane z PBN
                            </a>
                        </div>
                    </li>

                    <!-- Zacznij od poczƒÖtku -->
                    {% if has_skipped_authors and not search_lastname %}
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title" href="#" aria-expanded="true" style="pointer-events: none; cursor: default;">
                            üîÅ Nawigacja
                        </a>
                        <div class="accordion-content" data-tab-content style="display: block;">
                            <p style="margin-bottom: 10px;">Prze≈õledzile≈õ ju≈º kilku autor√≥w.</p>
                            <a href="{% url 'deduplikator_autorow:reset_skipped_authors' %}"
                               class="button alert expanded small">
                                Zacznij od poczƒÖtku
                            </a>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Wyszukiwanie autora -->
                    <li class="accordion-item {% if search_lastname %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if search_lastname %}aria-expanded="true"{% endif %}>
                            üîç Szukaj autora
                        </a>
                        <div class="accordion-content" data-tab-content {% if search_lastname %}style="display: block;"{% endif %}>
                            <form method="get" action="{% url 'deduplikator_autorow:duplicate_authors' %}" style="margin-bottom: 0;">
                                <label for="search_lastname" style="font-size: 0.9rem;">Po nazwisku:</label>
                                <input type="text" id="search_lastname" name="search_lastname"
                                       value="{{ search_lastname|default:'' }}"
                                       placeholder="Wpisz czƒô≈õƒá nazwiska..."
                                       style="margin-bottom: 10px; font-size: 0.9rem;">
                                <button type="submit" class="button primary expanded small">
                                    üîç Szukaj
                                </button>
                                {% if search_lastname %}
                                    <a href="{% url 'deduplikator_autorow:duplicate_authors' %}"
                                       class="button secondary expanded small" style="margin-top: 5px;">
                                        Wyczy≈õƒá
                                    </a>
                                    <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                                        <strong>Szukano:</strong> "{{ search_lastname }}"
                                        {% if search_results_count is not None %}
                                            <br><strong>Znaleziono:</strong> {{ search_results_count }} autor{% if search_results_count != 1 %}√≥w{% endif %}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </form>
                        </div>
                    </li>

                    <!-- Pobierz XLSX -->
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üìä Pobierz XLSX duplikat√≥w
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p style="margin-bottom: 10px;">Pobierz wszystkich autor√≥w z duplikatami w formacie Excel.</p>
                            <a href="{% url 'deduplikator_autorow:download_duplicates_xlsx' %}"
                               class="button success expanded"
                               style="margin: 0;">
                                üì• Pobierz XLSX
                            </a>
                        </div>
                    </li>

                    <!-- Obejrz nie-duplikaty -->
                    <li class="accordion-item {% if not_duplicate_count > 0 %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if not_duplicate_count > 0 %}aria-expanded="true"{% endif %}>
                            üëÅÔ∏è Obejrz nie-duplikaty
                        </a>
                        <div class="accordion-content" data-tab-content {% if not_duplicate_count > 0 %}style="display: block;"{% endif %}>
                            <p style="margin-bottom: 10px;">Przejrzyj autor√≥w oznaczonych jako nie bƒôdƒÖcych duplikatami.</p>
                            <a href="/admin/deduplikator_autorow/notaduplicate/"
                               class="button secondary expanded"
                               target="_blank"
                               style="margin: 0;">
                                üîç Otw√≥rz listƒô
                            </a>
                        </div>
                    </li>

                    <!-- Reset nie-duplikat√≥w -->
                    {% if not_duplicate_count > 0 %}
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üîÑ Zresetuj nie-duplikaty ({{ not_duplicate_count }})
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p style="margin-bottom: 10px;">Wyczy≈õƒá wszystkie oznaczenia nie-duplikat√≥w.</p>
                            <p style="margin-bottom: 10px; color: #d63031;">
                                ‚ö†Ô∏è Obecnie: {{ not_duplicate_count }} oznaczonych
                            </p>
                            <form method="post" action="{% url 'deduplikator_autorow:reset_not_duplicates' %}" style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit"
                                        class="button alert expanded"
                                        style="margin: 0;"
                                        onclick="return confirm('Czy na pewno chcesz zresetowaƒá wszystkie oznaczenia nie-duplikat√≥w? Tej operacji nie mo≈ºna cofnƒÖƒá.');">
                                    üóëÔ∏è Zresetuj wszystkie
                                </button>
                            </form>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Ignorowani autorzy -->
                    <li class="accordion-item {% if ignored_authors_count > 0 %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üö´ Ignorowani autorzy {% if ignored_authors_count > 0 %}({{ ignored_authors_count }}){% endif %}
                        </a>
                        <div class="accordion-content" data-tab-content {% if ignored_authors_count > 0 %}style="display: block;"{% endif %}>
                            <p style="margin-bottom: 10px;">Autorzy pominiƒôci w procesie deduplikacji.</p>
                            {% if ignored_authors_count > 0 %}
                                <p style="margin-bottom: 10px; color: #d63031;">
                                    ‚ö†Ô∏è Obecnie: {{ ignored_authors_count }} ignorowanych
                                </p>
                                <a href="/admin/deduplikator_autorow/ignoredauthor/"
                                   class="button secondary expanded small"
                                   target="_blank"
                                   style="margin-bottom: 5px;">
                                    <span class="fi-list"></span> Zobacz listƒô
                                </a>
                                <form method="post" action="{% url 'deduplikator_autorow:reset_ignored_authors' %}" style="margin: 0;">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="button alert expanded small"
                                            onclick="return confirm('Czy na pewno chcesz zresetowaƒá wszystkich ignorowanych autor√≥w? Tej operacji nie mo≈ºna cofnƒÖƒá.');">
                                        üóëÔ∏è Zresetuj ignorowanych
                                    </button>
                                </form>
                            {% else %}
                                <p style="color: #666;">Brak ignorowanych autor√≥w.</p>
                            {% endif %}
                        </div>
                    </li>

                    <!-- Historia scale≈Ñ -->
                    {% if recent_merges %}
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üìú Ostatnie scalenia
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <div style="max-height: 300px; overflow-y: auto;">
                                {% for merge in recent_merges %}
                                    <div style="margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 0.85rem;">
                                        <div style="font-weight: bold; margin-bottom: 4px;">
                                            {{ merge.duplicate_autor_str|default:"Duplikat" }}
                                            ‚Üí
                                            {{ merge.main_autor|default:"G≈Ç√≥wny" }}
                                        </div>
                                        <div style="color: #666;">
                                            <span class="fi-calendar"></span> {{ merge.created_on|date:"d.m.Y H:i" }}
                                        </div>
                                        <div style="margin-top: 4px;">
                                            <span class="label small {% if merge.operation_type == 'AUTHOR_DELETED' %}success{% elif merge.operation_type == 'DISCIPLINE_TRANSFER' %}primary{% else %}secondary{% endif %}">
                                                {{ merge.get_operation_type_display }}
                                            </span>
                                            {% if merge.publications_transferred > 0 %}
                                                <span class="label small success">{{ merge.publications_transferred }} publikacji</span>
                                            {% endif %}
                                            {% if merge.disciplines_transferred > 0 %}
                                                <span class="label small primary">{{ merge.disciplines_transferred }} dyscyplin</span>
                                            {% endif %}
                                            {% if merge.warnings %}
                                                <span class="label small warning" title="{{ merge.warnings|truncatewords:10 }}">ostrze≈ºenia</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <a href="/admin/deduplikator_autorow/logscalania/"
                               class="button secondary expanded small"
                               target="_blank"
                               style="margin-top: 10px;">
                                <span class="fi-list"></span> Zobacz wszystkie
                            </a>
                        </div>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content-with-sidebar">
            <!-- Local messages placeholder that respects sidebar layout -->
            <div id="localMessagesPlaceholder" style="margin-bottom: 20px;"></div>

            <div class="grid-x grid-padding-x align-middle" style="margin-bottom: 20px;">
                <div class="cell auto">
                    <h1>Deduplikator Autor√≥w PBN <span class="label warning" style="font-size: 0.6em; vertical-align: top;">BETA</span></h1>
                </div>
                <div class="cell shrink">
                    {% if not search_lastname and scientist %}
                        <div class="button-group">
                            {% if has_previous_authors %}
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?go_previous=1"
                                   class="button secondary">‚Üê Poprzedni autor</a>
                            {% endif %}
                            <form method="post" action="{% url 'deduplikator_autorow:ignore_author' %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="scientist_id" value="{{ scientist.pk }}">
                                <input type="hidden" name="reason" value="Pominiƒôty przez u≈ºytkownika">
                                <button type="submit"
                                        class="button warning"
                                        onclick="return confirm('Czy na pewno chcesz ignorowaƒá tego autora? Nie bƒôdzie wiƒôcej wy≈õwietlany w deduplikatorze.');">
                                    üö´ Ignoruj autora
                                </button>
                            </form>
                            <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_current=1"
                               class="button primary">Nastƒôpny autor ‚Üí</a>
                        </div>
                    {% elif not search_lastname %}
                        <div class="button-group">
                            {% if has_previous_authors %}
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?go_previous=1"
                                   class="button secondary">‚Üê Poprzedni autor</a>
                            {% endif %}
                            <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_current=1"
                               class="button primary">Nastƒôpny autor ‚Üí</a>
                        </div>
                    {% endif %}
                </div>
            </div>


            {% if not scientist %}
                <div class="callout warning">
                    <p><strong>Nie znaleziono autor√≥w z duplikatami.</strong></p>
                    <p>Wszystkie duplikaty zosta≈Çy prawdopodobnie ju≈º przetworzone lub nie ma autor√≥w wymagajƒÖcych
                        deduplikacji.</p>
                </div>
            {% else %}
                {% if glowny_autor %}
                    <div class="callout primary">
                        <h3>G≈Ç√≥wny rekord autora</h3>
                        <div class="grid-x grid-padding-x">
                            <div class="cell medium-4">
                                <strong>Imiƒô i nazwisko:</strong><br>
                                <span style="font-size: 1.5em; font-weight: bold; color: #1779ba;">
                                <a href="{% url 'bpp:browse_autor' glowny_autor.pk %}" target="_blank"
                                   style="color: inherit; text-decoration: none;">
                                    {% if glowny_autor.imiona %}{{ glowny_autor.imiona }}{% endif %}
                                    {{ glowny_autor.nazwisko|default:"[brak nazwiska]" }}
                                </a>
                            </span><br/>
                                <strong>BPP ID:</strong> {{ glowny_autor.pk }}<br/>
                                <strong>ORCID:</strong>
                                {% if glowny_autor.orcid %}
                                    <a href="https://orcid.org/{{ glowny_autor.orcid }}"
                                       target="_blank">{{ glowny_autor.orcid }}</a>
                                {% else %}
                                    brak
                                {% endif %}
                                {% if glowny_autor.pbn_uid_id %}
                                    <br><strong>PBN:</strong> <a href="{{ glowny_autor.link_do_pbn }}"
                                                                 target="_blank">{{ glowny_autor.pbn_uid_id }}</a><br/>
                                    <strong>{{ glowny_autor.pbn_uid.x.pbn_uid.currentEmploymentsInstitutionDisplayName }}</strong>
                                {% endif %}
                            </div>
                            <div class="cell medium-4">
                                <strong>Tytu≈Ç naukowy:</strong> {{ glowny_autor.tytul|default:"brak" }}<br/>
                                <strong>Liczba publikacji:</strong><br>
                                <span style="font-size: 1.3em; font-weight: bold; color: #2ba6cb; background-color: #e7f4fd; padding: 5px 10px; border-radius: 5px; display: inline-block;">
                                {{ glowne_publikacje_count|default:0 }} publikacji
                            </span>
                            </div>
                            <div class="cell medium-4">
                                <!-- Navigation moved to header -->
                            </div>
                        </div>

                        <h4>Dyscypliny g≈Ç√≥wnego autora (2022-2025):</h4>
                        <div style="margin-bottom: 15px;">
                            <table style="width: 100%; border: 1px solid #e1e1e1;">
                                <thead style="background-color: #f4f4f4;">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Rok</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Dyscyplina</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">%</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Subdyscyplina</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">%</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Rodzaj</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Etat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dyscyplina in glowny_autor_dyscypliny %}
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.rok }}</td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1;">{{ dyscyplina.dyscyplina_naukowa }}</td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">
                                                {% if dyscyplina.procent_dyscypliny %}{{ dyscyplina.procent_dyscypliny }}%{% else %}-{% endif %}
                                            </td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1;">
                                                {% if dyscyplina.subdyscyplina_naukowa %}{{ dyscyplina.subdyscyplina_naukowa }}{% else %}-{% endif %}
                                            </td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">
                                                {% if dyscyplina.procent_subdyscypliny %}{{ dyscyplina.procent_subdyscypliny }}%{% else %}-{% endif %}
                                            </td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.get_rodzaj_autora_display|default:"-" }}</td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">
                                                {% if dyscyplina.wymiar_etatu %}{{ dyscyplina.wymiar_etatu }}{% else %}-{% endif %}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" style="padding: 8px; border: 1px solid #e1e1e1; text-align: center; color: #999;">
                                                Brak przypisanych dyscyplin dla lat 2022-2025
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if glowne_publikacje %}
                            <h4>Publikacje g≈Ç√≥wnego autora:{% if glowne_publikacje_year_range %}
                                <small style="color: #666;">({{ glowne_publikacje_year_range }})</small>{% endif %}</h4>
                            <div class="publikacje-lista"
                                 style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e1e1; padding: 10px;">
                                {% for publikacja in glowne_publikacje %}
                                    <div class="publikacja-item"
                                         style="margin-bottom: 8px; padding: 5px; border-left: 3px solid #1779ba;">
                                        <small><strong>
                                            <a href="{% url 'bpp:browse_praca_old' publikacja.content_type.model publikacja.pk.1 %}"
                                               target="_blank" style="color: #1779ba; text-decoration: none;">
                                                {{ publikacja.tytul_oryginalny }}
                                            </a>
                                            {% if publikacja.rok %}
                                                <span style="color: #666; font-weight: normal;"> ({{ publikacja.rok }})</span>{% endif %}
                                        </strong></small><br>
                                        <small>{{ publikacja.opis_bibliograficzny_cache|truncatewords:20 }}</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <h3>Mo≈ºliwe duplikaty ({{ duplikaty_z_publikacjami|length }})</h3>

                    {% for duplikat_data in duplikaty_z_publikacjami %}
                        <div id="duplicate-card-{{ duplikat_data.autor.pk }}" class="callout {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}"
                             style="margin-bottom: 20px;">
                            <div class="grid-x grid-padding-x">
                                <div class="cell medium-8">
                                    <div style="margin-bottom: 10px;">
                                    <span style="font-size: 1.4em; font-weight: bold; color: #333;">
                                        <a href="{% url 'bpp:browse_autor' duplikat_data.autor.pk %}" target="_blank"
                                           style="color: inherit; text-decoration: none;">
                                            {% if duplikat_data.autor.imiona %}
                                                {{ duplikat_data.autor.imiona }}{% endif %}
                                            {{ duplikat_data.autor.nazwisko|default:"[brak nazwiska]" }}
                                        </a>
                                    </span><br>
                                        <span class="label {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}">
                                        Pewno≈õƒá: {{ duplikat_data.analiza.pewnosc }}%
                                    </span>
                                    </div>

                                    <div class="grid-x grid-padding-x">
                                        <div class="cell medium-6">
                                            <strong>Tytu≈Ç naukowy:</strong>
                                            {{ duplikat_data.autor.tytul|default:"brak" }}
                                        </div>
                                        <div class="cell medium-6">
                                            <strong>BPP ID:</strong> {{ duplikat_data.autor.pk }}<br/>
                                            <strong>ORCID:</strong>
                                            {% if duplikat_data.autor.orcid %}
                                                <a href="https://orcid.org/{{ duplikat_data.autor.orcid }}"
                                                   target="_blank">{{ duplikat_data.autor.orcid }}</a>
                                            {% else %}
                                                brak
                                            {% endif %}
                                            {% if duplikat_data.autor.pbn_uid_id %}
                                                <br><strong>PBN:</strong>
                                                <a href="{{ duplikat_data.autor.link_do_pbn }}"
                                                   target="_blank">{{ duplikat_data.autor.pbn_uid_id }}</a>
                                            {% endif %}
                                        </div>
                                        <div class="cell medium-12">
                                            <strong>Liczba publikacji:</strong><br>
                                            <span style="font-size: 1.2em; font-weight: bold; color: #5e5e5e; background-color: #f4f4f4; padding: 3px 8px; border-radius: 3px; display: inline-block;">
                                            {{ duplikat_data.publikacje_count|default:0 }} publikacji
                                        </span>
                                        </div>
                                    </div>

                                    <div style="margin-top: 10px;">
                                        <h5>Powody podobie≈Ñstwa:</h5>
                                        <ul>
                                            {% for powod in duplikat_data.analiza.powody_podobienstwa %}
                                                <li>{{ powod }}</li>
                                                {% empty %}
                                                <li>Brak szczeg√≥≈Çowych powod√≥w</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="cell medium-4 text-right">
                                    <div class="button-group stacked">
                                        <button type="button"
                                                id="merge-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small primary"
                                                onclick="return confirmMerge({{ glowny_autor.pk }}, {{ duplikat_data.autor.pk }});"
                                                style="width: 100%;">
                                            <span class="button-text">Scal automatycznie</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop" style="animation: spin 1s linear infinite;"></i> Scalanie...
                                            </span>
                                        </button>
                                        <button type="button"
                                                id="merge-no-pbn-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small warning"
                                                onclick="return confirmMergeNoPBN({{ glowny_autor.pk }}, {{ duplikat_data.autor.pk }});"
                                                style="width: 100%;">
                                            <span class="button-text">Scal, nie wysy≈Çaj do PBN</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop" style="animation: spin 1s linear infinite;"></i> Scalanie...
                                            </span>
                                        </button>
                                        <form method="post" action="{% url 'deduplikator_autorow:mark_non_duplicate' %}"
                                              style="display: block; width: 100%;">
                                            {% csrf_token %}
                                            <input type="hidden" name="scientist_pk"
                                                   value="{{ duplikat_data.autor.pk }}">
                                            <button type="submit" class="button small secondary" style="width: 100%;">
                                                Nie sƒÖ duplikatami
                                            </button>
                                        </form>
                                        {% if duplikat_data.publikacje_count == 0 %}
                                            <button class="button small alert"
                                                    onclick="return confirmDelete({{ duplikat_data.autor.pk }});"
                                                    style="width: 100%;">Usu≈Ñ autora (brak publikacji)
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <h5 style="margin-top: 15px;">Dyscypliny duplikatu (2022-2025):</h5>
                            <div style="margin-bottom: 10px;">
                                <table style="width: 100%; border: 1px solid #e1e1e1; font-size: 0.9em;">
                                    <thead style="background-color: #f9f9f9;">
                                        <tr>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Rok</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Dyscyplina</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">%</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Subdyscyplina</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">%</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Rodzaj</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Etat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dyscyplina in duplikat_data.dyscypliny %}
                                            <tr {% if dyscyplina.dyscyplina_naukowa != glowny_autor_dyscypliny.0.dyscyplina_naukowa %}style="background-color: #fff3cd;"{% endif %}>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.rok }}</td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1;">{{ dyscyplina.dyscyplina_naukowa }}</td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">
                                                    {% if dyscyplina.procent_dyscypliny %}{{ dyscyplina.procent_dyscypliny }}%{% else %}-{% endif %}
                                                </td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1;">
                                                    {% if dyscyplina.subdyscyplina_naukowa %}{{ dyscyplina.subdyscyplina_naukowa }}{% else %}-{% endif %}
                                                </td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">
                                                    {% if dyscyplina.procent_subdyscypliny %}{{ dyscyplina.procent_subdyscypliny }}%{% else %}-{% endif %}
                                                </td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.get_rodzaj_autora_display|default:"-" }}</td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">
                                                    {% if dyscyplina.wymiar_etatu %}{{ dyscyplina.wymiar_etatu }}{% else %}-{% endif %}
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="7" style="padding: 6px; border: 1px solid #e1e1e1; text-align: center; color: #999;">
                                                    Brak przypisanych dyscyplin dla lat 2022-2025
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            {% if duplikat_data.publikacje %}
                                <h5 style="margin-top: 15px;">Publikacje duplikatu:
                                    {% if duplikat_data.publikacje_year_range %}
                                        <small style="color: #666;">({{ duplikat_data.publikacje_year_range }})</small>{% endif %}
                                </h5>
                                <div class="publikacje-lista"
                                     style="max-height: 250px; overflow-y: auto; border: 1px solid #e1e1e1; padding: 10px; background-color: #f9f9f9;">
                                    {% for publikacja in duplikat_data.publikacje %}
                                        <div class="publikacja-item"
                                             style="margin-bottom: 6px; padding: 3px; border-left: 2px solid #8a8a8a;">
                                            <small><strong>
                                                <a href="{% url 'bpp:browse_praca' publikacja.pk.0 publikacja.pk.1 %}"
                                                   target="_blank" style="color: #333; text-decoration: none;">
                                                    {{ publikacja.tytul_oryginalny }}
                                                </a>
                                                {% if publikacja.rok %}
                                                    <span style="color: #666; font-weight: normal;"> ({{ publikacja.rok }})</span>{% endif %}
                                            </strong></small><br>
                                            <small style="color: #666;">
                                                {{ publikacja.opis_bibliograficzny_cache|truncatewords:15 }}</small>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="callout secondary">
                            <p>Nie znaleziono duplikat√≥w dla tego autora.</p>
                        </div>
                    {% endfor %}

                {% else %}
                    <div class="callout alert">
                        <p><strong>B≈ÇƒÖd:</strong> Nie mo≈ºna pobraƒá danych g≈Ç√≥wnego autora.</p>
                    </div>
                {% endif %}
            {% endif %}

        </div>
    </div>

    <script>
        // Move messages from base placeholder to local placeholder to respect sidebar layout
        function relocateMessages() {
            const baseMessages = document.getElementById('messagesPlaceholder');
            const localMessages = document.getElementById('localMessagesPlaceholder');

            if (baseMessages && localMessages) {
                // Move all children from base to local placeholder
                while (baseMessages.firstChild) {
                    localMessages.appendChild(baseMessages.firstChild);
                }

                // Also listen for any new messages that might be added dynamically
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes.length > 0) {
                            // Move new messages to local placeholder
                            while (baseMessages.firstChild) {
                                localMessages.appendChild(baseMessages.firstChild);
                            }
                        }
                    });
                });

                // Observe the base placeholder for new messages
                observer.observe(baseMessages, { childList: true });
            }
        }

        // Adjust sidebar position and height
        function adjustSidebarPosition() {
            const sidebar = document.querySelector('.left-menu-sidebar');
            const breadcrumbs = document.getElementById('breadcrumbs-wrapper');
            const footer = document.querySelector('.grid-container-fluid[style*="z-index: 10"]') ||
                          document.querySelector('.grid-container-fluid[style*="background-color: #f8f8f8"]');

            if (sidebar && breadcrumbs) {
                // Get breadcrumbs exact bottom position (including its border)
                const breadcrumbsRect = breadcrumbs.getBoundingClientRect();
                const breadcrumbsStyles = window.getComputedStyle(breadcrumbs);
                const breadcrumbsBorder = parseFloat(breadcrumbsStyles.borderBottomWidth) || 0;
                const topPosition = breadcrumbsRect.bottom; // This already includes the border

                // Set sidebar top position to align exactly with breadcrumbs bottom
                sidebar.style.top = topPosition + 'px';

                // Calculate height to stop before footer
                let sidebarHeight;
                if (footer) {
                    const footerRect = footer.getBoundingClientRect();

                    // If footer is visible in viewport, adjust height to stop at footer
                    if (footerRect.top < window.innerHeight) {
                        // Calculate exact height to stop just before footer
                        sidebarHeight = footerRect.top - topPosition - 10; // 10px gap before footer

                        // If the calculated height is too small, set minimum height
                        if (sidebarHeight < 300) {
                            sidebarHeight = 300;
                        }
                    } else {
                        // Footer not in viewport, use full viewport height
                        sidebarHeight = window.innerHeight - topPosition;
                    }
                } else {
                    // No footer found, use full viewport height
                    sidebarHeight = window.innerHeight - topPosition ;
                }

                // Apply the calculated height
                sidebar.style.height = sidebarHeight + 'px';

                // Keep z-index at 0 so sidebar remains visible but behind other elements
                sidebar.style.zIndex = '0';
            }
        }

        // Adjust on page load
        document.addEventListener('DOMContentLoaded', function() {
            adjustSidebarPosition();
            relocateMessages(); // Move messages to respect sidebar layout
        });

        // Adjust on window resize and scroll
        window.addEventListener('resize', adjustSidebarPosition);
        window.addEventListener('scroll', adjustSidebarPosition);

        // Adjust after Foundation initializes
        $(document).ready(function() {
            setTimeout(adjustSidebarPosition, 100);
            // Also relocate any messages that might have been added after DOM ready
            relocateMessages();
        });

        // Add CSS for spinner animation
        var style = document.createElement('style');
        style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);

        function confirmMerge(mainAuthorId, duplicateAuthorId) {
            if (!confirm('Czy jeste≈õ pewny/a? W ten spos√≥b przypiszesz wszystkie publikacje potencjalnego duplikatu autorowi g≈Ç√≥wnemu, domy≈õlnie z g≈Ç√≥wnƒÖ dyscyplinƒÖ. Zostanie zlecona te≈º wysy≈Çka tych prac do PBN w tle. Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
                return false;
            }

            // Get button and card elements
            var button = document.getElementById('merge-btn-' + duplicateAuthorId);
            var card = document.getElementById('duplicate-card-' + duplicateAuthorId);

            // Show spinner, disable button
            if (button) {
                button.disabled = true;
                button.querySelector('.button-text').style.display = 'none';
                button.querySelector('.spinner').style.display = 'inline';
            }

            // Make AJAX call
            $.ajax({
                url: '{% url "deduplikator_autorow:scal_autorow" %}',
                type: 'GET',
                dataType: 'json',
                data: {
                    'main_scientist_id': mainAuthorId,
                    'duplicate_scientist_id': duplicateAuthorId
                },
                complete: function(xhr, status) {
                    // Handle both success and error responses here
                    console.log('AJAX complete, status:', status, 'xhr:', xhr);

                    var response = null;
                    try {
                        response = xhr.responseJSON || JSON.parse(xhr.responseText);
                    } catch(e) {
                        console.log('Failed to parse response:', e);
                    }

                    console.log('Parsed response:', response);

                    // ONLY fade out if success is EXACTLY true
                    if (response && response.success === true) {
                        // Success - fade out the card
                        console.log('Merge successful (success === true), fading out card');
                        if (card) {
                            $(card).fadeOut(600, function() {
                                $(this).remove();

                                // Update the duplicate count in the header
                                var countElement = document.querySelector('h3');
                                if (countElement && countElement.textContent.includes('Mo≈ºliwe duplikaty')) {
                                    var currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
                                    var newCount = currentCount - 1;
                                    countElement.textContent = 'Mo≈ºliwe duplikaty (' + newCount + ')';

                                    // If no more duplicates, reload the page to get next author
                                    if (newCount === 0) {
                                        setTimeout(function() {
                                            window.location.reload();
                                        }, 500);
                                    }
                                }
                            });
                        }

                        // Show success message with details
                        if (bppNotifications && bppNotifications.addMessage) {
                            var message = 'Autorzy zostali pomy≈õlnie scaleni';
                            if (response.result) {
                                if (response.result.total_updated) {
                                    message += '\n‚Ä¢ ' + response.result.total_updated + ' publikacji przeniesionych';
                                }
                                if (response.result.disciplines_transferred && response.result.disciplines_transferred.length > 0) {
                                    message += '\n‚Ä¢ ' + response.result.disciplines_transferred.length + ' dyscyplin przeniesionych';
                                }
                                if (response.result.warnings && response.result.warnings.length > 0) {
                                    message += '\n‚Ä¢ ' + response.result.warnings.length + ' ostrze≈ºe≈Ñ';
                                }
                            }
                            bppNotifications.addMessage({
                                cssClass: 'success',
                                text: message,
                                sound: false
                            });
                        }
                    } else {
                        // Error from server - DO NOT fade out the card
                        console.log('Merge failed, response:', response);

                        var errorMessage = 'B≈ÇƒÖd podczas scalania autor√≥w:\n\n';

                        // Handle different error scenarios
                        if (!response) {
                            errorMessage += 'Brak odpowiedzi z serwera.';
                        } else if (response.success === false) {
                            // Explicitly handle success: false
                            if (response.error) {
                                errorMessage += response.error;
                            } else if (response.result && response.result.error) {
                                errorMessage += response.result.error;
                            } else {
                                errorMessage += 'Operacja nie powiod≈Ça siƒô (success: false). Sprawd≈∫ logi serwera.';
                            }
                        } else if (response.error) {
                            errorMessage += response.error;
                        } else {
                            errorMessage += 'Nieoczekiwana odpowied≈∫ serwera: ' + JSON.stringify(response);
                        }

                        // Add error message directly to the card
                        if (card) {
                            // Remove any existing error messages
                            var existingError = card.querySelector('.merge-error-alert');
                            if (existingError) {
                                existingError.remove();
                            }

                            // Create and add new error message
                            var errorDiv = document.createElement('div');
                            errorDiv.className = 'callout alert merge-error-alert';
                            errorDiv.style.marginTop = '15px';
                            errorDiv.innerHTML = '<h5 style="margin-bottom: 10px;">‚ùå B≈ÇƒÖd scalania</h5>' +
                                                '<p style="margin-bottom: 0;">' +
                                                errorMessage.replace(/\n/g, '<br>') +
                                                '</p>';

                            // Insert error after the main content div
                            var mainDiv = card.querySelector('.grid-x');
                            if (mainDiv) {
                                mainDiv.parentNode.insertBefore(errorDiv, mainDiv.nextSibling);
                            } else {
                                card.appendChild(errorDiv);
                            }

                            // Scroll to error message
                            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }

                        // Also show as notification if available
                        if (bppNotifications && bppNotifications.addMessage) {
                            bppNotifications.addMessage({
                                cssClass: 'alert',
                                text: errorMessage.replace(/\n/g, ' '),
                                sound: true
                            });
                        }

                        // Re-enable button so user can retry
                        if (button) {
                            button.disabled = false;
                            button.querySelector('.button-text').style.display = 'inline';
                            button.querySelector('.spinner').style.display = 'none';
                        }
                    }
                }
            });

            return false;
        }

        function confirmMergeNoPBN(mainAuthorId, duplicateAuthorId) {
            if (!confirm('Czy jeste≈õ pewny/a? W ten spos√≥b przypiszesz wszystkie publikacje potencjalnego duplikatu autorowi g≈Ç√≥wnemu, domy≈õlnie z g≈Ç√≥wnƒÖ dyscyplinƒÖ. Publikacje NIE zostanƒÖ wys≈Çane do PBN. Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
                return false;
            }

            // Get button and card elements
            var button = document.getElementById('merge-no-pbn-btn-' + duplicateAuthorId);
            var card = document.getElementById('duplicate-card-' + duplicateAuthorId);

            // Show spinner, disable button
            if (button) {
                button.disabled = true;
                button.querySelector('.button-text').style.display = 'none';
                button.querySelector('.spinner').style.display = 'inline';
            }

            // Make AJAX call with skip_pbn parameter
            $.ajax({
                url: '{% url "deduplikator_autorow:scal_autorow" %}',
                type: 'GET',
                dataType: 'json',
                data: {
                    'main_scientist_id': mainAuthorId,
                    'duplicate_scientist_id': duplicateAuthorId,
                    'skip_pbn': true
                },
                complete: function(xhr, status) {
                    // Handle both success and error responses here
                    console.log('AJAX complete (no PBN), status:', status, 'xhr:', xhr);

                    var response = null;
                    try {
                        response = xhr.responseJSON || JSON.parse(xhr.responseText);
                    } catch(e) {
                        console.log('Failed to parse response:', e);
                    }

                    console.log('Parsed response:', response);

                    // ONLY fade out if success is EXACTLY true
                    if (response && response.success === true) {
                        // Success - fade out the card
                        console.log('Merge successful without PBN (success === true), fading out card');
                        if (card) {
                            $(card).fadeOut(600, function() {
                                $(this).remove();

                                // Update the duplicate count in the header
                                var countElement = document.querySelector('h3');
                                if (countElement && countElement.textContent.includes('Mo≈ºliwe duplikaty')) {
                                    var currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
                                    var newCount = currentCount - 1;
                                    countElement.textContent = 'Mo≈ºliwe duplikaty (' + newCount + ')';

                                    // If no more duplicates, reload the page to get next author
                                    if (newCount === 0) {
                                        setTimeout(function() {
                                            window.location.reload();
                                        }, 500);
                                    }
                                }
                            });
                        }

                        // Show success message with details
                        if (bppNotifications && bppNotifications.addMessage) {
                            var message = 'Autorzy zostali pomy≈õlnie scaleni (bez wysy≈Çki do PBN)';
                            if (response.result) {
                                if (response.result.total_updated) {
                                    message += '\n‚Ä¢ ' + response.result.total_updated + ' publikacji przeniesionych';
                                }
                                if (response.result.disciplines_transferred && response.result.disciplines_transferred.length > 0) {
                                    message += '\n‚Ä¢ ' + response.result.disciplines_transferred.length + ' dyscyplin przeniesionych';
                                }
                                if (response.result.warnings && response.result.warnings.length > 0) {
                                    message += '\n‚Ä¢ ' + response.result.warnings.length + ' ostrze≈ºe≈Ñ';
                                }
                            }
                            bppNotifications.addMessage({
                                cssClass: 'success',
                                text: message,
                                sound: false
                            });
                        }
                    } else {
                        // Error from server - DO NOT fade out the card
                        console.log('Merge failed (no PBN), response:', response);

                        var errorMessage = 'B≈ÇƒÖd podczas scalania autor√≥w:\n\n';

                        // Handle different error scenarios
                        if (!response) {
                            errorMessage += 'Brak odpowiedzi z serwera.';
                        } else if (response.success === false) {
                            // Explicitly handle success: false
                            if (response.error) {
                                errorMessage += response.error;
                            } else if (response.result && response.result.error) {
                                errorMessage += response.result.error;
                            } else {
                                errorMessage += 'Operacja nie powiod≈Ça siƒô (success: false). Sprawd≈∫ logi serwera.';
                            }
                        } else if (response.error) {
                            errorMessage += response.error;
                        } else {
                            errorMessage += 'Nieoczekiwana odpowied≈∫ serwera: ' + JSON.stringify(response);
                        }

                        // Add error message directly to the card
                        if (card) {
                            // Remove any existing error messages
                            var existingError = card.querySelector('.merge-error-alert');
                            if (existingError) {
                                existingError.remove();
                            }

                            // Create and add new error message
                            var errorDiv = document.createElement('div');
                            errorDiv.className = 'callout alert merge-error-alert';
                            errorDiv.style.marginTop = '15px';
                            errorDiv.innerHTML = '<h5 style="margin-bottom: 10px;">‚ùå B≈ÇƒÖd scalania</h5>' +
                                                '<p style="margin-bottom: 0;">' +
                                                errorMessage.replace(/\n/g, '<br>') +
                                                '</p>';

                            // Insert error after the main content div
                            var mainDiv = card.querySelector('.grid-x');
                            if (mainDiv) {
                                mainDiv.parentNode.insertBefore(errorDiv, mainDiv.nextSibling);
                            } else {
                                card.appendChild(errorDiv);
                            }

                            // Scroll to error message
                            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }

                        // Also show as notification if available
                        if (bppNotifications && bppNotifications.addMessage) {
                            bppNotifications.addMessage({
                                cssClass: 'alert',
                                text: errorMessage.replace(/\n/g, ' '),
                                sound: true
                            });
                        }

                        // Re-enable button so user can retry
                        if (button) {
                            button.disabled = false;
                            button.querySelector('.button-text').style.display = 'inline';
                            button.querySelector('.spinner').style.display = 'none';
                        }
                    }
                }
            });

            return false;
        }

        function confirmDelete(authorId) {
            if (confirm('Czy na pewno chcesz usunƒÖƒá tego autora? Ta operacja jest nieodwracalna. Ta operacja NIE USUWA ' +
                'DANYCH AUTORA Z PBN.')) {
                // Create form and submit
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "deduplikator_autorow:delete_author" %}';

                var csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrfmiddlewaretoken';
                csrfToken.value = '{{ csrf_token }}';
                form.appendChild(csrfToken);

                var authorIdInput = document.createElement('input');
                authorIdInput.type = 'hidden';
                authorIdInput.name = 'author_id';
                authorIdInput.value = authorId;
                form.appendChild(authorIdInput);

                document.body.appendChild(form);
                form.submit();
                return true;
            }
            return false;
        }
    </script>
{% endblock %}
