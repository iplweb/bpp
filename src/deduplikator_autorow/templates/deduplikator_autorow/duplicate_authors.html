{% extends "base.html" %}
{% load static %}

{% block title %}Deduplikator Autor√≥w PBN{% endblock %}

{% block breadcrumbs %}
    <li><a href="/">Strona g≈Ç√≥wna</a></li>
    <li><a href="{% url "deduplikator_autorow:duplicate_authors" %}">Deduplikator autor√≥w PBN</a></li>
{% endblock %}

{% block content %}
    <div id="left-menu-container">
        <!-- Left Sidebar Menu -->
        <div class="left-menu-sidebar">
            <div class="left-menu-menu">
                <ul class="accordion" data-accordion data-allow-all-closed="true" data-multi-expand="true" style="border: none; padding: 0; margin: 0;">
                    <!-- Status skanowania duplikat√≥w -->
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title" href="#" aria-expanded="true" style="pointer-events: none; cursor: default;">
                            <span class="fi-magnifying-glass"></span> Skanowanie duplikat√≥w
                        </a>
                        <div class="accordion-content" data-tab-content style="display: block; padding: 10px 15px;">
                            {% if running_scan %}
                                <div id="scan-progress-container">
                                    <p style="margin-bottom: 5px; font-size: 0.85rem;">
                                        <strong>Status:</strong>
                                        <span style="color: orange;"><span class="fi-loop"></span> {{ running_scan.get_status_display }}</span>
                                    </p>
                                    <div style="width: 100%; background: #ddd; border-radius: 4px; margin-bottom: 10px;">
                                        <div id="scan-progress-bar"
                                             style="width: {{ running_scan.progress_percent }}%; background: #4CAF50; height: 20px; border-radius: 4px; transition: width 0.3s;">
                                        </div>
                                    </div>
                                    <p id="scan-progress-text" style="font-size: 0.85rem; margin-bottom: 10px;">
                                        {{ running_scan.progress_percent }}% ({{ running_scan.authors_scanned }}/{{ running_scan.total_authors_to_scan }} autor√≥w)
                                    </p>
                                    <p id="scan-duplicates-text" style="font-size: 0.85rem; margin-bottom: 10px;">
                                        Znaleziono duplikat√≥w: {{ running_scan.duplicates_found }}
                                    </p>
                                    <form method="post" action="{% url 'deduplikator_autorow:cancel_scan' %}" style="margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="button alert expanded small"
                                                onclick="return confirm('Czy na pewno chcesz anulowaƒá skanowanie?');">
                                            <span class="fi-x"></span> Anuluj skanowanie
                                        </button>
                                    </form>
                                </div>
                                <script>
                                    // Auto-refresh scan progress
                                    (function() {
                                        var scanId = {{ running_scan.pk }};
                                        var refreshInterval = setInterval(function() {
                                            fetch('{% url "deduplikator_autorow:scan_status" running_scan.pk %}')
                                                .then(function(response) { return response.json(); })
                                                .then(function(data) {
                                                    if (data.finished) {
                                                        clearInterval(refreshInterval);
                                                        location.reload();
                                                    } else {
                                                        // Update sidebar progress
                                                        document.getElementById('scan-progress-bar').style.width = data.progress_percent + '%';
                                                        document.getElementById('scan-progress-text').textContent =
                                                            data.progress_percent + '% (' + data.authors_scanned + '/' + data.total_authors_to_scan + ' autor√≥w)';
                                                        document.getElementById('scan-duplicates-text').textContent =
                                                            'Znaleziono duplikat√≥w: ' + data.duplicates_found;
                                                        // Update main content progress (if exists)
                                                        var mainBar = document.getElementById('main-scan-progress-bar');
                                                        var mainText = document.getElementById('main-scan-progress-text');
                                                        if (mainBar) {
                                                            mainBar.style.width = data.progress_percent + '%';
                                                        }
                                                        if (mainText) {
                                                            mainText.textContent = data.progress_percent + '% (' + data.authors_scanned + '/' + data.total_authors_to_scan + ' autor√≥w)';
                                                        }
                                                    }
                                                })
                                                .catch(function(err) {
                                                    console.error('Error fetching scan status:', err);
                                                });
                                        }, 3000);  // Refresh every 3 seconds
                                    })();
                                </script>
                            {% elif completed_scan %}
                                <p style="margin-bottom: 5px; font-size: 0.85rem;">
                                    <strong>Ostatnie skanowanie:</strong><br>
                                    {{ completed_scan.finished_at|date:"d.m.Y H:i" }}
                                </p>
                                <p style="margin-bottom: 5px; font-size: 0.85rem;">
                                    <strong>Status:</strong>
                                    <span style="color: green;"><span class="fi-check"></span> {{ completed_scan.get_status_display }}</span>
                                </p>
                                <p style="margin-bottom: 10px; font-size: 0.85rem;">
                                    <strong>Znaleziono:</strong> {{ completed_scan.duplicates_found }} duplikat√≥w<br>
                                    <strong>Do sprawdzenia:</strong> {{ pending_candidates_count }}
                                </p>
                                <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}" style="margin: 0;">
                                    {% csrf_token %}
                                    <button type="submit" class="button primary expanded small"
                                            onclick="return confirm('Czy na pewno chcesz uruchomiƒá nowe skanowanie? Poprzednie wyniki zostanƒÖ zastƒÖpione.');">
                                        <span class="fi-refresh"></span> Uruchom nowe skanowanie
                                    </button>
                                </form>
                            {% else %}
                                <p style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                    Brak wynik√≥w skanowania. Uruchom skanowanie, aby znale≈∫ƒá duplikaty autor√≥w.
                                </p>
                                <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}" style="margin: 0;">
                                    {% csrf_token %}
                                    <button type="submit" class="button primary expanded small">
                                        <span class="fi-magnifying-glass"></span> Uruchom skanowanie
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </li>

                    {% if pending_candidates_count %}
                    <!-- Liczba autor√≥w z duplikatami -->
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title" href="#" aria-expanded="true" style="pointer-events: none; cursor: default;">
                            <span class="fi-torsos-all"></span> {{ pending_candidates_count }} duplikat{% if pending_candidates_count != 1 %}√≥w{% endif %} do sprawdzenia
                        </a>
                        <div class="accordion-content" data-tab-content style="display: none;"></div>
                    </li>
                    {% endif %}

                    <!-- PBN Download Info -->
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#" style="pointer-events: none; cursor: default;">
                            üì• Dane PBN
                        </a>
                        <div class="accordion-content" data-tab-content style="display: block; padding: 10px 15px;">
                            {% if latest_pbn_download %}
                                <p style="margin-bottom: 5px; font-size: 0.85rem;">
                                    <strong>Ostatnie pobieranie:</strong><br>
                                    {{ latest_pbn_download.started_at|date:"d.m.Y H:i" }}
                                </p>
                                <p style="margin-bottom: 5px; font-size: 0.85rem;">
                                    <strong>Status:</strong>
                                    {% if latest_pbn_download.status == 'completed' %}
                                        <span style="color: green;">‚úì Zako≈Ñczone</span>
                                    {% elif latest_pbn_download.status == 'running' %}
                                        <span style="color: orange;">‚è≥ W trakcie</span>
                                    {% else %}
                                        <span style="color: red;">‚úó B≈ÇƒÖd</span>
                                    {% endif %}
                                </p>
                                {% if latest_pbn_download.completed_at %}
                                    <p style="margin-bottom: 10px; font-size: 0.85rem;">
                                        <strong>Zako≈Ñczone:</strong><br>
                                        {{ latest_pbn_download.completed_at|date:"d.m.Y H:i" }}
                                    </p>
                                {% endif %}
                            {% else %}
                                <p style="margin-bottom: 10px; font-size: 0.85rem; color: #666;">
                                    Brak informacji o pobraniu danych z PBN
                                </p>
                            {% endif %}
                            <a href="{% url 'pbn_downloader_app:main' %}"
                               class="button primary expanded small"
                               target="_blank">
                                üîÑ Pobierz dane z PBN
                            </a>
                        </div>
                    </li>

                    <!-- Zacznij od poczƒÖtku -->
                    {% if has_skipped_authors and not search_lastname %}
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title" href="#" aria-expanded="true" style="pointer-events: none; cursor: default;">
                            üîÅ Nawigacja
                        </a>
                        <div class="accordion-content" data-tab-content style="display: block;">
                            <p style="margin-bottom: 10px;">Prze≈õledzile≈õ ju≈º kilku autor√≥w.</p>
                            <a href="{% url 'deduplikator_autorow:reset_skipped_authors' %}"
                               class="button alert expanded small">
                                Zacznij od poczƒÖtku
                            </a>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Wyszukiwanie autora -->
                    <li class="accordion-item {% if search_lastname %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if search_lastname %}aria-expanded="true"{% endif %}>
                            üîç Szukaj autora
                        </a>
                        <div class="accordion-content" data-tab-content {% if search_lastname %}style="display: block;"{% endif %}>
                            <form method="get" action="{% url 'deduplikator_autorow:duplicate_authors' %}" style="margin-bottom: 0;">
                                <label for="search_lastname" style="font-size: 0.9rem;">Po nazwisku:</label>
                                <input type="text" id="search_lastname" name="search_lastname"
                                       value="{{ search_lastname|default:'' }}"
                                       placeholder="Wpisz czƒô≈õƒá nazwiska..."
                                       style="margin-bottom: 10px; font-size: 0.9rem;">
                                <button type="submit" class="button primary expanded small">
                                    üîç Szukaj
                                </button>
                                {% if search_lastname %}
                                    <a href="{% url 'deduplikator_autorow:duplicate_authors' %}"
                                       class="button secondary expanded small" style="margin-top: 5px;">
                                        Wyczy≈õƒá
                                    </a>
                                    <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                                        <strong>Szukano:</strong> "{{ search_lastname }}"
                                        {% if search_results_count is not None %}
                                            <br><strong>Znaleziono:</strong> {{ search_results_count }} autor{% if search_results_count != 1 %}√≥w{% endif %}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </form>
                        </div>
                    </li>

                    <!-- Pobierz XLSX -->
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üìä Pobierz XLSX duplikat√≥w
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p style="margin-bottom: 10px;">Pobierz wszystkich autor√≥w z duplikatami w formacie Excel.</p>
                            <a href="{% url 'deduplikator_autorow:download_duplicates_xlsx' %}"
                               class="button success expanded"
                               style="margin: 0;">
                                üì• Pobierz XLSX
                            </a>
                        </div>
                    </li>

                    <!-- Obejrz nie-duplikaty -->
                    <li class="accordion-item {% if not_duplicate_count > 0 %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if not_duplicate_count > 0 %}aria-expanded="true"{% endif %}>
                            üëÅÔ∏è Obejrz nie-duplikaty
                        </a>
                        <div class="accordion-content" data-tab-content {% if not_duplicate_count > 0 %}style="display: block;"{% endif %}>
                            <p style="margin-bottom: 10px;">Przejrzyj autor√≥w oznaczonych jako nie bƒôdƒÖcych duplikatami.</p>
                            <a href="/admin/deduplikator_autorow/notaduplicate/"
                               class="button secondary expanded"
                               target="_blank"
                               style="margin: 0;">
                                üîç Otw√≥rz listƒô
                            </a>
                        </div>
                    </li>

                    <!-- Reset nie-duplikat√≥w -->
                    {% if not_duplicate_count > 0 %}
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üîÑ Zresetuj nie-duplikaty ({{ not_duplicate_count }})
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p style="margin-bottom: 10px;">Wyczy≈õƒá wszystkie oznaczenia nie-duplikat√≥w.</p>
                            <p style="margin-bottom: 10px; color: #d63031;">
                                ‚ö†Ô∏è Obecnie: {{ not_duplicate_count }} oznaczonych
                            </p>
                            <form method="post" action="{% url 'deduplikator_autorow:reset_not_duplicates' %}" style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit"
                                        class="button alert expanded"
                                        style="margin: 0;"
                                        onclick="return confirm('Czy na pewno chcesz zresetowaƒá wszystkie oznaczenia nie-duplikat√≥w? Tej operacji nie mo≈ºna cofnƒÖƒá.');">
                                    üóëÔ∏è Zresetuj wszystkie
                                </button>
                            </form>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Ignorowani autorzy -->
                    <li class="accordion-item {% if ignored_authors_count > 0 %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üö´ Ignorowani autorzy {% if ignored_authors_count > 0 %}({{ ignored_authors_count }}){% endif %}
                        </a>
                        <div class="accordion-content" data-tab-content {% if ignored_authors_count > 0 %}style="display: block;"{% endif %}>
                            <p style="margin-bottom: 10px;">Autorzy pominiƒôci w procesie deduplikacji.</p>
                            {% if ignored_authors_count > 0 %}
                                <p style="margin-bottom: 10px; color: #d63031;">
                                    ‚ö†Ô∏è Obecnie: {{ ignored_authors_count }} ignorowanych
                                </p>
                                <a href="/admin/deduplikator_autorow/ignoredauthor/"
                                   class="button secondary expanded small"
                                   target="_blank"
                                   style="margin-bottom: 5px;">
                                    <span class="fi-list"></span> Zobacz listƒô
                                </a>
                                <form method="post" action="{% url 'deduplikator_autorow:reset_ignored_authors' %}" style="margin: 0;">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="button alert expanded small"
                                            onclick="return confirm('Czy na pewno chcesz zresetowaƒá wszystkich ignorowanych autor√≥w? Tej operacji nie mo≈ºna cofnƒÖƒá.');">
                                        üóëÔ∏è Zresetuj ignorowanych
                                    </button>
                                </form>
                            {% else %}
                                <p style="color: #666;">Brak ignorowanych autor√≥w.</p>
                            {% endif %}
                        </div>
                    </li>

                    <!-- Historia scale≈Ñ -->
                    {% if recent_merges %}
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üìú Ostatnie scalenia
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <div style="max-height: 300px; overflow-y: auto;">
                                {% for merge in recent_merges %}
                                    <div style="margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 0.85rem;">
                                        <div style="font-weight: bold; margin-bottom: 4px;">
                                            {{ merge.duplicate_autor_str|default:"Duplikat" }}
                                            ‚Üí
                                            {{ merge.main_autor|default:"G≈Ç√≥wny" }}
                                        </div>
                                        <div style="color: #666;">
                                            <span class="fi-calendar"></span> {{ merge.created_on|date:"d.m.Y H:i" }}
                                        </div>
                                        <div style="margin-top: 4px;">
                                            <span class="label small {% if merge.operation_type == 'AUTHOR_DELETED' %}success{% elif merge.operation_type == 'DISCIPLINE_TRANSFER' %}primary{% else %}secondary{% endif %}">
                                                {{ merge.get_operation_type_display }}
                                            </span>
                                            {% if merge.publications_transferred > 0 %}
                                                <span class="label small success">{{ merge.publications_transferred }} publikacji</span>
                                            {% endif %}
                                            {% if merge.disciplines_transferred > 0 %}
                                                <span class="label small primary">{{ merge.disciplines_transferred }} dyscyplin</span>
                                            {% endif %}
                                            {% if merge.warnings %}
                                                <span class="label small warning" title="{{ merge.warnings|truncatewords:10 }}">ostrze≈ºenia</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <a href="/admin/deduplikator_autorow/logscalania/"
                               class="button secondary expanded small"
                               target="_blank"
                               style="margin-top: 10px;">
                                <span class="fi-list"></span> Zobacz wszystkie
                            </a>
                        </div>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content-with-sidebar">
            <!-- Local messages placeholder that respects sidebar layout -->
            <div id="localMessagesPlaceholder" style="margin-bottom: 20px;"></div>

            <div class="grid-x grid-padding-x align-middle" style="margin-bottom: 20px;">
                <div class="cell auto">
                    <h1>Deduplikator Autor√≥w PBN <span class="label warning" style="font-size: 0.6em; vertical-align: top;">BETA</span></h1>
                </div>
                <div class="cell shrink">
                    {% if not search_lastname and scientist %}
                        <div class="button-group">
                            {% if skip_count > 0 %}
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"-1" }}"
                                   class="button secondary">‚Üê Poprzedni autor</a>
                            {% endif %}
                            <form method="post" action="{% url 'deduplikator_autorow:ignore_author' %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="scientist_id" value="{{ scientist.pk }}">
                                <input type="hidden" name="reason" value="Pominiƒôty przez u≈ºytkownika">
                                <button type="submit"
                                        class="button warning"
                                        onclick="return confirm('Czy na pewno chcesz ignorowaƒá tego autora? Nie bƒôdzie wiƒôcej wy≈õwietlany w deduplikatorze.');">
                                    üö´ Ignoruj autora
                                </button>
                            </form>
                            <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"1" }}"
                               class="button primary">Nastƒôpny autor ‚Üí</a>
                        </div>
                    {% elif not search_lastname and glowny_autor %}
                        <div class="button-group">
                            {% if skip_count > 0 %}
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"-1" }}"
                                   class="button secondary">‚Üê Poprzedni autor</a>
                            {% endif %}
                            <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"1" }}"
                               class="button primary">Nastƒôpny autor ‚Üí</a>
                        </div>
                    {% endif %}
                </div>
            </div>


            {% if no_scan_available %}
                <div class="callout primary" style="text-align: center; padding: 40px 20px;">
                    <h3><span class="fi-magnifying-glass"></span> Uruchom skanowanie</h3>
                    <p>Przed rozpoczƒôciem pracy z deduplikatorem, nale≈ºy uruchomiƒá skanowanie bazy danych w poszukiwaniu duplikat√≥w autor√≥w.</p>
                    <p style="margin-bottom: 20px;">Skanowanie jest wykonywane w tle i mo≈ºe potrwaƒá kilka minut w zale≈ºno≈õci od wielko≈õci bazy.</p>
                    <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}">
                        {% csrf_token %}
                        <button type="submit" class="button primary large">
                            <span class="fi-magnifying-glass"></span> Uruchom skanowanie duplikat√≥w
                        </button>
                    </form>
                </div>
            {% elif running_scan and not glowny_autor %}
                <div class="callout secondary" style="text-align: center; padding: 40px 20px;">
                    <h3><span class="fi-loop"></span> Skanowanie w toku...</h3>
                    <p>Proszƒô czekaƒá, skanowanie bazy w poszukiwaniu duplikat√≥w jest w trakcie.</p>
                    <div style="width: 50%; margin: 20px auto; background: #ddd; border-radius: 4px;">
                        <div id="main-scan-progress-bar"
                             style="width: {{ running_scan.progress_percent }}%; background: #4CAF50; height: 30px; border-radius: 4px; transition: width 0.3s;">
                        </div>
                    </div>
                    <p id="main-scan-progress-text" style="font-size: 1.2rem;">
                        {{ running_scan.progress_percent }}% ({{ running_scan.authors_scanned }}/{{ running_scan.total_authors_to_scan }} autor√≥w)
                    </p>
                    <p>Strona od≈õwie≈ºy siƒô automatycznie po zako≈Ñczeniu skanowania.</p>
                </div>
            {% elif not glowny_autor %}
                <div class="callout success" style="text-align: center; padding: 40px 20px;">
                    <h3><span class="fi-check"></span> Gratulacje!</h3>
                    <p><strong>Wszystkie duplikaty zosta≈Çy ju≈º przetworzone.</strong></p>
                    <p>Brak wiƒôcej duplikat√≥w do sprawdzenia. Mo≈ºesz uruchomiƒá nowe skanowanie, aby sprawdziƒá czy pojawi≈Çy siƒô nowi kandydaci.</p>
                    <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}" style="margin-top: 20px;">
                        {% csrf_token %}
                        <button type="submit" class="button primary"
                                onclick="return confirm('Czy na pewno chcesz uruchomiƒá nowe skanowanie?');">
                            <span class="fi-refresh"></span> Uruchom nowe skanowanie
                        </button>
                    </form>
                </div>
            {% else %}
                {% if glowny_autor %}
                    <div class="callout primary">
                        <h3>G≈Ç√≥wny rekord autora</h3>
                        <div class="grid-x grid-padding-x">
                            <div class="cell medium-4">
                                <strong>Imiƒô i nazwisko:</strong><br>
                                <span style="font-size: 1.5em; font-weight: bold; color: #1779ba;">
                                <a href="{% url 'bpp:browse_autor' glowny_autor.pk %}" target="_blank"
                                   style="color: inherit; text-decoration: none;">
                                    {% if glowny_autor.imiona %}{{ glowny_autor.imiona }}{% endif %}
                                    {{ glowny_autor.nazwisko|default:"[brak nazwiska]" }}
                                </a>
                            </span><br/>
                                <strong>BPP ID:</strong> {{ glowny_autor.pk }}<br/>
                                <strong>ORCID:</strong>
                                {% if glowny_autor.orcid %}
                                    <a href="https://orcid.org/{{ glowny_autor.orcid }}"
                                       target="_blank">{{ glowny_autor.orcid }}</a>
                                {% else %}
                                    brak
                                {% endif %}
                                {% if glowny_autor.pbn_uid_id %}
                                    <br><strong>PBN:</strong> <a href="{{ glowny_autor.link_do_pbn }}"
                                                                 target="_blank">{{ glowny_autor.pbn_uid_id }}</a><br/>
                                    <strong>{{ glowny_autor.pbn_uid.x.pbn_uid.currentEmploymentsInstitutionDisplayName }}</strong>
                                {% endif %}
                            </div>
                            <div class="cell medium-4">
                                <strong>Tytu≈Ç naukowy:</strong> {{ glowny_autor.tytul|default:"brak" }}<br/>
                                <strong>Liczba publikacji:</strong><br>
                                <span style="font-size: 1.3em; font-weight: bold; color: #2ba6cb; background-color: #e7f4fd; padding: 5px 10px; border-radius: 5px; display: inline-block;">
                                {{ glowne_publikacje_count|default:0 }} publikacji
                            </span>
                            </div>
                            <div class="cell medium-4">
                                <!-- Navigation moved to header -->
                            </div>
                        </div>

                        <h4>Dyscypliny g≈Ç√≥wnego autora (2022-2025):</h4>
                        <div style="margin-bottom: 15px;">
                            <table style="width: 100%; border: 1px solid #e1e1e1;">
                                <thead style="background-color: #f4f4f4;">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Rok</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Dyscyplina</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">%</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Subdyscyplina</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">%</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Rodzaj</th>
                                        <th style="padding: 8px; border: 1px solid #e1e1e1;">Etat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dyscyplina in glowny_autor_dyscypliny %}
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.rok }}</td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1;">{{ dyscyplina.dyscyplina_naukowa }}</td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">
                                                {% if dyscyplina.procent_dyscypliny %}{{ dyscyplina.procent_dyscypliny }}%{% else %}-{% endif %}
                                            </td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1;">
                                                {% if dyscyplina.subdyscyplina_naukowa %}{{ dyscyplina.subdyscyplina_naukowa }}{% else %}-{% endif %}
                                            </td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">
                                                {% if dyscyplina.procent_subdyscypliny %}{{ dyscyplina.procent_subdyscypliny }}%{% else %}-{% endif %}
                                            </td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.get_rodzaj_autora_display|default:"-" }}</td>
                                            <td style="padding: 8px; border: 1px solid #e1e1e1; text-align: center;">
                                                {% if dyscyplina.wymiar_etatu %}{{ dyscyplina.wymiar_etatu }}{% else %}-{% endif %}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" style="padding: 8px; border: 1px solid #e1e1e1; text-align: center; color: #999;">
                                                Brak przypisanych dyscyplin dla lat 2022-2025
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if glowne_publikacje %}
                            <h4>Publikacje g≈Ç√≥wnego autora:{% if glowne_publikacje_year_range %}
                                <small style="color: #666;">({{ glowne_publikacje_year_range }})</small>{% endif %}</h4>
                            <div class="publikacje-lista"
                                 style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e1e1; padding: 10px;">
                                {% for publikacja in glowne_publikacje %}
                                    <div class="publikacja-item"
                                         style="margin-bottom: 8px; padding: 5px; border-left: 3px solid #1779ba;">
                                        <small><strong>
                                            <a href="{% url 'bpp:browse_praca_old' publikacja.content_type.model publikacja.pk.1 %}"
                                               target="_blank" style="color: #1779ba; text-decoration: none;">
                                                {{ publikacja.tytul_oryginalny }}
                                            </a>
                                            {% if publikacja.rok %}
                                                <span style="color: #666; font-weight: normal;"> ({{ publikacja.rok }})</span>{% endif %}
                                        </strong></small><br>
                                        <small>{{ publikacja.opis_bibliograficzny_cache|truncatewords:20 }}</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="grid-x grid-padding-x align-middle" style="margin-bottom: 15px;">
                        <div class="cell auto">
                            <h3 style="margin: 0;">Mo≈ºliwe duplikaty ({{ duplikaty_z_publikacjami|length }})</h3>
                        </div>
                        {% if duplikaty_z_publikacjami|length > 0 %}
                        <div class="cell shrink">
                            <div id="merge-all-progress" style="display: none; margin-right: 15px;">
                                <span class="label warning">
                                    <span class="fi-loop" style="animation: spin 1s linear infinite;"></span>
                                    Scalanie... <span id="merge-progress-text">0/0</span> duplikat√≥w
                                </span>
                            </div>
                        </div>
                        <div class="cell shrink">
                            <div class="button-group">
                                <button type="button"
                                        id="merge-all-btn"
                                        class="button small success"
                                        onclick="return confirmMergeAll(false);">
                                    Scal wszystkie automatycznie
                                </button>
                                <button type="button"
                                        id="merge-all-no-pbn-btn"
                                        class="button small warning"
                                        onclick="return confirmMergeAll(true);">
                                    Scal wszystkie, nie wysy≈Çaj do PBN
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% for duplikat_data in duplikaty_z_publikacjami %}
                        <div id="duplicate-card-{{ duplikat_data.autor.pk }}" class="callout {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}"
                             style="margin-bottom: 20px;">
                            <div class="grid-x grid-padding-x">
                                <div class="cell medium-8">
                                    <div style="margin-bottom: 10px;">
                                    <span style="font-size: 1.4em; font-weight: bold; color: #333;">
                                        <a href="{% url 'bpp:browse_autor' duplikat_data.autor.pk %}" target="_blank"
                                           style="color: inherit; text-decoration: none;">
                                            {% if duplikat_data.autor.imiona %}
                                                {{ duplikat_data.autor.imiona }}{% endif %}
                                            {{ duplikat_data.autor.nazwisko|default:"[brak nazwiska]" }}
                                        </a>
                                    </span><br>
                                        <span class="label {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}">
                                        Pewno≈õƒá: {{ duplikat_data.analiza.pewnosc }}%
                                    </span>
                                    </div>

                                    <div class="grid-x grid-padding-x">
                                        <div class="cell medium-6">
                                            <strong>Tytu≈Ç naukowy:</strong>
                                            {{ duplikat_data.autor.tytul|default:"brak" }}
                                        </div>
                                        <div class="cell medium-6">
                                            <strong>BPP ID:</strong> {{ duplikat_data.autor.pk }}<br/>
                                            <strong>ORCID:</strong>
                                            {% if duplikat_data.autor.orcid %}
                                                <a href="https://orcid.org/{{ duplikat_data.autor.orcid }}"
                                                   target="_blank">{{ duplikat_data.autor.orcid }}</a>
                                            {% else %}
                                                brak
                                            {% endif %}
                                            {% if duplikat_data.autor.pbn_uid_id %}
                                                <br><strong>PBN:</strong>
                                                <a href="{{ duplikat_data.autor.link_do_pbn }}"
                                                   target="_blank">{{ duplikat_data.autor.pbn_uid_id }}</a>
                                            {% endif %}
                                        </div>
                                        <div class="cell medium-12">
                                            <strong>Liczba publikacji:</strong><br>
                                            <span style="font-size: 1.2em; font-weight: bold; color: #5e5e5e; background-color: #f4f4f4; padding: 3px 8px; border-radius: 3px; display: inline-block;">
                                            {{ duplikat_data.publikacje_count|default:0 }} publikacji
                                        </span>
                                        </div>
                                    </div>

                                    <div style="margin-top: 10px;">
                                        <h5>Powody podobie≈Ñstwa:</h5>
                                        <ul>
                                            {% for powod in duplikat_data.analiza.powody_podobienstwa %}
                                                <li>{{ powod }}</li>
                                                {% empty %}
                                                <li>Brak szczeg√≥≈Çowych powod√≥w</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="cell medium-4 text-right">
                                    <div class="button-group stacked">
                                        <button type="button"
                                                id="merge-with-disc-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small success"
                                                onclick="return confirmMergeWithDiscipline({{ glowny_autor.pk }}, {{ duplikat_data.autor.pk }}, {% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% else %}null{% endif %});"
                                                style="width: 100%;">
                                            <span class="button-text">Scal + ustaw dyscyplinƒô</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop" style="animation: spin 1s linear infinite;"></i> Scalanie...
                                            </span>
                                        </button>
                                        <button type="button"
                                                id="merge-with-subdisc-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small success"
                                                onclick="return confirmMergeWithSubdiscipline({{ glowny_autor.pk }}, {{ duplikat_data.autor.pk }}, {% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% else %}null{% endif %});"
                                                style="width: 100%;">
                                            <span class="button-text">Scal + ustaw subdyscyplinƒô</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop" style="animation: spin 1s linear infinite;"></i> Scalanie...
                                            </span>
                                        </button>
                                        <button type="button"
                                                id="merge-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small primary"
                                                onclick="return confirmMerge({{ glowny_autor.pk }}, {{ duplikat_data.autor.pk }}, {% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% else %}null{% endif %});"
                                                style="width: 100%;">
                                            <span class="button-text">Scal bez zmian dyscyplin</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop" style="animation: spin 1s linear infinite;"></i> Scalanie...
                                            </span>
                                        </button>
                                        <button type="button"
                                                id="merge-no-pbn-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small warning"
                                                onclick="return confirmMergeNoPBN({{ glowny_autor.pk }}, {{ duplikat_data.autor.pk }}, {% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% else %}null{% endif %});"
                                                style="width: 100%;">
                                            <span class="button-text">Scal, nie wysy≈Çaj do PBN</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop" style="animation: spin 1s linear infinite;"></i> Scalanie...
                                            </span>
                                        </button>
                                        <a href="#"
                                           onclick="openEditCiagle({{ duplikat_data.autor.pk }}); return false;"
                                           class="button small secondary"
                                           style="width: 100%;">
                                            <span class="fi-pencil"></span> Poka≈º wyd. ciƒÖg≈Çe
                                        </a>
                                        <a href="#"
                                           onclick="openEditZwarte({{ duplikat_data.autor.pk }}); return false;"
                                           class="button small secondary"
                                           style="width: 100%;">
                                            <span class="fi-pencil"></span> Poka≈º wyd. zwarte
                                        </a>
                                        {% if duplikat_data.candidate_id %}
                                        <form method="post" action="{% url 'deduplikator_autorow:mark_candidate_not_duplicate' %}"
                                              style="display: block; width: 100%;">
                                            {% csrf_token %}
                                            <input type="hidden" name="candidate_id"
                                                   value="{{ duplikat_data.candidate_id }}">
                                            <button type="submit" class="button small alert" style="width: 100%;">
                                                Nie sƒÖ duplikatami
                                            </button>
                                        </form>
                                        {% else %}
                                        <form method="post" action="{% url 'deduplikator_autorow:mark_non_duplicate' %}"
                                              style="display: block; width: 100%;">
                                            {% csrf_token %}
                                            <input type="hidden" name="scientist_pk"
                                                   value="{{ duplikat_data.autor.pk }}">
                                            <button type="submit" class="button small alert" style="width: 100%;">
                                                Nie sƒÖ duplikatami
                                            </button>
                                        </form>
                                        {% endif %}
                                        {% if duplikat_data.publikacje_count == 0 %}
                                            <button class="button small alert"
                                                    onclick="return confirmDelete({{ duplikat_data.autor.pk }});"
                                                    style="width: 100%;">Usu≈Ñ autora (brak publikacji)
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <h5 style="margin-top: 15px;">Dyscypliny duplikatu (2022-2025):</h5>
                            <div style="margin-bottom: 10px;">
                                <table style="width: 100%; border: 1px solid #e1e1e1; font-size: 0.9em;">
                                    <thead style="background-color: #f9f9f9;">
                                        <tr>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Rok</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Dyscyplina</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">%</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Subdyscyplina</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">%</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Rodzaj</th>
                                            <th style="padding: 6px; border: 1px solid #e1e1e1;">Etat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dyscyplina in duplikat_data.dyscypliny %}
                                            <tr {% if dyscyplina.dyscyplina_naukowa != glowny_autor_dyscypliny.0.dyscyplina_naukowa %}style="background-color: #fff3cd;"{% endif %}>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.rok }}</td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1;">{{ dyscyplina.dyscyplina_naukowa }}</td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">
                                                    {% if dyscyplina.procent_dyscypliny %}{{ dyscyplina.procent_dyscypliny }}%{% else %}-{% endif %}
                                                </td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1;">
                                                    {% if dyscyplina.subdyscyplina_naukowa %}{{ dyscyplina.subdyscyplina_naukowa }}{% else %}-{% endif %}
                                                </td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">
                                                    {% if dyscyplina.procent_subdyscypliny %}{{ dyscyplina.procent_subdyscypliny }}%{% else %}-{% endif %}
                                                </td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">{{ dyscyplina.get_rodzaj_autora_display|default:"-" }}</td>
                                                <td style="padding: 6px; border: 1px solid #e1e1e1; text-align: center;">
                                                    {% if dyscyplina.wymiar_etatu %}{{ dyscyplina.wymiar_etatu }}{% else %}-{% endif %}
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="7" style="padding: 6px; border: 1px solid #e1e1e1; text-align: center; color: #999;">
                                                    Brak przypisanych dyscyplin dla lat 2022-2025
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            {% if duplikat_data.publikacje %}
                                <h5 style="margin-top: 15px;">Publikacje duplikatu:
                                    {% if duplikat_data.publikacje_year_range %}
                                        <small style="color: #666;">({{ duplikat_data.publikacje_year_range }})</small>{% endif %}
                                </h5>
                                <div class="publikacje-lista"
                                     style="max-height: 250px; overflow-y: auto; border: 1px solid #e1e1e1; padding: 10px; background-color: #f9f9f9;">
                                    {% for publikacja in duplikat_data.publikacje %}
                                        <div class="publikacja-item"
                                             style="margin-bottom: 6px; padding: 3px; border-left: 2px solid #8a8a8a;">
                                            <small><strong>
                                                <a href="{% url 'bpp:browse_praca' publikacja.pk.0 publikacja.pk.1 %}"
                                                   target="_blank" style="color: #333; text-decoration: none;">
                                                    {{ publikacja.tytul_oryginalny }}
                                                </a>
                                                {% if publikacja.rok %}
                                                    <span style="color: #666; font-weight: normal;"> ({{ publikacja.rok }})</span>{% endif %}
                                            </strong></small><br>
                                            <small style="color: #666;">
                                                {{ publikacja.opis_bibliograficzny_cache|truncatewords:15 }}</small>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="callout secondary">
                            <p>Nie znaleziono duplikat√≥w dla tego autora.</p>
                        </div>
                    {% endfor %}

                {% else %}
                    <div class="callout alert">
                        <p><strong>B≈ÇƒÖd:</strong> Nie mo≈ºna pobraƒá danych g≈Ç√≥wnego autora.</p>
                    </div>
                {% endif %}
            {% endif %}

        </div>
    </div>

    <script>
        // Move messages from base placeholder to local placeholder to respect sidebar layout
        function relocateMessages() {
            const baseMessages = document.getElementById('messagesPlaceholder');
            const localMessages = document.getElementById('localMessagesPlaceholder');

            if (baseMessages && localMessages) {
                // Move all children from base to local placeholder
                while (baseMessages.firstChild) {
                    localMessages.appendChild(baseMessages.firstChild);
                }

                // Also listen for any new messages that might be added dynamically
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes.length > 0) {
                            // Move new messages to local placeholder
                            while (baseMessages.firstChild) {
                                localMessages.appendChild(baseMessages.firstChild);
                            }
                        }
                    });
                });

                // Observe the base placeholder for new messages
                observer.observe(baseMessages, { childList: true });
            }
        }

        // Adjust sidebar position and height
        function adjustSidebarPosition() {
            const sidebar = document.querySelector('.left-menu-sidebar');
            const breadcrumbs = document.getElementById('breadcrumbs-wrapper');
            const footer = document.querySelector('.grid-container-fluid[style*="z-index: 10"]') ||
                          document.querySelector('.grid-container-fluid[style*="background-color: #f8f8f8"]');

            if (sidebar && breadcrumbs) {
                // Get breadcrumbs exact bottom position (including its border)
                const breadcrumbsRect = breadcrumbs.getBoundingClientRect();
                const breadcrumbsStyles = window.getComputedStyle(breadcrumbs);
                const breadcrumbsBorder = parseFloat(breadcrumbsStyles.borderBottomWidth) || 0;
                const topPosition = breadcrumbsRect.bottom; // This already includes the border

                // Set sidebar top position to align exactly with breadcrumbs bottom
                sidebar.style.top = topPosition + 'px';

                // Calculate height to stop before footer
                let sidebarHeight;
                if (footer) {
                    const footerRect = footer.getBoundingClientRect();

                    // If footer is visible in viewport, adjust height to stop at footer
                    if (footerRect.top < window.innerHeight) {
                        // Calculate exact height to stop just before footer
                        sidebarHeight = footerRect.top - topPosition - 10; // 10px gap before footer

                        // If the calculated height is too small, set minimum height
                        if (sidebarHeight < 300) {
                            sidebarHeight = 300;
                        }
                    } else {
                        // Footer not in viewport, use full viewport height
                        sidebarHeight = window.innerHeight - topPosition;
                    }
                } else {
                    // No footer found, use full viewport height
                    sidebarHeight = window.innerHeight - topPosition ;
                }

                // Apply the calculated height
                sidebar.style.height = sidebarHeight + 'px';

                // Keep z-index at 0 so sidebar remains visible but behind other elements
                sidebar.style.zIndex = '0';
            }
        }

        // Adjust on page load
        document.addEventListener('DOMContentLoaded', function() {
            adjustSidebarPosition();
            relocateMessages(); // Move messages to respect sidebar layout
        });

        // Adjust on window resize and scroll
        window.addEventListener('resize', adjustSidebarPosition);
        window.addEventListener('scroll', adjustSidebarPosition);

        // Adjust after Foundation initializes
        $(document).ready(function() {
            setTimeout(adjustSidebarPosition, 100);
            // Also relocate any messages that might have been added after DOM ready
            relocateMessages();
        });

        // Add CSS for spinner animation
        var style = document.createElement('style');
        style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);

        function executeMerge(mainAuthorId, duplicateAuthorId, candidateId, skipPbn, autoAssignDiscipline, useSubdiscipline, buttonId) {
            // Get button and card elements
            var button = document.getElementById(buttonId);
            var card = document.getElementById('duplicate-card-' + duplicateAuthorId);

            // Show spinner, disable button
            if (button) {
                button.disabled = true;
                button.querySelector('.button-text').style.display = 'none';
                button.querySelector('.spinner').style.display = 'inline';
            }

            // Build request data
            var requestData = {
                'main_scientist_id': mainAuthorId,
                'duplicate_scientist_id': duplicateAuthorId
            };
            if (candidateId) {
                requestData['candidate_id'] = candidateId;
            }
            if (skipPbn) {
                requestData['skip_pbn'] = 'true';
            }
            if (autoAssignDiscipline) {
                requestData['auto_assign_discipline'] = 'true';
            }
            if (useSubdiscipline) {
                requestData['use_subdiscipline'] = 'true';
            }

            // Make AJAX call
            $.ajax({
                url: '{% url "deduplikator_autorow:scal_autorow" %}',
                type: 'GET',
                dataType: 'json',
                data: requestData,
                complete: function(xhr, status) {
                    console.log('AJAX complete, status:', status, 'xhr:', xhr);

                    var response = null;
                    try {
                        response = xhr.responseJSON || JSON.parse(xhr.responseText);
                    } catch(e) {
                        console.log('Failed to parse response:', e);
                    }

                    console.log('Parsed response:', response);

                    if (response && response.success === true) {
                        // Success - fade out the card
                        console.log('Merge successful (success === true), fading out card');
                        if (card) {
                            $(card).fadeOut(600, function() {
                                $(this).remove();

                                var countElement = document.querySelector('h3');
                                if (countElement && countElement.textContent.includes('Mo≈ºliwe duplikaty')) {
                                    var currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
                                    var newCount = currentCount - 1;
                                    countElement.textContent = 'Mo≈ºliwe duplikaty (' + newCount + ')';

                                    if (newCount === 0) {
                                        setTimeout(function() {
                                            window.location.reload();
                                        }, 500);
                                    }
                                }
                            });
                        }

                        // Show success message with details
                        if (bppNotifications && bppNotifications.addMessage) {
                            var message = 'Autorzy zostali pomy≈õlnie scaleni';
                            if (response.result) {
                                if (response.result.total_updated) {
                                    message += '\n‚Ä¢ ' + response.result.total_updated + ' publikacji przeniesionych';
                                }
                                if (response.result.disciplines_transferred && response.result.disciplines_transferred.length > 0) {
                                    message += '\n‚Ä¢ ' + response.result.disciplines_transferred.length + ' dyscyplin przeniesionych';
                                }
                                if (response.result.warnings && response.result.warnings.length > 0) {
                                    message += '\n‚Ä¢ ' + response.result.warnings.length + ' ostrze≈ºe≈Ñ';
                                }
                            }
                            bppNotifications.addMessage({
                                cssClass: 'success',
                                text: message,
                                sound: false
                            });
                        }
                    } else {
                        // Error from server
                        console.log('Merge failed, response:', response);

                        var errorMessage = 'B≈ÇƒÖd podczas scalania autor√≥w:\n\n';

                        if (!response) {
                            errorMessage += 'Brak odpowiedzi z serwera.';
                        } else if (response.success === false) {
                            if (response.error) {
                                errorMessage += response.error;
                            } else if (response.result && response.result.error) {
                                errorMessage += response.result.error;
                            } else {
                                errorMessage += 'Operacja nie powiod≈Ça siƒô (success: false). Sprawd≈∫ logi serwera.';
                            }
                        } else if (response.error) {
                            errorMessage += response.error;
                        } else {
                            errorMessage += 'Nieoczekiwana odpowied≈∫ serwera: ' + JSON.stringify(response);
                        }

                        if (card) {
                            var existingError = card.querySelector('.merge-error-alert');
                            if (existingError) {
                                existingError.remove();
                            }

                            var errorDiv = document.createElement('div');
                            errorDiv.className = 'callout alert merge-error-alert';
                            errorDiv.style.marginTop = '15px';
                            errorDiv.innerHTML = '<h5 style="margin-bottom: 10px;">B≈ÇƒÖd scalania</h5>' +
                                                '<p style="margin-bottom: 0;">' +
                                                errorMessage.replace(/\n/g, '<br>') +
                                                '</p>';

                            var mainDiv = card.querySelector('.grid-x');
                            if (mainDiv) {
                                mainDiv.parentNode.insertBefore(errorDiv, mainDiv.nextSibling);
                            } else {
                                card.appendChild(errorDiv);
                            }

                            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }

                        if (bppNotifications && bppNotifications.addMessage) {
                            bppNotifications.addMessage({
                                cssClass: 'alert',
                                text: errorMessage.replace(/\n/g, ' '),
                                sound: true
                            });
                        }

                        if (button) {
                            button.disabled = false;
                            button.querySelector('.button-text').style.display = 'inline';
                            button.querySelector('.spinner').style.display = 'none';
                        }
                    }
                }
            });

            return false;
        }

        function confirmMerge(mainAuthorId, duplicateAuthorId, candidateId) {
            if (!confirm('Czy jeste≈õ pewny/a? W ten spos√≥b przypiszesz wszystkie publikacje potencjalnego duplikatu autorowi g≈Ç√≥wnemu, domy≈õlnie z g≈Ç√≥wnƒÖ dyscyplinƒÖ. Zostanie zlecona te≈º wysy≈Çka tych prac do PBN w tle. Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
                return false;
            }
            return executeMerge(mainAuthorId, duplicateAuthorId, candidateId, false, false, false,
                'merge-btn-' + duplicateAuthorId);
        }

        function confirmMergeWithDiscipline(mainAuthorId, duplicateAuthorId, candidateId) {
            if (!confirm('Czy jeste≈õ pewny/a? Scalisz autor√≥w i przypisz g≈Ç√≥wnƒÖ dyscyplinƒô autora g≈Ç√≥wnego do prac bez dyscypliny. Zostanie zlecona wysy≈Çka do PBN.')) {
                return false;
            }
            return executeMerge(mainAuthorId, duplicateAuthorId, candidateId, false, true, false,
                'merge-with-disc-btn-' + duplicateAuthorId);
        }

        function confirmMergeWithSubdiscipline(mainAuthorId, duplicateAuthorId, candidateId) {
            if (!confirm('Czy jeste≈õ pewny/a? Scalisz autor√≥w i przypisz subdyscyplinƒô autora g≈Ç√≥wnego jako dyscyplinƒô dla prac bez dyscypliny. Zostanie zlecona wysy≈Çka do PBN.')) {
                return false;
            }
            return executeMerge(mainAuthorId, duplicateAuthorId, candidateId, false, false, true,
                'merge-with-subdisc-btn-' + duplicateAuthorId);
        }

        function openEditCiagle(autorId) {
            var baseQuery = encodeURIComponent('rok >= 2022 and rok <= 2025 and autorzy_set.autor.id = ' + autorId);
            window.open('/admin/bpp/wydawnictwo_ciagle/?q-l=on&q=' + baseQuery, '_blank');
        }

        function openEditZwarte(autorId) {
            var baseQuery = encodeURIComponent('rok >= 2022 and rok <= 2025 and autorzy_set.autor.id = ' + autorId);
            window.open('/admin/bpp/wydawnictwo_zwarte/?q-l=on&q=' + baseQuery, '_blank');
        }

        function confirmMergeNoPBN(mainAuthorId, duplicateAuthorId, candidateId) {
            if (!confirm('Czy jeste≈õ pewny/a? W ten spos√≥b przypiszesz wszystkie publikacje potencjalnego duplikatu autorowi g≈Ç√≥wnemu, domy≈õlnie z g≈Ç√≥wnƒÖ dyscyplinƒÖ. Publikacje NIE zostanƒÖ wys≈Çane do PBN. Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
                return false;
            }
            return executeMerge(mainAuthorId, duplicateAuthorId, candidateId, true, false, false,
                'merge-no-pbn-btn-' + duplicateAuthorId);
        }

        function confirmDelete(authorId) {
            if (confirm('Czy na pewno chcesz usunƒÖƒá tego autora? Ta operacja jest nieodwracalna. Ta operacja NIE USUWA ' +
                'DANYCH AUTORA Z PBN.')) {
                // Create form and submit
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "deduplikator_autorow:delete_author" %}';

                var csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrfmiddlewaretoken';
                csrfToken.value = '{{ csrf_token }}';
                form.appendChild(csrfToken);

                var authorIdInput = document.createElement('input');
                authorIdInput.type = 'hidden';
                authorIdInput.name = 'author_id';
                authorIdInput.value = authorId;
                form.appendChild(authorIdInput);

                document.body.appendChild(form);
                form.submit();
                return true;
            }
            return false;
        }

        function confirmMergeAll(skipPbn) {
            // Collect all duplicate IDs
            var duplicateCards = document.querySelectorAll('[id^="duplicate-card-"]');
            var duplicateIds = [];
            var mainAuthorId = {{ glowny_autor.pk }};

            duplicateCards.forEach(function(card) {
                var id = card.id.replace('duplicate-card-', '');
                duplicateIds.push(id);
            });

            if (duplicateIds.length === 0) {
                alert('Brak duplikat√≥w do scalenia.');
                return false;
            }

            // Confirmation
            var message = skipPbn
                ? 'Czy na pewno chcesz scaliƒá wszystkie ' + duplicateIds.length + ' duplikat√≥w?\n\n' +
                  'Publikacje NIE zostanƒÖ wys≈Çane do PBN.\n\n' +
                  'Operacja zostanie zatrzymana na pierwszym b≈Çƒôdzie.\n\n' +
                  'Tej operacji nie mo≈ºna cofnƒÖƒá.'
                : 'Czy na pewno chcesz scaliƒá wszystkie ' + duplicateIds.length + ' duplikat√≥w?\n\n' +
                  'Publikacje zostanƒÖ wys≈Çane do PBN.\n\n' +
                  'Operacja zostanie zatrzymana na pierwszym b≈Çƒôdzie.\n\n' +
                  'Tej operacji nie mo≈ºna cofnƒÖƒá.';

            if (!confirm(message)) {
                return false;
            }

            // Show progress, disable buttons
            document.getElementById('merge-all-progress').style.display = 'block';
            document.getElementById('merge-all-btn').disabled = true;
            document.getElementById('merge-all-no-pbn-btn').disabled = true;

            // Disable all individual merge buttons too
            duplicateIds.forEach(function(id) {
                var btn1 = document.getElementById('merge-btn-' + id);
                var btn2 = document.getElementById('merge-no-pbn-btn-' + id);
                if (btn1) btn1.disabled = true;
                if (btn2) btn2.disabled = true;
            });

            // Process duplicates sequentially
            var current = 0;
            var total = duplicateIds.length;

            function mergeNext() {
                if (current >= total) {
                    // All done - reload page
                    window.location.reload();
                    return;
                }

                var duplicateId = duplicateIds[current];
                current++;

                // Update progress
                document.getElementById('merge-progress-text').textContent = current + '/' + total;

                // Merge this duplicate
                $.ajax({
                    url: '{% url "deduplikator_autorow:scal_autorow" %}',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        'main_scientist_id': mainAuthorId,
                        'duplicate_scientist_id': duplicateId,
                        'skip_pbn': skipPbn
                    },
                    complete: function(xhr, status) {
                        var response = null;
                        try {
                            response = xhr.responseJSON || JSON.parse(xhr.responseText);
                        } catch(e) {
                            console.log('Failed to parse response:', e);
                        }

                        if (response && response.success === true) {
                            // Success - fade out card
                            var card = document.getElementById('duplicate-card-' + duplicateId);
                            if (card) {
                                $(card).fadeOut(400);
                            }
                            // Continue to next after short delay
                            setTimeout(mergeNext, 500);
                        } else {
                            // Error - stop and show message
                            handleMergeAllError(response, duplicateId);
                        }
                    }
                });
            }

            function handleMergeAllError(response, duplicateId) {
                // Hide progress
                document.getElementById('merge-all-progress').style.display = 'none';

                // Re-enable main buttons
                document.getElementById('merge-all-btn').disabled = false;
                document.getElementById('merge-all-no-pbn-btn').disabled = false;

                // Re-enable individual buttons for remaining duplicates
                for (var i = current; i < total; i++) {
                    var id = duplicateIds[i];
                    var btn1 = document.getElementById('merge-btn-' + id);
                    var btn2 = document.getElementById('merge-no-pbn-btn-' + id);
                    if (btn1) btn1.disabled = false;
                    if (btn2) btn2.disabled = false;
                }

                // Build error message
                var errorMessage = 'B≈ÇƒÖd podczas scalania duplikatu (ID: ' + duplicateId + '):\n\n';
                if (response && response.error) {
                    errorMessage += response.error;
                } else if (response && response.result && response.result.error) {
                    errorMessage += response.result.error;
                } else {
                    errorMessage += 'Nieznany b≈ÇƒÖd. Sprawd≈∫ logi serwera.';
                }

                errorMessage += '\n\nPomy≈õlnie scalono: ' + (current - 1) + ' z ' + total + ' duplikat√≥w.';

                alert(errorMessage);

                // Highlight the problematic card
                var card = document.getElementById('duplicate-card-' + duplicateId);
                if (card) {
                    card.style.border = '3px solid red';
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Show error in notification system if available
                if (bppNotifications && bppNotifications.addMessage) {
                    bppNotifications.addMessage({
                        cssClass: 'alert',
                        text: 'Scalanie automatyczne zatrzymane na b≈Çƒôdzie. Scalono ' + (current - 1) + ' z ' +
                              total + ' duplikat√≥w.',
                        sound: true
                    });
                }
            }

            // Start merging
            mergeNext();

            return false;
        }
    </script>
{% endblock %}
