{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet"
      href="{% static 'deduplikator_autorow/css/deduplikator_autorow.css' %}">
{% endblock %}

{% block title %}Deduplikator Autorów PBN{% endblock %}

{% block breadcrumbs %}
    <li><a href="/">Strona główna</a></li>
    <li><a href="{% url "deduplikator_autorow:duplicate_authors" %}">Deduplikator autorów PBN</a></li>
{% endblock %}

{% block content %}
    <div id="left-menu-container">
        <!-- Left Sidebar Menu -->
        <div class="left-menu-sidebar">
            <div class="left-menu-menu">
                <ul class="accordion deduplikator-autorow__accordion" data-accordion data-allow-all-closed="true" data-multi-expand="true" role="region" aria-label="Panel boczny z opcjami">
                    <!-- Status skanowania duplikatów -->
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title deduplikator-autorow__accordion-title" href="#" aria-expanded="true">
                            <span class="fi-magnifying-glass" aria-hidden="true"></span> Skanowanie duplikatów
                        </a>
                        <div class="accordion-content deduplikator-autorow__accordion-content" data-tab-content>
                            {% if running_scan %}
                                <div id="scan-progress-container">
                                    <p class="deduplikator-autorow__status-text">
                                        <strong>Status:</strong>
                                        <span class="deduplikator-autorow__status-running"><span class="fi-loop"></span> {{ running_scan.get_status_display }}</span>
                                    </p>
                                    <div class="deduplikator-autorow__progress-container">
                                        <div id="scan-progress-bar"
                                             class="deduplikator-autorow__progress-bar"
                                             style="width: {{ running_scan.progress_percent }}%;">
                                        </div>
                                    </div>
                                    <p id="scan-progress-text" class="deduplikator-autorow__status-text--spaced">
                                        {{ running_scan.progress_percent }}% ({{ running_scan.authors_scanned }}/{{ running_scan.total_authors_to_scan }} autorów)
                                    </p>
                                    <p id="scan-duplicates-text" class="deduplikator-autorow__status-text--spaced">
                                        Znaleziono duplikatów: {{ running_scan.duplicates_found }}
                                    </p>
                                    <p id="scan-eta-text" class="deduplikator-autorow__status-text--muted">
                                        <span class="fi-clock"></span> ETA: obliczanie...
                                    </p>
                                    <form method="post" action="{% url 'deduplikator_autorow:cancel_scan' %}" class="deduplikator-autorow__form">
                                        {% csrf_token %}
                                        <button type="submit" class="button alert expanded small"
                                                data-confirm="Czy na pewno chcesz anulować skanowanie?">
                                            <span class="fi-x"></span> Anuluj skanowanie
                                        </button>
                                    </form>
                                </div>
                                <script>
                                    // Auto-refresh scan progress
                                    (function() {
                                        var scanId = {{ running_scan.pk }};
                                        var refreshInterval = setInterval(function() {
                                            fetch('{% url "deduplikator_autorow:scan_status" running_scan.pk %}')
                                                .then(function(response) { return response.json(); })
                                                .then(function(data) {
                                                    if (data.finished) {
                                                        clearInterval(refreshInterval);
                                                        location.reload();
                                                    } else {
                                                        // Update sidebar progress
                                                        document.getElementById('scan-progress-bar').style.width = data.progress_percent + '%';
                                                        document.getElementById('scan-progress-text').textContent =
                                                            data.progress_percent + '% (' + data.authors_scanned + '/' + data.total_authors_to_scan + ' autorów)';
                                                        document.getElementById('scan-duplicates-text').textContent =
                                                            'Znaleziono duplikatów: ' + data.duplicates_found;
                                                        // Update ETA
                                                        var etaElement = document.getElementById('scan-eta-text');
                                                        if (etaElement && data.eta_seconds !== null) {
                                                            var etaMinutes = Math.floor(data.eta_seconds / 60);
                                                            var etaSecondsRest = data.eta_seconds % 60;
                                                            var etaStr = '';
                                                            if (etaMinutes > 0) {
                                                                etaStr = etaMinutes + ' min ' + etaSecondsRest + ' s';
                                                            } else {
                                                                etaStr = etaSecondsRest + ' s';
                                                            }
                                                            etaElement.innerHTML = '<span class="fi-clock"></span> Pozostało: ~' + etaStr + ' (zakończenie ok. ' + data.eta_time + ')';
                                                        } else if (etaElement) {
                                                            etaElement.innerHTML = '<span class="fi-clock"></span> ETA: obliczanie...';
                                                        }
                                                        // Update main content progress (if exists)
                                                        var mainBar = document.getElementById('main-scan-progress-bar');
                                                        var mainText = document.getElementById('main-scan-progress-text');
                                                        if (mainBar) {
                                                            mainBar.style.width = data.progress_percent + '%';
                                                        }
                                                        if (mainText) {
                                                            mainText.textContent = data.progress_percent + '% (' + data.authors_scanned + '/' + data.total_authors_to_scan + ' autorów)';
                                                        }
                                                        // Update main ETA
                                                        var mainEtaElement = document.getElementById('main-scan-eta-text');
                                                        if (mainEtaElement && data.eta_seconds !== null) {
                                                            var etaMinutes = Math.floor(data.eta_seconds / 60);
                                                            var etaSecondsRest = data.eta_seconds % 60;
                                                            var etaStr = '';
                                                            if (etaMinutes > 0) {
                                                                etaStr = etaMinutes + ' min ' + etaSecondsRest + ' s';
                                                            } else {
                                                                etaStr = etaSecondsRest + ' s';
                                                            }
                                                            mainEtaElement.innerHTML = '<span class="fi-clock"></span> Pozostało: ~' + etaStr + ' (zakończenie ok. ' + data.eta_time + ')';
                                                        } else if (mainEtaElement) {
                                                            mainEtaElement.innerHTML = '<span class="fi-clock"></span> ETA: obliczanie...';
                                                        }
                                                    }
                                                })
                                                .catch(function(err) {
                                                    console.error('Error fetching scan status:', err);
                                                });
                                        }, 3000);  // Refresh every 3 seconds
                                    })();
                                </script>
                            {% elif completed_scan %}
                                <p class="deduplikator-autorow__status-text">
                                    <strong>Ostatnie skanowanie:</strong><br>
                                    {{ completed_scan.finished_at|date:"d.m.Y H:i" }}
                                </p>
                                <p class="deduplikator-autorow__status-text">
                                    <strong>Status:</strong>
                                    <span class="deduplikator-autorow__status-completed"><span class="fi-check"></span> {{ completed_scan.get_status_display }}</span>
                                </p>
                                <p class="deduplikator-autorow__status-text--spaced">
                                    <strong>Znaleziono:</strong> {{ completed_scan.duplicates_found }} duplikatów<br>
                                    <strong>Do sprawdzenia:</strong> {{ pending_candidates_count }}
                                </p>
                                <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}" class="deduplikator-autorow__form">
                                    {% csrf_token %}
                                    <button type="submit" class="button primary expanded small"
                                            data-confirm="Czy na pewno chcesz uruchomić nowe skanowanie? Poprzednie wyniki zostaną zastąpione.">
                                        <span class="fi-refresh"></span> Uruchom nowe skanowanie
                                    </button>
                                </form>
                            {% else %}
                                <p class="deduplikator-autorow__status-text--muted">
                                    Brak wyników skanowania. Uruchom skanowanie, aby znaleźć duplikaty autorów.
                                </p>
                                <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}" class="deduplikator-autorow__form">
                                    {% csrf_token %}
                                    <button type="submit" class="button primary expanded small">
                                        <span class="fi-magnifying-glass"></span> Uruchom skanowanie
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </li>

                    {% if pending_candidates_count %}
                    <!-- Liczba autorów z duplikatami -->
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title deduplikator-autorow__accordion-title" href="#" aria-expanded="true">
                            <span class="fi-torsos-all" aria-hidden="true"></span> {{ pending_candidates_count }} duplikat{% if pending_candidates_count != 1 %}ów{% endif %} do sprawdzenia
                        </a>
                        <div class="accordion-content deduplikator-autorow__accordion-content--hidden" data-tab-content></div>
                    </li>
                    {% endif %}

                    <!-- PBN Download Info -->
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title deduplikator-autorow__accordion-title" href="#">
                            <span class="fi-download" aria-hidden="true"></span> Dane PBN
                        </a>
                        <div class="accordion-content deduplikator-autorow__accordion-content" data-tab-content>
                            {% if latest_pbn_download %}
                                <p class="deduplikator-autorow__status-text">
                                    <strong>Ostatnie pobieranie:</strong><br>
                                    {{ latest_pbn_download.started_at|date:"d.m.Y H:i" }}
                                </p>
                                <p class="deduplikator-autorow__status-text">
                                    <strong>Status:</strong>
                                    {% if latest_pbn_download.status == 'completed' %}
                                        <span class="deduplikator-autorow__status-completed"><span class="fi-check"></span> Zakończone</span>
                                    {% elif latest_pbn_download.status == 'running' %}
                                        <span class="deduplikator-autorow__status-running"><span class="fi-loop"></span> W trakcie</span>
                                    {% else %}
                                        <span class="deduplikator-autorow__status-error"><span class="fi-x"></span> Błąd</span>
                                    {% endif %}
                                </p>
                                {% if latest_pbn_download.completed_at %}
                                    <p class="deduplikator-autorow__status-text--spaced">
                                        <strong>Zakończone:</strong><br>
                                        {{ latest_pbn_download.completed_at|date:"d.m.Y H:i" }}
                                    </p>
                                {% endif %}
                            {% else %}
                                <p class="deduplikator-autorow__status-text--muted">
                                    Brak informacji o pobraniu danych z PBN
                                </p>
                            {% endif %}
                            <a href="{% url 'pbn_downloader_app:main' %}"
                               class="button primary expanded small"
                               target="_blank">
                                <span class="fi-refresh"></span> Pobierz dane z PBN
                            </a>
                        </div>
                    </li>

                    <!-- Zacznij od początku -->
                    {% if has_skipped_authors and not search_lastname %}
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title deduplikator-autorow__accordion-title" href="#" aria-expanded="true">
                            <span class="fi-loop" aria-hidden="true"></span> Nawigacja
                        </a>
                        <div class="accordion-content deduplikator-autorow__accordion-content" data-tab-content>
                            <p class="deduplikator-autorow__status-text--spaced">Prześledzileś już kilku autorów.</p>
                            <a href="{% url 'deduplikator_autorow:reset_skipped_authors' %}"
                               class="button alert expanded small">
                                Zacznij od początku
                            </a>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Wyszukiwanie autora -->
                    <li class="accordion-item {% if search_lastname %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if search_lastname %}aria-expanded="true"{% endif %}>
                            <span class="fi-magnifying-glass" aria-hidden="true"></span> Szukaj autora
                        </a>
                        <div class="accordion-content{% if search_lastname %} deduplikator-autorow__accordion-content{% endif %}" data-tab-content>
                            <form method="get" action="{% url 'deduplikator_autorow:duplicate_authors' %}" class="deduplikator-autorow__form">
                                <label for="search_lastname" class="deduplikator-autorow__label">Po nazwisku:</label>
                                <input type="text" id="search_lastname" name="search_lastname"
                                       value="{{ search_lastname|default:'' }}"
                                       placeholder="Wpisz część nazwiska..."
                                       class="deduplikator-autorow__input">
                                <button type="submit" class="button primary expanded small">
                                    <span class="fi-magnifying-glass"></span> Szukaj
                                </button>
                                {% if search_lastname %}
                                    <a href="{% url 'deduplikator_autorow:duplicate_authors' %}"
                                       class="button secondary expanded small deduplikator-autorow__button--margin-top">
                                        Wyczyść
                                    </a>
                                    <div class="deduplikator-autorow__search-results">
                                        <strong>Szukano:</strong> "{{ search_lastname }}"
                                        {% if search_results_count is not None %}
                                            <br><strong>Znaleziono:</strong> {{ search_results_count }} autor{% if search_results_count != 1 %}ów{% endif %}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </form>
                        </div>
                    </li>

                    <!-- Pobierz XLSX -->
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            <span class="fi-page-export" aria-hidden="true"></span> Pobierz XLSX duplikatów
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p class="deduplikator-autorow__status-text--spaced">Pobierz wszystkich autorów z duplikatami w formacie Excel.</p>
                            <a href="{% url 'deduplikator_autorow:download_duplicates_xlsx' %}"
                               class="button success expanded deduplikator-autorow__button">
                                <span class="fi-download"></span> Pobierz XLSX
                            </a>
                        </div>
                    </li>

                    <!-- Obejrz nie-duplikaty -->
                    <li class="accordion-item {% if not_duplicate_count > 0 %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if not_duplicate_count > 0 %}aria-expanded="true"{% endif %}>
                            <span class="fi-eye" aria-hidden="true"></span> Obejrz nie-duplikaty
                        </a>
                        <div class="accordion-content{% if not_duplicate_count > 0 %} deduplikator-autorow__accordion-content{% endif %}" data-tab-content>
                            <p class="deduplikator-autorow__status-text--spaced">Przejrzyj autorów oznaczonych jako nie będących duplikatami.</p>
                            <a href="/admin/deduplikator_autorow/notaduplicate/"
                               class="button secondary expanded deduplikator-autorow__button"
                               target="_blank">
                                <span class="fi-magnifying-glass"></span> Otwórz listę
                            </a>
                        </div>
                    </li>

                    <!-- Reset nie-duplikatów -->
                    {% if not_duplicate_count > 0 %}
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            <span class="fi-refresh" aria-hidden="true"></span> Zresetuj nie-duplikaty ({{ not_duplicate_count }})
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p class="deduplikator-autorow__status-text--spaced">Wyczyść wszystkie oznaczenia nie-duplikatów.</p>
                            <p class="deduplikator-autorow__status-warning deduplikator-autorow__status-text--spaced">
                                <span class="fi-alert"></span> Obecnie: {{ not_duplicate_count }} oznaczonych
                            </p>
                            <form method="post" action="{% url 'deduplikator_autorow:reset_not_duplicates' %}" class="deduplikator-autorow__form">
                                {% csrf_token %}
                                <button type="submit"
                                        class="button alert expanded deduplikator-autorow__button"
                                        data-confirm="Czy na pewno chcesz zresetować wszystkie oznaczenia nie-duplikatów? Tej operacji nie można cofnąć.">
                                    <span class="fi-trash"></span> Zresetuj wszystkie
                                </button>
                            </form>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Ignorowani autorzy -->
                    <li class="accordion-item {% if ignored_authors_count > 0 %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#">
                            <span class="fi-prohibited" aria-hidden="true"></span> Ignorowani autorzy {% if ignored_authors_count > 0 %}({{ ignored_authors_count }}){% endif %}
                        </a>
                        <div class="accordion-content{% if ignored_authors_count > 0 %} deduplikator-autorow__accordion-content{% endif %}" data-tab-content>
                            <p class="deduplikator-autorow__status-text--spaced">Autorzy pominięci w procesie deduplikacji.</p>
                            {% if ignored_authors_count > 0 %}
                                <p class="deduplikator-autorow__status-warning deduplikator-autorow__status-text--spaced">
                                    <span class="fi-alert"></span> Obecnie: {{ ignored_authors_count }} ignorowanych
                                </p>
                                <a href="/admin/deduplikator_autorow/ignoredauthor/"
                                   class="button secondary expanded small deduplikator-autorow__button-margin-bottom"
                                   target="_blank">
                                    <span class="fi-list"></span> Zobacz listę
                                </a>
                                <form method="post" action="{% url 'deduplikator_autorow:reset_ignored_authors' %}" class="deduplikator-autorow__form">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="button alert expanded small"
                                            data-confirm="Czy na pewno chcesz zresetować wszystkich ignorowanych autorów? Tej operacji nie można cofnąć.">
                                        <span class="fi-trash"></span> Zresetuj ignorowanych
                                    </button>
                                </form>
                            {% else %}
                                <p class="deduplikator-autorow__status-text--muted">Brak ignorowanych autorów.</p>
                            {% endif %}
                        </div>
                    </li>

                    <!-- Historia scaleń -->
                    {% if recent_merges %}
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            <span class="fi-book" aria-hidden="true"></span> Ostatnie scalenia
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <div class="deduplikator-autorow__merge-list">
                                {% for merge in recent_merges %}
                                    <div class="deduplikator-autorow__merge-item">
                                        <div class="deduplikator-autorow__merge-title">
                                            {{ merge.duplicate_autor_str|default:"Duplikat" }}
                                            <span class="fi-arrow-right"></span>
                                            {{ merge.main_autor|default:"Główny" }}
                                        </div>
                                        <div class="deduplikator-autorow__merge-date">
                                            <span class="fi-calendar"></span> {{ merge.created_on|date:"d.m.Y H:i" }}
                                        </div>
                                        <div class="deduplikator-autorow__merge-stats">
                                            <span class="label small {% if merge.operation_type == 'AUTHOR_DELETED' %}success{% elif merge.operation_type == 'DISCIPLINE_TRANSFER' %}primary{% else %}secondary{% endif %}">
                                                {{ merge.get_operation_type_display }}
                                            </span>
                                            {% if merge.publications_transferred > 0 %}
                                                <span class="label small success">{{ merge.publications_transferred }} publikacji</span>
                                            {% endif %}
                                            {% if merge.disciplines_transferred > 0 %}
                                                <span class="label small primary">{{ merge.disciplines_transferred }} dyscyplin</span>
                                            {% endif %}
                                            {% if merge.warnings %}
                                                <span class="label small warning" title="{{ merge.warnings|truncatewords:10 }}">ostrzeżenia</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <a href="/admin/deduplikator_autorow/logscalania/"
                               class="button secondary expanded small deduplikator-autorow__button--margin-top-large"
                               target="_blank">
                                <span class="fi-list"></span> Zobacz wszystkie
                            </a>
                        </div>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content-with-sidebar">
            <!-- Local messages placeholder that respects sidebar layout -->
            <div id="localMessagesPlaceholder" class="deduplikator-autorow__messages"></div>

            {% include "includes/pbn_freshness_warning.html" with custom_message="Analiza duplikatów opiera się na lokalnej kopii danych autorów z PBN. Wyniki mogą być nieaktualne." %}

            <div class="grid-x grid-padding-x align-middle deduplikator-autorow__header">
                <div class="cell auto">
                    <h1>Deduplikator Autorów PBN <span class="label warning deduplikator-autorow__beta-label">BETA</span></h1>
                </div>
                <div class="cell shrink">
                    {% if not search_lastname and scientist %}
                        <div class="button-group">
                            {% if skip_count > 0 %}
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"-1" }}"
                                   class="button secondary"><span class="fi-arrow-left"></span> Poprzedni autor</a>
                            {% endif %}
                            <form method="post" action="{% url 'deduplikator_autorow:ignore_author' %}" class="deduplikator-autorow__form--inline">
                                {% csrf_token %}
                                <input type="hidden" name="scientist_id" value="{{ scientist.pk }}">
                                <input type="hidden" name="reason" value="Pominięty przez użytkownika">
                                <button type="submit"
                                        class="button warning"
                                        data-confirm="Czy na pewno chcesz ignorować tego autora? Nie będzie więcej wyświetlany w deduplikatorze.">
                                    <span class="fi-prohibited"></span> Ignoruj autora
                                </button>
                            </form>
                            <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"1" }}"
                               class="button primary">Następny autor <span class="fi-arrow-right"></span></a>
                        </div>
                    {% elif not search_lastname and glowny_autor %}
                        <div class="button-group">
                            {% if skip_count > 0 %}
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"-1" }}"
                                   class="button secondary"><span class="fi-arrow-left"></span> Poprzedni autor</a>
                            {% endif %}
                            <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_count={{ skip_count|add:"1" }}"
                               class="button primary">Następny autor <span class="fi-arrow-right"></span></a>
                        </div>
                    {% endif %}
                </div>
            </div>


            {% if no_scan_available %}
                <div class="callout primary deduplikator-autorow__callout-centered">
                    <h3><span class="fi-magnifying-glass"></span> Uruchom skanowanie</h3>
                    <p>Przed rozpoczęciem pracy z deduplikatorem, należy uruchomić skanowanie bazy danych w poszukiwaniu duplikatów autorów.</p>
                    <p class="deduplikator-autorow__callout-hint">Skanowanie jest wykonywane w tle i może potrwać kilka minut w zależności od wielkości bazy.</p>
                    <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}">
                        {% csrf_token %}
                        <button type="submit" class="button primary large">
                            <span class="fi-magnifying-glass"></span> Uruchom skanowanie duplikatów
                        </button>
                    </form>
                </div>
            {% elif running_scan and not glowny_autor %}
                <div class="callout secondary deduplikator-autorow__callout-centered">
                    <h3><span class="fi-loop"></span> Skanowanie w toku...</h3>
                    <p>Proszę czekać, skanowanie bazy w poszukiwaniu duplikatów jest w trakcie.</p>
                    <div class="deduplikator-autorow__progress-wrapper">
                        <div id="main-scan-progress-bar"
                             class="deduplikator-autorow__progress-bar deduplikator-autorow__progress-bar--large"
                             style="width: {{ running_scan.progress_percent }}%;">
                        </div>
                    </div>
                    <p id="main-scan-progress-text" class="deduplikator-autorow__status-text--large">
                        {{ running_scan.progress_percent }}% ({{ running_scan.authors_scanned }}/{{ running_scan.total_authors_to_scan }} autorów)
                    </p>
                    <p id="main-scan-eta-text" class="deduplikator-autorow__status-text--medium">
                        <span class="fi-clock"></span> ETA: obliczanie...
                    </p>
                    <p>Strona odświeży się automatycznie po zakończeniu skanowania.</p>
                </div>
            {% elif not glowny_autor %}
                <div class="callout success deduplikator-autorow__callout-centered">
                    <h3><span class="fi-check"></span> Gratulacje!</h3>
                    <p><strong>Wszystkie duplikaty zostały już przetworzone.</strong></p>
                    <p>Brak więcej duplikatów do sprawdzenia. Możesz uruchomić nowe skanowanie, aby sprawdzić czy pojawiły się nowi kandydaci.</p>
                    <form method="post" action="{% url 'deduplikator_autorow:start_scan' %}" class="deduplikator-autorow__callout-margin-top">
                        {% csrf_token %}
                        <button type="submit" class="button primary"
                                data-confirm="Czy na pewno chcesz uruchomić nowe skanowanie?">
                            <span class="fi-refresh"></span> Uruchom nowe skanowanie
                        </button>
                    </form>
                </div>
            {% else %}
                {% if glowny_autor %}
                    <div class="callout primary">
                        <h3>Główny rekord autora</h3>
                        <div class="grid-x grid-padding-x">
                            <div class="cell medium-4">
                                <strong>Imię i nazwisko:</strong><br>
                                <span class="deduplikator-autorow__author-name">
                                <a href="{% url 'bpp:browse_autor' glowny_autor.pk %}" target="_blank"
                                   class="deduplikator-autorow__author-name--link">
                                    {% if glowny_autor.imiona %}{{ glowny_autor.imiona }}{% endif %}
                                    {{ glowny_autor.nazwisko|default:"[brak nazwiska]" }}
                                </a>
                            </span><br/>
                                <strong>BPP ID:</strong> {{ glowny_autor.pk }}<br/>
                                <strong>ORCID:</strong>
                                {% if glowny_autor.orcid %}
                                    <a href="https://orcid.org/{{ glowny_autor.orcid }}"
                                       target="_blank">{{ glowny_autor.orcid }}</a>
                                {% else %}
                                    brak
                                {% endif %}
                                {% if glowny_autor.pbn_uid_id %}
                                    <br><strong>PBN:</strong> <a href="{{ glowny_autor.link_do_pbn }}"
                                                                 target="_blank">{{ glowny_autor.pbn_uid_id }}</a><br/>
                                    <strong>{{ glowny_autor.pbn_uid.x.pbn_uid.currentEmploymentsInstitutionDisplayName }}</strong>
                                {% endif %}
                            </div>
                            <div class="cell medium-4">
                                <strong>Tytuł naukowy:</strong> {{ glowny_autor.tytul|default:"brak" }}<br/>
                                <strong>Liczba publikacji:</strong><br>
                                <span class="deduplikator-autorow__publication-count">
                                {{ glowne_publikacje_count|default:0 }} publikacji
                            </span>
                            </div>
                            <div class="cell medium-4">
                                <!-- Navigation moved to header -->
                            </div>
                        </div>

                        <h4>Dyscypliny głównego autora (2022-2025):</h4>
                        <div class="deduplikator-autorow__discipline-table">
                            <table class="deduplikator-autorow__table">
                                <thead class="deduplikator-autorow__table-head">
                                    <tr>
                                        <th class="deduplikator-autorow__table-cell">Rok</th>
                                        <th class="deduplikator-autorow__table-cell">Dyscyplina</th>
                                        <th class="deduplikator-autorow__table-cell">%</th>
                                        <th class="deduplikator-autorow__table-cell">Subdyscyplina</th>
                                        <th class="deduplikator-autorow__table-cell">%</th>
                                        <th class="deduplikator-autorow__table-cell">Rodzaj</th>
                                        <th class="deduplikator-autorow__table-cell">Etat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dyscyplina in glowny_autor_dyscypliny %}
                                        <tr>
                                            <td class="deduplikator-autorow__table-cell deduplikator-autorow__table-cell--center">{{ dyscyplina.rok }}</td>
                                            <td class="deduplikator-autorow__table-cell">{{ dyscyplina.dyscyplina_naukowa }}</td>
                                            <td class="deduplikator-autorow__table-cell deduplikator-autorow__table-cell--center">
                                                {% if dyscyplina.procent_dyscypliny %}{{ dyscyplina.procent_dyscypliny }}%{% else %}-{% endif %}
                                            </td>
                                            <td class="deduplikator-autorow__table-cell">
                                                {% if dyscyplina.subdyscyplina_naukowa %}{{ dyscyplina.subdyscyplina_naukowa }}{% else %}-{% endif %}
                                            </td>
                                            <td class="deduplikator-autorow__table-cell deduplikator-autorow__table-cell--center">
                                                {% if dyscyplina.procent_subdyscypliny %}{{ dyscyplina.procent_subdyscypliny }}%{% else %}-{% endif %}
                                            </td>
                                            <td class="deduplikator-autorow__table-cell deduplikator-autorow__table-cell--center">{{ dyscyplina.get_rodzaj_autora_display|default:"-" }}</td>
                                            <td class="deduplikator-autorow__table-cell deduplikator-autorow__table-cell--center">
                                                {% if dyscyplina.wymiar_etatu %}{{ dyscyplina.wymiar_etatu }}{% else %}-{% endif %}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" class="deduplikator-autorow__table-cell deduplikator-autorow__table-cell--center deduplikator-autorow__table-cell--muted">
                                                Brak przypisanych dyscyplin dla lat 2022-2025
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if glowne_publikacje %}
                            <h4>Publikacje głównego autora:{% if glowne_publikacje_year_range %}
                                <small class="deduplikator-autorow__year-hint">({{ glowne_publikacje_year_range }})</small>{% endif %}</h4>
                            <div class="deduplikator-autorow__publication-list">
                                {% for publikacja in glowne_publikacje %}
                                    <div class="deduplikator-autorow__publication-item">
                                        <small><strong>
                                            <a href="{% url 'bpp:browse_praca_old' publikacja.content_type.model publikacja.pk.1 %}"
                                               target="_blank" class="deduplikator-autorow__publication-link">
                                                {{ publikacja.tytul_oryginalny }}
                                            </a>
                                            {% if publikacja.rok %}
                                                <span class="deduplikator-autorow__publication-year"> ({{ publikacja.rok }})</span>{% endif %}
                                        </strong></small><br>
                                        <small>{{ publikacja.opis_bibliograficzny_cache|truncatewords:20 }}</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="grid-x grid-padding-x align-middle deduplikator-autorow__duplicates-header">
                        <div class="cell auto">
                            <h3 class="deduplikator-autorow__duplicates-title">Możliwe duplikaty ({{ duplikaty_z_publikacjami|length }})</h3>
                        </div>
                        {% if duplikaty_z_publikacjami|length > 0 %}
                        <div class="cell shrink">
                            <div id="merge-all-progress" class="deduplikator-autorow__merge-progress">
                                <span class="label warning">
                                    <span class="fi-loop deduplikator-autorow__spinner"></span>
                                    Scalanie... <span id="merge-progress-text">0/0</span> duplikatów
                                </span>
                            </div>
                        </div>
                        <div class="cell shrink">
                            <div class="button-group">
                                <button type="button"
                                        id="merge-all-btn"
                                        class="button small success"
                                        data-merge-all="true"
                                        data-skip-pbn="false">
                                    Scal wszystkie automatycznie
                                </button>
                                <button type="button"
                                        id="merge-all-no-pbn-btn"
                                        class="button small warning"
                                        data-merge-all="true"
                                        data-skip-pbn="true">
                                    Scal wszystkie, nie wysyłaj do PBN
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% for duplikat_data in duplikaty_z_publikacjami %}
                        <div id="duplicate-card-{{ duplikat_data.autor.pk }}" class="callout deduplikator-autorow__duplicate-card {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}">
                            <div class="grid-x grid-padding-x">
                                <div class="cell medium-8">
                                    <div class="deduplikator-autorow__duplicate-header">
                                    <span class="deduplikator-autorow__duplicate-name">
                                        <a href="{% url 'bpp:browse_autor' duplikat_data.autor.pk %}" target="_blank"
                                           class="deduplikator-autorow__duplicate-name--link">
                                            {% if duplikat_data.autor.imiona %}
                                                {{ duplikat_data.autor.imiona }}{% endif %}
                                            {{ duplikat_data.autor.nazwisko|default:"[brak nazwiska]" }}
                                        </a>
                                    </span><br>
                                        <span class="label {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}">
                                        Pewność: {{ duplikat_data.analiza.pewnosc }}%
                                    </span>
                                    </div>

                                    <div class="grid-x grid-padding-x">
                                        <div class="cell medium-6">
                                            <strong>Tytuł naukowy:</strong>
                                            {{ duplikat_data.autor.tytul|default:"brak" }}
                                        </div>
                                        <div class="cell medium-6">
                                            <strong>BPP ID:</strong> {{ duplikat_data.autor.pk }}<br/>
                                            <strong>ORCID:</strong>
                                            {% if duplikat_data.autor.orcid %}
                                                <a href="https://orcid.org/{{ duplikat_data.autor.orcid }}"
                                                   target="_blank">{{ duplikat_data.autor.orcid }}</a>
                                            {% else %}
                                                brak
                                            {% endif %}
                                            {% if duplikat_data.autor.pbn_uid_id %}
                                                <br><strong>PBN:</strong>
                                                <a href="{{ duplikat_data.autor.link_do_pbn }}"
                                                   target="_blank">{{ duplikat_data.autor.pbn_uid_id }}</a>
                                            {% endif %}
                                        </div>
                                        <div class="cell medium-12">
                                            <strong>Liczba publikacji:</strong><br>
                                            <span class="deduplikator-autorow__duplicate-publication-count">
                                            {{ duplikat_data.publikacje_count|default:0 }} publikacji
                                        </span>
                                        </div>
                                    </div>

                                    <div class="deduplikator-autorow__reasons-section">
                                        <h5>Powody podobieństwa:</h5>
                                        <ul>
                                            {% for powod in duplikat_data.analiza.powody_podobienstwa %}
                                                <li>{{ powod }}</li>
                                                {% empty %}
                                                <li>Brak szczegółowych powodów</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="cell medium-4 text-right">
                                    <div class="button-group stacked">
                                        <button type="button"
                                                id="merge-with-disc-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small success deduplikator-autorow__button--full-width"
                                                data-merge-action="with-discipline"
                                                data-main-author="{{ glowny_autor.pk }}"
                                                data-duplicate-author="{{ duplikat_data.autor.pk }}"
                                                data-candidate-id="{% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% endif %}">
                                            <span class="button-text">Scal + ustaw dyscyplinę</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop deduplikator-autorow__spinner"></i> Scalanie...
                                            </span>
                                        </button>
                                        <button type="button"
                                                id="merge-with-subdisc-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small success deduplikator-autorow__button--full-width"
                                                data-merge-action="with-subdiscipline"
                                                data-main-author="{{ glowny_autor.pk }}"
                                                data-duplicate-author="{{ duplikat_data.autor.pk }}"
                                                data-candidate-id="{% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% endif %}">
                                            <span class="button-text">Scal + ustaw subdyscyplinę</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop deduplikator-autorow__spinner"></i> Scalanie...
                                            </span>
                                        </button>
                                        <button type="button"
                                                id="merge-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small primary deduplikator-autorow__button--full-width"
                                                data-merge-action="standard"
                                                data-main-author="{{ glowny_autor.pk }}"
                                                data-duplicate-author="{{ duplikat_data.autor.pk }}"
                                                data-candidate-id="{% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% endif %}">
                                            <span class="button-text">Scal bez zmian dyscyplin</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop deduplikator-autorow__spinner"></i> Scalanie...
                                            </span>
                                        </button>
                                        <button type="button"
                                                id="merge-no-pbn-btn-{{ duplikat_data.autor.pk }}"
                                                class="button small warning deduplikator-autorow__button--full-width"
                                                data-merge-action="no-pbn"
                                                data-main-author="{{ glowny_autor.pk }}"
                                                data-duplicate-author="{{ duplikat_data.autor.pk }}"
                                                data-candidate-id="{% if duplikat_data.candidate_id %}{{ duplikat_data.candidate_id }}{% endif %}">
                                            <span class="button-text">Scal, nie wysyłaj do PBN</span>
                                            <span class="spinner" style="display: none;">
                                                <i class="fi-loop deduplikator-autorow__spinner"></i> Scalanie...
                                            </span>
                                        </button>
                                        <a href="#"
                                           class="button small secondary deduplikator-autorow__button--full-width"
                                           data-open-wydawnictwo="ciagle"
                                           data-autor-id="{{ duplikat_data.autor.pk }}">
                                            <span class="fi-pencil"></span> Pokaż wyd. ciągłe
                                        </a>
                                        <a href="#"
                                           class="button small secondary deduplikator-autorow__button--full-width"
                                           data-open-wydawnictwo="zwarte"
                                           data-autor-id="{{ duplikat_data.autor.pk }}">
                                            <span class="fi-pencil"></span> Pokaż wyd. zwarte
                                        </a>
                                        {% if duplikat_data.candidate_id %}
                                        <form method="post" action="{% url 'deduplikator_autorow:mark_candidate_not_duplicate' %}"
                                              class="deduplikator-autorow__form--block">
                                            {% csrf_token %}
                                            <input type="hidden" name="candidate_id"
                                                   value="{{ duplikat_data.candidate_id }}">
                                            <button type="submit" class="button small alert deduplikator-autorow__button--full-width">
                                                Nie są duplikatami
                                            </button>
                                        </form>
                                        {% else %}
                                        <form method="post" action="{% url 'deduplikator_autorow:mark_non_duplicate' %}"
                                              class="deduplikator-autorow__form--block">
                                            {% csrf_token %}
                                            <input type="hidden" name="scientist_pk"
                                                   value="{{ duplikat_data.autor.pk }}">
                                            <button type="submit" class="button small alert deduplikator-autorow__button--full-width">
                                                Nie są duplikatami
                                            </button>
                                        </form>
                                        {% endif %}
                                        {% if duplikat_data.publikacje_count == 0 %}
                                            <button class="button small alert deduplikator-autorow__button--full-width"
                                                    data-delete-author="{{ duplikat_data.autor.pk }}">
                                                Usuń autora (brak publikacji)
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <h5 class="deduplikator-autorow__section-title">Dyscypliny duplikatu (2022-2025):</h5>
                            <div class="deduplikator-autorow__discipline-section">
                                <table class="deduplikator-autorow__table deduplikator-autorow__table--small">
                                    <thead class="deduplikator-autorow__table-head--light">
                                        <tr>
                                            <th class="deduplikator-autorow__table-cell--small">Rok</th>
                                            <th class="deduplikator-autorow__table-cell--small">Dyscyplina</th>
                                            <th class="deduplikator-autorow__table-cell--small">%</th>
                                            <th class="deduplikator-autorow__table-cell--small">Subdyscyplina</th>
                                            <th class="deduplikator-autorow__table-cell--small">%</th>
                                            <th class="deduplikator-autorow__table-cell--small">Rodzaj</th>
                                            <th class="deduplikator-autorow__table-cell--small">Etat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dyscyplina in duplikat_data.dyscypliny %}
                                            <tr {% if dyscyplina.dyscyplina_naukowa != glowny_autor_dyscypliny.0.dyscyplina_naukowa %}class="deduplikator-autorow__table-cell--warning"{% endif %}>
                                                <td class="deduplikator-autorow__table-cell--small deduplikator-autorow__table-cell--center">{{ dyscyplina.rok }}</td>
                                                <td class="deduplikator-autorow__table-cell--small">{{ dyscyplina.dyscyplina_naukowa }}</td>
                                                <td class="deduplikator-autorow__table-cell--small deduplikator-autorow__table-cell--center">
                                                    {% if dyscyplina.procent_dyscypliny %}{{ dyscyplina.procent_dyscypliny }}%{% else %}-{% endif %}
                                                </td>
                                                <td class="deduplikator-autorow__table-cell--small">
                                                    {% if dyscyplina.subdyscyplina_naukowa %}{{ dyscyplina.subdyscyplina_naukowa }}{% else %}-{% endif %}
                                                </td>
                                                <td class="deduplikator-autorow__table-cell--small deduplikator-autorow__table-cell--center">
                                                    {% if dyscyplina.procent_subdyscypliny %}{{ dyscyplina.procent_subdyscypliny }}%{% else %}-{% endif %}
                                                </td>
                                                <td class="deduplikator-autorow__table-cell--small deduplikator-autorow__table-cell--center">{{ dyscyplina.get_rodzaj_autora_display|default:"-" }}</td>
                                                <td class="deduplikator-autorow__table-cell--small deduplikator-autorow__table-cell--center">
                                                    {% if dyscyplina.wymiar_etatu %}{{ dyscyplina.wymiar_etatu }}{% else %}-{% endif %}
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="7" class="deduplikator-autorow__table-cell--small deduplikator-autorow__table-cell--center deduplikator-autorow__table-cell--muted">
                                                    Brak przypisanych dyscyplin dla lat 2022-2025
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            {% if duplikat_data.publikacje %}
                                <h5 class="deduplikator-autorow__section-title">Publikacje duplikatu:
                                    {% if duplikat_data.publikacje_year_range %}
                                        <small class="deduplikator-autorow__year-hint">({{ duplikat_data.publikacje_year_range }})</small>{% endif %}
                                </h5>
                                <div class="deduplikator-autorow__publication-list deduplikator-autorow__publication-list--short">
                                    {% for publikacja in duplikat_data.publikacje %}
                                        <div class="deduplikator-autorow__publication-item--duplicate">
                                            <small><strong>
                                                <a href="{% url 'bpp:browse_praca' publikacja.pk.0 publikacja.pk.1 %}"
                                                   target="_blank" class="deduplikator-autorow__publication-link--muted">
                                                    {{ publikacja.tytul_oryginalny }}
                                                </a>
                                                {% if publikacja.rok %}
                                                    <span class="deduplikator-autorow__publication-year"> ({{ publikacja.rok }})</span>{% endif %}
                                            </strong></small><br>
                                            <small class="deduplikator-autorow__publication-description">
                                                {{ publikacja.opis_bibliograficzny_cache|truncatewords:15 }}</small>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="callout secondary">
                            <p>Nie znaleziono duplikatów dla tego autora.</p>
                        </div>
                    {% endfor %}

                {% else %}
                    <div class="callout alert">
                        <p><strong>Błąd:</strong> Nie można pobrać danych głównego autora.</p>
                    </div>
                {% endif %}
            {% endif %}

        </div>
    </div>

    <script>
        // Move messages from base placeholder to local placeholder to respect sidebar layout
        function relocateMessages() {
            const baseMessages = document.getElementById('messagesPlaceholder');
            const localMessages = document.getElementById('localMessagesPlaceholder');

            if (baseMessages && localMessages) {
                // Move all children from base to local placeholder
                while (baseMessages.firstChild) {
                    localMessages.appendChild(baseMessages.firstChild);
                }

                // Also listen for any new messages that might be added dynamically
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes.length > 0) {
                            // Move new messages to local placeholder
                            while (baseMessages.firstChild) {
                                localMessages.appendChild(baseMessages.firstChild);
                            }
                        }
                    });
                });

                // Observe the base placeholder for new messages
                observer.observe(baseMessages, { childList: true });
            }
        }

        // Adjust sidebar position and height
        function adjustSidebarPosition() {
            const sidebar = document.querySelector('.left-menu-sidebar');
            const breadcrumbs = document.getElementById('breadcrumbs-wrapper');
            const footer = document.querySelector('.grid-container-fluid[style*="z-index: 10"]') ||
                          document.querySelector('.grid-container-fluid[style*="background-color: #f8f8f8"]');

            if (sidebar && breadcrumbs) {
                // Get breadcrumbs exact bottom position (including its border)
                const breadcrumbsRect = breadcrumbs.getBoundingClientRect();
                const breadcrumbsStyles = window.getComputedStyle(breadcrumbs);
                const breadcrumbsBorder = parseFloat(breadcrumbsStyles.borderBottomWidth) || 0;
                const topPosition = breadcrumbsRect.bottom; // This already includes the border

                // Set sidebar top position to align exactly with breadcrumbs bottom
                sidebar.style.top = topPosition + 'px';

                // Calculate height to stop before footer
                let sidebarHeight;
                if (footer) {
                    const footerRect = footer.getBoundingClientRect();

                    // If footer is visible in viewport, adjust height to stop at footer
                    if (footerRect.top < window.innerHeight) {
                        // Calculate exact height to stop just before footer
                        sidebarHeight = footerRect.top - topPosition - 10; // 10px gap before footer

                        // If the calculated height is too small, set minimum height
                        if (sidebarHeight < 300) {
                            sidebarHeight = 300;
                        }
                    } else {
                        // Footer not in viewport, use full viewport height
                        sidebarHeight = window.innerHeight - topPosition;
                    }
                } else {
                    // No footer found, use full viewport height
                    sidebarHeight = window.innerHeight - topPosition ;
                }

                // Apply the calculated height
                sidebar.style.height = sidebarHeight + 'px';

                // Keep z-index at 0 so sidebar remains visible but behind other elements
                sidebar.style.zIndex = '0';
            }
        }

        // Adjust on page load
        document.addEventListener('DOMContentLoaded', function() {
            adjustSidebarPosition();
            relocateMessages(); // Move messages to respect sidebar layout
        });

        // Adjust on window resize and scroll
        window.addEventListener('resize', adjustSidebarPosition);
        window.addEventListener('scroll', adjustSidebarPosition);

        // Adjust after Foundation initializes
        $(document).ready(function() {
            setTimeout(adjustSidebarPosition, 100);
            // Also relocate any messages that might have been added after DOM ready
            relocateMessages();
        });

        // Add CSS for spinner animation
        var style = document.createElement('style');
        style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);

        function executeMerge(mainAuthorId, duplicateAuthorId, candidateId, skipPbn, autoAssignDiscipline, useSubdiscipline, buttonId) {
            // Get button and card elements
            var button = document.getElementById(buttonId);
            var card = document.getElementById('duplicate-card-' + duplicateAuthorId);

            // Show spinner, disable button
            if (button) {
                button.disabled = true;
                button.querySelector('.button-text').style.display = 'none';
                button.querySelector('.spinner').style.display = 'inline';
            }

            // Build request data
            var requestData = {
                'main_scientist_id': mainAuthorId,
                'duplicate_scientist_id': duplicateAuthorId
            };
            if (candidateId) {
                requestData['candidate_id'] = candidateId;
            }
            if (skipPbn) {
                requestData['skip_pbn'] = 'true';
            }
            if (autoAssignDiscipline) {
                requestData['auto_assign_discipline'] = 'true';
            }
            if (useSubdiscipline) {
                requestData['use_subdiscipline'] = 'true';
            }

            // Make AJAX call
            $.ajax({
                url: '{% url "deduplikator_autorow:scal_autorow" %}',
                type: 'GET',
                dataType: 'json',
                data: requestData,
                complete: function(xhr, status) {
                    console.log('AJAX complete, status:', status, 'xhr:', xhr);

                    var response = null;
                    try {
                        response = xhr.responseJSON || JSON.parse(xhr.responseText);
                    } catch(e) {
                        console.log('Failed to parse response:', e);
                    }

                    console.log('Parsed response:', response);

                    if (response && response.success === true) {
                        // Success - fade out the card
                        console.log('Merge successful (success === true), fading out card');
                        if (card) {
                            $(card).fadeOut(600, function() {
                                $(this).remove();

                                var countElement = document.querySelector('h3');
                                if (countElement && countElement.textContent.includes('Możliwe duplikaty')) {
                                    var currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
                                    var newCount = currentCount - 1;
                                    countElement.textContent = 'Możliwe duplikaty (' + newCount + ')';

                                    if (newCount === 0) {
                                        setTimeout(function() {
                                            window.location.reload();
                                        }, 500);
                                    }
                                }
                            });
                        }

                        // Show success message with details
                        if (bppNotifications && bppNotifications.addMessage) {
                            var message = 'Autorzy zostali pomyślnie scaleni';
                            if (response.result) {
                                if (response.result.total_updated) {
                                    message += '\n• ' + response.result.total_updated + ' publikacji przeniesionych';
                                }
                                if (response.result.disciplines_transferred && response.result.disciplines_transferred.length > 0) {
                                    message += '\n• ' + response.result.disciplines_transferred.length + ' dyscyplin przeniesionych';
                                }
                                if (response.result.warnings && response.result.warnings.length > 0) {
                                    message += '\n• ' + response.result.warnings.length + ' ostrzeżeń';
                                }
                            }
                            bppNotifications.addMessage({
                                cssClass: 'success',
                                text: message,
                                sound: false
                            });
                        }
                    } else {
                        // Error from server
                        console.log('Merge failed, response:', response);

                        var errorMessage = 'Błąd podczas scalania autorów:\n\n';

                        if (!response) {
                            errorMessage += 'Brak odpowiedzi z serwera.';
                        } else if (response.success === false) {
                            if (response.error) {
                                errorMessage += response.error;
                            } else if (response.result && response.result.error) {
                                errorMessage += response.result.error;
                            } else {
                                errorMessage += 'Operacja nie powiodła się (success: false). Sprawdź logi serwera.';
                            }
                        } else if (response.error) {
                            errorMessage += response.error;
                        } else {
                            errorMessage += 'Nieoczekiwana odpowiedź serwera: ' + JSON.stringify(response);
                        }

                        if (card) {
                            var existingError = card.querySelector('.merge-error-alert');
                            if (existingError) {
                                existingError.remove();
                            }

                            var errorDiv = document.createElement('div');
                            errorDiv.className = 'callout alert merge-error-alert deduplikator-autorow__section-title';
                            errorDiv.innerHTML = '<h5 style="margin-bottom: 10px;">Błąd scalania</h5>' +
                                                '<p style="margin-bottom: 0;">' +
                                                errorMessage.replace(/\n/g, '<br>') +
                                                '</p>';

                            var mainDiv = card.querySelector('.grid-x');
                            if (mainDiv) {
                                mainDiv.parentNode.insertBefore(errorDiv, mainDiv.nextSibling);
                            } else {
                                card.appendChild(errorDiv);
                            }

                            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }

                        if (bppNotifications && bppNotifications.addMessage) {
                            bppNotifications.addMessage({
                                cssClass: 'alert',
                                text: errorMessage.replace(/\n/g, ' '),
                                sound: true
                            });
                        }

                        if (button) {
                            button.disabled = false;
                            button.querySelector('.button-text').style.display = 'inline';
                            button.querySelector('.spinner').style.display = 'none';
                        }
                    }
                }
            });

            return false;
        }

        // Event delegation for merge actions (data-merge-action)
        document.addEventListener('click', function(e) {
            var target = e.target.closest('[data-merge-action]');
            if (!target) return;

            var action = target.dataset.mergeAction;
            var mainAuthorId = target.dataset.mainAuthor;
            var duplicateAuthorId = target.dataset.duplicateAuthor;
            var candidateId = target.dataset.candidateId || null;

            var messages = {
                'standard': 'Czy jesteś pewny/a? W ten sposób przypiszesz wszystkie publikacje potencjalnego duplikatu autorowi głównemu, domyślnie z główną dyscypliną. Zostanie zlecona też wysyłka tych prac do PBN w tle. Tej operacji nie można cofnąć.',
                'with-discipline': 'Czy jesteś pewny/a? Scalisz autorów i przypisz główną dyscyplinę autora głównego do prac bez dyscypliny. Zostanie zlecona wysyłka do PBN.',
                'with-subdiscipline': 'Czy jesteś pewny/a? Scalisz autorów i przypisz subdyscyplinę autora głównego jako dyscyplinę dla prac bez dyscypliny. Zostanie zlecona wysyłka do PBN.',
                'no-pbn': 'Czy jesteś pewny/a? W ten sposób przypiszesz wszystkie publikacje potencjalnego duplikatu autorowi głównemu, domyślnie z główną dyscypliną. Publikacje NIE zostaną wysłane do PBN. Tej operacji nie można cofnąć.'
            };

            if (!confirm(messages[action])) {
                e.preventDefault();
                return;
            }

            var skipPbn = (action === 'no-pbn');
            var autoAssignDiscipline = (action === 'with-discipline');
            var useSubdiscipline = (action === 'with-subdiscipline');

            executeMerge(mainAuthorId, duplicateAuthorId, candidateId, skipPbn,
                autoAssignDiscipline, useSubdiscipline, target.id);
            e.preventDefault();
        });

        // Event delegation for opening wydawnictwo (data-open-wydawnictwo)
        document.addEventListener('click', function(e) {
            var target = e.target.closest('[data-open-wydawnictwo]');
            if (!target) return;

            var type = target.dataset.openWydawnictwo;
            var autorId = target.dataset.autorId;
            var baseQuery = encodeURIComponent(
                'rok >= 2022 and rok <= 2025 and autorzy_set.autor.id = ' + autorId
            );
            window.open('/admin/bpp/wydawnictwo_' + type + '/?q-l=on&q=' + baseQuery, '_blank');
            e.preventDefault();
        });

        // Event delegation for delete author (data-delete-author)
        document.addEventListener('click', function(e) {
            var target = e.target.closest('[data-delete-author]');
            if (!target) return;

            var authorId = target.dataset.deleteAuthor;
            if (!confirm('Czy na pewno chcesz usunąć tego autora? Ta operacja jest nieodwracalna. Ta operacja NIE USUWA DANYCH AUTORA Z PBN.')) {
                e.preventDefault();
                return;
            }

            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "deduplikator_autorow:delete_author" %}';

            var csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = '{{ csrf_token }}';
            form.appendChild(csrfToken);

            var authorIdInput = document.createElement('input');
            authorIdInput.type = 'hidden';
            authorIdInput.name = 'author_id';
            authorIdInput.value = authorId;
            form.appendChild(authorIdInput);

            document.body.appendChild(form);
            form.submit();
        });

        // Event delegation for merge all (data-merge-all)
        document.addEventListener('click', function(e) {
            var target = e.target.closest('[data-merge-all]');
            if (!target) return;

            var skipPbn = target.dataset.skipPbn === 'true';
            handleMergeAll(skipPbn);
            e.preventDefault();
        });

        function handleMergeAll(skipPbn) {
            // Collect all duplicate IDs
            var duplicateCards = document.querySelectorAll('[id^="duplicate-card-"]');
            var duplicateIds = [];
            var mainAuthorId = {{ glowny_autor.pk }};

            duplicateCards.forEach(function(card) {
                var id = card.id.replace('duplicate-card-', '');
                duplicateIds.push(id);
            });

            if (duplicateIds.length === 0) {
                alert('Brak duplikatów do scalenia.');
                return false;
            }

            // Confirmation
            var message = skipPbn
                ? 'Czy na pewno chcesz scalić wszystkie ' + duplicateIds.length + ' duplikatów?\n\n' +
                  'Publikacje NIE zostaną wysłane do PBN.\n\n' +
                  'Operacja zostanie zatrzymana na pierwszym błędzie.\n\n' +
                  'Tej operacji nie można cofnąć.'
                : 'Czy na pewno chcesz scalić wszystkie ' + duplicateIds.length + ' duplikatów?\n\n' +
                  'Publikacje zostaną wysłane do PBN.\n\n' +
                  'Operacja zostanie zatrzymana na pierwszym błędzie.\n\n' +
                  'Tej operacji nie można cofnąć.';

            if (!confirm(message)) {
                return false;
            }

            // Show progress, disable buttons
            document.getElementById('merge-all-progress').style.display = 'block';
            document.getElementById('merge-all-btn').disabled = true;
            document.getElementById('merge-all-no-pbn-btn').disabled = true;

            // Disable all individual merge buttons too
            duplicateIds.forEach(function(id) {
                var btn1 = document.getElementById('merge-btn-' + id);
                var btn2 = document.getElementById('merge-no-pbn-btn-' + id);
                if (btn1) btn1.disabled = true;
                if (btn2) btn2.disabled = true;
            });

            // Process duplicates sequentially
            var current = 0;
            var total = duplicateIds.length;

            function mergeNext() {
                if (current >= total) {
                    // All done - reload page
                    window.location.reload();
                    return;
                }

                var duplicateId = duplicateIds[current];
                current++;

                // Update progress
                document.getElementById('merge-progress-text').textContent = current + '/' + total;

                // Merge this duplicate
                $.ajax({
                    url: '{% url "deduplikator_autorow:scal_autorow" %}',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        'main_scientist_id': mainAuthorId,
                        'duplicate_scientist_id': duplicateId,
                        'skip_pbn': skipPbn
                    },
                    complete: function(xhr, status) {
                        var response = null;
                        try {
                            response = xhr.responseJSON || JSON.parse(xhr.responseText);
                        } catch(e) {
                            console.log('Failed to parse response:', e);
                        }

                        if (response && response.success === true) {
                            // Success - fade out card
                            var card = document.getElementById('duplicate-card-' + duplicateId);
                            if (card) {
                                $(card).fadeOut(400);
                            }
                            // Continue to next after short delay
                            setTimeout(mergeNext, 500);
                        } else {
                            // Error - stop and show message
                            handleMergeAllError(response, duplicateId);
                        }
                    }
                });
            }

            function handleMergeAllError(response, duplicateId) {
                // Hide progress
                document.getElementById('merge-all-progress').style.display = 'none';

                // Re-enable main buttons
                document.getElementById('merge-all-btn').disabled = false;
                document.getElementById('merge-all-no-pbn-btn').disabled = false;

                // Re-enable individual buttons for remaining duplicates
                for (var i = current; i < total; i++) {
                    var id = duplicateIds[i];
                    var btn1 = document.getElementById('merge-btn-' + id);
                    var btn2 = document.getElementById('merge-no-pbn-btn-' + id);
                    if (btn1) btn1.disabled = false;
                    if (btn2) btn2.disabled = false;
                }

                // Build error message
                var errorMessage = 'Błąd podczas scalania duplikatu (ID: ' + duplicateId + '):\n\n';
                if (response && response.error) {
                    errorMessage += response.error;
                } else if (response && response.result && response.result.error) {
                    errorMessage += response.result.error;
                } else {
                    errorMessage += 'Nieznany błąd. Sprawdź logi serwera.';
                }

                errorMessage += '\n\nPomyślnie scalono: ' + (current - 1) + ' z ' + total + ' duplikatów.';

                alert(errorMessage);

                // Highlight the problematic card
                var card = document.getElementById('duplicate-card-' + duplicateId);
                if (card) {
                    card.style.border = '3px solid red';
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Show error in notification system if available
                if (bppNotifications && bppNotifications.addMessage) {
                    bppNotifications.addMessage({
                        cssClass: 'alert',
                        text: 'Scalanie automatyczne zatrzymane na błędzie. Scalono ' + (current - 1) + ' z ' +
                              total + ' duplikatów.',
                        sound: true
                    });
                }
            }

            // Start merging
            mergeNext();

            return false;
        }
    </script>
{% endblock %}
