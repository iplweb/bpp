{% extends "base.html" %}
{% load static %}

{% block title %}Deduplikator Autor√≥w PBN{% endblock %}

{% block breadcrumbs %}
    <li><a href="/">Strona g≈Ç√≥wna</a></li>
    <li><a href="{% url "deduplikator_autorow:duplicate_authors" %}">Deduplikator autor√≥w PBN</a></li>
{% endblock %}

{% block content %}
    <style>
        #deduplikator-sidebar {
            position: fixed;
            left: 0;
            width: 280px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 0;
        }

        #main-content-wrapper {
            margin-left: 300px;
            padding: 20px;
            padding-left: 10px;
        }

        /* Remove borders and style accordion items */
        #deduplikator-sidebar .accordion-item {
            border: none !important;
            margin-bottom: 0 !important;
        }

        #deduplikator-sidebar .accordion-title {
            font-weight: normal !important;
            font-size: 1rem !important;
            padding: 12px 15px !important;
            background: transparent !important;
            color: #333 !important;
            transition: all 0.2s ease !important;
        }

        #deduplikator-sidebar .accordion-title:hover {
            background: rgba(23, 121, 186, 0.08) !important;
            transform: translateX(5px);
        }

        #deduplikator-sidebar .accordion-content {
            font-size: 0.95rem !important;
            background: rgba(248, 248, 248, 0.5) !important;
            padding: 12px 15px !important;
        }

        #deduplikator-sidebar .accordion-content p {
            font-size: 0.95rem !important;
            font-weight: normal !important;
        }

        @media print {
            #deduplikator-sidebar {
                display: none;
            }
            #main-content-wrapper {
                margin-left: 0;
            }
        }

        @media screen and (max-width: 64em) {
            #deduplikator-sidebar {
                position: static;
                width: 100%;
                height: auto !important;
            }
            #main-content-wrapper {
                margin-left: 0;
            }
        }
    </style>

    <div id="deduplikator-container">
        <!-- Left Sidebar Menu -->
        <div id="deduplikator-sidebar">
            <div class="deduplikator-menu">
                <ul class="accordion" data-accordion data-allow-all-closed="true" data-multi-expand="true" style="border: none; padding: 0; margin: 0;">
                    {% if total_authors_with_duplicates %}
                    <!-- Liczba autor√≥w z duplikatami -->
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title" href="#" aria-expanded="true" style="pointer-events: none; cursor: default;">
                            üë• {{ total_authors_with_duplicates }} autor{% if total_authors_with_duplicates != 1 %}√≥w{% endif %} z duplikatami
                        </a>
                        <div class="accordion-content" data-tab-content style="display: none;"></div>
                    </li>
                    {% endif %}

                    <!-- Zacznij od poczƒÖtku -->
                    {% if has_skipped_authors and not search_lastname %}
                    <li class="accordion-item is-active" data-accordion-item>
                        <a class="accordion-title" href="#" aria-expanded="true" style="pointer-events: none; cursor: default;">
                            üîÅ Nawigacja
                        </a>
                        <div class="accordion-content" data-tab-content style="display: block;">
                            <p style="margin-bottom: 10px;">Prze≈õledzile≈õ ju≈º kilku autor√≥w.</p>
                            <a href="{% url 'deduplikator_autorow:reset_skipped_authors' %}"
                               class="button alert expanded small">
                                Zacznij od poczƒÖtku
                            </a>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Wyszukiwanie autora -->
                    <li class="accordion-item {% if search_lastname %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if search_lastname %}aria-expanded="true"{% endif %}>
                            üîç Szukaj autora
                        </a>
                        <div class="accordion-content" data-tab-content {% if search_lastname %}style="display: block;"{% endif %}>
                            <form method="get" action="{% url 'deduplikator_autorow:duplicate_authors' %}" style="margin-bottom: 0;">
                                <label for="search_lastname" style="font-size: 0.9rem;">Po nazwisku:</label>
                                <input type="text" id="search_lastname" name="search_lastname"
                                       value="{{ search_lastname|default:'' }}"
                                       placeholder="Wpisz czƒô≈õƒá nazwiska..."
                                       style="margin-bottom: 10px; font-size: 0.9rem;">
                                <button type="submit" class="button primary expanded small">
                                    üîç Szukaj
                                </button>
                                {% if search_lastname %}
                                    <a href="{% url 'deduplikator_autorow:duplicate_authors' %}"
                                       class="button secondary expanded small" style="margin-top: 5px;">
                                        Wyczy≈õƒá
                                    </a>
                                    <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                                        <strong>Szukano:</strong> "{{ search_lastname }}"
                                        {% if search_results_count is not None %}
                                            <br><strong>Znaleziono:</strong> {{ search_results_count }} autor{% if search_results_count != 1 %}√≥w{% endif %}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </form>
                        </div>
                    </li>

                    <!-- Pobierz XLSX -->
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üìä Pobierz XLSX duplikat√≥w
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p style="margin-bottom: 10px;">Pobierz wszystkich autor√≥w z duplikatami w formacie Excel.</p>
                            <a href="{% url 'deduplikator_autorow:download_duplicates_xlsx' %}"
                               class="button success expanded"
                               style="margin: 0;">
                                üì• Pobierz XLSX
                            </a>
                        </div>
                    </li>

                    <!-- Obejrz nie-duplikaty -->
                    <li class="accordion-item {% if not_duplicate_count > 0 %}is-active{% endif %}" data-accordion-item>
                        <a class="accordion-title" href="#" {% if not_duplicate_count > 0 %}aria-expanded="true"{% endif %}>
                            üëÅÔ∏è Obejrz nie-duplikaty
                        </a>
                        <div class="accordion-content" data-tab-content {% if not_duplicate_count > 0 %}style="display: block;"{% endif %}>
                            <p style="margin-bottom: 10px;">Przejrzyj autor√≥w oznaczonych jako nie bƒôdƒÖcych duplikatami.</p>
                            <a href="/admin/deduplikator_autorow/notaduplicate/"
                               class="button secondary expanded"
                               target="_blank"
                               style="margin: 0;">
                                üîç Otw√≥rz listƒô
                            </a>
                        </div>
                    </li>

                    <!-- Reset nie-duplikat√≥w -->
                    {% if not_duplicate_count > 0 %}
                    <li class="accordion-item" data-accordion-item>
                        <a class="accordion-title" href="#">
                            üîÑ Zresetuj listƒô ({{ not_duplicate_count }})
                        </a>
                        <div class="accordion-content" data-tab-content>
                            <p style="margin-bottom: 10px;">Wyczy≈õƒá wszystkie oznaczenia nie-duplikat√≥w.</p>
                            <p style="margin-bottom: 10px; color: #d63031;">
                                ‚ö†Ô∏è Obecnie: {{ not_duplicate_count }} oznaczonych
                            </p>
                            <form method="post" action="{% url 'deduplikator_autorow:reset_not_duplicates' %}" style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit"
                                        class="button alert expanded"
                                        style="margin: 0;"
                                        onclick="return confirm('Czy na pewno chcesz zresetowaƒá wszystkie oznaczenia nie-duplikat√≥w? Tej operacji nie mo≈ºna cofnƒÖƒá.');">
                                    üóëÔ∏è Zresetuj wszystkie
                                </button>
                            </form>
                        </div>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content-wrapper">
            <div class="grid-x grid-padding-x align-middle" style="margin-bottom: 20px;">
                <div class="cell auto">
                    <h1>Deduplikator Autor√≥w PBN <span class="label warning" style="font-size: 0.6em; vertical-align: top;">BETA</span></h1>
                </div>
                <div class="cell shrink">
                    {% if not search_lastname %}
                        <div class="button-group">
                            {% if has_previous_authors %}
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?go_previous=1"
                                   class="button secondary">‚Üê Poprzedni autor</a>
                            {% endif %}
                            <a href="{% url 'deduplikator_autorow:duplicate_authors' %}?skip_current=1"
                               class="button primary">Nastƒôpny autor ‚Üí</a>
                        </div>
                    {% endif %}
                </div>
            </div>


            {% if not scientist %}
                <div class="callout warning">
                    <p><strong>Nie znaleziono autor√≥w z duplikatami.</strong></p>
                    <p>Wszystkie duplikaty zosta≈Çy prawdopodobnie ju≈º przetworzone lub nie ma autor√≥w wymagajƒÖcych
                        deduplikacji.</p>
                </div>
            {% else %}
                {% if glowny_autor %}
                    <div class="callout primary">
                        <h3>G≈Ç√≥wny rekord autora</h3>
                        <div class="grid-x grid-padding-x">
                            <div class="cell medium-4">
                                <strong>Imiƒô i nazwisko:</strong><br>
                                <span style="font-size: 1.5em; font-weight: bold; color: #1779ba;">
                                <a href="{% url 'bpp:browse_autor' glowny_autor.pk %}" target="_blank"
                                   style="color: inherit; text-decoration: none;">
                                    {% if glowny_autor.imiona %}{{ glowny_autor.imiona }}{% endif %}
                                    {{ glowny_autor.nazwisko|default:"[brak nazwiska]" }}
                                </a>
                            </span><br/>
                                <strong>ORCID:</strong>
                                {% if glowny_autor.orcid %}
                                    <a href="https://orcid.org/{{ glowny_autor.orcid }}"
                                       target="_blank">{{ glowny_autor.orcid }}</a>
                                {% else %}
                                    brak
                                {% endif %}
                                {% if glowny_autor.pbn_uid_id %}
                                    <br><strong>PBN:</strong> <a href="{{ glowny_autor.link_do_pbn }}"
                                                                 target="_blank">{{ glowny_autor.pbn_uid_id }}</a><br/>
                                    <strong>{{ glowny_autor.pbn_uid.x.pbn_uid.currentEmploymentsInstitutionDisplayName }}</strong>
                                {% endif %}
                            </div>
                            <div class="cell medium-4">
                                <strong>Tytu≈Ç naukowy:</strong> {{ glowny_autor.tytul|default:"brak" }}<br/>
                                <strong>Liczba publikacji:</strong><br>
                                <span style="font-size: 1.3em; font-weight: bold; color: #2ba6cb; background-color: #e7f4fd; padding: 5px 10px; border-radius: 5px; display: inline-block;">
                                {{ glowne_publikacje_count|default:0 }} publikacji
                            </span>
                            </div>
                            <div class="cell medium-4">
                                <!-- Navigation moved to header -->
                            </div>
                        </div>


                        {% if glowne_publikacje %}
                            <h4>Publikacje g≈Ç√≥wnego autora:{% if glowne_publikacje_year_range %}
                                <small style="color: #666;">({{ glowne_publikacje_year_range }})</small>{% endif %}</h4>
                            <div class="publikacje-lista"
                                 style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e1e1; padding: 10px;">
                                {% for publikacja in glowne_publikacje %}
                                    <div class="publikacja-item"
                                         style="margin-bottom: 8px; padding: 5px; border-left: 3px solid #1779ba;">
                                        <small><strong>
                                            <a href="{% url 'bpp:browse_praca_old' publikacja.content_type.model publikacja.pk.1 %}"
                                               target="_blank" style="color: #1779ba; text-decoration: none;">
                                                {{ publikacja.tytul_oryginalny }}
                                            </a>
                                            {% if publikacja.rok %}
                                                <span style="color: #666; font-weight: normal;"> ({{ publikacja.rok }})</span>{% endif %}
                                        </strong></small><br>
                                        <small>{{ publikacja.opis_bibliograficzny_cache|truncatewords:20 }}</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <h3>Mo≈ºliwe duplikaty ({{ duplikaty_z_publikacjami|length }})</h3>

                    {% for duplikat_data in duplikaty_z_publikacjami %}
                        <div class="callout {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}"
                             style="margin-bottom: 20px;">
                            <div class="grid-x grid-padding-x">
                                <div class="cell medium-8">
                                    <div style="margin-bottom: 10px;">
                                    <span style="font-size: 1.4em; font-weight: bold; color: #333;">
                                        <a href="{% url 'bpp:browse_autor' duplikat_data.autor.pk %}" target="_blank"
                                           style="color: inherit; text-decoration: none;">
                                            {% if duplikat_data.autor.imiona %}
                                                {{ duplikat_data.autor.imiona }}{% endif %}
                                            {{ duplikat_data.autor.nazwisko|default:"[brak nazwiska]" }}
                                        </a>
                                    </span><br>
                                        <span class="label {% if duplikat_data.analiza.pewnosc > 50 %}success{% elif duplikat_data.analiza.pewnosc > 0 %}warning{% else %}alert{% endif %}">
                                        Pewno≈õƒá: {{ duplikat_data.analiza.pewnosc }}%
                                    </span>
                                    </div>

                                    <div class="grid-x grid-padding-x">
                                        <div class="cell medium-6">
                                            <strong>Tytu≈Ç naukowy:</strong>
                                            {{ duplikat_data.autor.tytul|default:"brak" }}
                                        </div>
                                        <div class="cell medium-6">
                                            <strong>ORCID:</strong>
                                            {% if duplikat_data.autor.orcid %}
                                                <a href="https://orcid.org/{{ duplikat_data.autor.orcid }}"
                                                   target="_blank">{{ duplikat_data.autor.orcid }}</a>
                                            {% else %}
                                                brak
                                            {% endif %}
                                            {% if duplikat_data.autor.pbn_uid_id %}
                                                <br><strong>PBN:</strong>
                                                <a href="{{ duplikat_data.autor.link_do_pbn }}"
                                                   target="_blank">{{ duplikat_data.autor.pbn_uid_id }}</a>
                                            {% endif %}
                                        </div>
                                        <div class="cell medium-12">
                                            <strong>Liczba publikacji:</strong><br>
                                            <span style="font-size: 1.2em; font-weight: bold; color: #5e5e5e; background-color: #f4f4f4; padding: 3px 8px; border-radius: 3px; display: inline-block;">
                                            {{ duplikat_data.publikacje_count|default:0 }} publikacji
                                        </span>
                                        </div>
                                    </div>

                                    <div style="margin-top: 10px;">
                                        <h5>Powody podobie≈Ñstwa:</h5>
                                        <ul>
                                            {% for powod in duplikat_data.analiza.powody_podobienstwa %}
                                                <li>{{ powod }}</li>
                                                {% empty %}
                                                <li>Brak szczeg√≥≈Çowych powod√≥w</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="cell medium-4 text-right">
                                    <div class="button-group stacked">
                                        <a href="#" class="button small primary" onclick="return confirmMerge();"
                                           style="width: 100%;">Scal automatycznie</a>
                                        <form method="post" action="{% url 'deduplikator_autorow:mark_non_duplicate' %}"
                                              style="display: block; width: 100%;">
                                            {% csrf_token %}
                                            <input type="hidden" name="scientist_pk"
                                                   value="{{ duplikat_data.autor.pk }}">
                                            <button type="submit" class="button small secondary" style="width: 100%;">
                                                Nie sƒÖ duplikatami
                                            </button>
                                        </form>
                                        {% if duplikat_data.publikacje_count == 0 %}
                                            <button class="button small alert"
                                                    onclick="return confirmDelete({{ duplikat_data.autor.pk }});"
                                                    style="width: 100%;">Usu≈Ñ autora (brak publikacji)
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            {% if duplikat_data.publikacje %}
                                <h5 style="margin-top: 15px;">Publikacje duplikatu:
                                    {% if duplikat_data.publikacje_year_range %}
                                        <small style="color: #666;">({{ duplikat_data.publikacje_year_range }})</small>{% endif %}
                                </h5>
                                <div class="publikacje-lista"
                                     style="max-height: 250px; overflow-y: auto; border: 1px solid #e1e1e1; padding: 10px; background-color: #f9f9f9;">
                                    {% for publikacja in duplikat_data.publikacje %}
                                        <div class="publikacja-item"
                                             style="margin-bottom: 6px; padding: 3px; border-left: 2px solid #8a8a8a;">
                                            <small><strong>
                                                <a href="{% url 'bpp:browse_praca' publikacja.pk.0 publikacja.pk.1 %}"
                                                   target="_blank" style="color: #333; text-decoration: none;">
                                                    {{ publikacja.tytul_oryginalny }}
                                                </a>
                                                {% if publikacja.rok %}
                                                    <span style="color: #666; font-weight: normal;"> ({{ publikacja.rok }})</span>{% endif %}
                                            </strong></small><br>
                                            <small style="color: #666;">
                                                {{ publikacja.opis_bibliograficzny_cache|truncatewords:15 }}</small>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="callout secondary">
                            <p>Nie znaleziono duplikat√≥w dla tego autora.</p>
                        </div>
                    {% endfor %}

                {% else %}
                    <div class="callout alert">
                        <p><strong>B≈ÇƒÖd:</strong> Nie mo≈ºna pobraƒá danych g≈Ç√≥wnego autora.</p>
                    </div>
                {% endif %}
            {% endif %}

        </div>
    </div>

    <script>
        // Adjust sidebar position and height
        function adjustSidebarPosition() {
            const sidebar = document.getElementById('deduplikator-sidebar');
            const breadcrumbs = document.getElementById('breadcrumbs-wrapper');
            const footer = document.querySelector('.grid-container-fluid[style*="z-index: 10"]') ||
                          document.querySelector('.grid-container-fluid[style*="background-color: #f8f8f8"]');

            if (sidebar && breadcrumbs) {
                // Get breadcrumbs exact bottom position (including its border)
                const breadcrumbsRect = breadcrumbs.getBoundingClientRect();
                const breadcrumbsStyles = window.getComputedStyle(breadcrumbs);
                const breadcrumbsBorder = parseFloat(breadcrumbsStyles.borderBottomWidth) || 0;
                const topPosition = breadcrumbsRect.bottom; // This already includes the border

                // Set sidebar top position to align exactly with breadcrumbs bottom
                sidebar.style.top = topPosition + 'px';

                // Calculate height to stop before footer
                let sidebarHeight;
                if (footer) {
                    const footerRect = footer.getBoundingClientRect();

                    // If footer is visible in viewport, adjust height to stop at footer
                    if (footerRect.top < window.innerHeight) {
                        // Calculate exact height to stop just before footer
                        sidebarHeight = footerRect.top - topPosition - 10; // 10px gap before footer

                        // If the calculated height is too small, set minimum height
                        if (sidebarHeight < 300) {
                            sidebarHeight = 300;
                        }
                    } else {
                        // Footer not in viewport, use full viewport height
                        sidebarHeight = window.innerHeight - topPosition;
                    }
                } else {
                    // No footer found, use full viewport height
                    sidebarHeight = window.innerHeight - topPosition ;
                }

                // Apply the calculated height
                sidebar.style.height = sidebarHeight + 'px';

                // Keep z-index at 0 so sidebar remains visible but behind other elements
                sidebar.style.zIndex = '0';
            }
        }

        // Adjust on page load
        document.addEventListener('DOMContentLoaded', adjustSidebarPosition);

        // Adjust on window resize and scroll
        window.addEventListener('resize', adjustSidebarPosition);
        window.addEventListener('scroll', adjustSidebarPosition);

        // Adjust after Foundation initializes
        $(document).ready(function() {
            setTimeout(adjustSidebarPosition, 100);
        });

        function confirmMerge() {
            return confirm('Czy jeste≈õ pewny/a? W ten spos√≥b przypiszesz wszystkie publikacje potencjalnego duplikatu autorowi g≈Ç√≥wnemu, domy≈õlnie z g≈Ç√≥wnƒÖ dyscyplinƒÖ. Zostanie zlecona te≈º wysy≈Çka tych prac do PBN w tle. Tej operacji nie mo≈ºna cofnƒÖƒá.');
        }

        function confirmDelete(authorId) {
            if (confirm('Czy na pewno chcesz usunƒÖƒá tego autora? Ta operacja jest nieodwracalna. Ta operacja NIE USUWA ' +
                'DANYCH AUTORA Z PBN.')) {
                // Create form and submit
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "deduplikator_autorow:delete_author" %}';

                var csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrfmiddlewaretoken';
                csrfToken.value = '{{ csrf_token }}';
                form.appendChild(csrfToken);

                var authorIdInput = document.createElement('input');
                authorIdInput.type = 'hidden';
                authorIdInput.name = 'author_id';
                authorIdInput.value = authorId;
                form.appendChild(authorIdInput);

                document.body.appendChild(form);
                form.submit();
                return true;
            }
            return false;
        }
    </script>
{% endblock %}
