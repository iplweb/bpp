{% load humanize %}

<!-- Partial template for HTMX polling -->

<!-- Status box - pokazywany zawsze -->
<div class="callout info">
    <p><strong>ID zadania:</strong> {{ task_id }}</p>
    <p><strong>Status:</strong>
        {% if task_state == "PROGRESS" %}
            <span class="label warning">W trakcie</span>
        {% elif task_state == "SUCCESS" %}
            <span class="label success">Zakończono</span>
        {% elif task_state == "FAILURE" %}
            <span class="label alert">Błąd</span>
        {% elif task_state == "PENDING" %}
            <span class="label secondary">Oczekuje</span>
        {% else %}
            <span class="label">{{ task_state }}</span>
        {% endif %}
    </p>
</div>

{% if not task_ready %}
    <!-- Zadanie w trakcie -->
    <div class="callout warning">
        <h4><span class="fi-loop"></span> Zadanie w trakcie wykonywania</h4>

        {% if info %}
            <div class="progress large" role="progressbar"
                 aria-valuenow="{{ info.progress|default:0|floatformat:0 }}"
                 aria-valuemin="0" aria-valuemax="100">
                <div class="progress-meter"
                     style="width: {{ info.progress|default:0|floatformat:0 }}%">
                    <p class="progress-meter-text">{{ info.progress|default:0|floatformat:0 }}%</p>
                </div>
            </div>

            <p><strong>Aktualny krok:</strong>
                {% if info.step == "validation" %}
                    <span class="fi-check"></span> Walidacja dyscyplin
                {% elif info.step == "snapshot" %}
                    <span class="fi-camera"></span> Tworzenie snapshotu
                {% elif info.step == "unpinning" %}
                    <span class="fi-unlock"></span> Odpinanie slotów
                {% elif info.step == "denorm" %}
                    <span class="fi-refresh"></span> Przeliczanie punktacji
                {% elif info.step == "optimization" %}
                    <span class="fi-target-two"></span> Przeliczanie optymalizacji
                {% elif info.step == "finalizing" %}
                    <span class="fi-database"></span> Finalizowanie zapisów do bazy danych...
                {% else %}
                    {{ info.step }}
                {% endif %}
            </p>

            {% if info.message %}
                <p><em>{{ info.message }}</em></p>
            {% endif %}

            {% if info.step == "unpinning" and info.total_batches %}
                <h5>Status odpinania:</h5>
                <table style="width: 100%; margin-bottom: 1rem;">
                    <tbody>
                        <tr>
                            <td><strong>Faza:</strong></td>
                            <td>
                                {% if info.unpinning_phase == "ciagle" %}
                                    Wydawnictwa ciągłe
                                {% elif info.unpinning_phase == "zwarte" %}
                                    Wydawnictwa zwarte
                                {% else %}
                                    {{ info.unpinning_phase }}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Porcja:</strong></td>
                            <td>
                                <span class="label warning">
                                    {{ info.current_batch }} / {{ info.total_batches }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Odpiętych w tej fazie:</strong></td>
                            <td>{{ info.unpinned_so_far|intcomma }} / {{ info.total_to_unpin|intcomma }}</td>
                        </tr>
                        {% if info.total_batches_all %}
                        <tr>
                            <td><strong>Łącznie porcji:</strong></td>
                            <td>
                                <span class="label secondary">
                                    {{ info.batches_processed_all }} / {{ info.total_batches_all }}
                                </span>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
                {% if info.eta_formatted %}
                <p><strong><span class="fi-clock"></span> Szacowany czas:</strong> ~{{ info.eta_formatted }}</p>
                {% endif %}
            {% endif %}

            {% if info.total_pinned_ciagle or info.total_pinned_zwarte %}
                <h5>Podsumowanie odpinania:</h5>
                <table style="width: 100%; margin-bottom: 1rem;">
                    <thead>
                        <tr>
                            <th>Typ</th>
                            <th>Początkowo przypiętych</th>
                            <th>Obecnie przypiętych</th>
                            <th>Odpiętych</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if info.total_pinned_ciagle %}
                        <tr>
                            <td>Wydawnictwa ciągłe</td>
                            <td>{{ info.total_pinned_ciagle|intcomma }}</td>
                            <td>{{ info.current_pinned_ciagle|default:info.total_pinned_ciagle|intcomma }}</td>
                            <td>
                                {% if info.unpinned_ciagle %}
                                    <span class="label success">{{ info.unpinned_ciagle|intcomma }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% if info.total_pinned_zwarte %}
                        <tr>
                            <td>Wydawnictwa zwarte</td>
                            <td>{{ info.total_pinned_zwarte|intcomma }}</td>
                            <td>{{ info.current_pinned_zwarte|default:info.total_pinned_zwarte|intcomma }}</td>
                            <td>
                                {% if info.unpinned_zwarte %}
                                    <span class="label success">{{ info.unpinned_zwarte|intcomma }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            {% endif %}

            {% if info.dirty_count %}
                <p><strong>Rekordów do przeliczenia:</strong> {{ info.dirty_count|intcomma }}</p>
            {% endif %}

            {% if info.step == "optimization" and info.total_optimizations %}
                <h5>Status przeliczania optymalizacji:</h5>
                <p>
                    <strong>Ukończono:</strong>
                    <span class="label {% if info.completed_optimizations == info.total_optimizations %}success{% else %}warning{% endif %}">
                        {{ info.completed_optimizations|default:0 }} / {{ info.total_optimizations }}
                    </span>
                </p>
                {% if info.running_optimizations %}
                    <p><strong>W trakcie:</strong> <span class="label secondary">{{ info.running_optimizations }}</span></p>
                {% endif %}
            {% endif %}
        {% endif %}

        <!-- Stan kolejki denormalizacji -->
        <p id="denorm-status" hx-get="{% url 'stan_systemu:ilosc_obiektow_w_denorm_queue' %}"
           hx-trigger="every 5s">
            Sprawdzanie kolejki przeliczania...
        </p>

        <p><em>Status odświeża się automatycznie co 5 sekund.</em></p>
    </div>

{% elif success %}
    <!-- Zadanie zakończone pomyślnie - automatyczne przekierowanie -->
    <div class="callout success" hx-get="{% url 'ewaluacja_optymalizacja:index' %}" hx-trigger="load delay:2s" hx-swap="none">
        <h4><span class="fi-check"></span> Optymalizacja zakończona pomyślnie!</h4>

        <p><em>Przekierowanie za 2 sekundy...</em></p>

        {% if result %}
            <h5>Podsumowanie:</h5>
            <ul>
                <li><strong>Uczelnia:</strong> {{ result.uczelnia_nazwa }}</li>
                <li><strong>Snapshot ID:</strong> {{ result.snapshot_id }}</li>
                <li><strong>Odpięte wydawnictwa ciągłe:</strong> {{ result.unpinned_ciagle|intcomma }}</li>
                <li><strong>Odpięte wydawnictwa zwarte:</strong> {{ result.unpinned_zwarte|intcomma }}</li>
                <li><strong>Łącznie odpiętych:</strong> {{ result.unpinned_total|intcomma }}</li>
            </ul>

            <div class="row">
                <div class="medium-6 columns">
                    <div class="callout secondary">
                        <h5>Przed optymalizacją:</h5>
                        <p><strong>Punkty:</strong> {{ result.points_before|floatformat:2|intcomma }}</p>
                        <p><strong>Sloty:</strong> {{ result.slots_before|floatformat:2|intcomma }}</p>
                    </div>
                </div>
                <div class="medium-6 columns">
                    <div class="callout primary">
                        <h5>Po optymalizacji:</h5>
                        <p><strong>Punkty:</strong> {{ result.points_after|floatformat:2|intcomma }}</p>
                        <p><strong>Sloty:</strong> {{ result.slots_after|floatformat:2|intcomma }}</p>
                    </div>
                </div>
            </div>

            <div class="callout warning">
                <p><span class="fi-info"></span> <strong>Ważne:</strong>
                Utworzono snapshot nr {{ result.snapshot_id }} przed zmianami.
                W razie potrzeby możesz go przywrócić w module
                <a href="/snapshot_odpiec/">Snapshoty odpięć</a>.</p>
            </div>
        {% endif %}
    </div>

    <script>
        // Przekieruj za 2 sekundy
        setTimeout(function() {
            window.location.href = "{% url 'ewaluacja_optymalizacja:index' %}";
        }, 2000);
    </script>

{% else %}
    <!-- Zadanie zakończone z błędem -->
    <div class="callout alert">
        <h4><span class="fi-x"></span> Wystąpił błąd</h4>
        {% if error %}
            <pre>{{ error }}</pre>
        {% else %}
            <p>Nieznany błąd. Sprawdź logi systemowe.</p>
        {% endif %}
    </div>
{% endif %}

<!-- Zatrzymaj polling jeśli zadanie jest gotowe -->
{% if task_ready %}
<script>
    // Zatrzymaj HTMX polling na progress-container
    var container = document.getElementById('progress-container');
    if (container) {
        // Usuń atrybut hx-trigger żeby zatrzymać polling
        container.removeAttribute('hx-trigger');
    }
</script>
{% endif %}
