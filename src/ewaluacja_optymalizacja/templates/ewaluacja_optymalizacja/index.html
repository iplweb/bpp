{% extends "base.html" %}
{% load humanize %}

{% block title %}Optymalizacja ewaluacji{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="/">Strona główna</a></li>
    <li class="current">Optymalizacja ewaluacji</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1>
            <span class="fi-target-two"></span> Optymalizacja ewaluacji
        </h1>

        {% if liczba_n_count == 0 %}
        <div class="callout alert">
            <h4><span class="fi-alert"></span> Brak danych liczby N!</h4>
            <p>Przed uruchomieniem optymalizacji musisz najpierw policzyć liczbę N dla uczelni.</p>
            <p>
                <a href="/ewaluacja_liczba_n/" class="button warning">
                    <span class="fi-graph-bar"></span> Przejdź do modułu Liczba N
                </a>
                lub uruchom polecenie: <code>python src/manage.py przelicz_n</code>
            </p>
        </div>
        {% elif liczba_n_raportowane == 0 %}
        <div class="callout warning">
            <h4><span class="fi-info"></span> Brak dyscyplin raportowanych</h4>
            <p>Znaleziono {{ liczba_n_count }} dyscyplin z danymi liczby N, ale żadna nie ma liczby N >= 12.</p>
            <p>Optymalizacja działa tylko dla dyscyplin raportowanych (liczba N >= 12).</p>
        </div>
        {% else %}
        <div class="callout success">
            <h4><span class="fi-check"></span> Gotowe do optymalizacji</h4>
            <p>Znaleziono <strong>{{ liczba_n_raportowane }}</strong> dyscyplin raportowanych (liczba N >= 12) z {{ liczba_n_count }} łącznie.</p>
        </div>
        {% endif %}

        <div class="button-group">
            <a href="{% url 'ewaluacja_optymalizacja:run-list' %}" class="button">
                <span class="fi-list"></span> Wszystkie kalkulacje
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:discipline-comparison' %}" class="button secondary">
                <span class="fi-graph-bar"></span> Porównanie dyscyplin
            </a>
            <a href="{% url 'ewaluacja_dwudyscyplinowcy:index' %}" class="button secondary">
                <span class="fi-torsos-all"></span> Dwudyscyplinowcy
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:database-verification' %}"
               class="button {% if has_problematic_slots %}alert{% else %}success{% endif %}">
                <span class="fi-magnifying-glass"></span> Weryfikacja bazy danych
            </a>
        </div>

        <div class="button-group" style="margin-top: 0.5rem;">
            <a href="/snapshot_odpiec/" class="button secondary">
                <span class="fi-camera"></span> Snapshoty odpięć
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:unpinning-list' %}"
               class="button info{% if dirty_count > 0 %} disabled{% endif %}"
               id="optymalizuj-przed-btn"
               {% if dirty_count > 0 %}onclick="event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;"{% endif %}>
                <span class="fi-zoom-in"></span> Optymalizuj przed
            </a>
            {% if status_bulk.w_trakcie and status_bulk.task_id and status_bulk.uczelnia %}
            <a href="{% url 'ewaluacja_optymalizacja:bulk-status' uczelnia_id=status_bulk.uczelnia.pk task_id=status_bulk.task_id %}"
               class="button warning">
                <span class="fi-loop"></span> Zobacz status ewaluacji
            </a>
            {% else %}
            <button form="bulk-optimization-form" type="submit" class="button warning{% if dirty_count > 0 %} disabled{% endif %}"
                    {% if dirty_count > 0 %}disabled{% endif %}
                    onclick="{% if dirty_count > 0 %}event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;{% else %}return confirm('Czy na pewno chcesz uruchomić optymalizację dla WSZYSTKICH dyscyplin raportowanych (>= 12 slotów)? Proces może potrwać kilka do kilkunastu minut.');{% endif %}">
                <span class="fi-play"></span> Policz całą ewaluację
            </button>
            {% endif %}
            {% if status_odpinania.w_trakcie and status_odpinania.task_id %}
            <a href="{% url 'ewaluacja_optymalizacja:optimize-unpin-status' task_id=status_odpinania.task_id %}"
               class="button success">
                <span class="fi-loop"></span> Zobacz status optymalizacji
            </a>
            {% else %}
            <a href="{% url 'ewaluacja_optymalizacja:optimize-unpin' %}"
               class="button success{% if dirty_count > 0 %} disabled{% endif %}"
               {% if dirty_count > 0 %}onclick="event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;"{% else %}onclick="return confirm('Czy na pewno chcesz zastosować optymalizację i odpiąć niepotrzebne sloty? Ta operacja:\n\n1. Sprawdzi czy wszystkie dyscypliny są przeliczone\n2. Utworzy snapshot obecnego stanu\n3. Odpnie dyscypliny w pracach niewykazanych do ewaluacji\n4. Automatycznie przeliczy punktację\n5. Przeliczy optymalizację dla wszystkich dyscyplin\n\nProces może potrwać 20-30 minut w zależności od liczby dyscyplin.');"{% endif %}>
                <span class="fi-unlock"></span> Optymalizuj, odpinając sloty
            </a>
            {% endif %}
        </div>

        <form id="bulk-optimization-form" method="POST" action="{% url 'ewaluacja_optymalizacja:bulk-start' %}">
            {% csrf_token %}
            <fieldset style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 3px; margin-top: 1rem;">
                <legend style="font-weight: bold; padding: 0 0.5rem;">Konfiguracja solvera:</legend>
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" id="algo-two-phase" name="algorithm_mode" value="two-phase" checked>
                    <label for="algo-two-phase" style="display: inline; margin-right: 1rem;">
                        <strong>Dwufazowy</strong> - najpierw per-autor, potem instytucja
                    </label>
                </div>
                <div>
                    <input type="radio" id="algo-single-phase" name="algorithm_mode" value="single-phase">
                    <label for="algo-single-phase" style="display: inline;">
                        <strong>Jednofazowy</strong> - wszystkie ograniczenia od razu
                    </label>
                </div>
            </fieldset>
        </form>

        <!-- Progress bar dla denormalizacji -->
        <div id="denorm-progress-container"
             hx-get="{% url 'ewaluacja_optymalizacja:denorm-progress' %}"
             hx-trigger="load, every 5s"
             hx-swap="innerHTML"
             data-initial-count="">
            <p><em>Sprawdzanie stanu przeliczania...</em></p>
        </div>

        <script>
        (function() {
            const container = document.getElementById('denorm-progress-container');
            const baseUrl = "{% url 'ewaluacja_optymalizacja:denorm-progress' %}";
            const flushUrl = "{% url 'ewaluacja_optymalizacja:trigger-denorm-flush' %}";
            const csrfToken = "{{ csrf_token }}";

            // Zmienne do śledzenia "zawieszonego" denorm
            let lastDirtyCount = null;
            let stuckSince = null;
            let lastFlushTriggered = null;

            // Funkcja aktywująca przyciski
            function enableButtons() {
                // Przyciski "Policz całą ewaluację"
                const bulkOptButton = document.querySelector('button[type="submit"][class*="warning"]');
                if (bulkOptButton) {
                    bulkOptButton.classList.remove('disabled');
                    bulkOptButton.removeAttribute('disabled');
                    bulkOptButton.setAttribute('onclick',
                        "return confirm('Czy na pewno chcesz uruchomić optymalizację dla WSZYSTKICH dyscyplin raportowanych (>= 12 slotów)? Proces może potrwać kilka do kilkunastu minut.');");
                }

                // Przycisk "Optymalizuj przed"
                const optymalizujPrzedBtn = document.getElementById('optymalizuj-przed-btn');
                if (optymalizujPrzedBtn) {
                    optymalizujPrzedBtn.classList.remove('disabled');
                    optymalizujPrzedBtn.onclick = null;
                }

                // Przycisk "Optymalizuj, odpinając sloty" - tylko jeśli to przycisk start (nie status)
                const unpinButton = document.querySelector('a[href*="optimize-unpin"] .fi-unlock');
                if (unpinButton) {
                    const link = unpinButton.parentElement;
                    link.classList.remove('disabled');
                    link.removeAttribute('onclick');
                    link.setAttribute('onclick',
                        "return confirm('Czy na pewno chcesz zastosować optymalizację i odpiąć niepotrzebne sloty? Ta operacja:\\n\\n1. Sprawdzi czy wszystkie dyscypliny są przeliczone\\n2. Utworzy snapshot obecnego stanu\\n3. Odpnie dyscypliny w pracach niewykazanych do ewaluacji\\n4. Automatycznie przeliczy punktację\\n5. Przeliczy optymalizację dla wszystkich dyscyplin\\n\\nProces może potrwać 20-30 minut w zależności od liczby dyscyplin.');");
                }
            }

            // Po każdym załadowaniu, zachowaj initial_count i sprawdź czy aktywować przyciski
            document.addEventListener('htmx:afterSwap', function(evt) {
                if (evt.detail.target.id !== 'denorm-progress-container') return;

                // Sprawdź czy mamy data-dirty-count w odpowiedzi
                // Atrybut jest w pierwszym divie wewnątrz containera (innerHTML swap)
                const innerDiv = container.querySelector('div[data-dirty-count]');
                const dirtyAttr = innerDiv ? innerDiv.getAttribute('data-dirty-count') : null;
                const initialAttr = container.getAttribute('data-initial-count');

                // Jeśli nie mamy jeszcze initial i mamy dirty > 0, ustaw initial
                if ((!initialAttr || initialAttr === '') && dirtyAttr && parseInt(dirtyAttr) > 0) {
                    container.setAttribute('data-initial-count', dirtyAttr);
                }

                // Zaktualizuj URL dla następnych requestów
                const initial = container.getAttribute('data-initial-count');
                if (initial && initial !== '') {
                    container.setAttribute('hx-get', baseUrl + '?initial=' + initial);
                }

                // Jeśli dirty_count spadł do 0, aktywuj przyciski
                if (dirtyAttr && parseInt(dirtyAttr) === 0) {
                    enableButtons();
                    // Reset zmiennych śledzenia
                    lastDirtyCount = null;
                    stuckSince = null;
                }

                // Wykrywanie "zawieszonego" denorm i automatyczne wyzwalanie flush
                const currentDirty = dirtyAttr ? parseInt(dirtyAttr) : 0;

                if (currentDirty > 0) {
                    const now = Date.now();

                    // Sprawdź czy liczba się nie zmieniła (denorm zawieszony)
                    if (lastDirtyCount !== null && currentDirty === lastDirtyCount) {
                        // Liczba nie zmieniła się od ostatniego sprawdzenia
                        if (stuckSince === null) {
                            stuckSince = now;
                        } else if (now - stuckSince >= 15000) {
                            // Zawieszony przez 15+ sekund
                            // Sprawdź czy możemy wywołać flush (30s cooldown)
                            if (lastFlushTriggered === null || now - lastFlushTriggered >= 30000) {
                                // Wywołaj flush
                                console.log('Denorm zawieszony - wywołuję flush_via_queue');
                                fetch(flushUrl, {
                                    method: "POST",
                                    headers: {
                                        "X-CSRFToken": csrfToken
                                    }
                                });
                                lastFlushTriggered = now;
                                stuckSince = null; // Reset timera zawieszenia
                            }
                        }
                    } else {
                        // Liczba się zmieniła - reset timera zawieszenia
                        stuckSince = null;
                    }

                    lastDirtyCount = currentDirty;
                } else {
                    // Reset gdy nie ma dirty instances
                    lastDirtyCount = null;
                    stuckSince = null;
                }
            });
        })();
        </script>

        {% if optimization_runs %}
        <h2>Ostatnie kalkulacje</h2>
        <table>
            <thead>
                <tr>
                    <th>Dyscyplina</th>
                    <th>3*N</th>
                    <th>Obliczono</th>
                    <th>Status</th>
                    <th>Punkty</th>
                    <th>Publikacje</th>
                    <th>Sloty</th>
                    <th>Sloty %</th>
                    <th>LOW-MONO %</th>
                    <th>Sloty poza N %</th>
                    <th>Przypięte</th>
                    <th>Odpięte</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for run in optimization_runs|slice:":10" %}
                <tr>
                    <td>{{ run.dyscyplina_naukowa.nazwa }}</td>
                    <td>{% if run.liczba_3n is not None %}{{ run.liczba_3n|floatformat:0 }}{% else %}-{% endif %}</td>
                    <td>{{ run.started_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if run.status == "completed" %}
                            <span class="label success">Zakończono</span>
                        {% elif run.status == "running" %}
                            <span class="label warning">W trakcie</span>
                        {% else %}
                            <span class="label alert">Błąd</span>
                        {% endif %}
                    </td>
                    <td>{{ run.total_points|floatformat:2 }}</td>
                    <td>{{ run.total_publications }}</td>
                    <td>{{ run.total_slots|floatformat:2 }}</td>
                    <td>{% if run.slots_fill_pct is not None %}{{ run.slots_fill_pct|floatformat:1 }}%{% else %}-{% endif %}</td>
                    <td>{{ run.low_mono_percentage|floatformat:1 }}%</td>
                    <td>{{ run.outside_n_slots_pct|floatformat:1 }}%</td>
                    <td>
                        {{ run.pin_stats.pinned }} ({{ run.pin_stats.pinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        {{ run.pin_stats.unpinned }} ({{ run.pin_stats.unpinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        <a href="{% url 'ewaluacja_optymalizacja:run-detail' run.pk %}" class="button tiny">
                            Zobacz szczegóły
                        </a>
                        {% if run.pin_stats.unpinned > 0 %}
                        <a href="{% url 'ewaluacja_optymalizacja:reset-discipline-pins' run.dyscyplina_naukowa.pk %}"
                           class="button tiny warning"
                           onclick="return confirm('Czy na pewno chcesz zresetować przypięcia dla dyscypliny \'{{ run.dyscyplina_naukowa.nazwa }}\'?\n\nTa operacja:\n1. Utworzy snapshot obecnego stanu\n2. Ustawi przypieta=True dla wszystkich {{ run.pin_stats.total }} rekordów z lat 2022-2025\n3. Automatycznie przeliczy punktację\n\nProces może potrwać kilka minut.');">
                            <span class="fi-refresh"></span> Resetuj przypięcia
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% if optimization_runs|slice:":10"|length > 1 %}
            <tfoot>
                <tr style="font-weight: bold; background-color: #f4f4f4; border-top: 2px solid #333;">
                    <td><strong>RAZEM</strong></td>
                    <td>{% if summary.total_3n > 0 %}{{ summary.total_3n|floatformat:0 }}{% else %}-{% endif %}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>{{ summary.total_points|floatformat:2 }}</td>
                    <td>{{ summary.total_publications }}</td>
                    <td>{{ summary.total_slots|floatformat:2 }}</td>
                    <td>{% if summary.avg_slots_fill_pct > 0 %}{{ summary.avg_slots_fill_pct|floatformat:1 }}%{% else %}-{% endif %}</td>
                    <td>{{ summary.avg_low_mono_pct|floatformat:1 }}%</td>
                    <td>{{ summary.avg_outside_n_pct|floatformat:1 }}%</td>
                    <td>
                        {{ summary.total_pinned }} ({{ summary.pinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        {{ summary.total_unpinned }} ({{ summary.unpinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        {% if summary.total_unpinned > 0 %}
                        <a href="{% url 'ewaluacja_optymalizacja:reset-all-pins' %}"
                           class="button tiny warning"
                           onclick="return confirm('Czy na pewno chcesz zresetować przypięcia dla WSZYSTKICH dyscyplin?\n\nTa operacja:\n1. Utworzy snapshot obecnego stanu\n2. Ustawi przypieta=True dla wszystkich rekordów z lat 2022-2025\n3. Dotyczy autorów którzy mają dyscyplinę, są zatrudnieni i afiliują\n4. Automatycznie przeliczy punktację\n\nProces może potrwać kilkanaście minut.');">
                            <span class="fi-refresh"></span> Resetuj przypięcia
                        </a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
        {% else %}
        <div class="callout warning">
            <p>Brak wykonanych optymalizacji. Uruchom polecenie <code>python src/manage.py solve_evaluation &lt;dyscyplina&gt;</code>
            aby utworzyć pierwszą optymalizację.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
