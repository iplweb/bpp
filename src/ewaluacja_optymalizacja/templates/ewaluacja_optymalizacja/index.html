{% extends "base.html" %}
{% load humanize %}

{% block title %}Optymalizacja ewaluacji{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="/">Strona główna</a></li>
    <li class="current">Optymalizacja ewaluacji</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1>
            <span class="fi-target-two"></span> Optymalizacja ewaluacji
        </h1>

        {% if liczba_n_count == 0 %}
        <div class="callout alert">
            <h4><span class="fi-alert"></span> Brak danych liczby N!</h4>
            <p>Przed uruchomieniem optymalizacji musisz najpierw policzyć liczbę N dla uczelni.</p>
            <p>
                <a href="/ewaluacja_liczba_n/" class="button warning">
                    <span class="fi-graph-bar"></span> Przejdź do modułu Liczba N
                </a>
                lub uruchom polecenie: <code>python src/manage.py przelicz_n</code>
            </p>
        </div>
        {% elif liczba_n_raportowane == 0 %}
        <div class="callout warning">
            <h4><span class="fi-info"></span> Brak dyscyplin raportowanych</h4>
            <p>Znaleziono {{ liczba_n_count }} dyscyplin z danymi liczby N, ale żadna nie ma liczby N >= 12.</p>
            <p>Optymalizacja działa tylko dla dyscyplin raportowanych (liczba N >= 12).</p>
        </div>
        {% else %}
        <div class="callout success">
            <h4><span class="fi-check"></span> Gotowe do optymalizacji</h4>
            <p>Znaleziono <strong>{{ liczba_n_raportowane }}</strong> dyscyplin raportowanych (liczba N >= 12) z {{ liczba_n_count }} łącznie.</p>
        </div>
        {% endif %}

        {% if unpinning_analysis_running %}
        <div class="callout warning" id="unpinning-analysis-callout" style="margin-top: 1rem;">
            <h5><span class="fi-loop"></span> Trwa analiza "Optymalizuj przed"</h5>
            <p>
                Przyciski "Policz cala ewaluacje" i "Optymalizuj, odpinajac sloty" sa zablokowane
                do momentu zakonczenia analizy mozliwosci odpinania.
            </p>
            <a href="{% url 'ewaluacja_optymalizacja:unpinning-combined-status' unpinning_task_id %}" class="button small">
                <span class="fi-eye"></span> Zobacz status analizy
            </a>
        </div>
        {% endif %}

        <div class="button-group">
            <a href="{% url 'ewaluacja_optymalizacja:run-list' %}" class="button">
                <span class="fi-list"></span> Wszystkie kalkulacje
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:discipline-comparison' %}" class="button secondary">
                <span class="fi-graph-bar"></span> Porównanie dyscyplin
            </a>
            <a href="{% url 'ewaluacja_dwudyscyplinowcy:index' %}" class="button secondary">
                <span class="fi-torsos-all"></span> Dwudyscyplinowcy
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:database-verification' %}"
               class="button {% if has_problematic_slots %}alert{% else %}success{% endif %}">
                <span class="fi-magnifying-glass"></span> Weryfikacja bazy danych
            </a>
        </div>

        <div class="button-group" style="margin-top: 0.5rem;">
            <a href="/snapshot_odpiec/" class="button secondary">
                <span class="fi-camera"></span> Snapshoty odpięć
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:unpinning-list' %}"
               class="button info{% if dirty_count > 0 %} disabled{% endif %}"
               id="optymalizuj-przed-btn"
               {% if dirty_count > 0 %}onclick="event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;"{% endif %}>
                <span class="fi-zoom-in"></span> Optymalizuj przed
            </a>
            {% if status_bulk.w_trakcie and status_bulk.task_id and status_bulk.uczelnia %}
            <a href="{% url 'ewaluacja_optymalizacja:bulk-status' uczelnia_id=status_bulk.uczelnia.pk task_id=status_bulk.task_id %}"
               class="button warning">
                <span class="fi-loop"></span> Zobacz status ewaluacji
            </a>
            {% else %}
            <button form="bulk-optimization-form" type="submit" class="button warning{% if dirty_count > 0 or unpinning_analysis_running %} disabled{% endif %}"
                    id="bulk-optimization-btn"
                    {% if dirty_count > 0 or unpinning_analysis_running %}disabled{% endif %}
                    onclick="{% if dirty_count > 0 %}event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;{% elif unpinning_analysis_running %}event.preventDefault(); alert('Trwa analiza Optymalizuj przed. Poczekaj na zakonczenie.'); return false;{% else %}return confirm('Czy na pewno chcesz uruchomić optymalizację dla WSZYSTKICH dyscyplin raportowanych (>= 12 slotów)? Proces może potrwać kilka do kilkunastu minut.');{% endif %}">
                <span class="fi-play"></span> Policz cala ewaluacje
            </button>
            {% endif %}
            {% if status_odpinania.w_trakcie and status_odpinania.task_id %}
            <a href="{% url 'ewaluacja_optymalizacja:optimize-unpin-status' task_id=status_odpinania.task_id %}"
               class="button success">
                <span class="fi-loop"></span> Zobacz status optymalizacji
            </a>
            {% else %}
            <a href="{% url 'ewaluacja_optymalizacja:optimize-unpin' %}"
               class="button success{% if dirty_count > 0 or unpinning_analysis_running %} disabled{% endif %}"
               id="optimize-unpin-btn"
               {% if dirty_count > 0 %}onclick="event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;"{% elif unpinning_analysis_running %}onclick="event.preventDefault(); alert('Trwa analiza Optymalizuj przed. Poczekaj na zakonczenie.'); return false;"{% else %}onclick="return confirm('Czy na pewno chcesz zastosować optymalizację i odpiąć niepotrzebne sloty? Ta operacja:\n\n1. Sprawdzi czy wszystkie dyscypliny są przeliczone\n2. Utworzy snapshot obecnego stanu\n3. Odpnie dyscypliny w pracach niewykazanych do ewaluacji\n4. Automatycznie przeliczy punktację\n5. Przeliczy optymalizację dla wszystkich dyscyplin\n\nProces może potrwać 20-30 minut w zależności od liczby dyscyplin.');"{% endif %}>
                <span class="fi-unlock"></span> Optymalizuj, odpinajac sloty
            </a>
            {% endif %}
        </div>

        <div class="button-group" style="margin-top: 0.5rem;">
            {% if optimization_runs and status_bulk.plik_zip_wszystkie_xls %}
            <a href="{% url 'ewaluacja_optymalizacja:export-all-disciplines-zip' %}"
               class="button success">
                <span class="fi-archive"></span> Pobierz wszystkie XLS (ZIP)
            </a>
            {% elif optimization_runs %}
            <span class="button disabled" title="Uruchom 'Policz całą ewaluację' aby wygenerować plik">
                <span class="fi-archive"></span> Pobierz wszystkie XLS (ZIP)
            </span>
            {% endif %}
            {% if optimization_runs %}
            <a href="{% url 'ewaluacja_optymalizacja:export-sedn-report-1' %}"
               class="button secondary">
                <span class="fi-page-export"></span> Raport SEDN #1
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:export-sedn-report-2' %}"
               class="button secondary">
                <span class="fi-page-export"></span> Raport SEDN #2
            </a>
            {% endif %}
        </div>

        <form id="bulk-optimization-form" method="POST" action="{% url 'ewaluacja_optymalizacja:bulk-start' %}">
            {% csrf_token %}
            <fieldset style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 3px; margin-top: 1rem;">
                <legend style="font-weight: bold; padding: 0 0.5rem;">Konfiguracja solvera:</legend>
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" id="algo-two-phase" name="algorithm_mode" value="two-phase" checked>
                    <label for="algo-two-phase" style="display: inline; margin-right: 1rem;">
                        <strong>Dwufazowy</strong> - najpierw per-autor, potem instytucja
                    </label>
                </div>
                <div>
                    <input type="radio" id="algo-single-phase" name="algorithm_mode" value="single-phase">
                    <label for="algo-single-phase" style="display: inline;">
                        <strong>Jednofazowy</strong> - wszystkie ograniczenia od razu
                    </label>
                </div>
            </fieldset>
        </form>

        <!-- Progress bar dla denormalizacji -->
        <div id="denorm-progress-container"
             hx-get="{% url 'ewaluacja_optymalizacja:denorm-progress' %}"
             hx-trigger="load, every 5s"
             hx-swap="innerHTML"
             data-initial-count="">
            <p><em>Sprawdzanie stanu przeliczania...</em></p>
        </div>

        <script>
        (function() {
            const container = document.getElementById('denorm-progress-container');
            const baseUrl = "{% url 'ewaluacja_optymalizacja:denorm-progress' %}";
            const flushUrl = "{% url 'ewaluacja_optymalizacja:trigger-denorm-flush' %}";
            const csrfToken = "{{ csrf_token }}";

            // Zmienne do sledzenia "zawieszonego" denorm
            let lastDirtyCount = null;
            let stuckSince = null;
            let lastFlushTriggered = null;
            let lastUnpinningRunning = {{ unpinning_analysis_running|yesno:'true,false' }};

            // Funkcja aktywujaca przyciski (tylko jezeli oba warunki sa spelnione)
            function enableButtons() {
                // Przycisk "Policz cala ewaluacje"
                const bulkOptButton = document.getElementById('bulk-optimization-btn');
                if (bulkOptButton) {
                    bulkOptButton.classList.remove('disabled');
                    bulkOptButton.removeAttribute('disabled');
                    bulkOptButton.setAttribute('onclick',
                        "return confirm('Czy na pewno chcesz uruchomic optymalizacje dla WSZYSTKICH dyscyplin raportowanych (>= 12 slotow)? Proces moze potrwac kilka do kilkunastu minut.');");
                }

                // Przycisk "Optymalizuj przed"
                const optymalizujPrzedBtn = document.getElementById('optymalizuj-przed-btn');
                if (optymalizujPrzedBtn) {
                    optymalizujPrzedBtn.classList.remove('disabled');
                    optymalizujPrzedBtn.onclick = null;
                }

                // Przycisk "Optymalizuj, odpinajac sloty"
                const optimizeUnpinBtn = document.getElementById('optimize-unpin-btn');
                if (optimizeUnpinBtn) {
                    optimizeUnpinBtn.classList.remove('disabled');
                    optimizeUnpinBtn.setAttribute('onclick',
                        "return confirm('Czy na pewno chcesz zastosowac optymalizacje i odpiac niepotrzebne sloty? Ta operacja:\\n\\n1. Sprawdzi czy wszystkie dyscypliny sa przeliczone\\n2. Utworzy snapshot obecnego stanu\\n3. Odpnie dyscypliny w pracach niewykazanych do ewaluacji\\n4. Automatycznie przeliczy punktacje\\n5. Przeliczy optymalizacje dla wszystkich dyscyplin\\n\\nProces moze potrwac 20-30 minut w zaleznosci od liczby dyscyplin.');");
                }

                // Przyciski "Resetuj przypięcia" (per-dyscyplina i wszystkie)
                const resetPinsBtns = document.querySelectorAll('.reset-pins-btn');
                resetPinsBtns.forEach(function(btn) {
                    btn.classList.remove('disabled');
                    // Przywróć oryginalne onclick z data atrybutu lub ustaw domyślne
                    const href = btn.getAttribute('href');
                    if (href.includes('reset-all-pins')) {
                        btn.setAttribute('onclick',
                            "return confirm('Czy na pewno chcesz zresetowac przypiecia dla WSZYSTKICH dyscyplin?\\n\\nTa operacja:\\n1. Utworzy snapshot obecnego stanu\\n2. Ustawi przypieta=True dla wszystkich rekordow z lat 2022-2025\\n3. Dotyczy autorow ktorzy maja dyscypline, sa zatrudnieni i afiliuja\\n4. Automatycznie przeliczy punktacje\\n\\nProces moze potrwac kilkanascie minut.');");
                    } else {
                        // Dla przycisków per-dyscyplina - potrzebujemy pobrać nazwę dyscypliny z kontekstu
                        // Użyjemy prostszego komunikatu bez nazwy dyscypliny
                        btn.setAttribute('onclick',
                            "return confirm('Czy na pewno chcesz zresetowac przypiecia dla tej dyscypliny?\\n\\nTa operacja:\\n1. Utworzy snapshot obecnego stanu\\n2. Ustawi przypieta=True dla wszystkich rekordow z lat 2022-2025\\n3. Automatycznie przeliczy punktacje\\n\\nProces moze potrwac kilka minut.');");
                    }
                });

                // Ukryj callout o analizie unpinning
                const unpinningCallout = document.getElementById('unpinning-analysis-callout');
                if (unpinningCallout) {
                    unpinningCallout.style.display = 'none';
                }
            }

            // Po kazdym zaladowaniu, zachowaj initial_count i sprawdz czy aktywowac przyciski
            document.addEventListener('htmx:afterSwap', function(evt) {
                if (evt.detail.target.id !== 'denorm-progress-container') return;

                // Sprawdz czy mamy data-dirty-count i data-unpinning-running w odpowiedzi
                const innerDiv = container.querySelector('div[data-dirty-count]');
                const dirtyAttr = innerDiv ? innerDiv.getAttribute('data-dirty-count') : null;
                const unpinningRunningAttr = innerDiv ? innerDiv.getAttribute('data-unpinning-running') : null;
                const initialAttr = container.getAttribute('data-initial-count');

                const currentDirty = dirtyAttr ? parseInt(dirtyAttr) : 0;
                const unpinningRunning = unpinningRunningAttr === 'true';

                // Jesli nie mamy jeszcze initial i mamy dirty > 0, ustaw initial
                if ((!initialAttr || initialAttr === '') && currentDirty > 0) {
                    container.setAttribute('data-initial-count', dirtyAttr);
                }

                // Zaktualizuj URL dla nastepnych requestow
                const initial = container.getAttribute('data-initial-count');
                if (initial && initial !== '') {
                    container.setAttribute('hx-get', baseUrl + '?initial=' + initial);
                }

                // Aktywuj przyciski tylko jezeli:
                // 1. dirty_count == 0 (denorm zakonczony)
                // 2. unpinning_analysis_running == false (analiza zakonczona)
                if (currentDirty === 0 && !unpinningRunning) {
                    enableButtons();
                    // Reset zmiennych sledzenia
                    lastDirtyCount = null;
                    stuckSince = null;
                }

                // Jesli analiza unpinning wlasnie sie zakonczyla, odswiez strone
                if (lastUnpinningRunning && !unpinningRunning) {
                    // Analiza sie zakonczyla - odswiez strone zeby zaktualizowac UI
                    window.location.reload();
                }
                lastUnpinningRunning = unpinningRunning;

                // Wykrywanie "zawieszonego" denorm i automatyczne wyzwalanie flush
                if (currentDirty > 0) {
                    const now = Date.now();

                    // Sprawdz czy liczba sie nie zmienila (denorm zawieszony)
                    if (lastDirtyCount !== null && currentDirty === lastDirtyCount) {
                        // Liczba nie zmienila sie od ostatniego sprawdzenia
                        if (stuckSince === null) {
                            stuckSince = now;
                        } else if (now - stuckSince >= 15000) {
                            // Zawieszony przez 15+ sekund
                            // Sprawdz czy mozemy wywolac flush (30s cooldown)
                            if (lastFlushTriggered === null || now - lastFlushTriggered >= 30000) {
                                // Wywolaj flush
                                console.log('Denorm zawieszony - wywoluje flush_via_queue');
                                fetch(flushUrl, {
                                    method: "POST",
                                    headers: {
                                        "X-CSRFToken": csrfToken
                                    }
                                });
                                lastFlushTriggered = now;
                                stuckSince = null; // Reset timera zawieszenia
                            }
                        }
                    } else {
                        // Liczba sie zmienila - reset timera zawieszenia
                        stuckSince = null;
                    }

                    lastDirtyCount = currentDirty;
                } else {
                    // Reset gdy nie ma dirty instances
                    lastDirtyCount = null;
                    stuckSince = null;
                }
            });
        })();
        </script>

        {% if optimization_runs %}
        {% if status_bulk.data_zakonczenia %}
        <div class="callout secondary" style="margin-bottom: 1rem;">
            <span class="fi-clock"></span> Wyniki wygenerowane: {{ status_bulk.data_zakonczenia|date:"Y-m-d H:i" }}
        </div>
        {% endif %}
        <h2>Ostatnie kalkulacje</h2>
        <table>
            <thead>
                <tr>
                    <th>Dyscyplina</th>
                    <th>3N ost.</th>
                    <th>Obliczono</th>
                    <th>Status</th>
                    <th>Punkty</th>
                    <th>Publikacje</th>
                    <th>Sloty</th>
                    <th>Sloty %</th>
                    <th>LOW-MONO %</th>
                    <th>Sloty poza N %</th>
                    <th>Przypięte</th>
                    <th>Odpięte</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for run in optimization_runs|slice:":10" %}
                <tr>
                    <td>{{ run.dyscyplina_naukowa.nazwa }}</td>
                    <td>{% if run.liczba_3n is not None %}{{ run.liczba_3n|floatformat:0 }}{% else %}-{% endif %}</td>
                    <td>{{ run.started_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if run.status == "completed" %}
                            <span class="label success">Zakończono</span>
                            {% if run.is_optimal %}
                            <span class="label success" title="Rozwiązanie optymalne - solver znalazł najlepszy wynik">
                                <span class="fi-check"></span> opt
                            </span>
                            {% else %}
                            <span class="label warning" title="Rozwiązanie może nie być optymalne (solver przekroczył limit czasu)">
                                <span class="fi-alert"></span>
                            </span>
                            {% endif %}
                        {% elif run.status == "running" %}
                            <span class="label warning">W trakcie</span>
                        {% else %}
                            <span class="label alert">Błąd</span>
                        {% endif %}
                    </td>
                    <td>{{ run.total_points|floatformat:2 }}</td>
                    <td>{{ run.total_publications }}</td>
                    <td>{{ run.total_slots|floatformat:2 }}</td>
                    <td>{% if run.slots_fill_pct is not None %}{{ run.slots_fill_pct|floatformat:1 }}%{% else %}-{% endif %}</td>
                    <td>{{ run.low_mono_percentage|floatformat:1 }}%</td>
                    <td>{{ run.outside_n_slots_pct|floatformat:1 }}%</td>
                    <td>
                        {{ run.pin_stats.pinned }} ({{ run.pin_stats.pinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        {{ run.pin_stats.unpinned }} ({{ run.pin_stats.unpinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        <a href="{% url 'ewaluacja_optymalizacja:run-detail' run.pk %}" class="button tiny">
                            Zobacz szczegóły
                        </a>
                        {% if run.pin_stats.unpinned > 0 %}
                        <a href="{% url 'ewaluacja_optymalizacja:reset-discipline-pins' run.dyscyplina_naukowa.pk %}"
                           class="button tiny warning reset-pins-btn{% if dirty_count > 0 %} disabled{% endif %}"
                           {% if dirty_count > 0 %}onclick="event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;"{% else %}onclick="return confirm('Czy na pewno chcesz zresetować przypięcia dla dyscypliny \'{{ run.dyscyplina_naukowa.nazwa }}\'?\n\nTa operacja:\n1. Utworzy snapshot obecnego stanu\n2. Ustawi przypieta=True dla wszystkich {{ run.pin_stats.total }} rekordów z lat 2022-2025\n3. Automatycznie przeliczy punktację\n\nProces może potrwać kilka minut.');"{% endif %}>
                            <span class="fi-refresh"></span> Resetuj przypięcia
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% if optimization_runs|slice:":10"|length > 1 %}
            <tfoot>
                <tr style="font-weight: bold; background-color: #f4f4f4; border-top: 2px solid #333;">
                    <td><strong>RAZEM</strong></td>
                    <td>{% if summary.total_3n > 0 %}{{ summary.total_3n|floatformat:0 }}{% else %}-{% endif %}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>{{ summary.total_points|floatformat:2 }}</td>
                    <td>{{ summary.total_publications }}</td>
                    <td>{{ summary.total_slots|floatformat:2 }}</td>
                    <td>{% if summary.avg_slots_fill_pct > 0 %}{{ summary.avg_slots_fill_pct|floatformat:1 }}%{% else %}-{% endif %}</td>
                    <td>{{ summary.avg_low_mono_pct|floatformat:1 }}%</td>
                    <td>{{ summary.avg_outside_n_pct|floatformat:1 }}%</td>
                    <td>
                        {{ summary.total_pinned }} ({{ summary.pinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        {{ summary.total_unpinned }} ({{ summary.unpinned_pct|floatformat:1 }}%)
                    </td>
                    <td>
                        {% if summary.total_unpinned > 0 %}
                        <a href="{% url 'ewaluacja_optymalizacja:reset-all-pins' %}"
                           class="button tiny warning reset-pins-btn{% if dirty_count > 0 %} disabled{% endif %}"
                           id="reset-all-pins-btn"
                           {% if dirty_count > 0 %}onclick="event.preventDefault(); alert('Czekamy na przeliczenie punktów. Obecnie jest {{ dirty_count }} rekordów do przeliczenia.'); return false;"{% else %}onclick="return confirm('Czy na pewno chcesz zresetować przypięcia dla WSZYSTKICH dyscyplin?\n\nTa operacja:\n1. Utworzy snapshot obecnego stanu\n2. Ustawi przypieta=True dla wszystkich rekordów z lat 2022-2025\n3. Dotyczy autorów którzy mają dyscyplinę, są zatrudnieni i afiliują\n4. Automatycznie przeliczy punktację\n\nProces może potrwać kilkanaście minut.');"{% endif %}>
                            <span class="fi-refresh"></span> Resetuj przypięcia
                        </a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
        {% else %}
        <div class="callout warning">
            <p>Brak wykonanych optymalizacji. Uruchom polecenie <code>python src/manage.py solve_evaluation &lt;dyscyplina&gt;</code>
            aby utworzyć pierwszą optymalizację.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
