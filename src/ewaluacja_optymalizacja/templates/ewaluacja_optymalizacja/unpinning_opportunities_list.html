{% extends "base.html" %}
{% load humanize %}

{% block title %}Możliwości odpinania prac wieloautorskich{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="{% url 'ewaluacja_optymalizacja:index' %}">Optymalizacja ewaluacji</a></li>
    <li class="current">Możliwości odpinania</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1>
            <span class="fi-list"></span> Możliwości odpinania prac wieloautorskich
        </h1>

        <div class="callout">
            <h4><span class="fi-info"></span> Informacja</h4>
            <p>
                Ta analiza identyfikuje prace wieloautorskie gdzie:
            </p>
            <ul>
                <li><strong>Autor A</strong>: praca <strong>NIE weszła</strong> do zebranych prac (algorytm plecakowy nie wybrał)
                    <strong>i</strong> ma PEŁNE sloty (≥80% wykorzystania)</li>
                <li><strong>Autor B</strong>: praca <strong>WESZŁA</strong> do zebranych prac
                    <strong>i</strong> ma miejsce na więcej udziałów</li>
                <li><strong>Odpięcie pracy dla Autora A</strong> umożliwi Autorowi B zwiększenie udziału</li>
            </ul>
            <p>
                <strong>"Sensowne"</strong> oznacza, że odpięcie zwiększy punkty dla Autora B.
                Średnia punktów na slot może spaść, ale całkowita liczba punktów musi wzrosnąć.
            </p>
        </div>

        <div class="button-group">
            <a href="{% url 'ewaluacja_optymalizacja:index' %}" class="button secondary">
                <span class="fi-arrow-left"></span> Powrót
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:analyze-unpinning' %}" class="button">
                <span class="fi-refresh"></span> Przelicz ponownie
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:unpinning-export-xlsx' %}?{% if selected_dyscyplina %}dyscyplina={{ selected_dyscyplina }}&{% endif %}{% if only_sensible %}only_sensible=1{% endif %}" class="button success">
                <span class="fi-page-export-csv"></span> Eksport do Excel
            </a>
            {% if sensible_count > 0 %}
            <a href="{% url 'ewaluacja_optymalizacja:unpin-all-sensible' %}"
               class="button warning"
               onclick="return confirm('Czy na pewno chcesz odpiąć wszystkie sensowne możliwości odpinania?\n\n' +
                   'Ta operacja:\n' +
                   '1. Utworzy snapshot obecnego stanu\n' +
                   '2. Odpnie {{ sensible_count }} rekordów (makes_sense=True)\n' +
                   '3. Poczeka na zakończenie denormalizacji\n' +
                   '4. Przeliczy metryki dla wszystkich autorów\n' +
                   '5. Ponownie uruchomi analizę unpinning\n\n' +
                   'Proces może potrwać 20-30 minut w zależności od liczby dyscyplin.');">
                <span class="fi-unlock"></span> Odepnij wszystkie sensowne ({{ sensible_count }})
            </a>
            {% endif %}
        </div>

        <!-- Statystyki -->
        <div class="callout success" style="margin-top: 1rem;">
            <h5><span class="fi-graph-bar"></span> Statystyki</h5>
            <p>
                Znaleziono <strong>{{ total_count }}</strong> możliwości odpinania,
                w tym <strong>{{ sensible_count }}</strong> sensownych
                (<strong>{{ sensible_count|floatformat:0|default:"0" }}%</strong> z {{ total_count|add:0|default:"1" }}).
            </p>
        </div>

        <!-- Filtry -->
        <form method="GET" action="{% url 'ewaluacja_optymalizacja:unpinning-list' %}">
            <fieldset style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 3px;">
                <legend style="font-weight: bold; padding: 0 0.5rem;">Filtry:</legend>

                <div class="row">
                    <div class="medium-4 columns">
                        <label>Dyscyplina:
                            <select name="dyscyplina">
                                <option value="">Wszystkie</option>
                                {% for d in dyscypliny %}
                                <option value="{{ d.pk }}" {% if selected_dyscyplina == d.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ d.nazwa }}
                                </option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>

                    <div class="medium-4 columns">
                        <label>
                            <input type="checkbox" name="only_sensible" value="1" {% if only_sensible %}checked{% endif %}>
                            Tylko sensowne
                        </label>
                    </div>

                    <div class="medium-4 columns">
                        <button type="submit" class="button small">
                            <span class="fi-filter"></span> Filtruj
                        </button>
                        <a href="{% url 'ewaluacja_optymalizacja:unpinning-list' %}" class="button small secondary">
                            <span class="fi-x"></span> Wyczyść
                        </a>
                    </div>
                </div>
            </fieldset>
        </form>

        {% if opportunities %}
        <table>
            <thead>
                <tr>
                    <th style="width: 20%;">Tytuł pracy</th>
                    <th>Dyscyplina</th>
                    <th>Autor A<br><small>(do odpięcia)</small></th>
                    <th>B może wziąć<br><small>(slotów)</small></th>
                    <th>Slot w<br>pracy</th>
                    <th>Różnica<br>pkt A</th>
                    <th>Różnica<br>slotów A</th>
                    <th>Różnica<br>pkt B</th>
                    <th>Różnica<br>slotów B</th>
                    <th>Autor B<br><small>(skorzysta)</small></th>
                    <th style="text-align: center;">Sensowne?</th>
                </tr>
            </thead>
            <tbody>
                {% for opp in opportunities %}
                <tr {% if opp.makes_sense %}style="background-color: #e7f7e7;"{% endif %}>
                    <td>
                        <a href="{% url 'ewaluacja_optymalizuj_publikacje:optymalizuj' opp.rekord.slug %}">
                            <strong>{{ opp.rekord_tytul|truncatewords:10 }}</strong>
                        </a>
                    </td>
                    <td>{{ opp.dyscyplina_naukowa.nazwa|truncatewords:3 }}</td>
                    <td>
                        <a href="{% url 'ewaluacja_metryki:szczegoly' opp.metryka_could_benefit.autor.slug opp.dyscyplina_naukowa.kod %}">
                            <strong>{{ opp.autor_could_benefit }}</strong>
                        </a><br>
                        <small>
                            Wykorzystanie: {{ opp.metryka_could_benefit.procent_wykorzystania_slotow|floatformat:1 }}%
                            ({{ opp.metryka_could_benefit.slot_nazbierany|floatformat:2 }} / {{ opp.metryka_could_benefit.slot_maksymalny|floatformat:2 }})
                        </small>
                    </td>
                    <td style="text-align: center;">
                        <strong style="font-size: 1.2em; color: #c60;">{{ opp.slots_missing|floatformat:2 }}</strong>
                    </td>
                    <td style="text-align: center;">
                        <strong>{{ opp.slot_in_work|floatformat:2 }}</strong>
                    </td>
                    <td style="text-align: center;">
                        {% if opp.punkty_roznica_a > 0 %}
                            <strong style="color: green;">+{{ opp.punkty_roznica_a|floatformat:2 }}</strong>
                        {% elif opp.punkty_roznica_a < 0 %}
                            <strong style="color: red;">{{ opp.punkty_roznica_a|floatformat:2 }}</strong>
                        {% else %}
                            <strong>0.00</strong>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if opp.sloty_roznica_a > 0 %}
                            <strong style="color: green;">+{{ opp.sloty_roznica_a|floatformat:2 }}</strong>
                        {% elif opp.sloty_roznica_a < 0 %}
                            <strong style="color: red;">{{ opp.sloty_roznica_a|floatformat:2 }}</strong>
                        {% else %}
                            <strong>0.00</strong>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if opp.punkty_roznica_b > 0 %}
                            <strong style="color: green;">+{{ opp.punkty_roznica_b|floatformat:2 }}</strong>
                        {% elif opp.punkty_roznica_b < 0 %}
                            <strong style="color: red;">{{ opp.punkty_roznica_b|floatformat:2 }}</strong>
                        {% else %}
                            <strong>0.00</strong>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if opp.sloty_roznica_b > 0 %}
                            <strong style="color: green;">+{{ opp.sloty_roznica_b|floatformat:2 }}</strong>
                        {% elif opp.sloty_roznica_b < 0 %}
                            <strong style="color: red;">{{ opp.sloty_roznica_b|floatformat:2 }}</strong>
                        {% else %}
                            <strong>0.00</strong>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'ewaluacja_metryki:szczegoly' opp.metryka_currently_using.autor.slug opp.dyscyplina_naukowa.kod %}">
                            <strong>{{ opp.autor_currently_using }}</strong>
                        </a><br>
                        <small>
                            Wykorzystanie: {{ opp.metryka_currently_using.procent_wykorzystania_slotow|floatformat:1 }}%
                            ({{ opp.metryka_currently_using.slot_nazbierany|floatformat:2 }} / {{ opp.metryka_currently_using.slot_maksymalny|floatformat:2 }})
                        </small>
                    </td>
                    <td style="text-align: center;">
                        {% if opp.makes_sense %}
                            <span class="label success"><span class="fi-check"></span> TAK</span>
                        {% else %}
                            <span class="label secondary">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Paginacja -->
        {% if opportunities.has_other_pages %}
        <div class="pagination-centered">
            <ul class="pagination">
                {% if opportunities.has_previous %}
                    <li class="arrow"><a href="?page={{ opportunities.previous_page_number }}{% if selected_dyscyplina %}&dyscyplina={{ selected_dyscyplina }}{% endif %}{% if only_sensible %}&only_sensible=1{% endif %}">«</a></li>
                {% else %}
                    <li class="arrow unavailable"><a href="">«</a></li>
                {% endif %}

                {% for num in opportunities.paginator.page_range %}
                    {% if opportunities.number == num %}
                        <li class="current"><a href="">{{ num }}</a></li>
                    {% elif num > opportunities.number|add:'-3' and num < opportunities.number|add:'3' %}
                        <li><a href="?page={{ num }}{% if selected_dyscyplina %}&dyscyplina={{ selected_dyscyplina }}{% endif %}{% if only_sensible %}&only_sensible=1{% endif %}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if opportunities.has_next %}
                    <li class="arrow"><a href="?page={{ opportunities.next_page_number }}{% if selected_dyscyplina %}&dyscyplina={{ selected_dyscyplina }}{% endif %}{% if only_sensible %}&only_sensible=1{% endif %}">»</a></li>
                {% else %}
                    <li class="arrow unavailable"><a href="">»</a></li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        {% else %}
        <div class="callout warning">
            <p>Nie znaleziono możliwości odpinania dla wybranych filtrów.</p>
            <p>
                <a href="{% url 'ewaluacja_optymalizacja:analyze-unpinning' %}" class="button">
                    <span class="fi-refresh"></span> Uruchom analizę
                </a>
            </p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
