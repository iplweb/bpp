{% extends "base.html" %}
{% load humanize %}

{% block title %}Możliwości odpinania prac wieloautorskich{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="{% url 'ewaluacja_optymalizacja:index' %}">Optymalizacja ewaluacji</a></li>
    <li class="current">Możliwości odpinania</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1>
            <span class="fi-list"></span> Możliwości odpinania prac wieloautorskich
        </h1>

        <div class="callout">
            <h4><span class="fi-info"></span> Informacja</h4>
            <p>
                Ta analiza identyfikuje prace wieloautorskie gdzie:
            </p>
            <ul>
                <li><strong>Autor A</strong>: praca <strong>NIE weszła</strong> do zebranych prac (algorytm plecakowy nie wybrał)
                    <strong>i</strong> ma PEŁNE sloty (≥80% wykorzystania)</li>
                <li><strong>Autor B</strong>: praca <strong>WESZŁA</strong> do zebranych prac
                    <strong>i</strong> ma miejsce na więcej udziałów</li>
                <li><strong>Odpięcie pracy dla Autora A</strong> umożliwi Autorowi B zwiększenie udziału</li>
            </ul>
            <p>
                <strong>"Sensowne"</strong> oznacza, że odpięcie zwiększy punkty dla Autora B.
                Średnia punktów na slot może spaść, ale całkowita liczba punktów musi wzrosnąć.
            </p>
        </div>

        <div class="button-group">
            <a href="{% url 'ewaluacja_optymalizacja:index' %}" class="button secondary">
                <span class="fi-arrow-left"></span> Powrót
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:analyze-unpinning' %}" class="button">
                <span class="fi-refresh"></span> Przelicz ponownie
            </a>
            <a href="{% url 'ewaluacja_optymalizacja:unpinning-export-xlsx' %}?{% if selected_dyscyplina %}dyscyplina={{ selected_dyscyplina }}&{% endif %}{% if selected_punktacja_zrodla %}punktacja_zrodla={{ selected_punktacja_zrodla }}&{% endif %}{% if only_sensible %}only_sensible=1{% endif %}" class="button success">
                <span class="fi-page-export-csv"></span> Eksport do Excel
            </a>
            {% if request.GET.fullwidth %}
            <a href="?{% if selected_dyscyplina %}dyscyplina={{ selected_dyscyplina }}&{% endif %}{% if selected_punktacja_zrodla %}punktacja_zrodla={{ selected_punktacja_zrodla }}&{% endif %}{% if only_sensible %}only_sensible=1&{% endif %}sort_by={{ sort_by }}&sort_dir={{ sort_dir }}" class="button secondary">
                <span class="fi-arrows-compress"></span> Normalna szerokość
            </a>
            {% else %}
            <a href="?{% if selected_dyscyplina %}dyscyplina={{ selected_dyscyplina }}&{% endif %}{% if selected_punktacja_zrodla %}punktacja_zrodla={{ selected_punktacja_zrodla }}&{% endif %}{% if only_sensible %}only_sensible=1&{% endif %}sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&fullwidth=1" class="button secondary">
                <span class="fi-arrows-expand"></span> Pełna szerokość
            </a>
            {% endif %}
            {% if sensible_count > 0 %}
            <a href="{% url 'ewaluacja_optymalizacja:unpin-all-sensible' %}"
               class="button warning"
               onclick="return confirm('Czy na pewno chcesz odpiąć wszystkie sensowne możliwości odpinania?\n\n' +
                   'Ta operacja:\n' +
                   '1. Utworzy snapshot obecnego stanu\n' +
                   '2. Odpnie {{ sensible_count }} rekordów (makes_sense=True)\n' +
                   '3. Poczeka na zakończenie denormalizacji\n' +
                   '4. Przeliczy metryki dla wszystkich autorów\n' +
                   '5. Ponownie uruchomi analizę unpinning\n\n' +
                   'Proces może potrwać 20-30 minut w zależności od liczby dyscyplin.');">
                <span class="fi-unlock"></span> Odepnij wszystkie sensowne ({{ sensible_count }})
            </a>
            {% endif %}
        </div>

        <!-- Statystyki -->
        <div class="callout success" style="margin-top: 1rem;">
            <h5><span class="fi-graph-bar"></span> Statystyki</h5>
            <p>
                Znaleziono <strong>{{ total_count }}</strong> możliwości odpinania,
                w tym <strong>{{ sensible_count }}</strong> sensownych
                (<strong>{{ sensible_percentage|floatformat:1|default:"0" }}%</strong> z {{ total_count }}).
            </p>
        </div>

        {% if status_unpinning.data_zakonczenia %}
        <div class="callout secondary" style="margin-top: 1rem;">
            <span class="fi-clock"></span> Wyniki wygenerowane: {{ status_unpinning.data_zakonczenia|date:"Y-m-d H:i" }}
        </div>
        {% endif %}

        <!-- Filtry -->
        <form method="GET" action="{% url 'ewaluacja_optymalizacja:unpinning-list' %}" id="filterForm">
            <!-- Hidden inputs to preserve sorting when filtering -->
            <input type="hidden" name="sort_by" value="{{ sort_by }}">
            <input type="hidden" name="sort_dir" value="{{ sort_dir }}">
            {% if request.GET.fullwidth %}
            <input type="hidden" name="fullwidth" value="1">
            {% endif %}

            <fieldset style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 3px;">
                <legend style="font-weight: bold; padding: 0 0.5rem;">Filtry:</legend>

                <div class="row">
                    <div class="medium-3 columns">
                        <label>Dyscyplina:
                            <select name="dyscyplina" class="auto-submit-filter">
                                <option value="">Wszystkie</option>
                                {% for d in dyscypliny %}
                                <option value="{{ d.pk }}" {% if selected_dyscyplina == d.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ d.nazwa }}
                                </option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>

                    <div class="medium-3 columns">
                        <label>Punktacja źródła:
                            <select name="punktacja_zrodla" class="auto-submit-filter">
                                <option value="">Wszystkie</option>
                                <option value="0-100" {% if selected_punktacja_zrodla == "0-100" %}selected{% endif %}>0-100 punktów</option>
                                <option value="100-140" {% if selected_punktacja_zrodla == "100-140" %}selected{% endif %}>100-140 punktów</option>
                                <option value="140-200" {% if selected_punktacja_zrodla == "140-200" %}selected{% endif %}>140-200 punktów</option>
                                <option value="200+" {% if selected_punktacja_zrodla == "200+" %}selected{% endif %}>200+ punktów</option>
                            </select>
                        </label>
                    </div>

                    <div class="medium-3 columns">
                        <label>
                            <input type="checkbox" name="only_sensible" value="1" {% if only_sensible %}checked{% endif %} class="auto-submit-filter">
                            Tylko sensowne
                        </label>
                    </div>

                    <div class="medium-3 columns">
                        <button type="submit" class="button small">
                            <span class="fi-filter"></span> Filtruj
                        </button>
                        <a href="{% url 'ewaluacja_optymalizacja:unpinning-list' %}{% if request.GET.fullwidth %}?fullwidth=1{% endif %}" class="button small secondary">
                            <span class="fi-x"></span> Wyczyść
                        </a>
                    </div>
                </div>
            </fieldset>
        </form>

        <script type="text/javascript">
            // Auto-submit filter form when filters change
            document.addEventListener('DOMContentLoaded', function() {
                var filterForm = document.getElementById('filterForm');
                var autoSubmitElements = document.querySelectorAll('.auto-submit-filter');

                autoSubmitElements.forEach(function(element) {
                    element.addEventListener('change', function() {
                        filterForm.submit();
                    });
                });
            });
        </script>

        {% if request.GET.fullwidth %}
            {# Full-width mode: close .large-12.columns and .row divs, then break out of base.html containers #}
            </div>
        </div>
        {# Close #content, .cell, .grid-x, .grid-container from base.html to reach grid-container-fluid level #}
        </div></div></div></div>

        {# Render table at full-width grid-container-fluid level #}
        <div class="grid-container-fluid" style="padding: 1rem 2rem;">
            {% include 'ewaluacja_optymalizacja/_unpinning_opportunities_table.html' %}
        </div>

        {# Reopen base.html containers for any remaining content #}
        <div class="grid-container">
            <div class="grid-x">
                <div class="cell">
                    <div id="content">
        {% else %}
            {# Normal mode: table stays within .large-12.columns #}
            {% include 'ewaluacja_optymalizacja/_unpinning_opportunities_table.html' %}
        {% endif %}
    </div>
</div>
{% endblock %}
