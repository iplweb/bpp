{% load humanize %}

{% if publications %}
{% include "ewaluacja_optymalizacja/_browser_pagination.html" %}

<div class="publication-list">
    {% for pub in publications %}
    <div class="publication-item ewaluacja-optymalizacja__publication-item">
        <!-- Wiersz 1: Tytuł + Rok + Punkty -->
        <div>
            <a href="{{ pub.url }}" target="_blank">{{ pub.tytul|truncatewords:15 }}</a>
            <small class="ewaluacja-optymalizacja__publication-year">({{ pub.rok }})</small>
            <small class="ewaluacja-optymalizacja__publication-points">
                <strong>{{ pub.punkty_kbn }}</strong> pkt
            </small>
        </div>

        <!-- Wiersz 2: Autorzy z wcięciem, jeden pod drugim -->
        <div class="ewaluacja-optymalizacja__authors-list">
            {% for author in pub.authors %}
            <div class="ewaluacja-optymalizacja__author-row">
                <span class="ewaluacja-optymalizacja__author-name">{{ author.autor }}</span>
                <small class="ewaluacja-optymalizacja__author-discipline">
                    {{ author.dyscyplina.nazwa|truncatechars:30 }}
                </small>
                <small class="ewaluacja-optymalizacja__author-points"
                       title="Punktacja udziału">
                    {% if author.pkdaut %}{{ author.pkdaut|floatformat:2 }} pkt{% else %}-{% endif %}
                </small>
                <small class="ewaluacja-optymalizacja__author-slot"
                       title="Slot za pracę / nazbierany / maksymalny">
                    {% if author.slot %}{{ author.slot|floatformat:2 }}{% else %}-{% endif %}
                    /
                    {% if author.slot_nazbierany %}{{ author.slot_nazbierany|floatformat:2 }}{% else %}-{% endif %}
                    /
                    {% if author.max_slot %}{{ author.max_slot|floatformat:2 }}{% else %}-{% endif %}
                </small>

                <!-- Badge: udział wybrany -->
                <span class="ewaluacja-optymalizacja__author-badge">
                    {% if pub.jest_wybrana and author.przypieta %}
                    <span class="label success ewaluacja-optymalizacja__badge"
                          title="Udział wybrany">TAK</span>
                    {% else %}
                    <span class="label secondary ewaluacja-optymalizacja__badge"
                          title="Udział nie wybrany">NIE</span>
                    {% endif %}
                </span>

                <!-- Przyciski akcji -->
                <button class="button tiny ewaluacja-optymalizacja__action-button{% if author.przypieta %} alert{% else %} success{% endif %}"
                        title="{% if author.przypieta %}Odepnij dyscyplinę{% else %}Przypnij dyscyplinę{% endif %}"
                        hx-post="{% url 'ewaluacja_optymalizacja:browser-toggle-pin' author.model_type author.pk %}"
                        hx-target="#recalc-modal-content"
                        hx-swap="innerHTML"
                        data-action="open-modal" data-modal-id="recalc-modal">
                    <span class="fi-{% if author.przypieta %}unlock{% else %}lock{% endif %} ewaluacja-optymalizacja__action-icon"></span>
                </button>

                {% if author.has_two_disciplines %}
                <button class="button tiny secondary ewaluacja-optymalizacja__action-button--swap"
                        title="Zamień na drugą dyscyplinę"
                        hx-post="{% url 'ewaluacja_optymalizacja:browser-swap-discipline' author.model_type author.pk %}"
                        hx-target="#recalc-modal-content"
                        hx-swap="innerHTML"
                        data-action="open-modal" data-modal-id="recalc-modal">
                    <span class="fi-shuffle ewaluacja-optymalizacja__action-icon"></span>
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

{% include "ewaluacja_optymalizacja/_browser_pagination.html" %}

{% else %}
<div class="callout warning">
    <p><span class="fi-info"></span> Nie znaleziono publikacji dla wybranych filtrów.</p>
    <p>Spróbuj zmienić kryteria wyszukiwania lub usuń filtry.</p>
</div>
{% endif %}
