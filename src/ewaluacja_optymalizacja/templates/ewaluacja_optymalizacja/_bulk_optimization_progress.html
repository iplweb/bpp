{% load humanize %}

<!-- Partial template for HTMX polling -->
{% if not task_ready %}
    {% if info and info.pending == info.total_disciplines %}
        <!-- Wszystkie zadania oczekują - jeszcze się nie rozpoczęły -->
        <div class="callout secondary">
            <h4><span class="fi-clock"></span> Oczekiwanie na rozpoczęcie przetwarzania</h4>
            <p><strong>Liczba dyscyplin do przetworzenia:</strong> {{ info.total_disciplines }}</p>
            <p><em>Status odświeża się automatycznie co 3 sekundy.</em></p>
        </div>
    {% else %}
        <!-- Zadanie w trakcie -->
        <div class="callout warning">
            <h4><span class="fi-loop"></span> Zadanie w trakcie wykonywania</h4>

            {% if info %}
            <div class="progress large" role="progressbar" aria-valuenow="{{ info.progress|default:0 }}"
                 aria-valuemin="0" aria-valuemax="100">
                <div class="progress-meter" style="width: {{ info.progress|default:0 }}%">
                    <p class="progress-meter-text">{{ info.progress|default:0 }}%</p>
                </div>
            </div>

            <p><strong>Status:</strong>
                {% if info.step == "optimizing" %}
                    <span class="fi-target-two"></span> Optymalizacja dyscyplin
                {% elif info.step == "finalizing" %}
                    <span class="fi-database"></span> Finalizowanie zapisów do bazy danych...
                {% else %}
                    {{ info.step }}
                {% endif %}
            </p>

            {% if info.message %}
                <p><em>{{ info.message }}</em></p>
            {% endif %}

            {% if info.total_disciplines %}
                <h5>Postęp optymalizacji:</h5>
                <table style="width: 100%; margin-bottom: 1rem;">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Liczba dyscyplin</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="fi-check"></span> Zakończone</td>
                            <td>
                                <span class="label success">{{ info.completed|default:0 }}</span>
                            </td>
                        </tr>
                        {% if info.running %}
                        <tr>
                            <td><span class="fi-loop"></span> W trakcie</td>
                            <td>
                                <span class="label warning">{{ info.running }}</span>
                            </td>
                        </tr>
                        {% endif %}
                        {% if info.pending %}
                        <tr>
                            <td><span class="fi-clock"></span> Oczekujące</td>
                            <td>
                                <span class="label secondary">{{ info.pending }}</span>
                            </td>
                        </tr>
                        {% endif %}
                        {% if info.failed %}
                        <tr>
                            <td><span class="fi-x"></span> Błędne</td>
                            <td>
                                <span class="label alert">{{ info.failed }}</span>
                            </td>
                        </tr>
                        {% endif %}
                        <tr style="font-weight: bold;">
                            <td>Razem</td>
                            <td>{{ info.total_disciplines }}</td>
                        </tr>
                    </tbody>
                </table>
            {% endif %}

            {% if info.disciplines %}
                <h5>Szczegóły dla poszczególnych dyscyplin:</h5>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Dyscyplina</th>
                                <th>Liczba N</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for disc in info.disciplines %}
                            <tr>
                                <td>{{ disc.dyscyplina_nazwa }}</td>
                                <td>{{ disc.liczba_n|floatformat:0 }}</td>
                                <td>
                                    {% if disc.status == "completed" %}
                                        <span class="label success">Zakończono</span>
                                    {% elif disc.status == "failed" %}
                                        <span class="label alert">Błąd</span>
                                    {% elif disc.status == "running" %}
                                        <span class="label warning">W trakcie</span>
                                    {% elif disc.status == "queued" %}
                                        <span class="label secondary">Oczekuje</span>
                                    {% else %}
                                        <span class="label">{{ disc.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        {% else %}
            <p>Zadanie zostało uruchomione i oczekuje na rozpoczęcie...</p>
        {% endif %}

        <p><em>Status odświeża się automatycznie co 3 sekundy.</em></p>
    </div>
    {% endif %}

{% elif success %}
    <!-- Zadanie zakończone pomyślnie -->
    <div class="callout success">
        <h4><span class="fi-check"></span> Przeliczanie zakończono pomyślnie!</h4>

        {% if result %}
            <h5>Podsumowanie:</h5>
            <ul>
                <li><strong>Uczelnia:</strong> {{ result.uczelnia_nazwa }}</li>
                <li><strong>Liczba dyscyplin:</strong> {{ result.total_disciplines }}</li>
                <li><strong>Pomyślne:</strong> <span class="label success">{{ result.successful }}</span></li>
                {% if result.failed %}
                <li><strong>Błędne:</strong> <span class="label alert">{{ result.failed }}</span></li>
                {% endif %}
            </ul>

            <h5>Szczegóły dla poszczególnych dyscyplin:</h5>
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Dyscyplina</th>
                            <th>Liczba N</th>
                            <th>Status</th>
                            <th>Punkty</th>
                            <th>Publikacje</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for disc in result.disciplines %}
                        <tr>
                            <td>{{ disc.dyscyplina_nazwa }}</td>
                            <td>{{ disc.liczba_n|floatformat:0 }}</td>
                            <td>
                                {% if disc.status == "completed" %}
                                    <span class="label success">Zakończono</span>
                                {% elif disc.status == "failed" %}
                                    <span class="label alert">Błąd</span>
                                {% else %}
                                    <span class="label warning">{{ disc.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if disc.total_points %}
                                    {{ disc.total_points|floatformat:1 }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if disc.total_publications %}
                                    {{ disc.total_publications }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if disc.optimization_run_id %}
                                    <a href="{% url 'ewaluacja_optymalizacja:run-detail' disc.optimization_run_id %}"
                                       class="button tiny">
                                        Zobacz szczegóły
                                    </a>
                                {% elif disc.error %}
                                    <button type="button" class="button tiny alert"
                                            onclick="alert('{{ disc.error|escapejs }}\n\n{% if disc.traceback %}Traceback:\n{{ disc.traceback|escapejs }}{% endif %}')">
                                        Zobacz błąd
                                    </button>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>

{% else %}
    <!-- Zadanie zakończone z błędem -->
    <div class="callout alert">
        <h4><span class="fi-x"></span> Wystąpił błąd</h4>
        {% if error %}
            <pre>{{ error }}</pre>
        {% else %}
            <p>Nieznany błąd. Sprawdź logi systemowe.</p>
        {% endif %}
    </div>
{% endif %}
