{% extends "base.html" %}
{% load humanize %}

{% block title %}Przeglądarka ewaluacji{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="{% url 'ewaluacja_optymalizacja:index' %}">Optymalizacja ewaluacji</a></li>
    <li class="current">Przeglądarka ewaluacji</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1>
            <span class="fi-list-thumbnails" aria-hidden="true"></span> Przeglądarka ewaluacji
        </h1>

        <div class="callout">
            <p>
                Ta strona pozwala przeglądać wszystkie publikacje z raportowanych
                dyscyplin i zarządzać przypięciami dyscyplin dla poszczególnych
                autorów. Po każdej zmianie następuje automatyczne przeliczenie
                całej ewaluacji.
            </p>
        </div>

        <div class="button-group" style="margin-bottom: 1rem;">
            <a href="{% url 'ewaluacja_optymalizacja:index' %}" class="button secondary">
                <span class="fi-arrow-left" aria-hidden="true"></span> Powrót do optymalizacji
            </a>
        </div>

        <!-- Podsumowanie dyscyplin (sticky - style w ewaluacja_optymalizacja.scss) -->
        <div id="discipline-summary"
             hx-get="{% url 'ewaluacja_optymalizacja:browser-summary' %}"
             hx-trigger="recalcComplete from:body"
             hx-indicator="this"
             aria-live="polite"
             aria-busy="false">
            {% include "ewaluacja_optymalizacja/_browser_discipline_summary.html" %}
        </div>

        <!-- Filtry -->
        <form id="filter-form"
              hx-get="{% url 'ewaluacja_optymalizacja:browser-table' %}"
              hx-target="#publication-table"
              hx-trigger="submit"
              hx-swap="innerHTML"
              hx-indicator="#publication-table"
              style="margin-top: 1rem;">
            {% csrf_token %}
            <fieldset style="border: 1px solid #ccc; padding: 1rem;
                             margin-bottom: 1rem; border-radius: 3px;">
                <legend style="font-weight: bold; padding: 0 0.5rem;">Filtry:</legend>

                <div class="row">
                    <div class="medium-2 columns">
                        <label>Rok:
                            <select name="rok" class="auto-submit-filter">
                                <option value="">Wszystkie</option>
                                {% for r in filters.lata %}
                                <option value="{{ r }}">{{ r }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>

                    <div class="medium-2 columns">
                        <label>Tytuł:
                            <input type="text" name="tytul" placeholder="Szukaj...">
                        </label>
                    </div>

                    <div class="medium-2 columns">
                        <label>Dyscyplina:
                            <select name="dyscyplina" class="auto-submit-filter">
                                <option value="">Wszystkie</option>
                                {% for d in filters.dyscypliny %}
                                <option value="{{ d.pk }}">{{ d.nazwa }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>

                    <div class="medium-2 columns">
                        <label>Nazwisko:
                            <input type="text" name="nazwisko" placeholder="Szukaj...">
                        </label>
                    </div>

                    <div class="medium-2 columns">
                        <label>Punkty:
                            <select name="punkty_kbn" class="auto-submit-filter">
                                <option value="">Wszystkie</option>
                                {% for p in punkty_kbn_values %}
                                <option value="{{ p }}">{{ p }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>

                    <div class="medium-2 columns">
                        <label>&nbsp;</label>
                        <button type="submit" class="button small expanded">
                            <span class="fi-filter" aria-hidden="true"></span> Filtruj
                        </button>
                    </div>
                </div>
            </fieldset>
        </form>

        <!-- Tabela publikacji (loading state w ewaluacja_optymalizacja.scss) -->
        <div id="publication-table"
             hx-get="{% url 'ewaluacja_optymalizacja:browser-table' %}"
             hx-trigger="load, recalcComplete from:body"
             hx-include="#filter-form"
             hx-swap="innerHTML"
             hx-indicator="this"
             aria-live="polite"
             aria-busy="false"
             role="region"
             aria-label="Tabela publikacji">
            <p><em>Ładowanie publikacji...</em></p>
        </div>

        <!-- Modal przeliczania -->
        <div class="reveal" id="recalc-modal" data-reveal
             data-close-on-click="false" data-close-on-esc="false"
             role="dialog"
             aria-modal="true"
             aria-labelledby="recalcModalTitle" aria-hidden="true">
            <h2 id="recalcModalTitle" class="sr-only">Przeliczanie ewaluacji</h2>
            <div id="recalc-modal-content"
                 aria-live="assertive"
                 aria-busy="false">
                <!-- Domyślny throbber podczas ładowania HTMX -->
                <div class="callout secondary modal-loading">
                    <span class="fi-loop" aria-hidden="true"></span>
                    <p>Przygotowywanie...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit przy zmianie selectów
    var autoSubmitElements = document.querySelectorAll('.auto-submit-filter');
    autoSubmitElements.forEach(function(element) {
        element.addEventListener('change', function() {
            htmx.trigger(document.getElementById('filter-form'), 'submit');
        });
    });
});

// Konfiguracja CSRF dla HTMX
document.body.addEventListener('htmx:configRequest', function(evt) {
    var csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        evt.detail.headers['X-CSRFToken'] = csrfInput.value;
    }
});

// Obsługa aria-busy dla dostępności podczas ładowania HTMX
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    var target = evt.detail.target;
    if (target && target.hasAttribute('aria-busy')) {
        target.setAttribute('aria-busy', 'true');
    }
});

document.body.addEventListener('htmx:afterSwap', function(evt) {
    var target = evt.detail.target;
    if (target && target.hasAttribute('aria-busy')) {
        target.setAttribute('aria-busy', 'false');
    }
});

// Obsługa zakończenia przeliczania
document.body.addEventListener('htmx:afterSettle', function(evt) {
    if (evt.detail.target.id === 'recalc-modal-content') {
        var modal = document.getElementById('recalc-modal');
        var content = evt.detail.target;
        var completeMarker = content.querySelector('[data-recalc-complete="true"]');

        if (completeMarker) {
            // Zamknij modal po 1.5s i odśwież dane
            setTimeout(function() {
                if (typeof $ !== 'undefined') {
                    $('#recalc-modal').foundation('close');
                } else {
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');
                }
                htmx.trigger(document.body, 'recalcComplete');
            }, 1500);
        }
    }
});

// Reset modala po zamknięciu (przywróć throbber dla następnego użycia)
$(document).on('closed.zf.reveal', '#recalc-modal', function() {
    var defaultContent = '<div class="callout secondary modal-loading">' +
        '<span class="fi-loop" aria-hidden="true"></span>' +
        '<p>Przygotowywanie...</p>' +
        '</div>';
    $('#recalc-modal-content').html(defaultContent);
});
</script>
{% endblock %}
