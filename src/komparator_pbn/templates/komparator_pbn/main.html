{% extends "base.html" %}
{% load static %}
{% csrf_token %}

{% block title %}Komparator PBN - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li class="current">Komparator PBN</li>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="large-12 columns">
            <h1>Komparator PBN <span class="label alert">BETA</span></h1>
            <p class="lead">Narzdzie do por贸wnywania danych BPP z danymi PBN</p>
            <div class="panel callout secondary">
                <h4><i class="fi-calendar"></i> Okres ewaluacyjny: {{ evaluation_start_year }}
                    - {{ evaluation_end_year }}</h4>
                <p>Analizowane s tylko publikacje z okresu najnowszej ewaluacji
                    ({{ evaluation_start_year }}-{{ evaluation_end_year }}).</p>
                <strong>UWAGA:</strong> ta funkcja wymaga pobrania wie偶ych danych z PBN. Analizy, kt贸re widzisz,
                opieraj si na <strong>LOKALNEJ KOPII</strong> danych z PBN.
                <br/><br/>
                <div style="text-align: center;">
                    <span style="color: #f39c12; font-size: 2.5em;"></span>
                    <br>
                    <span style="color: #f39c12; font-size: 1.5em;">Don't Panic!</span>
                </div>

                {% if latest_task %}
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #d3d3d3;">
                        <h6><i class="fi-info"></i> Status pobierania danych z PBN</h6>
                        {% if latest_task.status == 'completed' %}
                            <div style="padding: 1rem; background-color: #d4edda; border-left: 4px solid #28a745; margin: 0.5rem 0;">
                                <i class="fi-check" style="color: #28a745;"></i> <strong style="color: #155724;">Ostatnie pobieranie zakoczone pomylnie</strong>
                                <div style="margin-top: 0.5rem; font-size: 0.9em; color: #155724;">
                                    Data: {{ latest_task.completed_at|date:"d.m.Y H:i:s" }}<br>
                                    U偶ytkownik: {{ latest_task.user.username }}
                                </div>
                            </div>
                        {% elif latest_task.status == 'failed' %}
                            <div style="padding: 1rem; background-color: #f8d7da; border-left: 4px solid #dc3545; margin: 0.5rem 0;">
                                <i class="fi-alert" style="color: #dc3545;"></i> <strong style="color: #721c24;">Ostatnie pobieranie nie powiodo si</strong>
                                <div style="margin-top: 0.5rem; font-size: 0.9em; color: #721c24;">
                                    Data: {{ latest_task.completed_at|date:"d.m.Y H:i:s" }}<br>
                                    Bd: {{ latest_task.error_message|truncatewords:10 }}
                                </div>
                            </div>
                        {% elif latest_task.status == 'running' %}
                            <div style="padding: 1rem; background-color: #fff3cd; border-left: 4px solid #ffc107; margin: 0.5rem 0;">
                                <i class="fi-refresh" style="color: #ffc107; animation: pulse 1s infinite;"></i> <strong style="color: #856404;">Pobieranie w toku...</strong>
                                <div style="margin-top: 0.5rem; font-size: 0.9em; color: #856404;">
                                    Rozpoczte: {{ latest_task.started_at|date:"d.m.Y H:i:s" }}<br>
                                    Aktualny krok: {{ latest_task.current_step }}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}

                <div style="margin-top: 1rem;">
                    <a href="{% url "pbn_downloader_app:main" %}" class="button success expanded">
                        <i class="fi-cloud-download"></i> Przejd藕 do pobierania danych z PBN
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            {% include "includes/pbn_freshness_warning.html" with custom_message="Statystyki wywietlane poni偶ej mog by nieaktualne. Zaleca si pobranie wie偶ych danych z PBN." %}
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="panel callout">
                <h3>Statystyki publikacji</h3>
                <div class="row">
                    <div class="medium-6 columns">
                        <div class="stat-box">
                            <h4>Nigdy nie wysane do PBN</h4>
                            <div class="row">
                                <div class="medium-6 columns">
                                    <strong>Wydawnictwa cige:</strong> {{ ciagle_not_sent|default:0 }}
                                </div>
                                <div class="medium-6 columns">
                                    <strong>Wydawnictwa zwarte:</strong> {{ zwarte_not_sent|default:0 }}
                                </div>
                            </div>
                            <p><strong>Razem: {{ total_not_sent|default:0 }}</strong></p>
                        </div>
                    </div>
                    <div class="medium-6 columns">
                        <div class="stat-box">
                            <h4>Wysane do PBN</h4>
                            <div class="row">
                                <div class="medium-6 columns">
                                    <strong>Wydawnictwa cige:</strong> {{ ciagle_sent|default:0 }}
                                </div>
                                <div class="medium-6 columns">
                                    <strong>Wydawnictwa zwarte:</strong> {{ zwarte_sent|default:0 }}
                                </div>
                            </div>
                            <p><strong>Razem: {{ total_sent|default:0 }}</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="large-12 columns">
            <h3>Publikacje nigdy nie wysane do PBN</h3>
            <p>Przegldaj publikacje nie wysane do PBN przez Django Admin z automatycznym filtrowaniem.</p>
            {% if uczelnia.pbn_api_nie_wysylaj_prac_bez_pk %}
                Praca <strong>musi</strong> mie punkty PK, zgodnie z ustawieniami obiektu Uczelnia.<br/>
                Praca <strong>musi</strong> mie DOI lub adres strony WWW (pole WWW lub Dostp patny).<br/>
                Praca <strong>musi</strong> mie charakter formalny jeden z:
                {% for charakter in  charaktery_wysylane_do_pbn %}{{ charakter.nazwa }}, {% endfor %}
            {% endif %}
            <div class="row">
                <div class="medium-6 columns">
                    <div class="panel">
                        <h4>Wydawnictwa cige ({{ ciagle_not_sent }})</h4>
                        <p>Publikacje cige z okresu {{ evaluation_start_year }}-{{ evaluation_end_year }} nie wysane
                            do PBN.</p>
                        <a href="/admin/bpp/wydawnictwo_ciagle/?q-l=on&q=rok+%3E%3D+2022+and+rok+%3C%3D+2025+and+pbn_uid+%3D+None+and+%28doi%21%3D%22%22+or+www%21%3D%22%22+or+public_www%21%3D%22%22%29+and+charakter_formalny.rodzaj_pbn+%21%3D+None{% if uczelnia.pbn_api_nie_wysylaj_prac_bez_pk %}+and+punkty_kbn+%3E+0{% endif %}"
                           class="button expanded success" target="_blank">
                            <i class="fi-list"></i> Poka偶 w module redagowania
                        </a>
                    </div>
                </div>
                <div class="medium-6 columns">
                    <div class="panel">
                        <h4>Wydawnictwa zwarte ({{ zwarte_not_sent }})</h4>
                        <p>Publikacje zwarte z okresu {{ evaluation_start_year }}-{{ evaluation_end_year }} nie wysane
                            do PBN.</p>
                        <a href="/admin/bpp/wydawnictwo_zwarte/?q-l=on&q=rok+%3E%3D+2022+and+rok+%3C%3D+2025+and+pbn_uid+%3D+None+and+%28doi%21%3D%22%22+or+www%21%3D%22%22+or+public_www%21%3D%22%22%29+and+charakter_formalny.rodzaj_pbn+%21%3D+None{% if uczelnia.pbn_api_nie_wysylaj_prac_bez_pk %}+and+punkty_kbn+%3E+0{% endif %}"
                           class="button expanded info" target="_blank">
                            <i class="fi-list"></i> Poka偶 w module redagowania
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="panel callout info">
                <h3>Publikacje - rozbie偶noci midzy PBN a BPP</h3>
                <div class="row">
                    <div class="medium-6 columns">
                        <div class="stat-box">
                            <h4><i class="fi-alert"></i> Publikacje PBN nieistniejce w BPP</h4>
                            <p><strong>Liczba publikacji: {{ pbn_publications_not_in_bpp|default:0 }}</strong></p>
                            <small>Publikacje z lat {{ evaluation_start_year }}-{{ evaluation_end_year }} w bazie PBN, kt贸rych
                                PBN UID ID nie wystpuje w tabeli rekord贸w.
                                <br/>Potencjalnie:
                                <ul style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <li>mogy zosta dopisane przez u偶ytkownik贸w PBNu poza baz - przez interfejs GUI,</li>
                                    <li>mog by to te偶 zdublowane (po stronie PBN) rekordy, kt贸re powstay na skutek bdu podczas wysyki do PBN.</li>
                                </ul>
                            </small>
                            <div style="margin-top: 1rem;">
                                <a href="/admin/pbn_api/publication/?odpowiednik=brak&q=year+%3E%3D+2022+and+year+%3C%3D+2025+&q-l=on&status=ACTIVE"
                                   class="button expanded alert" target="_blank">
                                    <i class="fi-list"></i> Poka偶 w module redagowania
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="medium-6 columns">
                        <div class="stat-box stat-box-deleted-pbn">
                            <h4><i class="fi-trash"></i> Publikacje skasowane w PBN, a istniejce w BPP</h4>
                            <p><strong>Liczba publikacji: {{ deleted_pbn_in_bpp|default:0 }}</strong></p>
                            <small>Publikacje z bazy BPP, kt贸re maj przypisany PBN UID wskazujcy na publikacj ze statusem DELETED w bazie PBN.
                                <br/>Te publikacje zostay usunite po stronie PBN, ale nadal istniej w BPP z referencj do usunitej publikacji.
                                <br/>Wymaga to przegldu i ewentualnego:
                                <ul style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <li>ponownego wysania publikacji do PBN (jeli zostaa usunita przez pomyk),</li>
                                    <li>usunicia powizania PBN UID w BPP (jeli publikacja ma pozosta tylko w BPP),</li>
                                    <li>weryfikacji czy publikacja nie zostaa zduplikowana w PBN z nowym ID.</li>
                                </ul>
                            </small>
                            <div style="margin-top: 1rem;">
                                <a href="/admin/pbn_api/publication/?odpowiednik=jest&status=DELETED"
                                   class="button expanded warning" target="_blank">
                                    <i class="fi-list"></i> Poka偶 w module redagowania
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="panel callout warning">
                <h3>Autorzy</h3>
                <div class="row">
                    <div class="medium-4 columns">
                        <div class="stat-box">
                            <h4><i class="fi-torso"></i> Autorzy w PBN bez odpowiednika w BPP</h4>
                            <p><strong>Liczba autor贸w: {{ pbn_scientists_not_in_bpp|default:0 }}</strong></p>
                            <small>Autorzy z PBN API instytucji (from_institution_api=True), kt贸rych mongoId nie wystpuje w tabeli bpp.Autor.
                                <br/>S to autorzy pobrani z API instytucji PBN, kt贸rzy nie zostali jeszcze powizani z autorami w systemie BPP.
                            </small>
                            <div style="margin-top: 1rem;">
                                <a href="/admin/pbn_api/scientist/?from_institution_api__exact=1&odpowiednik=brak"
                                   class="button expanded warning" target="_blank">
                                    <i class="fi-list"></i> Poka偶 w module redagowania
                                </a>
                                <a href="{% url 'importer_autorow_pbn:main' %}"
                                   class="button expanded success" style="margin-top: 0.5rem;">
                                    <i class="fi-torsos-female-male"></i> Przejd藕 do importera autor贸w PBN
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="medium-4 columns">
                        <div class="stat-box">
                            <h4><i class="fi-duplicate"></i> Zduplikowani autorzy</h4>
                            <p><strong>Liczba autor贸w z duplikatami: {{ duplicate_authors_count|default:0 }}</strong></p>
                            <small>Autorzy w systemie BPP, kt贸rzy prawdopodobnie maj duplikaty na podstawie analizy nazwisk, imion i innych kryteri贸w.
                                <br/>Wymagaj przegldu i ewentualnego scalenia duplikat贸w.
                            </small>
                            <div style="margin-top: 1rem;">
                                <a href="{% url 'deduplikator_autorow:duplicate_authors' %}"
                                   class="button expanded secondary" target="_blank">
                                    <i class="fi-list"></i> Przejd藕 do deduplikatora autor贸w
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="medium-4 columns">
                        <div class="stat-box stat-box-deleted-scientists">
                            <h4><i class="fi-trash"></i> Autorzy skasowani w PBN, a istniejcy w BPP</h4>
                            <p><strong>Liczba autor贸w: {{ deleted_pbn_scientists_in_bpp|default:0 }}</strong></p>
                            <small>Autorzy w BPP, kt贸rzy maj przypisany PBN UID wskazujcy na naukowca ze statusem DELETED w bazie PBN.
                                <br/>Ci autorzy zostali usunici po stronie PBN, ale nadal istniej w BPP z referencj do usunitego naukowca.
                                <br/>Wymaga to przegldu i ewentualnego:
                                <ul style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <li>ponownego powizania z aktywnym naukowcem PBN,</li>
                                    <li>usunicia powizania PBN UID w BPP.</li>
                                </ul>
                            </small>
                            <div style="margin-top: 1rem;">
                                <a href="/admin/pbn_api/scientist/?status=DELETED"
                                   class="button expanded warning" target="_blank">
                                    <i class="fi-list"></i> Poka偶 w module redagowania
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="panel callout alert">
                <h3>殴r贸da</h3>
                <div class="row">
                    <div class="large-12 columns">
                        <div class="stat-box stat-box-deleted-journals">
                            <h4><span class="fi-trash"></span> 殴r贸da skasowane w PBN z publikacjami w BPP</h4>
                            <p><strong>Liczba 藕r贸de: {{ deleted_pbn_journals_in_bpp|default:0 }}</strong></p>
                            <small>殴r贸da w BPP, kt贸re maj przypisany PBN UID wskazujcy na czasopismo ze statusem DELETED w bazie PBN, a nadal posiadaj powizane publikacje.
                                <br/>Te 藕r贸da zostay usunite po stronie PBN, ale nadal istniej w BPP z publikacjami.
                                <br/>Wymaga to przegldu i przemapowania publikacji na aktualne 藕r贸da:
                                <ul style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <li>znalezienia aktywnego odpowiednika 藕r贸da w PBN,</li>
                                    <li>przemapowania wszystkich publikacji do nowego 藕r贸da,</li>
                                    <li>automatycznego dodania publikacji do kolejki eksportu PBN.</li>
                                </ul>
                            </small>
                            <div style="margin-top: 1rem;">
                                <a href="{% url 'przemapuj_zrodla_pbn:lista_skasowanych_zrodel' %}"
                                   class="button expanded alert">
                                    <span class="fi-refresh"></span> Przejd藕 do przemapowania 藕r贸de
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="panel callout info">
                <h3>R贸偶nice w udziaach PBN a BPP ({{ evaluation_start_year }}-{{ evaluation_end_year }})</h3>
                <div class="stat-box">
                    <h4><i class="fi-alert"></i> Rozbie偶noci dyscyplin midzy BPP a PBN</h4>
                    <p><strong>Cakowita liczba rozbie偶noci: {{ total_discipline_discrepancies|default:0 }}</strong></p>

                    <div class="row" style="margin-top: 1rem;">
                        <div class="medium-4 columns">
                            <div class="discipline-discrepancy-card empty-bpp">
                                <h5><i class="fi-x-circle"></i> Brak dyscypliny w BPP</h5>
                                <p class="lead">{{ bpp_empty_disciplines|default:0 }}</p>
                                <small>Przypadki gdzie PBN ma przypisan dyscyplin, ale BPP nie ma</small>
                            </div>
                        </div>
                        <div class="medium-4 columns">
                            <div class="discipline-discrepancy-card empty-pbn">
                                <h5><i class="fi-x-circle"></i> Brak dyscypliny w PBN</h5>
                                <p class="lead">{{ pbn_empty_disciplines|default:0 }}</p>
                                <small>Przypadki gdzie BPP ma przypisan dyscyplin, ale PBN nie ma</small>
                            </div>
                        </div>
                        <div class="medium-4 columns">
                            <div class="discipline-discrepancy-card different-disciplines">
                                <h5><i class="fi-alert"></i> R贸偶ne dyscypliny</h5>
                                <p class="lead">{{ both_present_different|default:0 }}</p>
                                <small>Przypadki gdzie obie strony maj dyscypliny, ale s r贸偶ne</small>
                            </div>
                        </div>
                    </div>

                    <small style="display: block; margin-top: 1rem;">
                        Por贸wnanie dotyczy owiadcze instytucji (OswiadczenieInstytucji) z PBN
                        z rekordami autor贸w publikacji (Wydawnictwo_Ciagle_Autor, Wydawnictwo_Zwarte_Autor) w BPP.
                        <br/>Analiza obejmuje tylko publikacje z okresu {{ evaluation_start_year }}-{{ evaluation_end_year }}.
                        <br/>
                        <strong>Uwaga:</strong> Te rozbie偶noci mog wynika z:
                        <ul>
                            <li>R贸偶nic w czasie aktualizacji danych midzy systemami</li>
                            <li>Rcznych korekt dokonanych tylko w jednym systemie</li>
                            <li>Bd贸w podczas synchronizacji danych</li>
                            <li>R贸偶nic w przypisaniu dyscyplin do autor贸w w r贸偶nych publikacjach</li>
                        </ul>
                    </small>

                    <div style="margin-top: 1rem;">
                        <a href="{% url 'komparator_pbn_udzialy:list' %}?rok_min={{ evaluation_start_year }}&rok_max={{ evaluation_end_year }}"
                           class="button expanded">
                            <i class="fi-magnifying-glass"></i> Przejd藕 do szczeg贸owego komparatora udzia贸w
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {##}
    {#    <div class="row">#}
    {#        <div class="large-12 columns">#}
    {#            <div class="panel callout">#}
    {#                <h3>Statystyki owiadcze</h3>#}
    {#                <div class="row">#}
    {#                    <div class="medium-6 columns">#}
    {#                        <div class="stat-box">#}
    {#                            <h4>Owiadczenia BPP ({{ evaluation_start_year }}-{{ evaluation_end_year }})</h4>#}
    {#                            <div class="row">#}
    {#                                <div class="medium-6 columns">#}
    {#                                    <strong>Wydawnictwa cige:</strong> {{ bpp_ciagle_statements|default:0 }}#}
    {#                                </div>#}
    {#                                <div class="medium-6 columns">#}
    {#                                    <strong>Wydawnictwa zwarte:</strong> {{ bpp_zwarte_statements|default:0 }}#}
    {#                                </div>#}
    {#                            </div>#}
    {#                            <p><strong>Razem BPP: {{ bpp_total_statements|default:0 }}</strong></p>#}
    {#                            <small>Owiadczenia autor贸w z przypieta=True, afiliuje=True i dyscyplina_naukowa</small>#}
    {#                        </div>#}
    {#                    </div>#}
    {#                    <div class="medium-6 columns">#}
    {#                        <div class="stat-box">#}
    {#                            <h4>Owiadczenia PBN ({{ evaluation_start_year }}-{{ evaluation_end_year }})</h4>#}
    {#                            <p><strong>Razem PBN: {{ pbn_statements|default:0 }}</strong></p>#}
    {#                            <small>Owiadczenia instytucji PBN dla publikacji z#}
    {#                                okresu {{ evaluation_start_year }}-{{ evaluation_end_year }}</small>#}
    {##}
    {#                            <div style="margin-top: 1rem;">#}
    {#                                <a href="{% url 'komparator_pbn:bpp_missing_in_pbn' %}" class="button small success">#}
    {#                                    BPP nie wysane do PBN#}
    {#                                </a>#}
    {#                                <a href="{% url 'komparator_pbn:pbn_missing_in_bpp' %}" class="button small alert"#}
    {#                                   style="margin-top: 0.5rem;">#}
    {#                                    PBN nieistniejce w BPP#}
    {#                                </a>#}
    {#                            </div>#}
    {#                        </div>#}
    {#                    </div>#}
    {#                </div>#}
    {#            </div>#}
    {#        </div>#}
    {#    </div>#}
    {##}
    {##}


{% endblock %}
