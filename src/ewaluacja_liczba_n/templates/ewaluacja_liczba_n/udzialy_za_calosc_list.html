{% extends "base.html" %}
{% load humanize %}
{% load url_helpers %}

{% block title %}Lista udziałów za cały okres - Liczba N{% endblock %}

{% block breadcrumbs %}
    <li><a href="/">Strona główna</a></li>
    <li><a href="{% url 'ewaluacja_liczba_n:index' %}">Liczba N</a></li>
    <li class="current">Lista udziałów za cały okres</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1><i class="fi-list"></i> Lista udziałów za cały okres (2022-2025)</h1>

        <div class="row">
            <div class="medium-8 columns">
                <form method="get" action="." class="form-inline" id="filter-form">
                    <div class="input-group">
                        <span class="input-group-label">Autor:</span>
                        <input type="text" name="search" value="{{ search }}"
                               placeholder="Nazwisko lub imię"
                               class="input-group-field" id="search-input">
                    </div>

                    <div class="input-group">
                        <span class="input-group-label">Dyscyplina:</span>
                        <select name="dyscyplina" class="input-group-field auto-submit">
                            <option value="">-- Wszystkie --</option>
                            {% for dyscyplina in dyscypliny %}
                                <option value="{{ dyscyplina.pk }}" {% if selected_dyscyplina == dyscyplina.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ dyscyplina.nazwa }} ({{ dyscyplina.kod }})
                                </option>
                            {% empty %}
                                <option disabled>Brak dyscyplin z danymi</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="input-group">
                        <span class="input-group-label">Rodzaj autora:</span>
                        <select name="rodzaj_autora" class="input-group-field auto-submit">
                            <option value="">-- Wszystkie --</option>
                            {% for rodzaj in rodzaje_autorow %}
                                <option value="{{ rodzaj.pk }}" {% if selected_rodzaj_autora == rodzaj.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ rodzaj.nazwa }}
                                </option>
                            {% empty %}
                                <option disabled>Brak rodzajów autorów z danymi</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="button primary">
                        <i class="fi-magnifying-glass"></i> Filtruj
                    </button>
                    <a href="{% url 'ewaluacja_liczba_n:udzialy-za-calosc-list' %}" class="button secondary">
                        <i class="fi-refresh"></i> Wyczyść filtry
                    </a>
                </form>
            </div>

            <div class="medium-4 columns text-right">
                <a href="{% url 'ewaluacja_liczba_n:udzialy-za-calosc-export' %}?{{ request.GET.urlencode }}" class="button success">
                    <i class="fi-download"></i> Eksport do XLSX
                </a>
                <a href="{% url 'ewaluacja_liczba_n:index' %}" class="button">
                    <i class="fi-arrow-left"></i> Powrót
                </a>
            </div>
        </div>

        <hr>

        {% if udzialy_data %}
            <!-- Pager above table -->
            {% include "pagination/pagination_with_anchor.html" %}

            <!-- Podsumowanie dla przefiltrowanych danych -->
            <div class="callout primary">
                <div class="row">
                    <div class="medium-4 columns">
                        <h5>Podsumowanie dla wybranych filtrów:</h5>
                        <p><strong>Liczba rekordów:</strong> {{ total_count|intcomma }}</p>
                    </div>
                    <div class="medium-4 columns">
                        <p><strong>Suma ilości udziałów:</strong>
                            <span class="label large success">{{ suma_udzialow|floatformat:2 }}</span>
                        </p>
                    </div>
                    <div class="medium-4 columns">
                        <p><strong>Suma udziałów - monografie:</strong>
                            <span class="label large warning">{{ suma_monografie|floatformat:2 }}</span>
                        </p>
                    </div>
                </div>
            </div>
            <table class="hover stack" id="pager">
                <thead>
                    <tr>
                        <th>
                            <a href="{% get_sort_url 'autor' %}"
                               class="sort-link">
                                Autor
                                {% if current_sort == 'autor' %}
                                    <i class="fi-arrow-down"></i>
                                {% elif current_sort == '-autor' %}
                                    <i class="fi-arrow-up"></i>
                                {% else %}
                                    <i class="fi-arrows-expand" style="opacity: 0.3;"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{% get_sort_url 'dyscyplina' %}"
                               class="sort-link">
                                Dyscyplina
                                {% if current_sort == 'dyscyplina' %}
                                    <i class="fi-arrow-down"></i>
                                {% elif current_sort == '-dyscyplina' %}
                                    <i class="fi-arrow-up"></i>
                                {% else %}
                                    <i class="fi-arrows-expand" style="opacity: 0.3;"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>Rodzaj autora</th>
                        <th class="text-center">
                            <a href="{% get_sort_url 'udzialy' %}"
                               class="sort-link">
                                Ilość udziałów<br>(2022-2025)
                                {% if current_sort == 'udzialy' %}
                                    <i class="fi-arrow-down"></i>
                                {% elif current_sort == '-udzialy' %}
                                    <i class="fi-arrow-up"></i>
                                {% else %}
                                    <i class="fi-arrows-expand" style="opacity: 0.3;"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-center">
                            <a href="{% get_sort_url 'monografie' %}"
                               class="sort-link">
                                Udziały - monografie
                                {% if current_sort == 'monografie' %}
                                    <i class="fi-arrow-down"></i>
                                {% elif current_sort == '-monografie' %}
                                    <i class="fi-arrow-up"></i>
                                {% else %}
                                    <i class="fi-arrows-expand" style="opacity: 0.3;"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>Komentarz</th>
                    </tr>
                </thead>
                <tbody>
                    {% for udzial in udzialy_data %}
                    <tr>
                        <td>
                            <a href="{% url 'bpp:browse_autor' udzial.autor.pk %}">
                                {{ udzial.autor }}
                            </a>
                        </td>
                        <td>
                            {{ udzial.dyscyplina_naukowa.nazwa }}
                            <small class="text-muted">({{ udzial.dyscyplina_naukowa.kod }})</small>
                        </td>
                        <td>
                            {% if udzial.rodzaj_autora %}
                                {% if udzial.rodzaj_autora.skrot == 'N' %}
                                    <span class="rodzaj-autora-badge type-n" title="{{ udzial.rodzaj_autora.nazwa }}">liczba N</span>
                                {% elif udzial.rodzaj_autora.skrot == 'D' %}
                                    <span class="rodzaj-autora-badge type-d" title="{{ udzial.rodzaj_autora.nazwa }}">doktorant</span>
                                {% elif udzial.rodzaj_autora.skrot == 'B' %}
                                    <span class="rodzaj-autora-badge type-b" title="{{ udzial.rodzaj_autora.nazwa }}">badawczy</span>
                                {% elif udzial.rodzaj_autora.skrot == 'Z' %}
                                    <span class="rodzaj-autora-badge type-z" title="{{ udzial.rodzaj_autora.nazwa }}">inny</span>
                                {% else %}
                                    {{ udzial.rodzaj_autora.nazwa }}
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Brak danych</span>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ udzial.ilosc_udzialow|floatformat:2 }}</td>
                        <td class="text-center">{{ udzial.ilosc_udzialow_monografie|floatformat:2 }}</td>
                        <td class="komentarz-cell">
                            <small class="komentarz-content">{{ udzial.komentarz|default:"" }}</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="text-bold">
                        <td colspan="3" class="text-right"><strong>Sumy dla bieżącej strony:</strong></td>
                        <td class="text-center">
                            <strong>{{ page_suma_udzialow|floatformat:2 }}</strong>
                        </td>
                        <td class="text-center">
                            <strong>{{ page_suma_monografie|floatformat:2 }}</strong>
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <!-- Pager below table -->
            {% include "pagination/pagination_with_anchor.html" %}

        {% else %}
            <div class="callout warning">
                <p>Brak danych do wyświetlenia. Upewnij się, że obliczono liczbę N dla ewaluacji.</p>
                <a href="{% url 'ewaluacja_liczba_n:index' %}" class="button">
                    <i class="fi-arrow-left"></i> Wróć do strony głównej
                </a>
            </div>
        {% endif %}
    </div>
</div>

<style>
    .input-group {
        margin-bottom: 1rem;
        margin-right: 1rem;
        display: inline-table;
    }
    .form-inline .input-group-label {
        display: table-cell;
        padding: 0.5rem 1rem;
        background: #e6e6e6;
        border: 1px solid #cacaca;
        border-right: 0;
        white-space: nowrap;
        vertical-align: middle;
    }
    .form-inline .input-group-field {
        display: table-cell;
        border-radius: 0;
        height: 2.5rem;
    }
    tfoot tr {
        background-color: #f0f0f0;
        font-weight: bold;
    }
    .sort-link {
        color: inherit;
        text-decoration: none;
        display: block;
    }
    .sort-link:hover {
        color: #1779ba;
    }
    .sort-link i {
        font-size: 0.9em;
        margin-left: 5px;
    }
    .year-label {
        display: inline-block;
        background: #6c757d;
        color: white;
        padding: 0.25rem 0.5rem;
        margin: 0.1rem 0.2rem;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
        white-space: nowrap;
    }
    .komentarz-cell {
        line-height: 1.8;
    }
    .rounded-label {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.1rem 0.2rem;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        white-space: nowrap;
        cursor: help;
        position: relative;
    }
    .rounded-label.mono {
        background: #5cb85c;
        color: white;
    }
    .rounded-label.total {
        background: #f0ad4e;
        color: white;
    }
    .rounded-label.reduced {
        background: #d9534f;
        color: white;
    }
    .rounded-label.mono-reduced {
        background: #c9302c;
        color: white;
    }
    .rodzaj-autora-badge {
        display: inline-block;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
        cursor: help;
    }
    .rodzaj-autora-badge.type-n {
        background: #5cb85c;
        color: white;
    }
    .rodzaj-autora-badge.type-d {
        background: #5bc0de;
        color: white;
    }
    .rodzaj-autora-badge.type-b {
        background: #f0ad4e;
        color: white;
    }
    .rodzaj-autora-badge.type-z {
        background: #777;
        color: white;
    }
    .rodzaj-autora-badge:hover {
        opacity: 0.9;
        transform: scale(1.05);
        transition: all 0.2s ease;
    }
    .rounded-label:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        white-space: normal;
        width: max-content;
        max-width: 300px;
        z-index: 1000;
        font-size: 0.9em;
        font-weight: normal;
        margin-bottom: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
</style>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Format komentarze - zamień tekst lat na labele
    document.querySelectorAll('.komentarz-content').forEach(function(element) {
        var komentarz = element.textContent;
        if (!komentarz) return;

        // Sprawdź czy komentarz zaczyna się od "Lata z danymi: "
        if (komentarz.startsWith('Lata z danymi: ')) {
            // Podziel komentarz na części (przed i po <br>)
            var parts = komentarz.split('<br>');
            var lataPart = parts[0].replace('Lata z danymi: ', '');

            // Wyciągnij lata (oddzielone przecinkami i spacjami)
            var lata = lataPart.split(',').map(function(rok) {
                return rok.trim();
            });

            // Utwórz HTML z labelami dla lat
            var html = '';
            lata.forEach(function(rok) {
                html += '<span class="year-label">' + rok + '</span>';
            });

            // Przetwórz resztę komentarza jeśli istnieje
            if (parts.length > 1) {
                for (var i = 1; i < parts.length; i++) {
                    var part = parts[i].trim();
                    if (!part) continue;

                    // Sprawdź czy to info o zaokrągleniu monografii
                    if (part.includes('Ilość udziałów za monografie zaokrąglona:')) {
                        var match = part.match(/(\d+\.\d+)\s*→\s*(\d+\.\d+)/);
                        if (match) {
                            var oldVal = parseFloat(match[1]).toFixed(2);
                            var newVal = parseFloat(match[2]).toFixed(2);
                            html += '<span class="rounded-label mono" title="Ilość udziałów za monografie zaokrąglona: ' +
                                    match[1] + ' → ' + match[2] + '">MONO ' + oldVal + ' → ' + newVal + '</span>';
                        }
                    }
                    // Sprawdź czy to info o zaokrągleniu ogólnym
                    else if (part.includes('Ilość udziałów zaokrąglona:')) {
                        var match = part.match(/(\d+\.\d+)\s*→\s*(\d+\.\d+)/);
                        if (match) {
                            var oldVal = parseFloat(match[1]).toFixed(2);
                            var newVal = parseFloat(match[2]).toFixed(2);
                            html += '<span class="rounded-label total" title="Ilość udziałów zaokrąglona: ' +
                                    match[1] + ' → ' + match[2] + '">UDZIAŁY ' + oldVal + ' → ' + newVal + '</span>';
                        }
                    }
                    // Sprawdź czy to info o redukcji udziałów
                    else if (part.includes('Ilość udziałów zredukowana:')) {
                        var match = part.match(/(\d+\.\d+)\s*→\s*(\d+\.\d+)/);
                        if (match) {
                            var oldVal = parseFloat(match[1]).toFixed(2);
                            var newVal = parseFloat(match[2]).toFixed(2);
                            html += '<span class="rounded-label reduced" title="Ilość udziałów zredukowana: ' +
                                    match[1] + ' → ' + match[2] + '">REDUKCJA ' + oldVal + ' → ' + newVal + '</span>';
                        }
                    }
                    // Sprawdź czy to info o redukcji udziałów za monografie
                    else if (part.includes('Ilość udziałów za monografie zredukowana:')) {
                        var match = part.match(/(\d+\.\d+)\s*→\s*(\d+\.\d+)/);
                        if (match) {
                            var oldVal = parseFloat(match[1]).toFixed(2);
                            var newVal = parseFloat(match[2]).toFixed(2);
                            html += '<span class="rounded-label mono-reduced" title="Ilość udziałów za monografie zredukowana: ' +
                                    match[1] + ' → ' + match[2] + '">MONO RED. ' + oldVal + ' → ' + newVal + '</span>';
                        }
                    }
                }
            }

            element.innerHTML = html;
        }
    });

    // Auto-focus on search input
    var searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.focus();
        // Move cursor to end of input if there's existing text
        var val = searchInput.value;
        searchInput.value = '';
        searchInput.value = val;
    }

    // Auto-submit form on select change
    var autoSubmitElements = document.querySelectorAll('.auto-submit');
    autoSubmitElements.forEach(function(element) {
        element.addEventListener('change', function() {
            document.getElementById('filter-form').submit();
        });
    });

    // Auto-submit form on search input with debounce
    var searchTimer = null;

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(function() {
                document.getElementById('filter-form').submit();
            }, 500); // Wait 500ms after user stops typing
        });

        // Also submit on Enter key
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimer);
                document.getElementById('filter-form').submit();
            }
        });
    }
});
</script>
{% endblock %}
