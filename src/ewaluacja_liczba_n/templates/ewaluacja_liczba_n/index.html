{% extends "base.html" %}
{% load humanize url_helpers static %}

{% block title %}Liczba N - Ewaluacja 2022-2025{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'ewaluacja_liczba_n/css/ewaluacja_liczba_n.css' %}">
{% endblock %}

{% block breadcrumbs %}
    <li><a href="/">Strona główna</a></li>
    <li class="current">Liczba N</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h1><i class="fi-list-number"></i> Liczba N - Ewaluacja 2022-2025</h1>

        <div class="callout primary">
            <h4>Obliczanie liczby N</h4>
            <p>Kliknij poniższy przycisk, aby obliczyć liczbę N dla ewaluacji 2022-2025.</p>
            <form method="post" action="{% url 'ewaluacja_liczba_n:oblicz' %}" id="obliczLiczbeNForm">
                {% csrf_token %}
                <button type="submit" class="button large success" id="obliczLiczbeNButton">
                    <i class="fi-refresh"></i> Oblicz liczbę N
                </button>
            </form>
        </div>

        <div class="row">
            <div class="medium-6 columns">
                <div class="callout">
                    <h4>Podsumowanie</h4>
                    <p><strong>Uczelnia:</strong> {{ uczelnia.nazwa }}</p>
                    <p><strong>Liczba dyscyplin:</strong> {{ liczby_n|length }}</p>
                    <p><strong>Suma liczby N:</strong> <span class="label large success">{{ suma_liczby_n|floatformat:2 }}</span></p>
                </div>
            </div>

            <div class="medium-6 columns">
                <div class="callout ewaluacja-liczba-n__actions-callout">
                    <h4>Akcje</h4>
                    <div class="ewaluacja-liczba-n__actions-container">
                        <div class="ewaluacja-liczba-n__button-row">
                            <a href="{% url 'ewaluacja_liczba_n:autorzy-list' %}" class="button primary ewaluacja-liczba-n__action-button">
                                <i class="fi-list"></i> Lista udziałów za rok
                            </a>
                            <a href="{% url 'ewaluacja_liczba_n:autorzy-export' %}" class="button success ewaluacja-liczba-n__action-button">
                                <i class="fi-download"></i> Eksportuj udziały za rok
                            </a>
                        </div>
                        <div class="ewaluacja-liczba-n__button-row">
                            <a href="{% url 'ewaluacja_liczba_n:udzialy-za-calosc-list' %}" class="button primary ewaluacja-liczba-n__action-button">
                                <i class="fi-list"></i> Lista udziałów za całość
                            </a>
                            <a href="{% url 'ewaluacja_liczba_n:udzialy-za-calosc-export' %}" class="button success ewaluacja-liczba-n__action-button">
                                <i class="fi-download"></i> Eksportuj udziały
                            </a>
                        </div>
                        <div class="ewaluacja-liczba-n__button-row">
                            <a href="{% url 'ewaluacja_liczba_n:weryfikuj-baze' %}" class="button warning ewaluacja-liczba-n__action-button">
                                <i class="fi-magnifying-glass"></i> Weryfikuj poprawność bazy
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h3>Liczba N dla poszczególnych dyscyplin</h3>
        {% if liczby_n %}
            <form method="post" action="{% url 'ewaluacja_liczba_n:save-sankcje' %}" id="sankcjeForm">
                {% csrf_token %}
                {{ formset.management_form }}
                <table class="hover stack">
                    <thead>
                        <tr>
                            <th>Lp.</th>
                            <th>Dyscyplina</th>
                            <th>Kod</th>
                            <th class="text-right">Liczba N - średnia</th>
                            <th class="text-right">Sankcje</th>
                            <th class="text-right">Liczba 3N - ostateczna</th>
                            <th class="text-right">Liczba N - koniec 2025</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for liczba in liczby_n %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ liczba.dyscyplina_naukowa.nazwa }}</td>
                            <td>{{ liczba.dyscyplina_naukowa.kod }}</td>
                            <td class="text-right">{{ liczba.liczba_n|floatformat:2 }}</td>
                            <td class="text-right">
                                {% with form=forms_by_id|get_item:liczba.pk %}
                                    {{ form.id }}
                                    {{ form.sankcje }}
                                {% endwith %}
                            </td>
                            <td class="text-right">{{ liczba.liczba_n_ostateczna|floatformat:2 }}</td>
                            <td class="text-right">{{ liczba.liczba_n_2025|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" class="text-right">SUMA:</th>
                            <th class="text-right">{{ suma_liczby_n|floatformat:2 }}</th>
                            <th class="text-right">{{ suma_sankcji|floatformat:2 }}</th>
                            <th class="text-right">{{ suma_liczby_n_ostatecznej|floatformat:2 }}</th>
                            <th class="text-right">{{ suma_liczby_n_2025|floatformat:2 }}</th>
                        </tr>
                    </tfoot>
                </table>
                <div class="text-right ewaluacja-liczba-n__save-button-wrapper">
                    <button type="submit" class="button primary" id="saveSankcjeButton">
                        <span class="fi-save"></span> Zapisz sankcje
                    </button>
                </div>
            </form>
        {% else %}
            <div class="callout warning">
                <p>Brak danych. Kliknij przycisk "Oblicz liczbę N" aby wygenerować dane.</p>
            </div>
        {% endif %}

        {% if dyscypliny_nieraportowane %}
        <h3>Dyscypliny nieraportowane</h3>
        <div class="callout alert">
            <p>Poniższe dyscypliny nie są raportowane w ewaluacji ze względu na liczbę N na koniec 2025 roku poniżej progu 12:</p>
            <table class="hover stack">
                <thead>
                    <tr>
                        <th>Lp.</th>
                        <th>Dyscyplina</th>
                        <th>Kod</th>
                        <th class="text-right">Liczba N - średnia</th>
                        <th class="text-right">Liczba N - koniec 2025</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dn in dyscypliny_nieraportowane %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ dn.dyscyplina_naukowa.nazwa }}</td>
                        <td>{{ dn.dyscyplina_naukowa.kod }}</td>
                        <td class="text-right">
                            {{ dn.liczba_n|floatformat:2 }}
                        </td>
                        <td class="text-right">
                            {{ dn.liczba_n_2025|floatformat:2 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        $('#obliczLiczbeNForm').on('submit', function(e) {
            var $button = $('#obliczLiczbeNButton');
            var $icon = $button.find('i');

            // Sprawdź czy przycisk jest już zablokowany
            if ($button.prop('disabled')) {
                e.preventDefault();
                return false;
            }

            // Zablokuj przycisk
            $button.prop('disabled', true);

            // Dodaj klasę disabled (wizualne wyszarzenie)
            $button.addClass('disabled');

            // Zmień ikonę i tekst na wskaźnik ładowania
            $icon.removeClass('fi-refresh');
            $icon.addClass('fi-clock');
            $button.html('<i class="fi-clock"></i> Obliczanie liczby N...');
        });
    });
</script>
{% endblock %}
