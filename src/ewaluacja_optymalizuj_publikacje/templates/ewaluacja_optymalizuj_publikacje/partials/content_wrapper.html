<div id="content-wrapper" class="ewaluacja-optymalizuj__content-wrapper">
    {% if not publikacja %}
        <div class="panel">
            <h4>Wybierz publikacje do optymalizacji</h4>
            <form method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="button">
                    <span class="fi-magnifying-glass"></span> Analizuj publikacje
                </button>
            </form>
        </div>
    {% else %}
        <div class="ewaluacja-optymalizuj__publication-header publication-header">
            <h3><a href="{% url 'bpp:browse_praca_by_slug' publikacja.slug %}"
                   class="ewaluacja-optymalizuj__publication-link">
                {{ publikacja.tytul_oryginalny|safe }}</a></h3>
            <p>ID: {{ publikacja.pk }} | Typ: {{ publikacja.typ_kbn|default:"" }}</p>
        </div>

        {% if stale_data_error %}
        <div class="callout alert ewaluacja-optymalizuj__stale-alert">
            <h5 class="ewaluacja-optymalizuj__stale-alert-title">
                <span class="fi-alert"></span> Nieaktualne dane metryk
            </h5>
            <p class="ewaluacja-optymalizuj__stale-alert-text">
                Wykryto nieaktualne dane metryk ewaluacyjnych.
                Prosze przebudowac metryki ewaluacyjne autorow.
            </p>
            <a href="{% url 'ewaluacja_metryki:lista' %}"
               class="button ewaluacja-optymalizuj__stale-alert-button">
                <span class="fi-refresh"></span> Przebuduj metryki ewaluacyjne autorow
            </a>
        </div>
        {% else %}

        <div id="summary-section"
             class="summary-box ewaluacja-optymalizuj__summary-box">
            <h4 class="ewaluacja-optymalizuj__summary-title">
                Podsumowanie punktacji
            </h4>
            <div class="ewaluacja-optymalizuj__summary-grid">
                <div>
                    <div class="animated-number ewaluacja-optymalizuj__summary-number--punkty">
                        {{ total_punkty|floatformat:0 }}
                    </div>
                    <div class="ewaluacja-optymalizuj__summary-label">
                        Punkty publikacji (PK)
                    </div>
                </div>
                <div>
                    <div class="animated-number ewaluacja-optymalizuj__summary-number--sloty">
                        {{ total_sloty|floatformat:2 }}
                    </div>
                    <div class="ewaluacja-optymalizuj__summary-label">
                        Laczna liczba slotow (przypiete)
                    </div>
                </div>
            </div>
        </div>

        <h3>Autorzy z przypisanymi dyscyplinami</h3>

        <div id="authors-container">
        {% for dyscyplina_group in autorzy_po_dyscyplinach %}
            <!-- Discipline Header -->
            <div class="ewaluacja-optymalizuj__discipline-header">
                <h4>
                    <span class="fi-book"></span>
                    {{ dyscyplina_group.dyscyplina.nazwa }}
                </h4>
                <div class="ewaluacja-optymalizuj__discipline-code">
                    Kod: {{ dyscyplina_group.dyscyplina.kod }}
                </div>
            </div>

            <!-- Authors in this discipline -->
            {% for autor_data in dyscyplina_group.autorzy %}
            <div id="author-{{ autor_data.autor.id }}-{{ autor_data.dyscyplina.id }}"
                 class="author-card ewaluacja-optymalizuj__author-card {% if not forloop.last %}ewaluacja-optymalizuj__author-card--not-last{% else %}ewaluacja-optymalizuj__author-card--last{% endif %}">
                <!-- Author Header -->
                <div class="ewaluacja-optymalizuj__author-header">
                    <div class="ewaluacja-optymalizuj__author-header-content">
                        <div class="ewaluacja-optymalizuj__author-name">
                            {% if autor_data.metryka_id %}
                            <a href="{% url 'ewaluacja_metryki:szczegoly' autor_data.autor.slug autor_data.dyscyplina.kod %}"
                               class="ewaluacja-optymalizuj__author-link">
                                {{ autor_data.autor.nazwisko }} {{ autor_data.autor.imiona }}
                            </a>
                            {% else %}
                            <a href="{% url 'bpp:browse_autor' autor_data.autor.slug %}"
                               class="ewaluacja-optymalizuj__author-link">
                                {{ autor_data.autor.nazwisko }} {{ autor_data.autor.imiona }}
                            </a>
                            <div class="ewaluacja-optymalizuj__author-missing-wrapper">
                                <a href="{% url 'ewaluacja_metryki:lista' %}"
                                   class="ewaluacja-optymalizuj__warning-link">
                                    <span class="fi-alert"></span> Metryka autora nie istnieje
                                </a>
                                {% if autor_data.autor_dyscyplina_missing_data %}
                                <a href="{% url 'admin:bpp_autor_dyscyplina_change' autor_data.autor_dyscyplina_id %}"
                                   target="_blank"
                                   class="ewaluacja-optymalizuj__edit-link">
                                    <span class="fi-page-edit"></span>
                                    Uzupelnij procent dyscypliny i wymiar etatu
                                </a>
                                {% endif %}
                                <a href="{% url 'ewaluacja_liczba_n:index' %}"
                                   target="_blank"
                                   class="ewaluacja-optymalizuj__n-link">
                                    <span class="fi-graph-bar"></span> Przelicz liczby N
                                </a>
                                <button type="button"
                                        data-action="pokaz-status-generowania"
                                        class="ewaluacja-optymalizuj__status-button">
                                    <span class="fi-refresh"></span>
                                    Sprawdź status generowania metryk
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        <div class="ewaluacja-optymalizuj__badges-container">
                            {% if autor_data.rodzaj_autora %}
                                <span class="ewaluacja-optymalizuj__badge ewaluacja-optymalizuj__badge--rodzaj">
                                    <span class="fi-torso"></span>
                                    {{ autor_data.rodzaj_autora.nazwa }}
                                </span>
                            {% endif %}

                            <!-- Alternative discipline if exists -->
                            {% if autor_data.alternative_discipline %}
                                <form method="post"
                                      class="ewaluacja-optymalizuj__form-inline"
                                      hx-post="{% url 'ewaluacja_optymalizuj_publikacje:optymalizuj' publikacja.slug %}"
                                      hx-target="#content-wrapper"
                                      hx-swap="outerHTML transition:true">
                                    {% csrf_token %}
                                    <input type="hidden"
                                           name="autor_assignment_id"
                                           value="{{ autor_data.autor_assignment_id }}">
                                    <input type="hidden"
                                           name="new_discipline_id"
                                           value="{{ autor_data.alternative_discipline.id }}">
                                    <input type="hidden"
                                           name="change_discipline"
                                           value="1">
                                    <button type="submit"
                                            class="ewaluacja-optymalizuj__badge ewaluacja-optymalizuj__badge--change-discipline {% if not autor_data.alternative_discipline_compatible %}ewaluacja-optymalizuj__badge--change-discipline-incompatible{% endif %}"
                                            title="Kliknij aby zmienic dyscypline">
                                        <span class="fi-refresh"></span>
                                        Zmien dyscypline na:
                                        {{ autor_data.alternative_discipline.nazwa }}
                                        ({{ autor_data.alternative_discipline.kod }})
                                    </button>
                                </form>
                            {% endif %}

                            {% if autor_data.przypieta %}
                                <span class="discipline-badge ewaluacja-optymalizuj__badge ewaluacja-optymalizuj__badge--pinned">
                                    <span class="fi-lock"></span> Przypieta
                                </span>

                                {% if autor_data.wybrana_do_ewaluacji %}
                                    <span class="ewaluacja-optymalizuj__badge ewaluacja-optymalizuj__badge--selected">
                                        <span class="fi-check"></span>
                                        Udział wybrany do ewaluacji
                                    </span>
                                {% else %}
                                    <span class="ewaluacja-optymalizuj__badge ewaluacja-optymalizuj__badge--not-selected">
                                        <span class="fi-x"></span> Udział niewybrany
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="discipline-badge ewaluacja-optymalizuj__badge ewaluacja-optymalizuj__badge--unpinned">
                                    <span class="fi-unlock"></span> Odpieta
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Author Data -->
                <div class="ewaluacja-optymalizuj__author-data">

                    <div class="ewaluacja-optymalizuj__author-grid">
                        <!-- Publication Points Section -->
                        {% if autor_data.przypieta %}
                        <div class="ewaluacja-optymalizuj__points-section">
                            <h4 class="ewaluacja-optymalizuj__section-title">
                                <span class="fi-page"></span> Punkty z publikacji
                            </h4>
                            <div class="ewaluacja-optymalizuj__points-grid">
                                <div class="ewaluacja-optymalizuj__points-item">
                                    <div class="ewaluacja-optymalizuj__points-label">
                                        Punkty (PKDAut)
                                    </div>
                                    <div class="ewaluacja-optymalizuj__points-value ewaluacja-optymalizuj__points-value--punkty">
                                        {{ autor_data.punkty|floatformat:2 }}
                                    </div>
                                </div>
                                <div class="ewaluacja-optymalizuj__points-item">
                                    <div class="ewaluacja-optymalizuj__points-label">
                                        Sloty
                                    </div>
                                    <div class="ewaluacja-optymalizuj__points-value ewaluacja-optymalizuj__points-value--sloty">
                                        {{ autor_data.sloty|floatformat:2 }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="ewaluacja-optymalizuj__points-section ewaluacja-optymalizuj__points-section--unpinned">
                            <h4 class="ewaluacja-optymalizuj__section-title ewaluacja-optymalizuj__section-title--muted">
                                <span class="fi-page"></span>
                                Punkty z publikacji (potencjalne)
                            </h4>
                            {% if autor_data.punkty or autor_data.sloty %}
                            <div class="ewaluacja-optymalizuj__points-grid">
                                <div class="ewaluacja-optymalizuj__points-item">
                                    <div class="ewaluacja-optymalizuj__points-label">
                                        Punkty (PKDAut)
                                    </div>
                                    <div class="ewaluacja-optymalizuj__points-value ewaluacja-optymalizuj__points-value--muted">
                                        {% if autor_data.punkty %}
                                            {{ autor_data.punkty|floatformat:2 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="ewaluacja-optymalizuj__points-item">
                                    <div class="ewaluacja-optymalizuj__points-label">
                                        Sloty
                                    </div>
                                    <div class="ewaluacja-optymalizuj__points-value ewaluacja-optymalizuj__points-value--muted">
                                        {% if autor_data.sloty %}
                                            {{ autor_data.sloty|floatformat:2 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="ewaluacja-optymalizuj__unpinned-note">
                                Dyscyplina odpieta - wartosci orientacyjne
                            </div>
                            {% else %}
                            <div class="ewaluacja-optymalizuj__no-data">
                                <span class="fi-unlink ewaluacja-optymalizuj__no-data-icon"></span>
                                Dyscyplina odpieta - brak punktacji
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Metrics Section -->
                        <div class="ewaluacja-optymalizuj__metrics-section">
                            <h4 class="ewaluacja-optymalizuj__section-title">
                                <span class="fi-graph-bar"></span> Metryki autora
                            </h4>
                            {% if autor_data.metryka %}
                                <div class="ewaluacja-optymalizuj__metrics-grid">
                                    <div class="ewaluacja-optymalizuj__metrics-item">
                                        <div class="ewaluacja-optymalizuj__metrics-label">
                                            Punkty lacznie
                                        </div>
                                        <div class="ewaluacja-optymalizuj__metrics-value ewaluacja-optymalizuj__metrics-value--total">
                                            {{ autor_data.metryka.punkty_nazbierane|floatformat:2 }}
                                        </div>
                                    </div>
                                    <div class="ewaluacja-optymalizuj__metrics-item">
                                        <div class="ewaluacja-optymalizuj__metrics-label">
                                            Srednia za slot
                                        </div>
                                        <div class="ewaluacja-optymalizuj__metrics-value ewaluacja-optymalizuj__metrics-value--avg">
                                            {{ autor_data.metryka.srednia_punktow|floatformat:2 }}
                                        </div>
                                    </div>
                                    <div class="ewaluacja-optymalizuj__metrics-item">
                                        <div class="ewaluacja-optymalizuj__metrics-label">
                                            Sloty nazbierane
                                        </div>
                                        <div class="ewaluacja-optymalizuj__metrics-value ewaluacja-optymalizuj__metrics-value--slots">
                                            {{ autor_data.metryka.sloty_wypelnione|floatformat:2 }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                <div class="ewaluacja-optymalizuj__progress-wrapper">
                                    <div class="ewaluacja-optymalizuj__progress-label">
                                        Wykorzystanie slotow
                                    </div>
                                    <div class="ewaluacja-optymalizuj__progress-bar">
                                        {% with percent=autor_data.metryka.udzial_procentowy|default:0 %}
                                        <div class="ewaluacja-optymalizuj__progress-fill {% if percent >= 60 %}ewaluacja-optymalizuj__progress-fill--high{% elif percent >= 30 %}ewaluacja-optymalizuj__progress-fill--medium{% else %}ewaluacja-optymalizuj__progress-fill--low{% endif %}"
                                             style="width: {% if percent > 100 %}100%{% elif percent < 5 %}5%{% else %}{{ percent|floatformat:0 }}%{% endif %};">
                                            <span class="ewaluacja-optymalizuj__progress-text">
                                                {{ percent|floatformat:1 }}%
                                            </span>
                                        </div>
                                        {% endwith %}
                                    </div>
                                    {% if autor_data.metryka.udzial_procentowy > 100 %}
                                    <div class="ewaluacja-optymalizuj__overflow-warning">
                                        <span class="fi-alert"></span>
                                        Przekroczenie o
                                        {{ autor_data.metryka.udzial_procentowy|add:"-100"|floatformat:1 }}%
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="ewaluacja-optymalizuj__metrics-empty">
                                    Brak danych metryki dla tego autora
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="ewaluacja-optymalizuj__action-section">
                        {% if autor_data.przypieta %}
                        <form method="post"
                              hx-post="{% url 'ewaluacja_optymalizuj_publikacje:optymalizuj' publikacja.slug %}"
                              hx-target="#content-wrapper"
                              hx-swap="outerHTML transition:true">
                            {% csrf_token %}
                            <input type="hidden"
                                   name="autor_assignment_id"
                                   value="{{ autor_data.autor_assignment_id }}">
                            <input type="hidden"
                                   name="unpin_discipline"
                                   value="1">
                            <button type="submit"
                                    class="ewaluacja-optymalizuj__unpin-button">
                                <span class="fi-minus"></span> Odepnij dyscypline
                                <span class="htmx-indicator ewaluacja-optymalizuj__indicator">
                                    <span class="fi-loop ewaluacja-optymalizuj__spinner"></span>
                                </span>
                            </button>
                            <small class="ewaluacja-optymalizuj__help-text">
                                Odpiecie dyscypliny spowoduje przeliczenie punktacji
                            </small>
                        </form>
                        {% else %}
                        <form method="post"
                              hx-post="{% url 'ewaluacja_optymalizuj_publikacje:optymalizuj' publikacja.slug %}"
                              hx-target="#content-wrapper"
                              hx-swap="outerHTML transition:true">
                            {% csrf_token %}
                            <input type="hidden"
                                   name="autor_assignment_id"
                                   value="{{ autor_data.autor_assignment_id }}">
                            <input type="hidden"
                                   name="pin_discipline"
                                   value="1">
                            <button type="submit"
                                    class="ewaluacja-optymalizuj__pin-button">
                                <span class="fi-plus"></span> Przypnij dyscypline
                                <span class="htmx-indicator ewaluacja-optymalizuj__indicator">
                                    <span class="fi-loop ewaluacja-optymalizuj__spinner"></span>
                                </span>
                            </button>
                            <small class="ewaluacja-optymalizuj__help-text">
                                Przypiecie dyscypliny przywroci punktacje
                            </small>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% empty %}
            <div class="alert-box info ewaluacja-optymalizuj__empty-state">
                Brak autorow dla tej dyscypliny.
            </div>
        {% endfor %}
        </div>

        {% endif %}{# stale_data_error #}
    {% endif %}
</div>
