{% extends "base.html" %}
{% load static %}

{% block title %}Optymalizacja publikacji{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li><a href="{% url "multiseek:index" %}">Wyszukiwanie</a></li>
    {% if publikacja %}
        <li><a href="{% url "bpp:browse_praca_by_slug" publikacja.slug %}">{{ publikacja.tytul_oryginalny|truncatewords_html:15|safe }}</a></li>
        <li class="current">Optymalizuj</li>
    {% else %}
        <li class="current">Optymalizuj</li>
    {% endif %}
{% endblock %}

{% block extrahead %}
<link rel="stylesheet"
      href="{% static 'ewaluacja_optymalizuj_publikacje/css/ewaluacja_optymalizuj_publikacje.css' %}">
<style>
    /* Smooth transitions for all morphing elements */
    .author-card,
    .summary-box,
    .metrics-value,
    .publication-header,
    .discipline-badge {
        transition: all 0.3s ease-in-out;
    }

    /* Fade in animation for new content */
    .htmx-settling .author-card,
    .htmx-settling .summary-box {
        opacity: 0.5;
    }

    .htmx-added {
        opacity: 0;
    }

    /* Smooth number transitions */
    .animated-number {
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Loading indicator */
    .htmx-request .htmx-indicator {
        display: inline-block;
        opacity: 1;
    }

    .htmx-indicator {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* Preserve scroll position during updates */
    #content-wrapper {
        min-height: 100vh;
        background: white;
    }


    /* Link hover effects */
    a {
        transition: all 0.2s ease;
    }

    a:hover {
        text-decoration: underline !important;
        opacity: 0.8;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="large-12 columns">
        <h2><span class="fi-wrench"></span> Optymalizacja publikacji</h2>

        {% include "ewaluacja_optymalizuj_publikacje/partials/content_wrapper.html" %}
    </div>
</div>

<!-- Modal dla statusu generowania -->
<div class="reveal" id="status-modal" data-reveal>
    <h3><span class="fi-graph-bar"></span> Status generowania metryk</h3>
    <div id="status-content" class="ewaluacja-optymalizuj__modal-content">
        <p class="ewaluacja-optymalizuj__modal-loading">
            <span class="fi-refresh ewaluacja-optymalizuj__modal-loading-icon"></span><br>
            Ładowanie...
        </p>
    </div>
    <button class="close-button" data-close aria-label="Zamknij modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<script>
function pokazStatusGenerowania() {
    const modal = new Foundation.Reveal($('#status-modal'));

    // Pokaż modal z komunikatem ładowania
    $('#status-content').html('<p class="ewaluacja-optymalizuj__modal-loading"><span class="fi-refresh ewaluacja-optymalizuj__modal-loading-icon"></span><br>Ładowanie...</p>');
    modal.open();

    // Pobierz JSON ze statusem
    fetch("{% url 'ewaluacja_metryki:status_generowania' %}")
        .then(response => response.json())
        .then(data => {
            // Formatuj datę
            const formatujDate = (isoString) => {
                if (!isoString) return 'Brak danych';
                const date = new Date(isoString);
                return date.toLocaleString('pl-PL', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            };

            // Określ status
            let statusHtml = '';
            if (data.w_trakcie) {
                statusHtml = '<span class="ewaluacja-optymalizuj__status-indicator ewaluacja-optymalizuj__status-indicator--in-progress"><span class="fi-clock"></span> W trakcie</span>';
            } else if (data.data_zakonczenia) {
                statusHtml = '<span class="ewaluacja-optymalizuj__status-indicator ewaluacja-optymalizuj__status-indicator--completed"><span class="fi-check"></span> Zakończone</span>';
            } else {
                statusHtml = '<span class="ewaluacja-optymalizuj__status-indicator ewaluacja-optymalizuj__status-indicator--no-data"><span class="fi-info"></span> Brak danych</span>';
            }

            // Buduj HTML
            let html = '<table class="ewaluacja-optymalizuj__status-table">';
            html += '<tbody>';

            // Status
            html += '<tr class="ewaluacja-optymalizuj__status-row">';
            html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Status</td>';
            html += '<td class="ewaluacja-optymalizuj__status-cell">' + statusHtml + '</td>';
            html += '</tr>';

            // Data rozpoczęcia
            if (data.data_rozpoczecia) {
                html += '<tr class="ewaluacja-optymalizuj__status-row">';
                html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Data rozpoczęcia</td>';
                html += '<td class="ewaluacja-optymalizuj__status-cell">' + formatujDate(data.data_rozpoczecia) + '</td>';
                html += '</tr>';
            }

            // Data zakończenia
            if (data.data_zakonczenia) {
                html += '<tr class="ewaluacja-optymalizuj__status-row">';
                html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Data zakończenia</td>';
                html += '<td class="ewaluacja-optymalizuj__status-cell">' + formatujDate(data.data_zakonczenia) + '</td>';
                html += '</tr>';
            }

            // Liczba do przetworzenia
            html += '<tr class="ewaluacja-optymalizuj__status-row">';
            html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Liczba do przetworzenia</td>';
            html += '<td class="ewaluacja-optymalizuj__status-cell">' + data.liczba_do_przetworzenia + '</td>';
            html += '</tr>';

            // Liczba przetworzonych
            html += '<tr class="ewaluacja-optymalizuj__status-row">';
            html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Liczba przetworzonych</td>';
            html += '<td class="ewaluacja-optymalizuj__status-cell"><strong class="ewaluacja-optymalizuj__status-value--blue">' + data.liczba_przetworzonych + '</strong></td>';
            html += '</tr>';

            // Postęp (jeśli w trakcie)
            if (data.w_trakcie && data.procent) {
                html += '<tr class="ewaluacja-optymalizuj__status-row">';
                html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Postęp</td>';
                html += '<td class="ewaluacja-optymalizuj__status-cell"><strong class="ewaluacja-optymalizuj__status-value--orange">' + data.procent + '%</strong></td>';
                html += '</tr>';
            }

            // Liczba błędów
            html += '<tr class="ewaluacja-optymalizuj__status-row">';
            html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Liczba błędów</td>';
            let bledyClass = data.liczba_bledow > 0 ? 'ewaluacja-optymalizuj__status-value--red' : 'ewaluacja-optymalizuj__status-value--green';
            html += '<td class="ewaluacja-optymalizuj__status-cell"><strong class="' + bledyClass + '">' + data.liczba_bledow + '</strong></td>';
            html += '</tr>';

            // Ostatni komunikat
            if (data.ostatni_komunikat) {
                html += '<tr class="ewaluacja-optymalizuj__status-row">';
                html += '<td class="ewaluacja-optymalizuj__status-cell ewaluacja-optymalizuj__status-cell--label">Ostatni komunikat</td>';
                html += '<td class="ewaluacja-optymalizuj__status-cell"><code class="ewaluacja-optymalizuj__status-code">' + data.ostatni_komunikat + '</code></td>';
                html += '</tr>';
            }

            html += '</tbody>';
            html += '</table>';

            // Dodaj przycisk do listy metryk
            html += '<div class="ewaluacja-optymalizuj__status-footer">';
            html += '<a href="{% url 'ewaluacja_metryki:lista' %}" class="button"><span class="fi-list"></span> Przejdź do listy metryk</a>';
            html += '</div>';

            $('#status-content').html(html);
        })
        .catch(error => {
            console.error('Błąd pobierania statusu:', error);
            $('#status-content').html('<div class="alert-box alert">Błąd podczas pobierania statusu generowania.</div>');
        });
}
</script>
{% endblock %}
