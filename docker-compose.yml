#
# Uwaga uwaga: ten docker-compose.yml to deweloperska konfiguracja uruchamiania BPP.
# Odsłania wszystkie porty. NIE uzywać w produkcji. Zostaliście ostrzeżeni.
#

services:
  db:
    image: iplweb/bpp_dbserver:${DOCKER_VERSION:-latest}
    build:
      context: ./deploy/dbserver
      dockerfile: Dockerfile
      tags:
        - iplweb/bpp_dbserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_dbserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_dbserver:latest
      cache_to:
        - type=inline
    restart: always
    environment:
      - PGPORT=${DJANGO_BPP_DB_PORT:-5432}
      # Ustaw na "1" dla maksymalnej wydajności (wyłącza fsync, synchronous_commit)
      # TYLKO dla developmentu/testów! NIE UŻYWAĆ W PRODUKCJI!
      - POSTGRESQL_UNSAFE_BUT_FAST=1
    ports:
      - ${DJANGO_BPP_DB_PORT:-5432}:${DJANGO_BPP_DB_PORT:-5432}
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      start_period: 10s
      interval: 5s
      timeout: 5s
      retries: 5

  celerybeat:
    image: iplweb/bpp_beatserver:${DOCKER_VERSION:-latest}
    build:
      context: ./deploy/beatserver
      dockerfile: Dockerfile
      tags:
        - iplweb/bpp_beatserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_beatserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_base:latest
        - type=registry,ref=iplweb/bpp_beatserver:latest
      cache_to:
        - type=inline
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
      - ENABLE_AUTORELOAD_ON_CODE_CHANGE=${ENABLE_AUTORELOAD_ON_CODE_CHANGE:-1}
    restart: always
    volumes:
      - ./src:/app/src
      - ./src/django_bpp/staticroot:/staticroot
      - media:/mediaroot
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      appserver:
        condition: service_healthy

  appserver:
    image: iplweb/bpp_appserver:${DOCKER_VERSION:-latest}
    build:
      context: .
      dockerfile: deploy/appserver/Dockerfile
      tags:
        - iplweb/bpp_appserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_appserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_base:latest
        - type=registry,ref=iplweb/bpp_appserver:latest
      cache_to:
        - type=inline
    restart: always
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
      - ENABLE_AUTORELOAD_ON_CODE_CHANGE=${ENABLE_AUTORELOAD_ON_CODE_CHANGE:-1}
      - DJANGO_BPP_CSRF_EXTRA_ORIGINS=https://bpp.localnet:10443,https://localhost:10443
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
    ports:
      - ${DJANGO_BPP_PORT_APP:-8000}:8000
    volumes:
      - ./src:/app/src
      - ./src/django_bpp/staticroot:/staticroot
      - media:/mediaroot

  authserver:
    # Lightweight auth server for nginx authentication
    # Starts quickly (seconds) - no migrations, no collectstatic
    # Used by nginx auth_request for Grafana, Dozzle, etc.
    image: iplweb/bpp_authserver:${DOCKER_VERSION:-latest}
    build:
      context: .
      dockerfile: deploy/authserver/Dockerfile
      tags:
        - iplweb/bpp_authserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_authserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_base:latest
        - type=registry,ref=iplweb/bpp_authserver:latest
      cache_to:
        - type=inline
    restart: always
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.auth_server
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8001/health/"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 3
    volumes:
      - ./src:/app/src

  workerserver-general:
    image: iplweb/bpp_workerserver:${DOCKER_VERSION:-latest}
    build:
      context: .
      dockerfile: deploy/workerserver/Dockerfile
      tags:
        - iplweb/bpp_workerserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_workerserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_base:latest
        - type=registry,ref=iplweb/bpp_workerserver:latest
      cache_to:
        - type=inline
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - WEB_CONCURRENCY=4
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
      - ENABLE_AUTORELOAD_ON_CODE_CHANGE=${ENABLE_AUTORELOAD_ON_CODE_CHANGE:-1}
    restart: always
    volumes:
      - ./src:/app/src
      - ./src/django_bpp/staticroot:/staticroot
      - media:/mediaroot
    depends_on:
      # Musi czekać na appserver, gdyż appserver aktualizuje ewentualnie baze danych.
      # Czy nawet w ogóle ją buduje...
      rabbitmq:
        condition: service_healthy
      appserver:
        condition: service_healthy

  workerserver-denorm:
    image: iplweb/bpp_workerserver:${DOCKER_VERSION:-latest}
    build:
      context: .
      dockerfile: deploy/workerserver/Dockerfile
      tags:
        - iplweb/bpp_workerserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_workerserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_base:latest
        - type=registry,ref=iplweb/bpp_workerserver:latest
      cache_to:
        - type=inline
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - WEB_CONCURRENCY=4
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
      - ENABLE_AUTORELOAD_ON_CODE_CHANGE=${ENABLE_AUTORELOAD_ON_CODE_CHANGE:-1}
      - CELERY_QUEUE=denorm
    restart: always
    volumes:
      - ./src:/app/src
      - ./src/django_bpp/staticroot:/staticroot
      - media:/mediaroot
    depends_on:
      # Musi czekać na appserver, gdyż appserver aktualizuje ewentualnie baze danych.
      # Czy nawet w ogóle ją buduje...
      rabbitmq:
        condition: service_healthy
      appserver:
        condition: service_healthy

  workerserver-status:
    image: iplweb/bpp_workerserver:${DOCKER_VERSION:-latest}
    build:
      context: .
      dockerfile: deploy/workerserver/Dockerfile
      tags:
        - iplweb/bpp_workerserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_workerserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_base:latest
        - type=registry,ref=iplweb/bpp_workerserver:latest
      cache_to:
        - type=inline
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    command: status
    depends_on:
      workerserver-general:
        condition: service_healthy
      workerserver-denorm:
        condition: service_healthy
    profiles: ['manual']

  denorm-queue:
    # run only SINGLE service, this is only a mechanism to pass
    # PostgreSQL LISTEN to Celery queue
    image: iplweb/bpp_denorm_queue:${DOCKER_VERSION:-latest}
    build:
      context: .
      dockerfile: deploy/denorm-queue/Dockerfile
      tags:
        - iplweb/bpp_denorm_queue:${DOCKER_VERSION:-latest}
        - iplweb/bpp_denorm_queue:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_base:latest
        - type=registry,ref=iplweb/bpp_denorm_queue:latest
      cache_to:
        - type=inline
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
      - ENABLE_AUTORELOAD_ON_CODE_CHANGE=${ENABLE_AUTORELOAD_ON_CODE_CHANGE:-1}
    restart: always
    volumes:
      - ./src:/app/src
    depends_on:
      rabbitmq:
        condition: service_healthy
      workerserver-denorm:
        condition: service_healthy

  webserver:
    image: iplweb/bpp_webserver:${DOCKER_VERSION:-latest}
    build:
      context: ./deploy/webserver
      dockerfile: Dockerfile
      tags:
        - iplweb/bpp_webserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_webserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_webserver:latest
      cache_to:
        - type=inline
    restart: always
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - USE_DEV_TEMPLATE=${USE_DEV_TEMPLATE:-true}
    ports:
      - ${DJANGO_BPP_PORT_HTTP:-1080}:80
      - ${DJANGO_BPP_PORT_HTTPS:-10443}:443
    volumes:
      - ./src/django_bpp/staticroot:/var/www/html/staticroot
      - media:/mediaroot
      - ssl_certs:/etc/ssl/private

  dozzle:
    image: amir20/dozzle:latest
    restart: always
    environment:
      - DOZZLE_BASE=/dozzle
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    expose:
      - 8080

  loki:
    image: grafana/loki:3.4.1
    restart: always
    command: -config.file=/etc/loki/local-config.yaml

  grafana:
    image: grafana/grafana:latest
    restart: always
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    environment:
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_AUTH_PROXY_ENABLED=true
      - GF_AUTH_PROXY_HEADER_NAME=X-WEBAUTH-USER
      - GF_AUTH_PROXY_HEADER_PROPERTY=username
      - GF_AUTH_PROXY_AUTO_SIGN_UP=true
      - GF_AUTH_PROXY_HEADERS=Email:X-WEBAUTH-EMAIL Name:X-WEBAUTH-NAME
    volumes:
      - grafana_data:/var/lib/grafana
    expose:
      - 3000
    depends_on:
      - loki

  alloy:
    image: grafana/alloy:latest
    restart: always
    command: >
      run /etc/alloy/config.alloy
      --server.http.listen-addr=0.0.0.0:12345
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - alloy_config:/etc/alloy:ro
    depends_on:
      - loki

  redis:
    image: redis:latest
    restart: always
    command: redis-server --loglevel warning --port ${DJANGO_BPP_REDIS_PORT:-6379}
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${DJANGO_BPP_REDIS_PORT:-6379}", "ping"]
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 3
    ports:
      - ${DJANGO_BPP_REDIS_PORT:-6379}:${DJANGO_BPP_REDIS_PORT:-6379}
    volumes:
      - redis_data:/data

  rabbitmq:
    image: rabbitmq:management-alpine
    restart: always
    env_file:
      - path: .env.docker
        required: true
      - path: .env
        required: false
    ports:
      - ${DJANGO_BPP_RABBITMQ_PORT:-5672}:${DJANGO_BPP_RABBITMQ_PORT:-5672}
      - ${DJANGO_BPP_PORT_RABBITMQ_MGMT:-15672}:15672 # Management UI port
    environment:
      RABBITMQ_NODE_PORT: ${DJANGO_BPP_RABBITMQ_PORT:-5672}
      RABBITMQ_DEFAULT_USER: ${DJANGO_BPP_RABBITMQ_USER:-bpp}
      RABBITMQ_DEFAULT_PASS: ${DJANGO_BPP_RABBITMQ_PASS:-bpp}
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: >-
        -rabbit log_levels [{connection,error},{channel,error},{mirroring,error},{federation,error},{upgrade,error}]
        log [{console,[{level,error}]}]
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 5
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

volumes:
  staticfiles:
  media:
  postgresql_data:
  redis_data:
  rabbitmq_data: # RabbitMQ data persistence
  ssl_certs:     # SSL certificates for production
  backup:        # Backup storage (used by rclone)
  rclone_config: # Rclone configuration
  grafana_data:
  alloy_config:
