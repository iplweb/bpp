#
# Uwaga uwaga: ten docker-compose.yml to deweloperska konfiguracja uruchamiania BPP.
# Odsłania wszystkie porty. NIE uzywać w produkcji. Zostaliście ostrzeżeni.
#

services:
  db:
    image: iplweb/bpp_dbserver:latest
    restart: always
    volumes:
      - postgresql_data:/var/lib/postgresql/data

  celerybeat:
    image: iplweb/bpp_beatserver:latest
    env_file: .env.docker
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
    restart: always
    volumes:
      - ./src:/app/src
      - staticfiles:/staticroot
      - media:/mediaroot
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      appserver:
        condition: service_started

  appserver:
    image: iplweb/bpp_appserver:latest
    restart: always
    env_file: .env.docker
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
    ports:
      - 8000:8000
    volumes:
      - ./src:/app/src
      - staticfiles:/staticroot
      - media:/mediaroot

  workerserver-general:
    image: iplweb/bpp_workerserver:latest
    env_file: .env.docker
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
    command: worker -Q celery
    restart: always
    volumes:
      - ./src:/app/src
      - staticfiles:/staticroot
      - media:/mediaroot
    depends_on:
      # Musi czekać na appserver, gdyż appserver aktualizuje ewentualnie baze danych.
      # Czy nawet w ogóle ją buduje...
      rabbitmq:
        condition: service_healthy
      appserver:
        condition: service_healthy

  workerserver-denorm:
    image: iplweb/bpp_workerserver:latest
    env_file: .env.docker
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
    command: worker -Q denorm
    restart: always
    volumes:
      - ./src:/app/src
      - staticfiles:/staticroot
      - media:/mediaroot
    depends_on:
      # Musi czekać na appserver, gdyż appserver aktualizuje ewentualnie baze danych.
      # Czy nawet w ogóle ją buduje...
      rabbitmq:
        condition: service_healthy
      appserver:
        condition: service_healthy

  workerserver-status:
    image: iplweb/bpp_workerserver:latest
    env_file: .env.docker
    command: status
    depends_on:
      workerserver-general:
        condition: service_healthy
      workerserver-denorm:
        condition: service_healthy
    profiles: ['manual']

  denorm-queue:
    # run only SINGLE service, this is only a mechanism to pass
    # PostgreSQL LISTEN to Celery queue
    image: iplweb/bpp_base:latest
    env_file: .env.docker
    environment:
      - DJANGO_SETTINGS_MODULE=django_bpp.settings.local
    entrypoint: ["uv", "run", "python", "src/manage.py", "denorm_queue"]
    healthcheck:
      test: ['CMD','true'] # disable the healthcheck
    restart: always
    volumes:
      - ./src:/app/src
    depends_on:
      rabbitmq:
        condition: service_healthy
      workerserver-denorm:
        condition: service_healthy

  webserver:
    image: iplweb/bpp_webserver:latest
    restart: always
    env_file: .env.docker
    depends_on:
      appserver:
        condition: service_healthy
    ports:
      - 1080:80
      - 10443:443
    volumes:
      - staticfiles:/var/www/html/staticroot
      - media:/mediaroot
      - ssl_certs:/etc/ssl/private

  redis:
    image: redis:latest
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 3
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data

  rabbitmq:
    image: rabbitmq:management-alpine
    restart: always
    env_file: .env.docker
    ports:
      - 5672:5672   # AMQP protocol port
      - 15672:15672 # Management UI port
    environment:
      RABBITMQ_DEFAULT_USER: ${DJANGO_BPP_RABBITMQ_USER:-bpp}
      RABBITMQ_DEFAULT_PASS: ${DJANGO_BPP_RABBITMQ_PASS:-bpp}
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 5
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

volumes:
  staticfiles:
  media:
  postgresql_data:
  redis_data:
  rabbitmq_data: # RabbitMQ data persistence
  ssl_certs:     # SSL certificates for production
  backup:        # Backup storage (used by rclone)
  rclone_config: # Rclone configuration
