version: 2
jobs:
  build:

    docker:
      - image: mpasternak79/circleci-python:3.7-node-browsers-nginx-http-push
        environment:
          PGUSER: postgres
          PGHOST: localhost
          PGPORT: 5432
          PGDATABASE: bpp
          DJANGO_BPP_SECRET_KEY: foobar
          DJANGO_SETTINGS_MODULE: django_bpp.settings.test
      - image: mpasternak79/circleci-postgres:12
      - image: rabbitmq:latest
        
    steps:
      - checkout

      - run: sudo npm install -g grunt-cli
      - run: sudo pipenv install --system -d
      - run: make assets

      # Uruchamiaj na lokalnym firefoxie używając jednego CPU
      - run: pytest -n 2 --cov=src --splinter-webdriver=firefox  --nginx-host=localhost --liveserver=localhost -m "not serial"
      - run: pytest -n 0 --splinter-webdriver=firefox  --nginx-host=localhost --liveserver=localhost -m "serial"

      # Testy JavaScript
      - run: make js-tests

      # Wyślij statystyki pokrycia kodu testami do coveralls.io  
      - run: coveralls
