# BPP Docker Deployment - Database Component
# Contains PostgreSQL database service

services:
  db:
    image: iplweb/bpp_dbserver:${DOCKER_VERSION:-latest}
    build:
      context: ./deploy/dbserver
      dockerfile: Dockerfile
      tags:
        - iplweb/bpp_dbserver:${DOCKER_VERSION:-latest}
        - iplweb/bpp_dbserver:latest
      cache_from:
        - type=registry,ref=iplweb/bpp_dbserver:latest
      cache_to:
        - type=inline
    restart: always
    environment:
      - PGPORT=${DJANGO_BPP_DB_PORT:-5432}
      - POSTGRES_DB=${DJANGO_BPP_DB_NAME:-bpp}
      - POSTGRES_USER=${DJANGO_BPP_DB_USER:-bpp}
      # Ustaw na "1" dla maksymalnej wydajności (wyłącza fsync, synchronous_commit)
      # TYLKO dla developmentu/testów! NIE UŻYWAĆ W PRODUKCJI!
      - POSTGRESQL_UNSAFE_BUT_FAST=1
    ports:
      - ${DJANGO_BPP_DB_PORT:-5432}:${DJANGO_BPP_DB_PORT:-5432}
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DJANGO_BPP_DB_USER:-bpp}"]
      start_period: 10s
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgresql_data:
